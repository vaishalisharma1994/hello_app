<div id="cha-account_activation" data-tralics-id="cid60" class="chapter" data-number="11" data-chapter="account_activation"><h1><a href="account_activation_fragment.html#cha-account_activation" class="heading hyperref"><span class="number">Chapter 11 </span>Account activation</a></h1>
<p>At present, newly registered users immediately have full access to their accounts (<a href="sign_up_fragment.html#cha-sign_up" class="hyperref">Chapter <span class="ref">7</span></a>); in this chapter, we’ll implement an account activation step to verify that the user controls the email address they used to sign up.<sup id="cha-11_footnote-ref-1" class="footnote"><a href="#cha-11_footnote-1">1</a></sup><span class="intersentencespace"></span> This will involve associating an activation token and digest with a user, sending the user an email with a link including the token, and activating the user upon clicking the link.<span class="intersentencespace"></span> In <a href="password_reset_fragment.html#cha-password_reset" class="hyperref">Chapter <span class="ref">12</span></a>, we’ll apply similar ideas to allow users to reset their passwords if they forget them.<span class="intersentencespace"></span> Each of these two features will involve creating a new resource, thereby giving us a chance to see further examples of controllers, routing, and database migrations.<span class="intersentencespace"></span> In the process, we’ll also have a chance to learn how to send email in Rails, both in development and in production.</p>
<p>Our strategy for handling account activation parallels user login (<a href="basic_login_fragment.html#sec-logging_in" class="hyperref">Section <span class="ref">8.2</span></a>) and especially remembering users (<a href="advanced_login_fragment.html#sec-remember_me" class="hyperref">Section <span class="ref">9.1</span></a>).<span class="intersentencespace"></span> The basic sequence appears as follows:</p>
<ol>
<li>Start users in an “unactivated” state.<span class="intersentencespace"></span>
</li>
<li>When a user signs up, generate an activation token and corresponding activation digest.<span class="intersentencespace"></span>
</li>
<li>Save the activation digest to the database, and then send an email to the user with a link containing the activation token and user’s email address.<sup id="cha-11_footnote-ref-2" class="footnote"><a href="#cha-11_footnote-2">2</a></sup>
</li>
<li>When the user clicks the link, find the user by email address, and then authenticate the token by comparing with the activation digest.<span class="intersentencespace"></span>
</li>
<li>If the user is authenticated, change the status from “unactivated” to “activated”.<span class="intersentencespace"></span>
</li></ol>
<p>Because of the similarity with passwords and remember tokens, we will be able to reuse many of the same ideas for account activation (as well as password reset), including the <code>User.digest</code> and <code>User.new_token</code> methods and a modified version of the <code>user.authenticated?</code> method.<span class="intersentencespace"></span> <a href="account_activation_fragment.html#table-password_token_digest" class="hyperref">Table <span class="ref">11.1</span></a> illustrates the analogy (including the password reset from <a href="password_reset_fragment.html#cha-password_reset" class="hyperref">Chapter <span class="ref">12</span></a>).</p>
<div class="table" id="table-password_token_digest" data-tralics-id="uid1347" data-number="11.1"><table class="tabular">
<tbody><tr class="bottom_border"><td colspan="1" class="align_center"><strong>find by</strong></td>
<td colspan="1" class="align_center"><strong>string</strong></td>
<td colspan="1" class="align_center"><strong>digest</strong></td>
<td colspan="1" class="align_center"><strong>authentication</strong></td>
</tr><tr><td class="align_left"><code>email</code></td>
<td class="align_left"><code>password</code></td>
<td class="align_left"><code>password_digest</code></td>
<td class="align_left"><code>authenticate(password)</code></td>
</tr><tr><td class="align_left"><code>id</code></td>
<td class="align_left"><code>remember_token</code></td>
<td class="align_left"><code>remember_digest</code></td>
<td class="align_left"><code>authenticated?(:remember, token)</code></td>
</tr><tr><td class="align_left"><code>email</code></td>
<td class="align_left"><code>activation_token</code></td>
<td class="align_left"><code>activation_digest</code></td>
<td class="align_left"><code>authenticated?(:activation, token)</code></td>
</tr><tr><td class="align_left"><code>email</code></td>
<td class="align_left"><code>reset_token</code></td>
<td class="align_left"><code>reset_digest</code></td>
<td class="align_left"><code>authenticated?(:reset, token)</code></td>
</tr></tbody></table><div class="caption"><span class="header">Table 11.1: </span><span class="description">The analogy between login, remembering, account activation, and password reset.
</span></div></div>
<p>In <a href="account_activation_fragment.html#sec-account_activations_resource" class="hyperref">Section <span class="ref">11.1</span></a>, we’ll make a resource and data model for account activations (<a href="account_activation_fragment.html#sec-account_activations_resource" class="hyperref">Section <span class="ref">11.1</span></a>), and in <a href="account_activation_fragment.html#sec-account_activation_emails" class="hyperref">Section <span class="ref">11.2</span></a> we’ll add a <em>mailer</em> for sending account activation emails (<a href="account_activation_fragment.html#sec-account_activation_emails" class="hyperref">Section <span class="ref">11.2</span></a>).<span class="intersentencespace"></span> We’ll implement the actual account activation, including a generalized version of the <code>authenticated?</code> method from <a href="account_activation_fragment.html#table-password_token_digest" class="hyperref">Table <span class="ref">11.1</span></a>, in <a href="account_activation_fragment.html#sec-activating_the_account" class="hyperref">Section <span class="ref">11.3</span></a>.</p>
</div><div id="sec-account_activations_resource" data-tralics-id="cid61" class="section" data-number="11.1"><h2><a href="account_activation_fragment.html#sec-account_activations_resource" class="heading hyperref"><span class="number">11.1 </span>Account activations resource</a></h2>
<p>As with sessions (<a href="basic_login_fragment.html#sec-sessions_and_failed_login" class="hyperref">Section <span class="ref">8.1</span></a>), we’ll model account activations as a resource even though they won’t be associated with an Active Record model.<span class="intersentencespace"></span> Instead, we’ll include the relevant data (including the activation token and activation status) in the User model itself.</p>
<p>Because we’ll be treating account activations as a resource, we’ll interact with them via a standard REST URL.<span class="intersentencespace"></span> The activation link will be modifying the user’s activation status, and for such modifications the standard REST practice is to issue a <code class="tt">PATCH</code> request to the <code>update</code> action (<a href="sign_up_fragment.html#table-RESTful_users" class="hyperref">Table <span class="ref">7.1</span></a>).<span class="intersentencespace"></span> The activation link needs to be sent in an email, though, and hence will involve a regular browser click, which issues a <code class="tt">GET</code> request instead of <code class="tt">PATCH</code>.<span class="intersentencespace"></span> This design constraint means that we can’t use the <code>update</code> action, but we’ll do the next-best thing and use the <code>edit</code> action instead, which does respond to <code class="tt">GET</code> requests.</p>
<p>As usual, we’ll make a topic branch for the new feature:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b account-activation
</pre></div></div>
<div id="sec-account_activations_controller" data-tralics-id="uid1348" class="subsection" data-number="11.1.1"><h3><a href="account_activation_fragment.html#sec-account_activations_controller" class="heading hyperref"><span class="number">11.1.1 </span>Account activations controller</a></h3>
<p>As with Users and Sessions, the actions (or, in this case, the sole action) for the Account Activations resource will live inside an Account Activations controller, which we can generate as follows:<sup id="cha-11_footnote-ref-3" class="footnote"><a href="#cha-11_footnote-3">3</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller AccountActivations
</pre></div></div>
<p>As we’ll see in <a href="account_activation_fragment.html#sec-mailer_templates" class="hyperref">Section <span class="ref">11.2.1</span></a>, the activation email will involve a URL of the form</p>
<div class="code"><div class="highlight"><pre><span class="n">edit_account_activation_url</span><span class="p">(</span><span class="n">activation_token</span><span class="p">,</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div></div>
<p>which means we’ll need a named route for the <code>edit</code> action.<span class="intersentencespace"></span> We can arrange for this with the <code>resources</code> line shown in <a href="account_activation_fragment.html#code-account_activations_route" class="hyperref">Listing <span class="ref">11.1</span></a>, which gives the RESTful route shown in <a href="account_activation_fragment.html#table-RESTful_account_activations" class="hyperref">Table <span class="ref">11.2</span></a>.</p>
<div class="codelisting" id="code-account_activations_route" data-tralics-id="uid1350" data-number="11.1"><div class="heading"><span class="number">Listing 11.1:</span> 

<span class="description">Adding a route for the Account Activations <code>edit</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">root</span>   <span class="s1">'static_pages#home'</span>
  <span class="n">get</span>    <span class="s1">'/help'</span><span class="p">,</span>    <span class="ss">to</span><span class="p">:</span> <span class="s1">'static_pages#help'</span>
  <span class="n">get</span>    <span class="s1">'/about'</span><span class="p">,</span>   <span class="ss">to</span><span class="p">:</span> <span class="s1">'static_pages#about'</span>
  <span class="n">get</span>    <span class="s1">'/contact'</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">'static_pages#contact'</span>
  <span class="n">get</span>    <span class="s1">'/signup'</span><span class="p">,</span>  <span class="ss">to</span><span class="p">:</span> <span class="s1">'users#new'</span>
  <span class="n">get</span>    <span class="s1">'/login'</span><span class="p">,</span>   <span class="ss">to</span><span class="p">:</span> <span class="s1">'sessions#new'</span>
  <span class="n">post</span>   <span class="s1">'/login'</span><span class="p">,</span>   <span class="ss">to</span><span class="p">:</span> <span class="s1">'sessions#create'</span>
  <span class="n">delete</span> <span class="s1">'/logout'</span><span class="p">,</span>  <span class="ss">to</span><span class="p">:</span> <span class="s1">'sessions#destroy'</span>
  <span class="n">resources</span> <span class="ss">:users</span>
<span class="hll">  <span class="n">resources</span> <span class="ss">:account_activations</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="o">]</span>
</span><span class="k">end</span>
</pre></div></div></div><div class="table" id="table-RESTful_account_activations" data-tralics-id="uid1351" data-number="11.2"><table class="tabular">
<tbody><tr class="bottom_border"><td class="align_left"><strong>HTTP request</strong></td>
<td class="align_left"><strong>URL</strong></td>
<td class="align_left"><strong>Action</strong></td>
<td class="align_left"><strong>Named route</strong></td>
</tr><tr><td class="align_left"><code class="tt">GET</code></td>
<td class="align_left">/account_activation/&lt;token&gt;/edit</td>
<td class="align_left"><code>edit</code></td>
<td class="align_left"><code>edit_account_activation_url(token)</code></td>
</tr></tbody></table><div class="caption"><span class="header">Table 11.2: </span><span class="description">RESTful route provided by the Account Activations resource in <a href="account_activation_fragment.html#code-account_activations_route" class="hyperref">Listing <span class="ref">11.1</span></a>.
</span></div></div>
<p>We’ll define the <code>edit</code> action itself in <a href="account_activation_fragment.html#sec-activation_edit_action" class="hyperref">Section <span class="ref">11.3.2</span></a>, after we’ve finished the Account Activations data model and mailers.</p>
<div id="sec-exercises_account_activations_controller" data-tralics-id="uid1352" class="subsubsection" data-number="11.1.1.1"><h4><a href="#sec-exercises_account_activations_controller" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Verify that the test suite is still <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>. <span class="exercise" id="ex-4955e7"></span>
</li>
<li>Why does <a href="account_activation_fragment.html#table-RESTful_account_activations" class="hyperref">Table <span class="ref">11.2</span></a> list the <code>_url</code> form of the named route instead of the <code>_path</code> form?<span class="intersentencespace"></span> <em>Hint</em>: We’re going to use it in an email. <span class="exercise" id="ex-a02b35"></span>
</li></ol>
</div></div>
<div id="sec-account_activation_data_model" data-tralics-id="uid1355" class="subsection" data-number="11.1.2"><h3><a href="account_activation_fragment.html#sec-account_activation_data_model" class="heading hyperref"><span class="number">11.1.2 </span>Account activation data model</a></h3>
<p>As discussed in the introduction, we need a unique activation token for use in the activation email.<span class="intersentencespace"></span> One possibility would be to use a string that’s stored both in the database and included in the activation URL, but this raises security concerns if our database is compromised.<span class="intersentencespace"></span> For example, an attacker with access to the database could immediately activate newly created accounts (thereby logging in as the user), and could then change the password to gain control.<sup id="cha-11_footnote-ref-4" class="footnote"><a href="#cha-11_footnote-4">4</a></sup></p>
<p>To prevent such scenarios, we’ll follow the example of passwords (<a href="modeling_users_fragment.html#cha-modeling_users" class="hyperref">Chapter <span class="ref">6</span></a>) and remember tokens (<a href="advanced_login_fragment.html#cha-advanced_login" class="hyperref">Chapter <span class="ref">9</span></a>) by pairing a publicly exposed virtual attribute with a secure hash digest saved to the database.<span class="intersentencespace"></span> This way we can access the activation token using</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">activation_token</span>
</pre></div></div>
<p>and authenticate the user with code like</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:activation</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
</pre></div></div>
<p>(This will require a modification of the <code>authenticated?</code> method defined in <a href="advanced_login_fragment.html#code-authenticated_p" class="hyperref">Listing <span class="ref">9.6</span></a>.)</p>
<p>We’ll also add a boolean attribute called <code>activated</code> to the User model, which will allow us to test if a user is activated using the same kind of auto-generated boolean method we saw in <a href="updating_and_deleting_users_fragment.html#sec-administrative_users" class="hyperref">Section <span class="ref">10.4.1</span></a>:</p>
<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">activated?</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</pre></div></div>
<p>Finally, although we won’t use it in this tutorial, we’ll record the time and date of the activation in case we want it for future reference.<span class="intersentencespace"></span> The full data model appears in <a href="account_activation_fragment.html#fig-user_model_account_activation" class="hyperref">Figure <span class="ref">11.1</span></a>.</p>
<div class="center figure" id="fig-user_model_account_activation" data-tralics-id="uid1357" data-number="11.1"><span class="graphics"><img src="images/figures/user_model_account_activation.png" alt="user_model_account_activation"></span>
<div class="caption"><span class="header">Figure 11.1: </span><span class="description">The User model with added account activation attributes.
</span></div></div>
<p>The migration to add the data model from <a href="account_activation_fragment.html#fig-user_model_account_activation" class="hyperref">Figure <span class="ref">11.1</span></a> adds all three attributes at the command line:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_activation_to_users <span class="se">\</span>
<span class="gp">&gt;</span> activation_digest:string activated:boolean activated_at:datetime
</pre></div></div>
<p>(As noted in <a href="basic_login_fragment.html#sec-testing_layout_changes" class="hyperref">Section <span class="ref">8.2.4</span></a>, the <code>&gt;</code> on the second line is a “line continuation” character inserted automatically by the shell, and should not be typed literally.)<span class="intersentencespace"></span> As with the <code>admin</code> attribute (<a href="updating_and_deleting_users_fragment.html#code-admin_migration" class="hyperref">Listing <span class="ref">10.54</span></a>), we’ll add a default boolean value of <code>false</code> to the <code>activated</code> attribute, as shown in <a href="account_activation_fragment.html#code-add_activation_to_users_migration" class="hyperref">Listing <span class="ref">11.2</span></a>.</p>
<div class="codelisting" id="code-add_activation_to_users_migration" data-tralics-id="uid1358" data-number="11.2"><div class="heading"><span class="number">Listing 11.2:</span> 

<span class="description">A migration for account activation (with added index).<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">db/migrate/[timestamp]_add_activation_to_users.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddActivationToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="o">[</span><span class="mi">5</span><span class="o">.</span><span class="mi">0</span><span class="o">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:activation_digest</span><span class="p">,</span> <span class="ss">:string</span>
<span class="hll">    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:activated</span><span class="p">,</span> <span class="ss">:boolean</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="kp">false</span>
</span>    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:activated_at</span><span class="p">,</span> <span class="ss">:datetime</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>We then apply the migration as usual:</p>
<div class="code"><div class="highlight"><pre>$ rails db:migrate
</pre></div></div>
<div id="sec-activation_token_callback" data-tralics-id="uid1359" class="subsubsection" data-number="11.1.2.1"><h4><a href="#sec-activation_token_callback" class="heading">Activation token callback</a></h4>
<p>Because every newly signed-up user will require activation, we should assign an activation token and digest to each user object before it’s created.<span class="intersentencespace"></span> We saw a similar idea in <a href="modeling_users_fragment.html#sec-uniqueness_validation" class="hyperref">Section <span class="ref">6.2.5</span></a>, where we needed to convert an email address to lower-case before saving a user to the database.<span class="intersentencespace"></span> In that case, we used a <code>before_save</code> callback combined with the <code>downcase</code> method (<a href="modeling_users_fragment.html#code-email_downcase" class="hyperref">Listing <span class="ref">6.32</span></a>).<span class="intersentencespace"></span> A <code>before_save</code> callback is automatically called before the object is saved, which includes both object creation and updates, but in the case of the activation digest we only want the callback to fire when the user is created.<span class="intersentencespace"></span> This requires a <code>before_create</code> callback, which we’ll define as follows:</p>
<div class="code"><div class="highlight"><pre><span class="n">before_create</span> <span class="ss">:create_activation_digest</span>
</pre></div></div>
<p>This code, called a <em>method reference</em>, arranges for Rails to look for a method called <code>create_activation_digest</code> and run it before creating the user.<span class="intersentencespace"></span> (In <a href="modeling_users_fragment.html#code-email_downcase" class="hyperref">Listing <span class="ref">6.32</span></a>, we passed <code>before_save</code> an explicit block, but the method reference technique is generally preferred.)<span class="intersentencespace"></span> Because the <code>create_activation_digest</code> method itself is only used internally by the User model, there’s no need to expose it to outside users; as we saw in <a href="sign_up_fragment.html#sec-strong_parameters" class="hyperref">Section <span class="ref">7.3.2</span></a>, the Ruby way to accomplish this is to use the <code>private</code> keyword:</p>
<div class="code"><div class="highlight"><pre><span class="kp">private</span>

  <span class="k">def</span> <span class="nf">create_activation_digest</span>
    <span class="c1"># Create the token and digest.</span>
  <span class="k">end</span>
</pre></div></div>
<p>All methods defined in a class after <code>private</code> are automatically hidden, as seen in this console session:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">create_activation_digest</span>
<span class="go">NoMethodError: private method `create_activation_digest' called for #&lt;User&gt;</span>
</pre></div></div>
<p>The purpose of the <code>before_create</code> callback is to assign the token and corresponding digest, which we can accomplish as follows:</p>
<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">activation_token</span>  <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
<span class="nb">self</span><span class="o">.</span><span class="n">activation_digest</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">activation_token</span><span class="p">)</span>
</pre></div></div>
<p>This code simply reuses the token and digest methods used for the remember token, as we can see by comparing it with the <code>remember</code> method from <a href="advanced_login_fragment.html#code-user_model_remember" class="hyperref">Listing <span class="ref">9.3</span></a>:</p>
<div class="code"><div class="highlight"><pre><span class="c1"># Remembers a user in the database for use in persistent sessions.</span>
<span class="k">def</span> <span class="nf">remember</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
  <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_digest</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">remember_token</span><span class="p">))</span>
<span class="k">end</span>
</pre></div></div>
<p>The main difference is the use of <code>update_attribute</code> in the latter case.<span class="intersentencespace"></span> The reason for the difference is that remember tokens and digests are created for users that already exist in the database, whereas the <code>before_create</code> callback happens <em>before</em> the user has been created, so there’s not yet any attribute to update.<span class="intersentencespace"></span> As a result of the callback, when a new user is defined with <code>User.new</code> (as in user signup, <a href="sign_up_fragment.html#code-create_action_strong_parameters" class="hyperref">Listing <span class="ref">7.19</span></a>), it will automatically get both <code>activation_token</code> and <code>activation_digest</code> attributes; because the latter is associated with a column in the database (<a href="account_activation_fragment.html#fig-user_model_account_activation" class="hyperref">Figure <span class="ref">11.1</span></a>), it will be written to the database automatically when the user is saved.</p>
<p>Putting together the discussion above yields the User model shown in <a href="account_activation_fragment.html#code-user_model_activation_code" class="hyperref">Listing <span class="ref">11.3</span></a>.<span class="intersentencespace"></span> As required by the virtual nature of the activation token, we’ve added a second <code>attr_accessor</code> to our model.<span class="intersentencespace"></span> Note that we’ve taken the opportunity to replace the email downcasing callback from <a href="modeling_users_fragment.html#code-email_downcase" class="hyperref">Listing <span class="ref">6.32</span></a> with a method reference.</p>
<div class="codelisting" id="code-user_model_activation_code" data-tralics-id="uid1360" data-number="11.3"><div class="heading"><span class="number">Listing 11.3:</span> 

<span class="description">Adding account activation code to the User model.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="hll">  <span class="kp">attr_accessor</span> <span class="ss">:remember_token</span><span class="p">,</span> <span class="ss">:activation_token</span>
</span><span class="hll">  <span class="n">before_save</span>   <span class="ss">:downcase_email</span>
</span><span class="hll">  <span class="n">before_create</span> <span class="ss">:create_activation_digest</span>
</span>  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="c1"># Converts email to all lower-case.</span>
    <span class="k">def</span> <span class="nf">downcase_email</span>
<span class="hll">      <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span>
</span>    <span class="k">end</span>

    <span class="c1"># Creates and assigns the activation token and digest.</span>
    <span class="k">def</span> <span class="nf">create_activation_digest</span>
<span class="hll">      <span class="nb">self</span><span class="o">.</span><span class="n">activation_token</span>  <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
</span><span class="hll">      <span class="nb">self</span><span class="o">.</span><span class="n">activation_digest</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">activation_token</span><span class="p">)</span>
</span>    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div></div>
<div id="sec-seed_and_fixture_users" data-tralics-id="uid1361" class="subsubsection" data-number="11.1.2.2"><h4><a href="#sec-seed_and_fixture_users" class="heading">Seed and fixture users</a></h4>
<p>Before moving on, we should also update our seed data and fixtures so that our sample and test users are initially activated, as shown in <a href="account_activation_fragment.html#code-seed_users_activated" class="hyperref">Listing <span class="ref">11.4</span></a> and <a href="account_activation_fragment.html#code-fixture_users_activated" class="hyperref">Listing <span class="ref">11.5</span></a>.<span class="intersentencespace"></span> (The <code>Time.zone.now</code> method is a built-in Rails helper that returns the current timestamp, taking into account the time zone on the server.)</p>
<div class="codelisting" id="code-seed_users_activated" data-tralics-id="uid1362" data-number="11.4"><div class="heading"><span class="number">Listing 11.4:</span> 

<span class="description">Activating seed users by default.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">db/seeds.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span>  <span class="s2">"Example User"</span><span class="p">,</span>
             <span class="ss">email</span><span class="p">:</span> <span class="s2">"example@railstutorial.org"</span><span class="p">,</span>
             <span class="ss">password</span><span class="p">:</span>              <span class="s2">"foobar"</span><span class="p">,</span>
             <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span>
             <span class="ss">admin</span><span class="p">:</span>     <span class="kp">true</span><span class="p">,</span>
<span class="hll">             <span class="ss">activated</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
</span><span class="hll">             <span class="ss">activated_at</span><span class="p">:</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span>
<span class="mi">99</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
  <span class="nb">name</span>  <span class="o">=</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Name</span><span class="o">.</span><span class="n">name</span>
  <span class="n">email</span> <span class="o">=</span> <span class="s2">"example-</span><span class="si">#{</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">@railstutorial.org"</span>
  <span class="n">password</span> <span class="o">=</span> <span class="s2">"password"</span>
  <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span>  <span class="nb">name</span><span class="p">,</span>
              <span class="ss">email</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
              <span class="ss">password</span><span class="p">:</span>              <span class="n">password</span><span class="p">,</span>
              <span class="ss">password_confirmation</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
<span class="hll">              <span class="ss">activated</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
</span><span class="hll">              <span class="ss">activated_at</span><span class="p">:</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="code-fixture_users_activated" data-tralics-id="uid1363" data-number="11.5"><div class="heading"><span class="number">Listing 11.5:</span> 

<span class="description">Activating fixture users.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">test/fixtures/users.yml</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="l-Scalar-Plain">michael</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Michael Example</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael@example.com</span>
  <span class="l-Scalar-Plain">password_digest</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= User.digest('password') %&gt;</span>
  <span class="l-Scalar-Plain">admin</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
<span class="hll">  <span class="l-Scalar-Plain">activated</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class="hll">  <span class="l-Scalar-Plain">activated_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= Time.zone.now %&gt;</span>
</span>
<span class="l-Scalar-Plain">archer</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Sterling Archer</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">duchess@example.gov</span>
  <span class="l-Scalar-Plain">password_digest</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= User.digest('password') %&gt;</span>
<span class="hll">  <span class="l-Scalar-Plain">activated</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class="hll">  <span class="l-Scalar-Plain">activated_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= Time.zone.now %&gt;</span>
</span>
<span class="l-Scalar-Plain">lana</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Lana Kane</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">hands@example.gov</span>
  <span class="l-Scalar-Plain">password_digest</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= User.digest('password') %&gt;</span>
<span class="hll">  <span class="l-Scalar-Plain">activated</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class="hll">  <span class="l-Scalar-Plain">activated_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= Time.zone.now %&gt;</span>
</span>
<span class="l-Scalar-Plain">malory</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Malory Archer</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">boss@example.gov</span>
  <span class="l-Scalar-Plain">password_digest</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= User.digest('password') %&gt;</span>
<span class="hll">  <span class="l-Scalar-Plain">activated</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class="hll">  <span class="l-Scalar-Plain">activated_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= Time.zone.now %&gt;</span>
</span>
<span class="l-Scalar-Plain">&lt;% 30.times do |n| %&gt;</span>
<span class="l-Scalar-Plain">user_&lt;%= n %&gt;</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span>  <span class="l-Scalar-Plain">&lt;%= "User</span> <span class="c1">#{n}" %&gt;</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= "user-#{n}@example.com" %&gt;</span>
  <span class="l-Scalar-Plain">password_digest</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= User.digest('password') %&gt;</span>
<span class="hll">  <span class="l-Scalar-Plain">activated</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class="hll">  <span class="l-Scalar-Plain">activated_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= Time.zone.now %&gt;</span>
</span><span class="l-Scalar-Plain">&lt;% end %&gt;</span>
</pre></div></div></div><p>To apply the changes in <a href="account_activation_fragment.html#code-seed_users_activated" class="hyperref">Listing <span class="ref">11.4</span></a>, reset the database to reseed the data as usual:</p>
<div class="code"><div class="highlight"><pre>$ rails db:migrate:reset
$ rails db:seed
</pre></div></div>
</div>
<div id="sec-exercises_account_activation_data_model" data-tralics-id="uid1364" class="subsubsection" data-number="11.1.2.3"><h4><a href="#sec-exercises_account_activation_data_model" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Verify that the test suite is still <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span> after the changes made in this section. <span class="exercise" id="ex-e1cdee"></span>
</li>
<li>By instantiating a User object in the console, confirm that calling the <code>create_activation_digest</code> method raises a <code>NoMethodError</code> due to its being a private method.<span class="intersentencespace"></span> What is the value of the user’s activation digest? <span class="exercise" id="ex-09d340"></span>
</li>
<li>In <a href="modeling_users_fragment.html#code-downcase_bang" class="hyperref">Listing <span class="ref">6.34</span></a>, we saw that email downcasing can be written more simply as <code>email.downcase!</code> (without any assignment).<span class="intersentencespace"></span> Make this change to the <code>downcase_email</code> method in <a href="account_activation_fragment.html#code-user_model_activation_code" class="hyperref">Listing <span class="ref">11.3</span></a> and verify by running the test suite that it works. <span class="exercise" id="ex-ffb351"></span>
</li></ol>
</div></div></div><div id="sec-account_activation_emails" data-tralics-id="cid62" class="section" data-number="11.2"><h2><a href="account_activation_fragment.html#sec-account_activation_emails" class="heading hyperref"><span class="number">11.2 </span>Account activation emails</a></h2>
<p>With the data modeling complete, we’re now ready to add the code needed to send an account activation email.<span class="intersentencespace"></span> The method is to add a User <em>mailer</em> using the Action Mailer library, which we’ll use in the Users controller <code>create</code> action to send an email with an activation link.<span class="intersentencespace"></span> Mailers are structured much like controller actions, with email templates defined as views.<span class="intersentencespace"></span> These templates will include links with the activation token and email address associated with the account to be activated.</p>
<div id="sec-mailer_templates" data-tralics-id="uid1368" class="subsection" data-number="11.2.1"><h3><a href="account_activation_fragment.html#sec-mailer_templates" class="heading hyperref"><span class="number">11.2.1 </span>Mailer templates</a></h3>
<p>As with models and controllers, we can generate a mailer using <code>rails generate</code>, as shown in <a href="account_activation_fragment.html#code-generate_user_mailer" class="hyperref">Listing <span class="ref">11.6</span></a>.</p>
<div class="codelisting" id="code-generate_user_mailer" data-tralics-id="uid1369" data-number="11.6"><div class="heading"><span class="number">Listing 11.6:</span> 

<span class="description">Generating the User mailer.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate mailer UserMailer account_activation password_reset
</pre></div></div></div><p>In addition to the necessary <code>account_activation</code> method, <a href="account_activation_fragment.html#code-generate_user_mailer" class="hyperref">Listing <span class="ref">11.6</span></a> generates the <code>password_reset</code> method we’ll need in <a href="password_reset_fragment.html#cha-password_reset" class="hyperref">Chapter <span class="ref">12</span></a>.</p>
<p>The command in <a href="account_activation_fragment.html#code-generate_user_mailer" class="hyperref">Listing <span class="ref">11.6</span></a> also generates two view templates for each mailer, one for plain-text email and one for HTML email.<span class="intersentencespace"></span> For the account activation mailer method, they appear as in <a href="account_activation_fragment.html#code-generated_account_activation_view_text" class="hyperref">Listing <span class="ref">11.7</span></a> and <a href="account_activation_fragment.html#code-generated_account_activation_view_html" class="hyperref">Listing <span class="ref">11.8</span></a>.<span class="intersentencespace"></span> (We’ll take care of the corresponding password reset templates in <a href="password_reset_fragment.html#cha-password_reset" class="hyperref">Chapter <span class="ref">12</span></a>.)</p>
<div class="codelisting" id="code-generated_account_activation_view_text" data-tralics-id="uid1370" data-number="11.7"><div class="heading"><span class="number">Listing 11.7:</span> 

<span class="description">The generated account activation text view.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/user_mailer/account_activation.text.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre>UserMailer#account_activation

<span class="cp">&lt;%=</span> <span class="vi">@greeting</span> <span class="cp">%&gt;</span>, find me in app/views/user_mailer/account_activation.text.erb
</pre></div></div></div><div class="codelisting" id="code-generated_account_activation_view_html" data-tralics-id="uid1371" data-number="11.8"><div class="heading"><span class="number">Listing 11.8:</span> 

<span class="description">The generated account activation HTML view.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/user_mailer/account_activation.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>UserMailer#account_activation<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;p&gt;</span>
  <span class="cp">&lt;%=</span> <span class="vi">@greeting</span> <span class="cp">%&gt;</span>, find me in app/views/user_mailer/account_activation.html.erb
<span class="nt">&lt;/p&gt;</span>
</pre></div></div></div><p>Let’s take a look at the generated mailers to get a sense of how they work (<a href="account_activation_fragment.html#code-generated_application_mailer" class="hyperref">Listing <span class="ref">11.9</span></a> and <a href="account_activation_fragment.html#code-generated_user_mailer" class="hyperref">Listing <span class="ref">11.10</span></a>).<span class="intersentencespace"></span> We see in <a href="account_activation_fragment.html#code-generated_application_mailer" class="hyperref">Listing <span class="ref">11.9</span></a> that there is a default <code>from</code> address common to all mailers in the application, and each method in <a href="account_activation_fragment.html#code-generated_user_mailer" class="hyperref">Listing <span class="ref">11.10</span></a> has a recipient’s address as well.<span class="intersentencespace"></span> (<a href="account_activation_fragment.html#code-generated_application_mailer" class="hyperref">Listing <span class="ref">11.9</span></a> also uses a mailer layout corresponding to the email format; although it won’t ever matter in this tutorial, the resulting HTML and plain-text mailer layouts can be found in <code>app/views/layouts</code>.)<span class="intersentencespace"></span> The generated code also includes an instance variable (<code>@greeting</code>), which is available in the mailer views in much the same way that instance variables in controllers are available in ordinary views.</p>
<div class="codelisting" id="code-generated_application_mailer" data-tralics-id="uid1372" data-number="11.9"><div class="heading"><span class="number">Listing 11.9:</span> 

<span class="description">The generated application mailer.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/mailers/application_mailer.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ApplicationMailer</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">default</span> <span class="ss">from</span><span class="p">:</span> <span class="s2">"from@example.com"</span>
  <span class="n">layout</span> <span class="s1">'mailer'</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="code-generated_user_mailer" data-tralics-id="uid1373" data-number="11.10"><div class="heading"><span class="number">Listing 11.10:</span> 

<span class="description">The generated User mailer.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/mailers/user_mailer.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UserMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>

  <span class="c1"># Subject can be set in your I18n file at config/locales/en.yml</span>
  <span class="c1"># with the following lookup:</span>
  <span class="c1">#</span>
  <span class="c1">#   en.user_mailer.account_activation.subject</span>
  <span class="c1">#</span>
  <span class="k">def</span> <span class="nf">account_activation</span>
<span class="hll">    <span class="vi">@greeting</span> <span class="o">=</span> <span class="s2">"Hi"</span>
</span>
<span class="hll">    <span class="n">mail</span> <span class="ss">to</span><span class="p">:</span> <span class="s2">"to@example.org"</span>
</span>  <span class="k">end</span>

  <span class="c1"># Subject can be set in your I18n file at config/locales/en.yml</span>
  <span class="c1"># with the following lookup:</span>
  <span class="c1">#</span>
  <span class="c1">#   en.user_mailer.password_reset.subject</span>
  <span class="c1">#</span>
  <span class="k">def</span> <span class="nf">password_reset</span>
<span class="hll">    <span class="vi">@greeting</span> <span class="o">=</span> <span class="s2">"Hi"</span>
</span>
<span class="hll">    <span class="n">mail</span> <span class="ss">to</span><span class="p">:</span> <span class="s2">"to@example.org"</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>To make a working activation email, we’ll first customize the generated template as shown in <a href="account_activation_fragment.html#code-application_mailer" class="hyperref">Listing <span class="ref">11.11</span></a>.<span class="intersentencespace"></span> Next, we’ll create an instance variable containing the user (for use in the view), and then mail the result to <code>user.email</code> (<a href="account_activation_fragment.html#code-mail_account_activation" class="hyperref">Listing <span class="ref">11.12</span></a>).<span class="intersentencespace"></span> As seen in <a href="account_activation_fragment.html#code-mail_account_activation" class="hyperref">Listing <span class="ref">11.12</span></a>, the <code>mail</code> method also takes a <code>subject</code> key, whose value is used as the email’s subject line.</p>
<div class="codelisting" id="code-application_mailer" data-tralics-id="uid1374" data-number="11.11"><div class="heading"><span class="number">Listing 11.11:</span> 

<span class="description">The application mailer with a new default <code>from</code> address.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/mailers/application_mailer.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ApplicationMailer</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
<span class="hll">  <span class="n">default</span> <span class="ss">from</span><span class="p">:</span> <span class="s2">"noreply@example.com"</span>
</span>  <span class="n">layout</span> <span class="s1">'mailer'</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="code-mail_account_activation" data-tralics-id="uid1375" data-number="11.12"><div class="heading"><span class="number">Listing 11.12:</span> 

<span class="description">Mailing the account activation link.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/mailers/user_mailer.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UserMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>

<span class="hll">  <span class="k">def</span> <span class="nf">account_activation</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class="hll">    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
</span><span class="hll">    <span class="n">mail</span> <span class="ss">to</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="ss">subject</span><span class="p">:</span> <span class="s2">"Account activation"</span>
</span><span class="hll">  <span class="k">end</span>
</span>
  <span class="k">def</span> <span class="nf">password_reset</span>
    <span class="vi">@greeting</span> <span class="o">=</span> <span class="s2">"Hi"</span>

    <span class="n">mail</span> <span class="ss">to</span><span class="p">:</span> <span class="s2">"to@example.org"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>As with ordinary views, we can use embedded Ruby to customize the template views, in this case greeting the user by name and including a link to a custom activation link.<span class="intersentencespace"></span> Our plan is to find the user by email address and then authenticate the activation token, so the link needs to include both the email and the token.<span class="intersentencespace"></span> Because we’re modeling activations using an Account Activations resource, the token itself can appear as the argument of the named route defined in <a href="account_activation_fragment.html#code-account_activations_route" class="hyperref">Listing <span class="ref">11.1</span></a>:</p>
<div class="code"><div class="highlight"><pre><span class="n">edit_account_activation_url</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">activation_token</span><span class="p">,</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div></div>
<p>Recalling that</p>
<div class="code"><div class="highlight"><pre><span class="n">edit_user_url</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div></div>
<p>produces a URL of the form</p>
<div class="code"><div class="highlight"><pre>http://www.example.com/users/1/edit
</pre></div></div>
<p>the corresponding account activation link’s base URL will look like this:</p>
<div class="code"><div class="highlight"><pre>http://www.example.com/account_activations/q5lt38hQDc_959PVoo6b7A/edit
</pre></div></div>
<p>Here <code>q5lt38hQDc_959PVoo6b7A</code> is a URL-safe base64 string generated by the <code>new_token</code> method (<a href="advanced_login_fragment.html#code-token_method" class="hyperref">Listing <span class="ref">9.2</span></a>), and it plays the same role as the user id in /users/1/edit.<span class="intersentencespace"></span> In particular, in the Activations controller <code>edit</code> action, the token will be available in the <code>params</code> hash as <code>params[:id]</code>.</p>
<p>In order to include the email as well, we need to use a <em>query parameter</em>, which in a URL appears as a key-value pair located after a question mark:<sup id="cha-11_footnote-ref-5" class="footnote"><a href="#cha-11_footnote-5">5</a></sup></p>
<div class="code"><div class="highlight"><pre>account_activations/q5lt38hQDc_959PVoo6b7A/edit?email=foo%40example.com
</pre></div></div>
<p>Notice that the ‘@’ in the email address appears as <code>%40</code>, i.e., it’s “escaped out” to guarantee a valid URL.<span class="intersentencespace"></span> The way to set a query parameter in Rails is to include a hash in the named route:</p>
<div class="code"><div class="highlight"><pre><span class="n">edit_account_activation_url</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">activation_token</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
</pre></div></div>
<p>When using named routes in this way to define query parameters, Rails automatically escapes out any special characters.<span class="intersentencespace"></span> The resulting email address will also be unescaped automatically in the controller, and will be available via <code>params[:email]</code>.</p>
<p>With the <code>@user</code> instance variable as defined in <a href="account_activation_fragment.html#code-mail_account_activation" class="hyperref">Listing <span class="ref">11.12</span></a>, we can create the necessary links using the named edit route and embedded Ruby, as shown in <a href="account_activation_fragment.html#code-account_activation_view_text" class="hyperref">Listing <span class="ref">11.13</span></a> and <a href="account_activation_fragment.html#code-account_activation_view_html" class="hyperref">Listing <span class="ref">11.14</span></a>.<span class="intersentencespace"></span> Note that the HTML template in <a href="account_activation_fragment.html#code-account_activation_view_html" class="hyperref">Listing <span class="ref">11.14</span></a> uses the <code>link_to</code> method to construct a valid link.</p>
<div class="codelisting" id="code-account_activation_view_text" data-tralics-id="uid1377" data-number="11.13"><div class="heading"><span class="number">Listing 11.13:</span> 

<span class="description">The account activation text view.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/user_mailer/account_activation.text.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre>Hi <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>,

Welcome to the Sample App! Click on the link below to activate your account:

<span class="cp">&lt;%=</span> <span class="n">edit_account_activation_url</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">activation_token</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div></div></div><div class="codelisting" id="code-account_activation_view_html" data-tralics-id="uid1378" data-number="11.14"><div class="heading"><span class="number">Listing 11.14:</span> 

<span class="description">The account activation HTML view.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/user_mailer/account_activation.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;p&gt;</span>Hi <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>,<span class="nt">&lt;/p&gt;</span>

<span class="nt">&lt;p&gt;</span>
Welcome to the Sample App! Click on the link below to activate your account:
<span class="nt">&lt;/p&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Activate"</span><span class="p">,</span> <span class="n">edit_account_activation_url</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">activation_token</span><span class="p">,</span>
                                                    <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div></div></div>
<div id="sec-exercises_mailer_templates" data-tralics-id="uid1379" class="subsubsection" data-number="11.2.1.1"><h4><a href="#sec-exercises_mailer_templates" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>At the console, verify that the <code>escape</code> method in the <code>CGI</code> module escapes out the email address as shown in <a href="account_activation_fragment.html#code-cgi_escape" class="hyperref">Listing <span class="ref">11.15</span></a>.<span class="intersentencespace"></span> What is the escaped value of the string <code>"Don’t panic!"</code>? <span class="exercise" id="ex-bb787b"></span>
</li></ol>
<div class="codelisting" id="code-cgi_escape" data-tralics-id="uid1381" data-number="11.15"><div class="heading"><span class="number">Listing 11.15:</span> 

<span class="description">Escaping an email with <code>CGI.escape</code>.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">CGI</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="s1">'foo@example.com'</span><span class="p">)</span>
<span class="go">=&gt; "foo%40example.com"</span>
</pre></div></div></div></div></div>
<div id="sec-email_previews" data-tralics-id="uid1382" class="subsection" data-number="11.2.2"><h3><a href="account_activation_fragment.html#sec-email_previews" class="heading hyperref"><span class="number">11.2.2 </span>Email previews</a></h3>
<p>To see the results of the templates defined in <a href="account_activation_fragment.html#code-account_activation_view_text" class="hyperref">Listing <span class="ref">11.13</span></a> and <a href="account_activation_fragment.html#code-account_activation_view_html" class="hyperref">Listing <span class="ref">11.14</span></a>, we can use <em>email previews</em>, which are special URLs exposed by Rails to let us see what our email messages look like.<span class="intersentencespace"></span> First, we need to add some configuration to our application’s development environment, as shown in <a href="account_activation_fragment.html#code-development_email_settings" class="hyperref">Listing <span class="ref">11.16</span></a>.</p>
<div class="codelisting" id="code-development_email_settings" data-tralics-id="uid1383" data-number="11.16"><div class="heading"><span class="number">Listing 11.16:</span> 

<span class="description">Email settings in development.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">config/environments/development.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">raise_delivery_errors</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">delivery_method</span> <span class="o">=</span> <span class="ss">:test</span>
  <span class="n">host</span> <span class="o">=</span> <span class="s1">'example.com'</span> <span class="c1"># Don't use this literally; use your local dev host instead</span>
  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">default_url_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">host</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="ss">protocol</span><span class="p">:</span> <span class="s1">'https'</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p><a href="account_activation_fragment.html#code-development_email_settings" class="hyperref">Listing <span class="ref">11.16</span></a> uses a host name of <code>’example.com’</code>, but as indicated in the comment you should use the actual host of your development environment.<span class="intersentencespace"></span> For example, on my system either of the following works (depending on whether I’m using the cloud IDE or the local server):</p>
<div class="code"><div class="highlight"><pre><span class="n">host</span> <span class="o">=</span> <span class="s1">'rails-tutorial-mhartl.c9users.io'</span>     <span class="c1"># Cloud IDE</span>
<span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">default_url_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">host</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="ss">protocol</span><span class="p">:</span> <span class="s1">'https'</span> <span class="p">}</span>
</pre></div></div>
<p>or</p>
<div class="code"><div class="highlight"><pre><span class="n">host</span> <span class="o">=</span> <span class="s1">'localhost:3000'</span>                     <span class="c1"># Local server</span>
<span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">default_url_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">host</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="ss">protocol</span><span class="p">:</span> <span class="s1">'http'</span> <span class="p">}</span>
</pre></div></div>
<p>After restarting the development server to activate the configuration in <a href="account_activation_fragment.html#code-development_email_settings" class="hyperref">Listing <span class="ref">11.16</span></a>, we next need to update the User mailer <em>preview file</em>, which was automatically generated in <a href="account_activation_fragment.html#sec-account_activation_emails" class="hyperref">Section <span class="ref">11.2</span></a>, as shown in <a href="account_activation_fragment.html#code-generated_user_mailer_previews" class="hyperref">Listing <span class="ref">11.17</span></a>.</p>
<div class="codelisting" id="code-generated_user_mailer_previews" data-tralics-id="uid1384" data-number="11.17"><div class="heading"><span class="number">Listing 11.17:</span> 

<span class="description">The generated User mailer previews.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">test/mailers/previews/user_mailer_preview.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="c1"># Preview all emails at http://localhost:3000/rails/mailers/user_mailer</span>
<span class="k">class</span> <span class="nc">UserMailerPreview</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Preview</span>

  <span class="c1"># Preview this email at</span>
  <span class="c1"># http://localhost:3000/rails/mailers/user_mailer/account_activation</span>
  <span class="k">def</span> <span class="nf">account_activation</span>
    <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span>
  <span class="k">end</span>

  <span class="c1"># Preview this email at</span>
  <span class="c1"># http://localhost:3000/rails/mailers/user_mailer/password_reset</span>
  <span class="k">def</span> <span class="nf">password_reset</span>
    <span class="no">UserMailer</span><span class="o">.</span><span class="n">password_reset</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div><p>Because the <code>account_activation</code> method defined in <a href="account_activation_fragment.html#code-mail_account_activation" class="hyperref">Listing <span class="ref">11.12</span></a> requires a valid user object as an argument, the code in <a href="account_activation_fragment.html#code-generated_user_mailer_previews" class="hyperref">Listing <span class="ref">11.17</span></a> won’t work as written.<span class="intersentencespace"></span> To fix it, we define a <code>user</code> variable equal to the first user in the development database, and then pass it as an argument to <code>UserMailer.account_activation</code> (<a href="account_activation_fragment.html#code-account_activation_preview" class="hyperref">Listing <span class="ref">11.18</span></a>).<span class="intersentencespace"></span> Note that <a href="account_activation_fragment.html#code-account_activation_preview" class="hyperref">Listing <span class="ref">11.18</span></a> also assigns a value to <code>user.activation_token</code>, which is necessary because the account activation templates in <a href="account_activation_fragment.html#code-account_activation_view_text" class="hyperref">Listing <span class="ref">11.13</span></a> and <a href="account_activation_fragment.html#code-account_activation_view_html" class="hyperref">Listing <span class="ref">11.14</span></a> need an account activation token.<span class="intersentencespace"></span> (Because <code>activation_token</code> is a virtual attribute (<a href="account_activation_fragment.html#sec-account_activations_resource" class="hyperref">Section <span class="ref">11.1</span></a>), the user from the database doesn’t have one.)</p>
<div class="codelisting" id="code-account_activation_preview" data-tralics-id="uid1385" data-number="11.18"><div class="heading"><span class="number">Listing 11.18:</span> 

<span class="description">A working preview method for account activation.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">test/mailers/previews/user_mailer_preview.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="c1"># Preview all emails at http://localhost:3000/rails/mailers/user_mailer</span>
<span class="k">class</span> <span class="nc">UserMailerPreview</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Preview</span>

  <span class="c1"># Preview this email at</span>
  <span class="c1"># http://localhost:3000/rails/mailers/user_mailer/account_activation</span>
  <span class="k">def</span> <span class="nf">account_activation</span>
<span class="hll">    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
</span><span class="hll">    <span class="n">user</span><span class="o">.</span><span class="n">activation_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
</span><span class="hll">    <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="c1"># Preview this email at</span>
  <span class="c1"># http://localhost:3000/rails/mailers/user_mailer/password_reset</span>
  <span class="k">def</span> <span class="nf">password_reset</span>
    <span class="no">UserMailer</span><span class="o">.</span><span class="n">password_reset</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>With the preview code as in <a href="account_activation_fragment.html#code-account_activation_preview" class="hyperref">Listing <span class="ref">11.18</span></a>, we can visit the suggested URLs to preview the account activation emails.<span class="intersentencespace"></span> (If you are using the cloud IDE, you should replace <code>localhost:3000</code> with the corresponding base URL.)<span class="intersentencespace"></span> The resulting HTML and text emails appear as in <a href="account_activation_fragment.html#fig-account_activation_html_preview" class="hyperref">Figure <span class="ref">11.2</span></a> and <a href="account_activation_fragment.html#fig-account_activation_text_preview" class="hyperref">Figure <span class="ref">11.3</span></a>.</p>
<div class="center figure" id="fig-account_activation_html_preview" data-tralics-id="uid1386" data-number="11.2">
<div class="graphics image"><img src="images/figures/account_activation_html_preview_4th_ed.png" alt="images/figures/account_activation_html_preview_4th_ed"></div><div class="caption"><span class="header">Figure 11.2: </span><span class="description">A preview of the HTML version of the account activation email.
</span></div></div>
<div class="center figure" id="fig-account_activation_text_preview" data-tralics-id="uid1387" data-number="11.3">
<div class="graphics image"><img src="images/figures/account_activation_text_preview_4th_ed.png" alt="images/figures/account_activation_text_preview_4th_ed"></div><div class="caption"><span class="header">Figure 11.3: </span><span class="description">A preview of the text version the account activation email.
</span></div></div>
<div id="sec-exercises_email_previews" data-tralics-id="uid1388" class="subsubsection" data-number="11.2.2.1"><h4><a href="#sec-exercises_email_previews" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Preview the email templates in your browser.<span class="intersentencespace"></span> What do the Date fields read for your previews? <span class="exercise" id="ex-be4a4e"></span>
</li></ol>
</div></div>
<div id="sec-email_tests" data-tralics-id="uid1390" class="subsection" data-number="11.2.3"><h3><a href="account_activation_fragment.html#sec-email_tests" class="heading hyperref"><span class="number">11.2.3 </span>Email tests</a></h3>
<p>As a final step, we’ll write a couple of tests to double-check the results shown in the email previews.<span class="intersentencespace"></span> This isn’t as hard as it sounds, because Rails has generated useful example tests for us (<a href="account_activation_fragment.html#code-generated_user_mailer_test" class="hyperref">Listing <span class="ref">11.19</span></a>).</p>
<div class="codelisting" id="code-generated_user_mailer_test" data-tralics-id="uid1391" data-number="11.19"><div class="heading"><span class="number">Listing 11.19:</span> 

<span class="description">The User mailer test generated by Rails.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">test/mailers/user_mailer_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserMailerTest</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="nb">test</span> <span class="s2">"account_activation"</span> <span class="k">do</span>
    <span class="n">mail</span> <span class="o">=</span> <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span>
    <span class="n">assert_equal</span> <span class="s2">"Account activation"</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">subject</span>
    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">"to@example.org"</span><span class="o">]</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">to</span>
    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">"from@example.com"</span><span class="o">]</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">from</span>
    <span class="n">assert_match</span> <span class="s2">"Hi"</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"password_reset"</span> <span class="k">do</span>
    <span class="n">mail</span> <span class="o">=</span> <span class="no">UserMailer</span><span class="o">.</span><span class="n">password_reset</span>
    <span class="n">assert_equal</span> <span class="s2">"Password reset"</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">subject</span>
    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">"to@example.org"</span><span class="o">]</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">to</span>
    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">"from@example.com"</span><span class="o">]</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">from</span>
    <span class="n">assert_match</span> <span class="s2">"Hi"</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The tests in <a href="account_activation_fragment.html#code-generated_user_mailer_test" class="hyperref">Listing <span class="ref">11.19</span></a> use the powerful <code>assert_match</code> method, which can be used either with a string or a regular expression:</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_match</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'foobar'</span>      <span class="c1"># true</span>
<span class="n">assert_match</span> <span class="s1">'baz'</span><span class="p">,</span> <span class="s1">'foobar'</span>      <span class="c1"># false</span>
<span class="n">assert_match</span> <span class="sr">/\w+/</span><span class="p">,</span> <span class="s1">'foobar'</span>      <span class="c1"># true</span>
<span class="n">assert_match</span> <span class="sr">/\w+/</span><span class="p">,</span> <span class="s1">'$#!*+@'</span>      <span class="c1"># false</span>
</pre></div></div>
<p>The test in <a href="account_activation_fragment.html#code-real_account_activation_test" class="hyperref">Listing <span class="ref">11.20</span></a> uses <code>assert_match</code> to check that the name, activation token, and escaped email appear in the email’s body.<span class="intersentencespace"></span> For the last of these, note the use of</p>
<div class="code"><div class="highlight"><pre><span class="no">CGI</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
</pre></div></div>
<p>to escape the test user’s email, which we met briefly in <a href="account_activation_fragment.html#sec-exercises_mailer_templates" class="hyperref">Section <span class="ref">11.2.1.1</span></a>.<sup id="cha-11_footnote-ref-6" class="footnote"><a href="#cha-11_footnote-6">6</a></sup></p>
<div class="codelisting" id="code-real_account_activation_test" data-tralics-id="uid1393" data-number="11.20"><div class="heading"><span class="number">Listing 11.20:</span> 

<span class="description">A test of the current email implementation.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/mailers/user_mailer_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserMailerTest</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="nb">test</span> <span class="s2">"account_activation"</span> <span class="k">do</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="n">user</span><span class="o">.</span><span class="n">activation_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
    <span class="n">mail</span> <span class="o">=</span> <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="s2">"Account activation"</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">subject</span>
    <span class="n">assert_equal</span> <span class="o">[</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">]</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">to</span>
    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">"noreply@example.com"</span><span class="o">]</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">from</span>
    <span class="n">assert_match</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>               <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span>
    <span class="n">assert_match</span> <span class="n">user</span><span class="o">.</span><span class="n">activation_token</span><span class="p">,</span>   <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span>
    <span class="n">assert_match</span> <span class="no">CGI</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">),</span>  <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that <a href="account_activation_fragment.html#code-real_account_activation_test" class="hyperref">Listing <span class="ref">11.20</span></a> takes care to add an activation token to the fixture user, which would otherwise be blank.<span class="intersentencespace"></span> (<a href="account_activation_fragment.html#code-real_account_activation_test" class="hyperref">Listing <span class="ref">11.20</span></a> also removes the generated password reset test, which we’ll add back (in modified form) in <a href="password_reset_fragment.html#sec-reset_email_tests" class="hyperref">Section <span class="ref">12.2.2</span></a>.)</p>
<p>To get the test in <a href="account_activation_fragment.html#code-real_account_activation_test" class="hyperref">Listing <span class="ref">11.20</span></a> to pass, we have to configure our test file with the proper domain host, as shown in <a href="account_activation_fragment.html#code-test_domain_host" class="hyperref">Listing <span class="ref">11.21</span></a>.</p>
<div class="codelisting" id="code-test_domain_host" data-tralics-id="uid1394" data-number="11.21"><div class="heading"><span class="number">Listing 11.21:</span> 

<span class="description">Setting the test domain host.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">config/environments/test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">delivery_method</span> <span class="o">=</span> <span class="ss">:test</span>
<span class="hll">  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">default_url_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">host</span><span class="p">:</span> <span class="s1">'example.com'</span> <span class="p">}</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>With the code as above, the mailer test should be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid1395" data-tralics-id="uid1395" data-number="11.22"><div class="heading"><span class="number">Listing 11.22:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test:mailers
</pre></div></div></div>
<div id="sec-exercises_email_tests" data-tralics-id="uid1396" class="subsubsection" data-number="11.2.3.1"><h4><a href="#sec-exercises_email_tests" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Verify that the full test suite is still <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>. <span class="exercise" id="ex-b429e6"></span>
</li>
<li>Confirm that the test goes <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span> if you remove the call to <code>CGI.escape</code> in <a href="account_activation_fragment.html#code-real_account_activation_test" class="hyperref">Listing <span class="ref">11.20</span></a>. <span class="exercise" id="ex-9ed121"></span>
</li></ol>
</div></div>
<div id="sec-updating_create" data-tralics-id="uid1399" class="subsection" data-number="11.2.4"><h3><a href="account_activation_fragment.html#sec-updating_create" class="heading hyperref"><span class="number">11.2.4 </span>Updating the Users <code class="tt">create</code> action</a></h3>
<p>To use the mailer in our application, we just need to add a couple of lines to the <code>create</code> action used to sign users up, as shown in <a href="account_activation_fragment.html#code-user_signup_with_account_activation" class="hyperref">Listing <span class="ref">11.23</span></a>.<span class="intersentencespace"></span> Note that <a href="account_activation_fragment.html#code-user_signup_with_account_activation" class="hyperref">Listing <span class="ref">11.23</span></a> has changed the redirect behavior upon signing up.<span class="intersentencespace"></span> Before, we redirected to the user’s profile page (<a href="sign_up_fragment.html#sec-successful_signups" class="hyperref">Section <span class="ref">7.4</span></a>), but that doesn’t make sense now that we’re requiring account activation.<span class="intersentencespace"></span> Instead, we now redirect to the root URL.</p>
<div class="codelisting" id="code-user_signup_with_account_activation" data-tralics-id="uid1400" data-number="11.23"><div class="heading"><span class="number">Listing 11.23:</span> 

<span class="description">Adding account activation to user signup.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
<span class="hll">      <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span><span class="o">.</span><span class="n">deliver_now</span>
</span><span class="hll">      <span class="n">flash</span><span class="o">[</span><span class="ss">:info</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Please check your email to activate your account."</span>
</span><span class="hll">      <span class="n">redirect_to</span> <span class="n">root_url</span>
</span>    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Because <a href="account_activation_fragment.html#code-user_signup_with_account_activation" class="hyperref">Listing <span class="ref">11.23</span></a> redirects to the root URL instead of to the profile page and doesn’t log the user in as before, the test suite is currently <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>, even though the application is working as designed.<span class="intersentencespace"></span> We’ll fix this by temporarily commenting out the failing lines, as shown in <a href="account_activation_fragment.html#code-comment_out_failing_tests" class="hyperref">Listing <span class="ref">11.24</span></a>.<span class="intersentencespace"></span> We’ll uncomment these lines and write passing tests for account activation in <a href="account_activation_fragment.html#sec-activation_test_and_refactoring" class="hyperref">Section <span class="ref">11.3.3</span></a>.</p>
<div class="codelisting" id="code-comment_out_failing_tests" data-tralics-id="uid1401" data-number="11.24"><div class="heading"><span class="number">Listing 11.24:</span> 

<span class="description">Temporarily commenting out failing tests.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_signup_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersSignupTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="nb">test</span> <span class="s2">"invalid signup information"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">signup_path</span>
    <span class="n">assert_no_difference</span> <span class="s1">'User.count'</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">users_path</span><span class="p">,</span> <span class="ss">params</span><span class="p">:</span> <span class="p">{</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span>  <span class="s2">""</span><span class="p">,</span>
                                         <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@invalid"</span><span class="p">,</span>
                                         <span class="ss">password</span><span class="p">:</span>              <span class="s2">"foo"</span><span class="p">,</span>
                                         <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"bar"</span> <span class="p">}</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="n">assert_template</span> <span class="s1">'users/new'</span>
    <span class="n">assert_select</span> <span class="s1">'div#error_explanation'</span>
    <span class="n">assert_select</span> <span class="s1">'div.field_with_errors'</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"valid signup information"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">signup_path</span>
    <span class="n">assert_difference</span> <span class="s1">'User.count'</span><span class="p">,</span> <span class="mi">1</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">users_path</span><span class="p">,</span> <span class="ss">params</span><span class="p">:</span> <span class="p">{</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span>  <span class="s2">"Example User"</span><span class="p">,</span>
                                         <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                                         <span class="ss">password</span><span class="p">:</span>              <span class="s2">"password"</span><span class="p">,</span>
                                         <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"password"</span> <span class="p">}</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="n">follow_redirect!</span>
<span class="hll">    <span class="c1"># assert_template 'users/show'</span>
</span><span class="hll">    <span class="c1"># assert is_logged_in?</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>If you now try signing up as a new user, you should be redirected as shown in <a href="account_activation_fragment.html#fig-redirected_not_activated" class="hyperref">Figure <span class="ref">11.4</span></a>, and an email like the one shown in <a href="account_activation_fragment.html#code-account_activation_email" class="hyperref">Listing <span class="ref">11.25</span></a> should be generated.<span class="intersentencespace"></span> Note that you will <em>not</em> receive an actual email in a development environment, but it will show up in your server logs.<span class="intersentencespace"></span> (You may have to scroll up a bit to see it.)<span class="intersentencespace"></span> <a href="account_activation_fragment.html#sec-activation_email_in_production" class="hyperref">Section <span class="ref">11.4</span></a> discusses how to send email for real in a production environment.</p>
<div class="codelisting" id="code-account_activation_email" data-tralics-id="uid1402" data-number="11.25"><div class="heading"><span class="number">Listing 11.25:</span> 

<span class="description">A sample account activation email from the server log.</span>
</div>

<div class="code"><div class="highlight"><pre>UserMailer#account_activation: processed outbound mail in 292.4ms
Sent mail to michael@michaelhartl.com (47.3ms)
Date: Mon, 06 Jun 2016 20:17:41 +0000
From: noreply@example.com
To: michael@michaelhartl.com
Message-ID: &lt;5755da6518cb4_f2c9222494c7178e@mhartl-rails-tutorial-3045526.mail&gt;
Subject: Account activation
Mime-Version: 1.0
Content-Type: multipart/alternative;
 boundary="--==_mimepart_5755da6513e89_f2c9222494c71639";
 charset=UTF-8
Content-Transfer-Encoding: 7bit


----==_mimepart_5755da6513e89_f2c9222494c71639
Content-Type: text/plain;
 charset=UTF-8
Content-Transfer-Encoding: 7bit

Hi Michael Hartl,

Welcome to the Sample App! Click on the link below to activate your account:

https://rails-tutorial-mhartl.c9users.io/account_activations/
-L9kBsbIjmrqpJGB0TUKcA/edit?email=michael%40michaelhartl.com

----==_mimepart_5755da6513e89_f2c9222494c71639
Content-Type: text/html;
 charset=UTF-8
Content-Transfer-Encoding: 7bit

&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8" /&gt;
    &lt;style&gt;
      /* Email styles need to be inline */
    &lt;/style&gt;
  &lt;/head&gt;

  &lt;body&gt;
    &lt;h1&gt;Sample App&lt;/h1&gt;

&lt;p&gt;Hi Michael Hartl,&lt;/p&gt;

&lt;p&gt;
Welcome to the Sample App! Click on the link below to activate your account:
&lt;/p&gt;

&lt;a href="https://rails-tutorial-mhartl.c9users.io/account_activations/
-L9kBsbIjmrqpJGB0TUKcA/edit?email=michael%40michaelhartl.com"&gt;Activate&lt;/a&gt;
  &lt;/body&gt;
&lt;/html&gt;

----==_mimepart_5755da6513e89_f2c9222494c71639--
</pre></div></div></div><div class="center figure" id="fig-redirected_not_activated" data-tralics-id="uid1403" data-number="11.4">
<div class="graphics image"><img src="images/figures/redirected_not_activated.png" alt="images/figures/redirected_not_activated"></div><div class="caption"><span class="header">Figure 11.4: </span><span class="description">The Home page with an activation message after signup.
</span></div></div>
<div id="sec-exercises_updating_create" data-tralics-id="uid1404" class="subsubsection" data-number="11.2.4.1"><h4><a href="#sec-exercises_updating_create" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Sign up as a new user and verify that you’re properly redirected.<span class="intersentencespace"></span> What is the content of the generated email in the server log?<span class="intersentencespace"></span> What is the value of the activation token? <span class="exercise" id="ex-f1397e"></span>
</li>
<li>Verify at the console that the new user has been created but that it is not yet activated. <span class="exercise" id="ex-0e32b6"></span>
</li></ol>
</div></div></div><div id="sec-activating_the_account" data-tralics-id="cid63" class="section" data-number="11.3"><h2><a href="account_activation_fragment.html#sec-activating_the_account" class="heading hyperref"><span class="number">11.3 </span>Activating the account</a></h2>
<p>Now that we have a correctly generated email as in <a href="account_activation_fragment.html#code-account_activation_email" class="hyperref">Listing <span class="ref">11.25</span></a>, we need to write the <code>edit</code> action in the Account Activations controller that actually activates the user.<span class="intersentencespace"></span> As usual, we’ll write a test for this action, and once the code is tested we’ll refactor it to move some functionality out of the Account Activations controller and into the User model.</p>
<div id="sec-generalizing_the_authenticated_method" data-tralics-id="uid1407" class="subsection" data-number="11.3.1"><h3><a href="account_activation_fragment.html#sec-generalizing_the_authenticated_method" class="heading hyperref"><span class="number">11.3.1 </span>Generalizing the <code class="tt">authenticated?</code> method</a></h3>
<p>Recall from the discussion in <a href="account_activation_fragment.html#sec-mailer_templates" class="hyperref">Section <span class="ref">11.2.1</span></a> that the activation token and email are available as <code>params[:id]</code> and <code>params[:email]</code>, respectively.<span class="intersentencespace"></span> Following the model of passwords (<a href="basic_login_fragment.html#code-find_authenticate_user" class="hyperref">Listing <span class="ref">8.7</span></a>) and remember tokens (<a href="advanced_login_fragment.html#code-persistent_current_user" class="hyperref">Listing <span class="ref">9.9</span></a>), we plan to find and authenticate the user with code something like this:</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">)</span>
<span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:activation</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>(As we’ll see in a moment, there will be one extra boolean in the expression above.<span class="intersentencespace"></span> See if you can guess what it will be.)</p>
<p>The above code uses the <code>authenticated?</code> method to test if the account activation digest matches the given token, but at present this won’t work because that method is specialized to the remember token (<a href="advanced_login_fragment.html#code-authenticated_p" class="hyperref">Listing <span class="ref">9.6</span></a>):</p>
<div class="code"><div class="highlight"><pre><span class="c1"># Returns true if the given token matches the digest.</span>
<span class="k">def</span> <span class="nf">authenticated?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
  <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">remember_digest</span><span class="o">.</span><span class="n">nil?</span>
  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">remember_digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p>Here <code>remember_digest</code> is an attribute on the User model, and inside the model we can rewrite it as follows:</p>
<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">remember_digest</span>
</pre></div></div>
<p>Somehow, we want to be able to make this <em>variable</em>, so we can call</p>
<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">activation_token</span>
</pre></div></div>
<p>instead by passing in the appropriate parameter to the <code>authenticated?</code> method.</p>
<p>The solution involves our first example of <em>metaprogramming</em>, which is essentially a program that writes a program.<span class="intersentencespace"></span> (Metaprogramming is one of Ruby’s strongest suits, and many of the “magic” features of Rails are due to its use of Ruby metaprogramming.)<span class="intersentencespace"></span> The key in this case is the powerful <code>send</code> method, which lets us call a method with a name of our choice by “sending a message” to a given object.<span class="intersentencespace"></span> For example, in this console session we use <code>send</code> on a native Ruby object to find the length of an array:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">length</span>
<span class="go">=&gt; 3</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:length</span><span class="p">)</span>
<span class="go">=&gt; 3</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">"length"</span><span class="p">)</span>
<span class="go">=&gt; 3</span>
</pre></div></div>
<p>Here we see that passing the symbol <code>:length</code> or string <code>"length"</code> to <code>send</code> is equivalent to calling the <code>length</code> method on the given object.<span class="intersentencespace"></span> As a second example, we’ll access the <code>activation_digest</code> attribute of the first user in the database:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">activation_digest</span>
<span class="go">=&gt; "$2a$10$4e6TFzEJAVNyjLv8Q5u22ensMt28qEkx0roaZvtRcp6UZKRM6N9Ae"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:activation_digest</span><span class="p">)</span>
<span class="go">=&gt; "$2a$10$4e6TFzEJAVNyjLv8Q5u22ensMt28qEkx0roaZvtRcp6UZKRM6N9Ae"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">"activation_digest"</span><span class="p">)</span>
<span class="go">=&gt; "$2a$10$4e6TFzEJAVNyjLv8Q5u22ensMt28qEkx0roaZvtRcp6UZKRM6N9Ae"</span>
<span class="hll"><span class="gp">&gt;&gt; </span><span class="n">attribute</span> <span class="o">=</span> <span class="ss">:activation</span>
</span><span class="hll"><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">attribute</span><span class="si">}</span><span class="s2">_digest"</span><span class="p">)</span>
</span><span class="hll"><span class="go">=&gt; "$2a$10$4e6TFzEJAVNyjLv8Q5u22ensMt28qEkx0roaZvtRcp6UZKRM6N9Ae"</span>
</span></pre></div></div>
<p>Note in the last example that we’ve defined an <code>attribute</code> variable equal to the symbol <code>:activation</code> and used string interpolation to build up the proper argument to <code>send</code>.<span class="intersentencespace"></span> This would work also with the string <code>’activation’</code>, but using a symbol is more conventional, and in either case</p>
<div class="code"><div class="highlight"><pre><span class="s2">"</span><span class="si">#{</span><span class="n">attribute</span><span class="si">}</span><span class="s2">_digest"</span>
</pre></div></div>
<p>becomes</p>
<div class="code"><div class="highlight"><pre><span class="s2">"activation_digest"</span>
</pre></div></div>
<p>once the string is interpolated.<span class="intersentencespace"></span> (We saw how symbols are interpolated as strings in <a href="sign_up_fragment.html#sec-the_flash" class="hyperref">Section <span class="ref">7.4.2</span></a>.)</p>
<p>Based on this discussion of <code>send</code>, we can rewrite the current <code>authenticated?</code> method as follows:</p>
<div class="code"><div class="highlight"><pre><span class="hll"><span class="k">def</span> <span class="nf">authenticated?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
</span><span class="hll">  <span class="n">digest</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">"remember_digest"</span><span class="p">)</span>
</span>  <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">digest</span><span class="o">.</span><span class="n">nil?</span>
  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p>With this template in place, we can generalize the method by adding a function argument with the name of the digest, and then use string interpolation as above:</p>
<div class="code"><div class="highlight"><pre><span class="hll"><span class="k">def</span> <span class="nf">authenticated?</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
</span><span class="hll">  <span class="n">digest</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">attribute</span><span class="si">}</span><span class="s2">_digest"</span><span class="p">)</span>
</span>  <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">digest</span><span class="o">.</span><span class="n">nil?</span>
  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p>(Here we have renamed the second argument <code>token</code> to emphasize that it’s now generic.)<span class="intersentencespace"></span> Because we’re inside the user model, we can also omit <code>self</code>, yielding the most idiomatically correct version:</p>
<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">authenticated?</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
<span class="hll">  <span class="n">digest</span> <span class="o">=</span> <span class="nb">send</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">attribute</span><span class="si">}</span><span class="s2">_digest"</span><span class="p">)</span>
</span>  <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">digest</span><span class="o">.</span><span class="n">nil?</span>
  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p>We can now reproduce the previous behavior of <code>authenticated?</code> by invoking it like this:</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:remember</span><span class="p">,</span> <span class="n">remember_token</span><span class="p">)</span>
</pre></div></div>
<p>Applying this discussion to the User model yields the generalized <code>authenticated?</code> method shown in <a href="account_activation_fragment.html#code-generalized_authenticated_p" class="hyperref">Listing <span class="ref">11.26</span></a>.</p>
<div class="codelisting" id="code-generalized_authenticated_p" data-tralics-id="uid1408" data-number="11.26"><div class="heading"><span class="number">Listing 11.26:</span> 

<span class="description">A generalized <code>authenticated?</code> method.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Returns true if the given token matches the digest.</span>
  <span class="k">def</span> <span class="nf">authenticated?</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
    <span class="n">digest</span> <span class="o">=</span> <span class="nb">send</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">attribute</span><span class="si">}</span><span class="s2">_digest"</span><span class="p">)</span>
    <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">digest</span><span class="o">.</span><span class="n">nil?</span>
    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>The caption to <a href="account_activation_fragment.html#code-generalized_authenticated_p" class="hyperref">Listing <span class="ref">11.26</span></a> indicates a <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span> test suite:</p>
<div class="codelisting" id="uid1409" data-tralics-id="uid1409" data-number="11.27"><div class="heading"><span class="number">Listing 11.27:</span> <span class="description"><span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div><p>The reason for the failure is that the <code>current_user</code> method (<a href="advanced_login_fragment.html#code-persistent_current_user" class="hyperref">Listing <span class="ref">9.9</span></a>) and the test for <code>nil</code> digests (<a href="advanced_login_fragment.html#code-test_authenticated_invalid_token" class="hyperref">Listing <span class="ref">9.17</span></a>) both use the old version of <code>authenticated?</code>, which expects one argument instead of two.<span class="intersentencespace"></span> To fix this, we simply update the two cases to use the generalized method, as shown in <a href="account_activation_fragment.html#code-generalized_current_user" class="hyperref">Listing <span class="ref">11.28</span></a> and <a href="account_activation_fragment.html#code-test_authenticated_invalid_token_updated" class="hyperref">Listing <span class="ref">11.29</span></a>.</p>
<div class="codelisting" id="code-generalized_current_user" data-tralics-id="uid1410" data-number="11.28"><div class="heading"><span class="number">Listing 11.28:</span> 

<span class="description">Using the generalized <code>authenticated?</code> method in <code>current_user</code>.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Returns the current logged-in user (if any).</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
      <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="k">elsif</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
<span class="hll">      <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:remember</span><span class="p">,</span> <span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</span>        <span class="n">log_in</span> <span class="n">user</span>
        <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="code-test_authenticated_invalid_token_updated" data-tralics-id="uid1411" data-number="11.29"><div class="heading"><span class="number">Listing 11.29:</span> 

<span class="description">Using the generalized <code>authenticated?</code> method in the User test.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                     <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"authenticated? should return false for a user with nil digest"</span> <span class="k">do</span>
<span class="hll">    <span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:remember</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>At this point, the tests should be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid1412" data-tralics-id="uid1412" data-number="11.30"><div class="heading"><span class="number">Listing 11.30:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div><p>Refactoring the code as above is incredibly more error-prone without a solid test suite, which is why we went to such trouble to write good tests in <a href="advanced_login_fragment.html#sec-login_with_remembering" class="hyperref">Section <span class="ref">9.1.2</span></a> and <a href="advanced_login_fragment.html#sec-remember_tests" class="hyperref">Section <span class="ref">9.3</span></a>.</p>
<div id="sec-exercises_generalizing_the_authenticated_method" data-tralics-id="uid1413" class="subsubsection" data-number="11.3.1.1"><h4><a href="#sec-exercises_generalizing_the_authenticated_method" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Create and remember new user at the console.<span class="intersentencespace"></span> What are the user’s remember and activation tokens?<span class="intersentencespace"></span> What are the corresponding digests? <span class="exercise" id="ex-6fc4f1"></span>
</li>
<li>Using the generalized <code>authenticated?</code> method from <a href="account_activation_fragment.html#code-generalized_authenticated_p" class="hyperref">Listing <span class="ref">11.26</span></a>, verify that the user is authenticated according to both the remember token and the activation token. <span class="exercise" id="ex-fdc50d"></span>
</li></ol>
</div></div>
<div id="sec-activation_edit_action" data-tralics-id="uid1416" class="subsection" data-number="11.3.2"><h3><a href="account_activation_fragment.html#sec-activation_edit_action" class="heading hyperref"><span class="number">11.3.2 </span>Activation <code class="tt">edit</code> action</a></h3>
<p>With the <code>authenticated?</code> method as in <a href="account_activation_fragment.html#code-generalized_authenticated_p" class="hyperref">Listing <span class="ref">11.26</span></a>, we’re now ready to write an <code>edit</code> action that authenticates the user corresponding to the email address in the <code>params</code> hash.<span class="intersentencespace"></span> Our test for validity will look like this:</p>
<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">user</span><span class="o">.</span><span class="n">activated?</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:activation</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>Note the presence of <code>!user.activated?</code>, which is the extra boolean alluded to above.<span class="intersentencespace"></span> This prevents our code from activating users who have already been activated, which is important because we’ll be logging in users upon confirmation, and we don’t want to allow attackers who manage to obtain the activation link to log in as the user.</p>
<p>If the user is authenticated according to the booleans above, we need to activate the user and update the <code>activated_at</code> timestamp:<sup id="cha-11_footnote-ref-7" class="footnote"><a href="#cha-11_footnote-7">7</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:activated</span><span class="p">,</span>    <span class="kp">true</span><span class="p">)</span>
<span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:activated_at</span><span class="p">,</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</pre></div></div>
<p>This leads to the <code>edit</code> action shown in <a href="account_activation_fragment.html#code-account_activation_edit_action" class="hyperref">Listing <span class="ref">11.31</span></a>.<span class="intersentencespace"></span> Note also that <a href="account_activation_fragment.html#code-account_activation_edit_action" class="hyperref">Listing <span class="ref">11.31</span></a> handles the case of an invalid activation token; this should rarely happen, but it’s easy enough to redirect in this case to the root URL.</p>
<div class="codelisting" id="code-account_activation_edit_action" data-tralics-id="uid1418" data-number="11.31"><div class="heading"><span class="number">Listing 11.31:</span> 

<span class="description">An <code>edit</code> action to activate accounts.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/account_activations_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AccountActivationsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">edit</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">user</span><span class="o">.</span><span class="n">activated?</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:activation</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:activated</span><span class="p">,</span>    <span class="kp">true</span><span class="p">)</span>
      <span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:activated_at</span><span class="p">,</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
      <span class="n">log_in</span> <span class="n">user</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Account activated!"</span>
      <span class="n">redirect_to</span> <span class="n">user</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Invalid activation link"</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>With the code in <a href="account_activation_fragment.html#code-account_activation_edit_action" class="hyperref">Listing <span class="ref">11.31</span></a>, you should now be able to paste in the URL from <a href="account_activation_fragment.html#code-account_activation_email" class="hyperref">Listing <span class="ref">11.25</span></a> to activate the relevant user.<span class="intersentencespace"></span> For example, on my system I visited the URL</p>
<div class="code"><div class="highlight"><pre>https://rails-tutorial-mhartl.c9users.io/account_activations/
fFb_F94mgQtmlSvRFGsITw/edit?email=michael%40michaelhartl.com
</pre></div></div>
<p>and got the result shown in <a href="account_activation_fragment.html#fig-activated_user" class="hyperref">Figure <span class="ref">11.5</span></a>.</p>
<div class="center figure" id="fig-activated_user" data-tralics-id="uid1419" data-number="11.5">
<div class="graphics image"><img src="images/figures/activated_user_4th_ed.png" alt="images/figures/activated_user_4th_ed"></div><div class="caption"><span class="header">Figure 11.5: </span><span class="description">The profile page after a successful activation.
</span></div></div>
<p>Of course, currently user activation doesn’t actually <em>do</em> anything, because we haven’t changed how users log in.<span class="intersentencespace"></span> In order to have account activation mean something, we need to allow users to log in only if they are activated.<span class="intersentencespace"></span> As shown in <a href="account_activation_fragment.html#code-preventing_unactivated_logins" class="hyperref">Listing <span class="ref">11.32</span></a>, the way to do this is to log the user in as usual if <code>user.activated?</code> is true; otherwise, we redirect to the root URL with a <code>warning</code> message (<a href="account_activation_fragment.html#fig-not_activated_warning" class="hyperref">Figure <span class="ref">11.6</span></a>).</p>
<div class="codelisting" id="code-preventing_unactivated_logins" data-tralics-id="uid1420" data-number="11.32"><div class="heading"><span class="number">Listing 11.32:</span> 

<span class="description">Preventing unactivated users from logging in.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
<span class="hll">      <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">activated?</span>
</span><span class="hll">        <span class="n">log_in</span> <span class="n">user</span>
</span><span class="hll">        <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="o">==</span> <span class="s1">'1'</span> <span class="p">?</span> <span class="n">remember</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">:</span> <span class="n">forget</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class="hll">        <span class="n">redirect_back_or</span> <span class="n">user</span>
</span><span class="hll">      <span class="k">else</span>
</span><span class="hll">        <span class="n">message</span>  <span class="o">=</span> <span class="s2">"Account not activated. "</span>
</span><span class="hll">        <span class="n">message</span> <span class="o">+=</span> <span class="s2">"Check your email for the activation link."</span>
</span><span class="hll">        <span class="n">flash</span><span class="o">[</span><span class="ss">:warning</span><span class="o">]</span> <span class="o">=</span> <span class="n">message</span>
</span><span class="hll">        <span class="n">redirect_to</span> <span class="n">root_url</span>
</span><span class="hll">      <span class="k">end</span>
</span>    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">log_out</span> <span class="k">if</span> <span class="n">logged_in?</span>
    <span class="n">redirect_to</span> <span class="n">root_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><div class="center figure" id="fig-not_activated_warning" data-tralics-id="uid1421" data-number="11.6">
<div class="graphics image"><img src="images/figures/not_activated_warning.png" alt="images/figures/not_activated_warning"></div><div class="caption"><span class="header">Figure 11.6: </span><span class="description">The warning message for a not-yet-activated user.
</span></div></div>
<p>With that, apart from one refinement, the basic functionality of user activation is done.<span class="intersentencespace"></span> (That refinement is preventing unactivated users from being displayed, which is left as an exercise (<a href="account_activation_fragment.html#sec-exercises_activation_test_and_refactoring" class="hyperref">Section <span class="ref">11.3.3.1</span></a>).)<span class="intersentencespace"></span> In <a href="account_activation_fragment.html#sec-activation_test_and_refactoring" class="hyperref">Section <span class="ref">11.3.3</span></a>, we’ll complete the process by adding some tests and then doing a little refactoring.</p>
<div id="sec-exercises_activation_edit_action" data-tralics-id="uid1422" class="subsubsection" data-number="11.3.2.1"><h4><a href="#sec-exercises_activation_edit_action" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Paste in the URL from the email generated in <a href="account_activation_fragment.html#sec-updating_create" class="hyperref">Section <span class="ref">11.2.4</span></a>.<span class="intersentencespace"></span> What is the activation token? <span class="exercise" id="ex-5595f3"></span>
</li>
<li>Verify at the console that the User is authenticated according to the activation token in the URL from the previous exercise.<span class="intersentencespace"></span> Is the user now activated? <span class="exercise" id="ex-32e5f6"></span>
</li></ol>
</div></div>
<div id="sec-activation_test_and_refactoring" data-tralics-id="uid1425" class="subsection" data-number="11.3.3"><h3><a href="account_activation_fragment.html#sec-activation_test_and_refactoring" class="heading hyperref"><span class="number">11.3.3 </span>Activation test and refactoring</a></h3>
<p>In this section, we’ll add an integration test for account activation.<span class="intersentencespace"></span> Because we already have a test for signing up with valid information, we’ll add the steps to the test developed in <a href="sign_up_fragment.html#sec-a_test_for_valid_submission" class="hyperref">Section <span class="ref">7.4.4</span></a> (<a href="sign_up_fragment.html#code-a_test_for_valid_submission" class="hyperref">Listing <span class="ref">7.33</span></a>).<span class="intersentencespace"></span> There are quite a few steps, but they are mostly straightforward; see if you can follow along in <a href="account_activation_fragment.html#code-signup_with_account_activation_test" class="hyperref">Listing <span class="ref">11.33</span></a>.<span class="intersentencespace"></span> (The highlights in <a href="account_activation_fragment.html#code-signup_with_account_activation_test" class="hyperref">Listing <span class="ref">11.33</span></a> indicate lines that are especially important or easy to miss, but there are other new lines as well, so take care to add them all.)</p>
<div class="codelisting" id="code-signup_with_account_activation_test" data-tralics-id="uid1426" data-number="11.33"><div class="heading"><span class="number">Listing 11.33:</span> 

<span class="description">Adding account activation to the user signup test.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_signup_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersSignupTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

<span class="hll">  <span class="k">def</span> <span class="nf">setup</span>
</span><span class="hll">    <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">deliveries</span><span class="o">.</span><span class="n">clear</span>
</span><span class="hll">  <span class="k">end</span>
</span>
  <span class="nb">test</span> <span class="s2">"invalid signup information"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">signup_path</span>
    <span class="n">assert_no_difference</span> <span class="s1">'User.count'</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">users_path</span><span class="p">,</span> <span class="ss">params</span><span class="p">:</span> <span class="p">{</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span>  <span class="s2">""</span><span class="p">,</span>
                                         <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@invalid"</span><span class="p">,</span>
                                         <span class="ss">password</span><span class="p">:</span>              <span class="s2">"foo"</span><span class="p">,</span>
                                         <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"bar"</span> <span class="p">}</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="n">assert_template</span> <span class="s1">'users/new'</span>
    <span class="n">assert_select</span> <span class="s1">'div#error_explanation'</span>
    <span class="n">assert_select</span> <span class="s1">'div.field_with_errors'</span>
  <span class="k">end</span>

<span class="hll">  <span class="nb">test</span> <span class="s2">"valid signup information with account activation"</span> <span class="k">do</span>
</span>    <span class="n">get</span> <span class="n">signup_path</span>
    <span class="n">assert_difference</span> <span class="s1">'User.count'</span><span class="p">,</span> <span class="mi">1</span> <span class="k">do</span>
<span class="hll">      <span class="n">post</span> <span class="n">users_path</span><span class="p">,</span> <span class="ss">params</span><span class="p">:</span> <span class="p">{</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span>  <span class="s2">"Example User"</span><span class="p">,</span>
</span>                                         <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                                         <span class="ss">password</span><span class="p">:</span>              <span class="s2">"password"</span><span class="p">,</span>
                                         <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"password"</span> <span class="p">}</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="n">assert_equal</span> <span class="mi">1</span><span class="p">,</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">deliveries</span><span class="o">.</span><span class="n">size</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">assigns</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="n">user</span><span class="o">.</span><span class="n">activated?</span>
    <span class="c1"># Try to log in before activation.</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="n">is_logged_in?</span>
    <span class="c1"># Invalid activation token</span>
    <span class="n">get</span> <span class="n">edit_account_activation_path</span><span class="p">(</span><span class="s2">"invalid token"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="n">is_logged_in?</span>
    <span class="c1"># Valid token, wrong email</span>
    <span class="n">get</span> <span class="n">edit_account_activation_path</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">activation_token</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s1">'wrong'</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="n">is_logged_in?</span>
    <span class="c1"># Valid activation token</span>
    <span class="n">get</span> <span class="n">edit_account_activation_path</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">activation_token</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
    <span class="n">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">activated?</span>
    <span class="n">follow_redirect!</span>
<span class="hll">    <span class="n">assert_template</span> <span class="s1">'users/show'</span>
</span><span class="hll">    <span class="n">assert</span> <span class="n">is_logged_in?</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>There’s a lot of code in <a href="account_activation_fragment.html#code-signup_with_account_activation_test" class="hyperref">Listing <span class="ref">11.33</span></a>, but the only completely novel code is in the line</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_equal</span> <span class="mi">1</span><span class="p">,</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">deliveries</span><span class="o">.</span><span class="n">size</span>
</pre></div></div>
<p>This code verifies that exactly 1 message was delivered.<span class="intersentencespace"></span> Because the <code>deliveries</code> array is global, we have to reset it in the <code>setup</code> method to prevent our code from breaking if any other tests deliver email (as will be the case in <a href="password_reset_fragment.html#cha-password_reset" class="hyperref">Chapter <span class="ref">12</span></a>).<span class="intersentencespace"></span> <a href="account_activation_fragment.html#code-signup_with_account_activation_test" class="hyperref">Listing <span class="ref">11.33</span></a> also uses the <code>assigns</code> method for the first time in the main tutorial; as explained in a <a href="advanced_login_fragment.html#cha-advanced_login" class="hyperref">Chapter <span class="ref">9</span></a> exercise (<a href="advanced_login_fragment.html#sec-exercises_testing_the_remember_me_box" class="hyperref">Section <span class="ref">9.3.1.1</span></a>), <code>assigns</code> lets us access instance variables in the corresponding action.<span class="intersentencespace"></span> For example, the Users controller’s <code>create</code> action defines an <code>@user</code> variable (<a href="account_activation_fragment.html#code-user_signup_with_account_activation" class="hyperref">Listing <span class="ref">11.23</span></a>), so we can access it in the test using <code>assigns(:user)</code>.<span class="intersentencespace"></span> Finally, note that <a href="account_activation_fragment.html#code-signup_with_account_activation_test" class="hyperref">Listing <span class="ref">11.33</span></a> restores the lines we commented out in <a href="account_activation_fragment.html#code-comment_out_failing_tests" class="hyperref">Listing <span class="ref">11.24</span></a>.</p>
<p>At this point, the test suite should be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid1427" data-tralics-id="uid1427" data-number="11.34"><div class="heading"><span class="number">Listing 11.34:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div><p>With the test in <a href="account_activation_fragment.html#code-signup_with_account_activation_test" class="hyperref">Listing <span class="ref">11.33</span></a>, we’re ready to refactor a little by moving some of the user manipulation out of the controller and into the model.<span class="intersentencespace"></span> In particular, we’ll make an <code>activate</code> method to update the user’s activation attributes and a <code>send_activation_email</code> to send the activation email.<span class="intersentencespace"></span> The extra methods appear in <a href="account_activation_fragment.html#code-user_activation_methods" class="hyperref">Listing <span class="ref">11.35</span></a>, and the refactored application code appears in <a href="account_activation_fragment.html#code-user_signup_refactored" class="hyperref">Listing <span class="ref">11.36</span></a> and <a href="account_activation_fragment.html#code-account_activation_refactored" class="hyperref">Listing <span class="ref">11.37</span></a>.</p>
<div class="codelisting" id="code-user_activation_methods" data-tralics-id="uid1428" data-number="11.35"><div class="heading"><span class="number">Listing 11.35:</span> 

<span class="description">Adding user activation methods to the User model.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Activates an account.</span>
  <span class="k">def</span> <span class="nf">activate</span>
<span class="hll">    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:activated</span><span class="p">,</span>    <span class="kp">true</span><span class="p">)</span>
</span><span class="hll">    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:activated_at</span><span class="p">,</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="c1"># Sends activation email.</span>
  <span class="k">def</span> <span class="nf">send_activation_email</span>
<span class="hll">    <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="n">deliver_now</span>
</span>  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="code-user_signup_refactored" data-tralics-id="uid1429" data-number="11.36"><div class="heading"><span class="number">Listing 11.36:</span> 

<span class="description">Sending email via the user model object.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
<span class="hll">      <span class="vi">@user</span><span class="o">.</span><span class="n">send_activation_email</span>
</span>      <span class="n">flash</span><span class="o">[</span><span class="ss">:info</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Please check your email to activate your account."</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="code-account_activation_refactored" data-tralics-id="uid1430" data-number="11.37"><div class="heading"><span class="number">Listing 11.37:</span> 

<span class="description">Account activation via the user model object.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/account_activations_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AccountActivationsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">edit</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">user</span><span class="o">.</span><span class="n">activated?</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="ss">:activation</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="hll">      <span class="n">user</span><span class="o">.</span><span class="n">activate</span>
</span>      <span class="n">log_in</span> <span class="n">user</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Account activated!"</span>
      <span class="n">redirect_to</span> <span class="n">user</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Invalid activation link"</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that <a href="account_activation_fragment.html#code-user_activation_methods" class="hyperref">Listing <span class="ref">11.35</span></a> eliminates the use of <code>user.</code>, which would break inside the User model because there is no such variable:</p>
<div class="code"><div class="highlight"><pre><span class="gd">-user.update_attribute(:activated,    true)</span>
<span class="gd">-user.update_attribute(:activated_at, Time.zone.now)</span>
<span class="gi">+update_attribute(:activated,    true)</span>
<span class="gi">+update_attribute(:activated_at, Time.zone.now)</span>
</pre></div></div>
<p>(We could have switched from <code>user</code> to <code>self</code>, but recall from <a href="modeling_users_fragment.html#sec-uniqueness_validation" class="hyperref">Section <span class="ref">6.2.5</span></a> that <code>self</code> is optional inside the model.)<span class="intersentencespace"></span> It also changes <code>@user</code> to <code>self</code> in the call to the User mailer:</p>
<div class="code"><div class="highlight"><pre><span class="gd">-UserMailer.account_activation(@user).deliver_now</span>
<span class="gi">+UserMailer.account_activation(self).deliver_now</span>
</pre></div></div>
<p>These are <em>exactly</em> the kinds of details that are easy to miss during even a simple refactoring but will be caught by a good test suite.<span class="intersentencespace"></span> Speaking of which, the test suite should still be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid1431" data-tralics-id="uid1431" data-number="11.38"><div class="heading"><span class="number">Listing 11.38:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div>
<div id="sec-exercises_activation_test_and_refactoring" data-tralics-id="uid1432" class="subsubsection" data-number="11.3.3.1"><h4><a href="#sec-exercises_activation_test_and_refactoring" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>In <a href="account_activation_fragment.html#code-user_activation_methods" class="hyperref">Listing <span class="ref">11.35</span></a>, the <code>activate</code> method makes two calls to the <code>update_attribute</code>, each of which requires a separate database transaction.<span class="intersentencespace"></span> By filling in the template shown in <a href="account_activation_fragment.html#code-update_columns" class="hyperref">Listing <span class="ref">11.39</span></a>, replace the two <code>update_attribute</code> calls with a single call to <code>update_columns</code>, which hits the database only once.<span class="intersentencespace"></span> After making the changes, verify that the test suite is still <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>. <span class="exercise" id="ex-be2f50"></span>
</li>
<li>Right now <em>all</em> users are displayed on the user index page at /users and are visible via the URL /users/:id, but it makes sense to show users only if they are activated.<span class="intersentencespace"></span> Arrange for this behavior by filling in the template shown in <a href="account_activation_fragment.html#code-show_only_active_users_exercise" class="hyperref">Listing <span class="ref">11.40</span></a>.<sup id="cha-11_footnote-ref-8" class="footnote"><a href="#cha-11_footnote-8">8</a></sup><span class="intersentencespace"></span> (This uses the Active Record <code>where</code> method, which we’ll learn more about in <a href="user_microposts_fragment.html#sec-a_proto_feed" class="hyperref">Section <span class="ref">13.3.3</span></a>.) <span class="exercise" id="ex-6dc5ff"></span>
</li>
<li>To test the code in the previous exercise, write integration tests for both /users and /users/:id. <span class="exercise" id="ex-935d6f"></span>
</li></ol>
<div class="codelisting" id="code-update_columns" data-tralics-id="uid1437" data-number="11.39"><div class="heading"><span class="number">Listing 11.39:</span> 

<span class="description">A template for using <code>update_columns</code>.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">attr_accessor</span> <span class="ss">:remember_token</span><span class="p">,</span> <span class="ss">:activation_token</span>
  <span class="n">before_save</span>   <span class="ss">:downcase_email</span>
  <span class="n">before_create</span> <span class="ss">:create_activation_digest</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Activates an account.</span>
  <span class="k">def</span> <span class="nf">activate</span>
<span class="hll">    <span class="n">update_columns</span><span class="p">(</span><span class="ss">activated</span><span class="p">:</span> <span class="no">FILL_IN</span><span class="p">,</span> <span class="ss">activated_at</span><span class="p">:</span> <span class="no">FILL_IN</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="c1"># Sends activation email.</span>
  <span class="k">def</span> <span class="nf">send_activation_email</span>
    <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="n">deliver_now</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="c1"># Converts email to all lower-case.</span>
    <span class="k">def</span> <span class="nf">downcase_email</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span>
    <span class="k">end</span>

    <span class="c1"># Creates and assigns the activation token and digest.</span>
    <span class="k">def</span> <span class="nf">create_activation_digest</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">activation_token</span>  <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">activation_digest</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">activation_token</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="code-show_only_active_users_exercise" data-tralics-id="uid1438" data-number="11.40"><div class="heading"><span class="number">Listing 11.40:</span> 

<span class="description">A template for code to show only active users.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span> </span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">index</span>
<span class="hll">    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">activated</span><span class="p">:</span> <span class="no">FILL_IN</span><span class="p">)</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="hll">    <span class="n">redirect_to</span> <span class="n">root_url</span> <span class="ow">and</span> <span class="k">return</span> <span class="k">unless</span> <span class="no">FILL_IN</span>
</span>  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div></div></div></div><div id="sec-activation_email_in_production" data-tralics-id="cid64" class="section" data-number="11.4"><h2><a href="account_activation_fragment.html#sec-activation_email_in_production" class="heading hyperref"><span class="number">11.4 </span>Email in production</a></h2>
<p>Now that we’ve got account activations working in development, in this section we’ll configure our application so that it can actually send email in production.<span class="intersentencespace"></span> We’ll first get set up with a free service to send email, and then configure and deploy our application.</p>
<p>To send email in production, we’ll use SendGrid, which is available as an add-on at Heroku for verified accounts.<span class="intersentencespace"></span> (This requires adding credit card information to your Heroku account, but there is no charge when verifying an account.)<span class="intersentencespace"></span> For our purposes, the “starter” tier (which as of this writing is limited to 400 emails a day but costs nothing) is the best fit.<span class="intersentencespace"></span> We can add it to our app as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku addons:create sendgrid:starter
</pre></div></div>
<p>(This might fail on systems with an older version of Heroku’s command-line interface.<span class="intersentencespace"></span> In this case, either <a href="https://toolbelt.heroku.com/" target="_blank" rel="noopener">upgrade to the latest Heroku toolbelt</a> or try the older syntax <code>heroku addons:add sendgrid:starter</code>.)</p>
<p>To configure our application to use SendGrid, we need to fill out the <a href="https://en.wikipedia.org/wiki/Simple_Mail_Transfer_Protocol" target="_blank" rel="noopener">SMTP</a> settings for our production environment.<span class="intersentencespace"></span> As shown in <a href="account_activation_fragment.html#code-sendgrid_config" class="hyperref">Listing <span class="ref">11.41</span></a>, you will also have to define a <code>host</code> variable with the address of your production website.</p>
<div class="codelisting" id="code-sendgrid_config" data-tralics-id="uid1439" data-number="11.41"><div class="heading"><span class="number">Listing 11.41:</span> 

<span class="description">Configuring Rails to use SendGrid in production.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">config/environments/production.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">raise_delivery_errors</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">delivery_method</span> <span class="o">=</span> <span class="ss">:smtp</span>
  <span class="n">host</span> <span class="o">=</span> <span class="s1">'&lt;your heroku app&gt;.herokuapp.com'</span>
  <span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">default_url_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">host</span><span class="p">:</span> <span class="n">host</span> <span class="p">}</span>
  <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">smtp_settings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">:address</span>        <span class="o">=&gt;</span> <span class="s1">'smtp.sendgrid.net'</span><span class="p">,</span>
    <span class="ss">:port</span>           <span class="o">=&gt;</span> <span class="s1">'587'</span><span class="p">,</span>
    <span class="ss">:authentication</span> <span class="o">=&gt;</span> <span class="ss">:plain</span><span class="p">,</span>
    <span class="ss">:user_name</span>      <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">'SENDGRID_USERNAME'</span><span class="o">]</span><span class="p">,</span>
    <span class="ss">:password</span>       <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">'SENDGRID_PASSWORD'</span><span class="o">]</span><span class="p">,</span>
    <span class="ss">:domain</span>         <span class="o">=&gt;</span> <span class="s1">'heroku.com'</span><span class="p">,</span>
    <span class="ss">:enable_starttls_auto</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>The email configuration in <a href="account_activation_fragment.html#code-sendgrid_config" class="hyperref">Listing <span class="ref">11.41</span></a> includes the <code>user_name</code> and <code>password</code> of the SendGrid account, but note that they are accessed via the <code>ENV</code> environment variable instead of being hard-coded.<span class="intersentencespace"></span> This is a best practice for production applications, which for security reasons should never expose sensitive information such as raw passwords in source code.<span class="intersentencespace"></span> In the present case, these variables are configured automatically via the SendGrid add-on, but we’ll see an example in <a href="user_microposts_fragment.html#sec-image_upload_in_production" class="hyperref">Section <span class="ref">13.4.4</span></a> where we’ll have to define them ourselves.<span class="intersentencespace"></span> In case you’re curious, you can view the environment variables used in <a href="account_activation_fragment.html#code-sendgrid_config" class="hyperref">Listing <span class="ref">11.41</span></a> as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku config:get SENDGRID_USERNAME
<span class="gp">$</span> heroku config:get SENDGRID_PASSWORD
</pre></div></div>
<p>At this point, you should merge the topic branch into master:</p>
<div class="code"><div class="highlight"><pre>$ rails test
$ git add -A
$ git commit -m "Add account activation"
$ git checkout master
$ git merge account-activation
</pre></div></div>
<p>Then push up to the remote repository and deploy to Heroku:</p>
<div class="code"><div class="highlight"><pre>$ rails test
$ git push
$ git push heroku
$ heroku run rails db:migrate
</pre></div></div>
<p>Once the Heroku deploy has finished, try signing up for the sample application in production using an email address you control.<span class="intersentencespace"></span> You should get an activation email as implemented in <a href="account_activation_fragment.html#sec-account_activation_emails" class="hyperref">Section <span class="ref">11.2</span></a>, as shown in <a href="account_activation_fragment.html#fig-activation_email_production" class="hyperref">Figure <span class="ref">11.7</span></a>.<span class="intersentencespace"></span> Clicking on the link should activate the account as promised, as shown in <a href="account_activation_fragment.html#fig-activated_in_production" class="hyperref">Figure <span class="ref">11.8</span></a>.</p>
<div class="center figure" id="fig-activation_email_production" data-tralics-id="uid1440" data-number="11.7">
<div class="graphics image box"><img src="images/figures/activation_email_production_4th_ed.png" alt="images/figures/activation_email_production_4th_ed"></div><div class="caption"><span class="header">Figure 11.7: </span><span class="description">An account activation email sent in production.
</span></div></div>
<div class="center figure" id="fig-activated_in_production" data-tralics-id="uid1441" data-number="11.8">
<div class="graphics image"><img src="images/figures/activated_in_production.png" alt="images/figures/activated_in_production"></div><div class="caption"><span class="header">Figure 11.8: </span><span class="description">Successful account activation in production.
</span></div></div>
<div id="sec-exercises_activation_email_in_production" data-tralics-id="uid1442" class="subsubsection" data-number="11.4.3.2"><h4><a href="#sec-exercises_activation_email_in_production" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Sign up for a new account in production.<span class="intersentencespace"></span> Did you get the email? <span class="exercise" id="ex-010ba6"></span>
</li>
<li>Click on the link in the activation email to confirm that it works.<span class="intersentencespace"></span> What is the corresponding entry in the server log?<span class="intersentencespace"></span> <em>Hint</em>: Run <code>heroku logs</code> at the command line. <span class="exercise" id="ex-8b6970"></span>
</li></ol>
</div></div><div id="sec-activation_conclusion" data-tralics-id="cid65" class="section" data-number="11.5"><h2><a href="account_activation_fragment.html#sec-activation_conclusion" class="heading hyperref"><span class="number">11.5 </span>Conclusion</a></h2>
<p>With the added account activation, our sample application’s sign up, log in, and log out machinery is nearly complete.<span class="intersentencespace"></span> The only significant feature left is allowing users to reset their passwords if they forget them.<span class="intersentencespace"></span> As we’ll see in <a href="password_reset_fragment.html#cha-password_reset" class="hyperref">Chapter <span class="ref">12</span></a>, password reset shares many features with account activation, which means that we’ll be able to put the knowledge we’ve gained in this chapter to good use.</p>
<div id="sec-activation_what_we_learned_in_this_chapter" data-tralics-id="uid1445" class="subsection" data-number="11.5.1"><h3><a href="account_activation_fragment.html#sec-activation_what_we_learned_in_this_chapter" class="heading hyperref"><span class="number">11.5.1 </span>What we learned in this chapter</a></h3>
<ul>
<li>Like sessions, account activations can be modeled as a resource despite not being Active Record objects.
</li>
<li>Rails can generate Action Mailer actions and views to send email.
</li>
<li>Action Mailer supports both plain-text and HTML mail.
</li>
<li>As with ordinary actions and views, instance variables defined in mailer actions are available in mailer views.
</li>
<li>Account activations use a generated token to create a unique URL for activating users.
</li>
<li>Account activations use a hashed activation digest to securely identify valid activation requests.
</li>
<li>Both mailer tests and integration tests are useful for verifying the behavior of the User mailer.
</li>
<li>We can send email in production using SendGrid.
</li></ul>
</div></div><div id="cha-11_footnotes">
  <ol class="footnotes">
    <li id="cha-11_footnote-1">This chapter is independent of the others, apart from the mailer generation in <a href="account_activation_fragment.html#code-generate_user_mailer" class="hyperref">Listing <span class="ref">11.6</span></a>, which is used in <a href="password_reset_fragment.html#cha-password_reset" class="hyperref">Chapter <span class="ref">12</span></a>.<span class="intersentencespace"></span> Readers can skip to <a href="password_reset_fragment.html#cha-password_reset" class="hyperref">Chapter <span class="ref">12</span></a> or to <a href="user_microposts_fragment.html#cha-user_microposts" class="hyperref">Chapter <span class="ref">13</span></a> with minimal discontinuity, although the former will be substantially more challenging due to substantial overlap with this chapter. <a class="arrow" href="#cha-11_footnote-ref-1">↑</a></li>
    <li id="cha-11_footnote-2">We could use the user’s id instead, since it’s already exposed in the URLs of our application, but using email addresses is more future-proof in case we want to obfuscate user ids for any reason (such as to prevent competitors from knowing how many users our application has, for example). <a class="arrow" href="#cha-11_footnote-ref-2">↑</a></li>
    <li id="cha-11_footnote-3">Because we’ll be using an <code>edit</code> action, we could include <code>edit</code> on the command line, but this would also generate both an edit view and a test, neither of which we’ll turn out to need. <a class="arrow" href="#cha-11_footnote-ref-3">↑</a></li>
    <li id="cha-11_footnote-4">It’s mainly for this reason that we won’t be using the (perhaps slightly misnamed) <code>has_secure_token</code> facility added in Rails 5, which stores the corresponding token in the database as unhashed <a href="https://en.wikipedia.org/wiki/Cleartext" target="_blank" rel="noopener">cleartext</a>. <a class="arrow" href="#cha-11_footnote-ref-4">↑</a></li>
    <li id="cha-11_footnote-5">URLs can contain multiple query parameters, consisting of multiple key-value pairs separated by the ampersand character <code>&amp;</code>, as in <code>/edit?name=Foo%20Bar&amp;email=foo%40example.com</code>. <a class="arrow" href="#cha-11_footnote-ref-5">↑</a></li>
    <li id="cha-11_footnote-6">When I originally wrote this chapter, I couldn’t recall offhand how to escape URLs in Rails, and figuring it out was pure technical sophistication (<a href="beginning_fragment.html#aside-technical_sophistication" class="hyperref">Box <span class="ref">1.1</span></a>).<span class="intersentencespace"></span> What I did was Google “<a href="http://lmgtfy.com/?q=ruby+rails+escape+url" target="_blank" rel="noopener">ruby rails escape url</a>”, which led me to <a href="http://stackoverflow.com/questions/6714196/ruby-url-encoding-string" target="_blank" rel="noopener">find two main possibilities</a>, <code>URI.encode(str)</code> and <code>CGI.escape(str)</code>.<span class="intersentencespace"></span> Trying them both revealed that the latter works.<span class="intersentencespace"></span> (It turns out there’s a third possibility: the <code>ERB::Util</code> library supplies a <a href="http://apidock.com/ruby/ERB/Util/url_encode" target="_blank" rel="noopener">url_encode</a> method that has the same effect.) <a class="arrow" href="#cha-11_footnote-ref-6">↑</a></li>
    <li id="cha-11_footnote-7">Here we use two calls to <code>update_attribute</code> rather than a single call to <code>updated_attributes</code> because (per <a href="modeling_users_fragment.html#sec-updating_user_objects" class="hyperref">Section <span class="ref">6.1.5</span></a>) the latter would run the validations.<span class="intersentencespace"></span> Lacking in this case the user password, these validations would fail. <a class="arrow" href="#cha-11_footnote-ref-7">↑</a></li>
    <li id="cha-11_footnote-8">Note that <a href="account_activation_fragment.html#code-show_only_active_users_exercise" class="hyperref">Listing <span class="ref">11.40</span></a> uses <code>and</code> in place of <code>&amp;&amp;</code>.<span class="intersentencespace"></span> The two are nearly identical, but the latter operator has a higher <a href="http://en.wikipedia.org/wiki/Order_of_operations#Programming_languages" target="_blank" rel="noopener"><em>precedence</em></a>, which binds too tightly to <code>root_url</code> in this case.<span class="intersentencespace"></span> We could fix the problem by putting <code>root_url</code> in parentheses, but the idiomatically correct way to do it is to use <code>and</code> instead. <a class="arrow" href="#cha-11_footnote-ref-8">↑</a></li>
  </ol>
</div>"kn      X,X,=hyX'  a,:https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial_4th_edition/html/account_activation_fragment.html?X-Amz-Expires=604800&X-Amz-Date=20170205T134559Z&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20170205/us-west-2/s3/aws4_request&X-Amz-SignedHeaders=host&X-Amz-Signature=94ecc90200e5b460bdac396b95e5e2c5f2d9354e6b75022ca08d9aa307b2dd06 security-info FnhllAKWRHGAlo+ESXykKAAAAAAAAAAAwAAAAAAAAEaphjoj9ApAYLLhYqsrhSapAAQAAgAAAAAAAAAAAAAAACw4N6+LhUposNgK7YiYWzI/H82DxalM0aJQdnbKfH40ZgoyJpFcT/u7IImFpjLfBfjtg2TO2UxuhrpIr1PDk+YAAAAAAAAGGzCCBhcwggT/oAMCAQICEAkMEh1kGcxPzNQuULyfEo0wDQYJKoZIhvcNAQELBQAwZDELMAkGA1UEBhMCVVMxFTATBgNVBAoTDERpZ2lDZXJ0IEluYzEZMBcGA1UECxMQd3d3LmRpZ2ljZXJ0LmNvbTEjMCEGA1UEAxMaRGlnaUNlcnQgQmFsdGltb3JlIENBLTIgRzIwHhcNMTYwNzE4MDAwMDAwWhcNMTcxMDI2MTIwMDAwWjB1MQswCQYDVQQGEwJVUzETMBEGA1UECBMKV2FzaGluZ3RvbjEQMA4GA1UEBxMHU2VhdHRsZTEYMBYGA1UEChMPQW1hem9uLmNvbSBJbmMuMSUwIwYDVQQDDBwqLnMzLXVzLXdlc3QtMi5hbWF6b25hd3MuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtPtaIwJ9+anWiEq/qLdHgQkQ51FdpjU3C/o1HSP3DGHcijP8q6gpOQ2GIT4xaAOOEstz5v5WY8kOfEE0UXsyB8LxmNyu4nPz4gEE1jCKXaFaMQUexl2nz1hNBCzabnDV10EB2+XPOWPw1troTgtKWuBxZ4EaC7dQXkgpqSqzcio33y9sZHlcEa2ok0DMgxTaEY0ryVdODJMlTIVoFwzkiedRV3dl7yRK8EqWMfWnVJzJ2JVMRqakWjQeLE+8oeo4F0m6BEch9qpIA8JV20oFv0cQLM6QQNFzX2EN/2v5uBtrB5g/g39+5Yu+kgkfhedTSkFunjEGol8G7jssC3jijwIDAQABo4ICsjCCAq4wHwYDVR0jBBgwFoAUwBKyKHRoRmfpcCV0GgBFWwZ9XEQwHQYDVR0OBBYEFF1JaGNuDmFfuVhgXPTd3tg4yz2iMIHhBgNVHREEgdkwgdaCGnMzLXVzLXdlc3QtMi5hbWF6b25hd3MuY29tghwqLnMzLXVzLXdlc3QtMi5hbWF6b25hd3MuY29tghpzMy51cy13ZXN0LTIuYW1hem9uYXdzLmNvbYIcKi5zMy51cy13ZXN0LTIuYW1hem9uYXdzLmNvbYIkczMuZHVhbHN0YWNrLnVzLXdlc3QtMi5hbWF6b25hd3MuY29tgiYqLnMzLmR1YWxzdGFjay51cy13ZXN0LTIuYW1hem9uYXdzLmNvbYISKi5zMy5hbWF6b25hd3MuY29tMA4GA1UdDwEB/wQEAwIFoDAdBgNVHSUEFjAUBggrBgEFBQcDAQYIKwYBBQUHAwIwgYEGA1UdHwR6MHgwOqA4oDaGNGh0dHA6Ly9jcmwzLmRpZ2ljZXJ0LmNvbS9EaWdpQ2VydEJhbHRpbW9yZUNBLTJHMi5jcmwwOqA4oDaGNGh0dHA6Ly9jcmw0LmRpZ2ljZXJ0LmNvbS9EaWdpQ2VydEJhbHRpbW9yZUNBLTJHMi5jcmwwTAYDVR0gBEUwQzA3BglghkgBhv1sAQEwKjAoBggrBgEFBQcCARYcaHR0cHM6Ly93d3cuZGlnaWNlcnQuY29tL0NQUzAIBgZngQwBAgIweQYIKwYBBQUHAQEEbTBrMCQGCCsGAQUFBzABhhhodHRwOi8vb2NzcC5kaWdpY2VydC5jb20wQwYIKwYBBQUHMAKGN2h0dHA6Ly9jYWNlcnRzLmRpZ2ljZXJ0LmNvbS9EaWdpQ2VydEJhbHRpbW9yZUNBLTJHMi5jcnQwDAYDVR0TAQH/BAIwADANBgkqhkiG9w0BAQsFAAOCAQEAYH38ntfWdhwWcuD895IsKMmdlnbReTnnEKe6n6tldoxpWEJkjMA0hURZnZrbr5FL3ar6bWF9wnFKMYPxMfjhNzpB8/lbp63yZSDmVpDIsOIRWjkdcMsnpBHDHQWPV9T7fIgxT4WqAK92O3kQs1+bmsuXISBelIMev1G02BYa7EDD8JZyoltleTcs8rzvRRgE37GfxAtu07fxQqyDSvj7ojpSoIUmTVDVJMTGCkSemYpdR3DqTzmsej6eV7TbLdvFTjFnRJ4Zdehb17CoVvkOTB1v/oXaabIIi3UEsDu3UpxdB7mU4G1qgy8XDMitAtpBL6+EIw0QKw5+JoSuzbybEgAAAIAAAACAAAAAJVRMU19FQ0RIRV9SU0FfV0lUSF9BRVNfMTI4X0dDTV9TSEEyNTYAAAABAAA= request-method GET request-Origin https://www.railstutorial.org response-head HTTP/1.1 200 OK
x-amz-id-2: l7VsJyo2rZM9Swj/fFUl2ofND3teuzIQGp67UCMfyaLoAlRTVJcifFd7HgMj5k9jOdX+LWvG6YI=
x-amz-request-id: 806414FF7240AA5E
Date: Sun, 05 Feb 2017 13:46:12 GMT
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: GET
Access-Control-Max-Age: 3000
Vary: Origin, Access-Control-Request-Headers, Access-Control-Request-Method
Last-Modified: Thu, 22 Dec 2016 05:27:39 GMT
Etag: "41bda8c49ad129cb6e2c91f0a6377063"
Accept-Ranges: bytes
Content-Type: text/html
Content-Length: 184948
Server: AmazonS3
 uncompressed-len 0  t