<div id="cha-advanced_login" data-tralics-id="cid49" class="chapter" data-number="9" data-chapter="advanced_login"><h1><a href="advanced_login_fragment.html#cha-advanced_login" class="heading hyperref"><span class="number">Chapter 9 </span>Advanced login</a></h1>
<p>The basic login system developed in <a href="basic_login_fragment.html#cha-basic_login" class="hyperref">Chapter <span class="ref">8</span></a> is fully functional, but most modern websites include the ability to “remember” users when they visit the site again even if they’ve closed their browsers in the interim.<span class="intersentencespace"></span> In this chapter, we use <em>permanent cookies</em> to implement this behavior.<span class="intersentencespace"></span> We’ll start by automatically remembering users when they log in (<a href="advanced_login_fragment.html#sec-remember_me" class="hyperref">Section <span class="ref">9.1</span></a>), a common model used by sites such as Bitbucket and GitHub.<span class="intersentencespace"></span> We’ll then add the ability to <em>optionally</em> remember users using a “remember me” checkbox, a model used by sites such as Twitter and Facebook.</p>
<p>Because the <a href="basic_login_fragment.html#cha-basic_login" class="hyperref">Chapter <span class="ref">8</span></a> login system is complete by itself, the core of the sample application will work fine without it, and if desired you can skip right to <a href="updating_and_deleting_users_fragment.html#cha-updating_showing_and_deleting_users" class="hyperref">Chapter <span class="ref">10</span></a> (and from there to <a href="user_microposts_fragment.html#cha-user_microposts" class="hyperref">Chapter <span class="ref">13</span></a>).<span class="intersentencespace"></span> On the other hand, learning how to implement the “remember me” feature is both highly instructive by itself and lays an essential foundation for account activation (<a href="account_activation_fragment.html#cha-account_activation" class="hyperref">Chapter <span class="ref">11</span></a>) and password reset (<a href="password_reset_fragment.html#cha-password_reset" class="hyperref">Chapter <span class="ref">12</span></a>).<span class="intersentencespace"></span> Moreover, the result is an outstanding example of <a href="https://www.learnenough.com/command-line-tutorial#aside-computer_magic" target="_blank" rel="noopener">computer magic</a>: You’ve seen a billion of these “remember me” login forms on the Web, and now’s your chance to learn how to make one.</p>
</div><div id="sec-remember_me" data-tralics-id="cid50" class="section" data-number="9.1"><h2><a href="advanced_login_fragment.html#sec-remember_me" class="heading hyperref"><span class="number">9.1 </span>Remember me</a></h2>
<p>In this section, we’ll add the ability to remember our users’ login state even after they close and reopen their browsers.<span class="intersentencespace"></span> This “remember me” behavior will happen automatically, and users will automatically stay logged in until they explicitly log out.<span class="intersentencespace"></span> As we’ll see, the resulting machinery will make it easy to add an optional “remember me” checkbox as well (<a href="advanced_login_fragment.html#sec-remember_me_checkbox" class="hyperref">Section <span class="ref">9.2</span></a>).</p>
<p>As usual, I suggest switching to a topic branch before proceeding:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b advanced-login
</pre></div></div>
<div id="sec-remember_token" data-tralics-id="uid1087" class="subsection" data-number="9.1.1"><h3><a href="advanced_login_fragment.html#sec-remember_token" class="heading hyperref"><span class="number">9.1.1 </span>Remember token and digest</a></h3>
<p>In <a href="basic_login_fragment.html#sec-logging_in" class="hyperref">Section <span class="ref">8.2</span></a>, we used the Rails <code>session</code> method to store the user’s id, but this information disappears when the user closes their browser.<span class="intersentencespace"></span> In this section, we’ll take the first step toward persistent sessions by generating a <em>remember token</em> appropriate for creating permanent cookies using the <code>cookies</code> method, together with a secure <em>remember digest</em> for authenticating those tokens.</p>
<p>As noted in <a href="basic_login_fragment.html#sec-a_working_log_in_method" class="hyperref">Section <span class="ref">8.2.1</span></a>, information stored using <code>session</code> is automatically secure, but this is not the case with information stored using <code>cookies</code>.<span class="intersentencespace"></span> In particular, persistent cookies are vulnerable to <a href="http://en.wikipedia.org/wiki/Session_hijacking" target="_blank" rel="noopener">session hijacking</a>, in which an attacker uses a stolen remember token to log in as a particular user.<span class="intersentencespace"></span> There are four main ways to steal cookies: (1) using a <a href="https://en.wikipedia.org/wiki/Packet_analyzer" target="_blank" rel="noopener">packet sniffer</a> to detect cookies being passed over insecure networks,<sup id="cha-9_footnote-ref-1" class="footnote"><a href="#cha-9_footnote-1">1</a></sup> (2) compromising a database containing remember tokens, (3) using <a href="http://en.wikipedia.org/wiki/Cross-site_scripting" target="_blank" rel="noopener">cross-site scripting (XSS)</a>, and (4) gaining physical access to a machine with a logged-in user.<span class="intersentencespace"></span> We prevented the first problem in <a href="sign_up_fragment.html#sec-professional_grade_deployment" class="hyperref">Section <span class="ref">7.5</span></a> by using <a href="https://en.wikipedia.org/wiki/Transport_Layer_Security" target="_blank" rel="noopener">Secure Sockets Layer</a> (SSL) site-wide, which protects network data from packet sniffers.<span class="intersentencespace"></span> We’ll prevent the second problem by storing a hash digest of the remember tokens instead of the token itself, in much the same way that we stored password digests instead of raw passwords in <a href="modeling_users_fragment.html#sec-adding_a_secure_password" class="hyperref">Section <span class="ref">6.3</span></a>.<sup id="cha-9_footnote-ref-2" class="footnote"><a href="#cha-9_footnote-2">2</a></sup><span class="intersentencespace"></span> Rails automatically prevents the third problem by escaping any content inserted into view templates.<span class="intersentencespace"></span> Finally, although there’s no iron-clad way to stop attackers who have physical access to a logged-in computer, we’ll minimize the fourth problem by changing tokens every time a user logs out and by taking care to <a href="https://en.wikipedia.org/wiki/Digital_signature" target="_blank" rel="noopener"><em>cryptographically sign</em></a> any potentially sensitive information we place on the browser.</p>
<p>With these design and security considerations in mind, our plan for creating persistent sessions appears as follows:</p>
<ol>
<li>Create a random string of digits for use as a remember token.<span class="intersentencespace"></span>
</li>
<li>Place the token in the browser cookies with an expiration date far in the future.<span class="intersentencespace"></span>
</li>
<li>Save the hash digest of the token to the database.<span class="intersentencespace"></span>
</li>
<li>Place an encrypted version of the user’s id in the browser cookies.<span class="intersentencespace"></span>
</li>
<li>When presented with a cookie containing a persistent user id, find the user in the database using the given id, and verify that the remember token cookie matches the associated hash digest from the database.<span class="intersentencespace"></span>
</li></ol>
<p>Note how similar the final step is to logging a user in, where we retrieve the user by email address and then verify (using the <code>authenticate</code> method) that the submitted password matches the password digest (<a href="basic_login_fragment.html#code-find_authenticate_user" class="hyperref">Listing <span class="ref">8.7</span></a>).<span class="intersentencespace"></span> As a result, our implementation will parallel aspects of <code>has_secure_password</code>.</p>
<p>We’ll start by adding the required <code>remember_digest</code> attribute to the User model, as shown in <a href="advanced_login_fragment.html#fig-user_model_remember_digest" class="hyperref">Figure <span class="ref">9.1</span></a>.</p>
<div class="center figure" id="fig-user_model_remember_digest" data-tralics-id="uid1095" data-number="9.1"><span class="graphics"><img src="images/figures/user_model_remember_digest.png" alt="user_model_remember_digest"></span>
<div class="caption"><span class="header">Figure 9.1: </span><span class="description">The User model with an added <code>remember_digest</code> attribute.
</span></div></div>
<p>To add the data model from <a href="advanced_login_fragment.html#fig-user_model_remember_digest" class="hyperref">Figure <span class="ref">9.1</span></a> to our application, we’ll generate a migration:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_remember_digest_to_users remember_digest:string
</pre></div></div>
<p>(Compare to the password digest migration in <a href="modeling_users_fragment.html#sec-a_hashed_password" class="hyperref">Section <span class="ref">6.3.1</span></a>.)<span class="intersentencespace"></span> As in previous migrations, we’ve used a migration name that ends in <code>_to_users</code> to tell Rails that the migration is designed to alter the <code>users</code> table in the database.<span class="intersentencespace"></span> Because we also included the attribute (<code>remember_digest</code>) and type (<code>string</code>), Rails generates a default migration for us, as shown in <a href="advanced_login_fragment.html#code-add_remember_digest_to_users_generated" class="hyperref">Listing <span class="ref">9.1</span></a>.</p>
<div class="codelisting" id="code-add_remember_digest_to_users_generated" data-tralics-id="uid1096" data-number="9.1"><div class="heading"><span class="number">Listing 9.1:</span> 

<span class="description">The generated migration for the remember digest.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">db/migrate/[timestamp]_add_remember_digest_to_users.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddRememberDigestToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="o">[</span><span class="mi">5</span><span class="o">.</span><span class="mi">0</span><span class="o">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:remember_digest</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Because we don’t expect to retrieve users by remember digest, there’s no need to put an index on the <code>remember_digest</code> column, and we can use the default migration as generated above:</p>
<div class="code"><div class="highlight"><pre>$ rails db:migrate
</pre></div></div>
<p>Now we have to decide what to use as a remember token.<span class="intersentencespace"></span> There are many mostly equivalent possibilities—essentially, any long random string will do.<span class="intersentencespace"></span> The <code>urlsafe_base64</code> method from the <code>SecureRandom</code> module in the Ruby standard library fits the bill:<sup id="cha-9_footnote-ref-3" class="footnote"><a href="#cha-9_footnote-3">3</a></sup> it returns a random string of length 22 composed of the characters A–Z, a–z, 0–9, “-”, and “_” (for a total of 64 possibilities, thus “<a href="http://en.wikipedia.org/wiki/Base64" target="_blank" rel="noopener">base64</a>”).<span class="intersentencespace"></span> A typical base64 string appears as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails console
<span class="gp">&gt;</span>&gt; SecureRandom.urlsafe_base64
<span class="go">=&gt; "q5lt38hQDc_959PVoo6b7A"</span>
</pre></div></div>
<p>Just as it’s perfectly fine if two users have the same password,<sup id="cha-9_footnote-ref-4" class="footnote"><a href="#cha-9_footnote-4">4</a></sup> there’s no need for remember tokens to be unique, but it’s more secure if they are.<sup id="cha-9_footnote-ref-5" class="footnote"><a href="#cha-9_footnote-5">5</a></sup><span class="intersentencespace"></span> In the case of the base64 string above, each of the 22 characters has 64 possibilities, so the probability of two remember tokens colliding is a negligibly small <span class="inline_math">\( 1/64^{22} = 2^{-132} \approx 10^{-40} \)</span>.<sup id="cha-9_footnote-ref-6" class="footnote"><a href="#cha-9_footnote-6">6</a></sup><span class="intersentencespace"></span> As a bonus, by using base64 strings specifically designed to be safe in URLs (as indicated by the name <code>urlsafe_base64</code>), we’ll be able to use the same token generator to make account activation and password reset links in <a href="password_reset_fragment.html#cha-password_reset" class="hyperref">Chapter <span class="ref">12</span></a>.</p>
<p>Remembering users involves creating a remember token and saving the digest of the token to the database.<span class="intersentencespace"></span> We’ve already defined a <code>digest</code> method for use in the test fixtures (<a href="basic_login_fragment.html#code-digest_method" class="hyperref">Listing <span class="ref">8.21</span></a>), and we can use the results of the discussion above to create a <code>new_token</code> method to create a new token.<span class="intersentencespace"></span> As with <code>digest</code>, the new token method doesn’t need a user object, so we’ll make it a class method.<sup id="cha-9_footnote-ref-7" class="footnote"><a href="#cha-9_footnote-7">7</a></sup><span class="intersentencespace"></span> The result is the User model shown in <a href="advanced_login_fragment.html#code-token_method" class="hyperref">Listing <span class="ref">9.2</span></a>.</p>
<div class="codelisting" id="code-token_method" data-tralics-id="uid1102" data-number="9.2"><div class="heading"><span class="number">Listing 9.2:</span> 

<span class="description">Adding a method for generating tokens.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
  <span class="n">has_secure_password</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">minimum</span><span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>

  <span class="c1"># Returns the hash digest of the given string.</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">digest</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">SecurePassword</span><span class="o">.</span><span class="n">min_cost</span> <span class="p">?</span> <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">::</span><span class="no">MIN_COST</span> <span class="p">:</span>
                                                  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">.</span><span class="n">cost</span>
    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="ss">cost</span><span class="p">:</span> <span class="n">cost</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Returns a random token.</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">new_token</span>
<span class="hll">    <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Our plan for the implementation is to make a <code>user.remember</code> method that associates a remember token with the user and saves the corresponding remember digest to the database.<span class="intersentencespace"></span> Because of the migration in <a href="advanced_login_fragment.html#code-add_remember_digest_to_users_generated" class="hyperref">Listing <span class="ref">9.1</span></a>, the User model already has a <code>remember_digest</code> attribute, but it doesn’t yet have a <code>remember_token</code> attribute.<span class="intersentencespace"></span> We need a way to make a token available via <code>user.remember_token</code> (for storage in the cookies) <em>without</em> storing it in the database.<span class="intersentencespace"></span> We solved a similar issue with secure passwords in <a href="modeling_users_fragment.html#sec-adding_a_secure_password" class="hyperref">Section <span class="ref">6.3</span></a>, which paired a virtual <code>password</code> attribute with a secure <code>password_digest</code> attribute in the database.<span class="intersentencespace"></span> In that case, the virtual <code>password</code> attribute was created automatically by <code>has_secure_password</code>, but we’ll have to write the code for a <code>remember_token</code> ourselves.<span class="intersentencespace"></span> The way to do this is to use <code>attr_accessor</code> to create an accessible attribute, which we saw before in <a href="rails_flavored_ruby_fragment.html#sec-a_user_class" class="hyperref">Section <span class="ref">4.4.5</span></a>:</p>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="hll">  <span class="kp">attr_accessor</span> <span class="ss">:remember_token</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">remember</span>
<span class="hll">    <span class="nb">self</span><span class="o">.</span><span class="n">remember_token</span> <span class="o">=</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class="hll">    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_digest</span><span class="p">,</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p>Note the form of the assignment in the first line of the <code>remember</code> method.<span class="intersentencespace"></span> Because of the way Ruby handles assignments inside objects, without <code>self</code> the assignment would create a <em>local</em> variable called <code>remember_token</code>, which isn’t what we want.<span class="intersentencespace"></span> Using <code>self</code> ensures that assignment sets the user’s <code>remember_token</code> attribute.<span class="intersentencespace"></span> (Now you know why the <code>before_save</code> callback from <a href="modeling_users_fragment.html#code-email_downcase" class="hyperref">Listing <span class="ref">6.32</span></a> uses <code>self.email</code> instead of just <code>email</code>.)<span class="intersentencespace"></span> Meanwhile, the second line of <code>remember</code> uses the <code>update_attribute</code> method to update the remember digest.<span class="intersentencespace"></span> (As noted in <a href="modeling_users_fragment.html#sec-updating_user_objects" class="hyperref">Section <span class="ref">6.1.5</span></a>, this method bypasses the validations, which is necessary in this case because we don’t have access to the user’s password or confirmation.)</p>
<p>With these considerations in mind, we can create a valid token and associated digest by first making a new remember token using <code>User.new_token</code>, and then updating the remember digest with the result of applying <code>User.digest</code>.<span class="intersentencespace"></span> This procedure gives the <code>remember</code> method shown in <a href="advanced_login_fragment.html#code-user_model_remember" class="hyperref">Listing <span class="ref">9.3</span></a>.</p>
<div class="codelisting" id="code-user_model_remember" data-tralics-id="uid1103" data-number="9.3"><div class="heading"><span class="number">Listing 9.3:</span> 

<span class="description">Adding a <code>remember</code> method to the User model.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="hll">  <span class="kp">attr_accessor</span> <span class="ss">:remember_token</span>
</span>  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
  <span class="n">has_secure_password</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">minimum</span><span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>

  <span class="c1"># Returns the hash digest of the given string.</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">digest</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">SecurePassword</span><span class="o">.</span><span class="n">min_cost</span> <span class="p">?</span> <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">::</span><span class="no">MIN_COST</span> <span class="p">:</span>
                                                  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">.</span><span class="n">cost</span>
    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="ss">cost</span><span class="p">:</span> <span class="n">cost</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Returns a random token.</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">new_token</span>
    <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
  <span class="k">end</span>

  <span class="c1"># Remembers a user in the database for use in persistent sessions.</span>
  <span class="k">def</span> <span class="nf">remember</span>
<span class="hll">    <span class="nb">self</span><span class="o">.</span><span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
</span><span class="hll">    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_digest</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">remember_token</span><span class="p">))</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div>
<div id="sec-exercises_remember_token" data-tralics-id="uid1104" class="subsubsection" data-number="9.1.1.1"><h4><a href="#sec-exercises_remember_token" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>In the console, assign <code>user</code> to the first user in the database, and verify by calling it directly that the <code>remember</code> method works.<span class="intersentencespace"></span> How do <code>remember_token</code> and <code>remember_digest</code> compare? <span class="exercise" id="ex-edf2eb"></span>
</li>
<li>In <a href="advanced_login_fragment.html#code-user_model_remember" class="hyperref">Listing <span class="ref">9.3</span></a>, we defined the new token and digest class methods by explicitly prefixing them with <code>User</code>.<span class="intersentencespace"></span> This works fine and, because they are actually <em>called</em> using <code>User.new_token</code> and <code>User.digest</code>, it is probably the clearest way to define them.<span class="intersentencespace"></span> But there are two perhaps more idiomatically correct ways to define class methods, one slightly confusing and one extremely confusing.<span class="intersentencespace"></span> By running the test suite, verify that the implementations in <a href="advanced_login_fragment.html#code-token_digest_self" class="hyperref">Listing <span class="ref">9.4</span></a> (slightly confusing) and <a href="advanced_login_fragment.html#code-token_digest_class_self" class="hyperref">Listing <span class="ref">9.5</span></a> (extremely confusing) are correct.<span class="intersentencespace"></span> (Note that, in the context of <a href="advanced_login_fragment.html#code-token_digest_self" class="hyperref">Listing <span class="ref">9.4</span></a> and <a href="advanced_login_fragment.html#code-token_digest_class_self" class="hyperref">Listing <span class="ref">9.5</span></a>, <code>self</code> is the <code>User</code> class, whereas the other uses of <code>self</code> in the User model refer to a user object <em>instance</em>.<span class="intersentencespace"></span> This is part of what makes them confusing.) <span class="exercise" id="ex-b22c3e"></span>
</li></ol>
<div class="codelisting" id="code-token_digest_self" data-tralics-id="uid1107" data-number="9.4"><div class="heading"><span class="number">Listing 9.4:</span> 

<span class="description">Defining the new token and digest methods using <code>self</code>.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Returns the hash digest of the given string.</span>
<span class="hll">  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">digest</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
</span>    <span class="n">cost</span> <span class="o">=</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">SecurePassword</span><span class="o">.</span><span class="n">min_cost</span> <span class="p">?</span> <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">::</span><span class="no">MIN_COST</span> <span class="p">:</span>
                                                  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">.</span><span class="n">cost</span>
    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="ss">cost</span><span class="p">:</span> <span class="n">cost</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Returns a random token.</span>
<span class="hll">  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">new_token</span>
</span>    <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="code-token_digest_class_self" data-tralics-id="uid1108" data-number="9.5"><div class="heading"><span class="number">Listing 9.5:</span> 

<span class="description">Defining the new token and digest methods using <code>class &lt;&lt; self</code>.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="hll">  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span>    <span class="c1"># Returns the hash digest of the given string.</span>
<span class="hll">    <span class="k">def</span> <span class="nf">digest</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
</span>      <span class="n">cost</span> <span class="o">=</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">SecurePassword</span><span class="o">.</span><span class="n">min_cost</span> <span class="p">?</span> <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">::</span><span class="no">MIN_COST</span> <span class="p">:</span>
                                                    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">.</span><span class="n">cost</span>
      <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="ss">cost</span><span class="p">:</span> <span class="n">cost</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="c1"># Returns a random token.</span>
<span class="hll">    <span class="k">def</span> <span class="nf">new_token</span>
</span>      <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
</pre></div></div></div></div></div>
<div id="sec-login_with_remembering" data-tralics-id="uid1109" class="subsection" data-number="9.1.2"><h3><a href="advanced_login_fragment.html#sec-login_with_remembering" class="heading hyperref"><span class="number">9.1.2 </span>Login with remembering</a></h3>
<p>Having created a working <code>user.remember</code> method, we’re now in a position to create a persistent session by storing a user’s (encrypted) id and remember token as permanent cookies on the browser.<span class="intersentencespace"></span> The way to do this is with the <code>cookies</code> method, which (as with <code>session</code>) we can treat as a hash.<span class="intersentencespace"></span> A cookie consists of two pieces of information, a <code>value</code> and an optional <code>expires</code> date.<span class="intersentencespace"></span> For example, we could make a persistent session by creating a cookie with value equal to the remember token that expires 20 years from now:</p>
<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">value</span><span class="p">:</span>   <span class="n">remember_token</span><span class="p">,</span>
                             <span class="ss">expires</span><span class="p">:</span> <span class="mi">20</span><span class="o">.</span><span class="n">years</span><span class="o">.</span><span class="n">from_now</span><span class="o">.</span><span class="n">utc</span> <span class="p">}</span>
</pre></div></div>
<p>(This uses one of the convenient Rails time helpers, as discussed in <a href="advanced_login_fragment.html#aside-time_helpers" class="hyperref">Box <span class="ref">9.1</span></a>.)<span class="intersentencespace"></span> This pattern of setting a cookie that expires 20 years in the future is so common that Rails has a special <code>permanent</code> method to implement it, so that we can simply write</p>
<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">remember_token</span>
</pre></div></div>
<p>This causes Rails to set the expiration to <code>20.years.from_now</code> automatically.</p>
<div class="aside" id="aside-time_helpers" data-tralics-id="uid1110" data-number="9.1"><div class="heading"><span class="number">Box 9.1.</span> 

<span class="description">Cookies expire <code class="tt">20.years.from_now</code></span></div>
<p>You may recall from <a href="rails_flavored_ruby_fragment.html#sec-a_class_of_our_own" class="hyperref">Section <span class="ref">4.4.2</span></a> that Ruby lets you add methods to <em>any</em> class, even built-in ones.<span class="intersentencespace"></span> In that section, we added a <code class="tt">palindrome?</code> method to the <code class="tt">String</code> class (and discovered as a result that <code class="tt">"deified"</code> is a palindrome), and we also saw how Rails adds a <code class="tt">blank?</code> method to class <code class="tt">Object</code> (so that <code class="tt">"".blank?</code>, <code class="tt">" ".blank?</code>, and <code class="tt">nil.blank?</code> are all <code class="tt">true</code>).<span class="intersentencespace"></span> The <code class="tt">cookies.permanent</code> method, which creates “permanent” cookies with an expiration <code class="tt">20.years.from_now</code>, gives yet another example of this practice through one of Rails’ <em>time helpers</em>, which are methods added to <code class="tt">Fixnum</code> (the base class for integers):</p>
<pre>  $ rails console
  &gt;&gt; 1.year.from_now
  =&gt; Wed, 21 Jun 2017 19:36:29 UTC +00:00
  &gt;&gt; 10.weeks.ago
  =&gt; Tue, 12 Apr 2016 19:36:44 UTC +00:00</pre>
<p>Rails adds other helpers, too:</p>
<pre>  &gt;&gt; 1.kilobyte
  =&gt; 1024
  &gt;&gt; 5.megabytes
  =&gt; 5242880</pre>
<p>These are useful for upload validations, making it easy to restrict, say, image uploads to <code class="tt">5.megabytes</code>.</p>
<p>Although it should be used with caution, the flexibility to add methods to built-in classes allows for extraordinarily natural additions to plain Ruby.<span class="intersentencespace"></span> Indeed, much of the elegance of Rails ultimately derives from the malleability of the underlying Ruby language.</p>

</div><p>To store the user’s id in the cookies, we could follow the pattern used with the <code>session</code> method (<a href="basic_login_fragment.html#code-log_in_function" class="hyperref">Listing <span class="ref">8.14</span></a>) using something like</p>
<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</pre></div></div>
<p>Because it places the id as plain text, this method exposes the form of the application’s cookies and makes it easier for an attacker to compromise user accounts.<span class="intersentencespace"></span> To avoid this problem, we’ll use a <em>signed</em> cookie, which securely encrypts the cookie before placing it on the browser:<sup id="cha-9_footnote-ref-8" class="footnote"><a href="#cha-9_footnote-8">8</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</pre></div></div>
<p>Because we want the user id to be paired with the permanent remember token, we should make it permanent as well, which we can do by chaining the <code>signed</code> and <code>permanent</code> methods:</p>
<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</pre></div></div>
<p>After the cookies are set, on subsequent page views we can retrieve the user with code like</p>
<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>where <code>cookies.signed[:user_id]</code> automatically decrypts the user id cookie.<span class="intersentencespace"></span> We can then use bcrypt to verify that <code>cookies[:remember_token]</code> matches the <code>remember_digest</code> generated in <a href="advanced_login_fragment.html#code-user_model_remember" class="hyperref">Listing <span class="ref">9.3</span></a>.<span class="intersentencespace"></span> (In case you’re wondering why we don’t just use the signed user id, without the remember token, this would allow an attacker with possession of the encrypted id to log in as the user in perpetuity.<span class="intersentencespace"></span> In the present design, an attacker with both cookies can log in as the user only until the user logs out.)</p>
<p>The final piece of the puzzle is to verify that a given remember token matches the user’s remember digest, and in this context there are a couple of equivalent ways to use bcrypt to verify a match.<span class="intersentencespace"></span> If you look at the <a href="https://github.com/rails/rails/blob/master/activemodel/lib/active_model/secure_password.rb" target="_blank" rel="noopener">secure password source code</a>, you’ll find a comparison like this:<sup id="cha-9_footnote-ref-9" class="footnote"><a href="#cha-9_footnote-9">9</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">password_digest</span><span class="p">)</span> <span class="o">==</span> <span class="n">unencrypted_password</span>
</pre></div></div>
<p>In our case, the analogous code would look like this:</p>
<div class="code"><div class="highlight"><pre><span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">remember_digest</span><span class="p">)</span> <span class="o">==</span> <span class="n">remember_token</span>
</pre></div></div>
<p>If you think about it, this code is really strange: it appears to be comparing a bcrypt password digest directly with a token, which would imply <em>decrypting</em> the digest in order to compare using <code>==</code>.<span class="intersentencespace"></span> But the whole point of using bcrypt is for hashing to be irreversible, so this can’t be right.<span class="intersentencespace"></span> Indeed, digging into the <a href="https://github.com/codahale/bcrypt-ruby/blob/master/lib/bcrypt/password.rb" target="_blank" rel="noopener">source code of the bcrypt gem</a> verifies that the comparison operator <code>==</code> is being <em>redefined</em>, and under the hood the comparison above is equivalent to the following:</p>
<div class="code"><div class="highlight"><pre><span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">remember_digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
</pre></div></div>
<p>Instead of <code>==</code>, this uses the boolean method <code>is_password?</code> to perform the comparison.<span class="intersentencespace"></span> Because its meaning is a little clearer, we’ll prefer this second comparison form in the application code.</p>
<p>The above discussion suggests putting the digest–token comparison into an <code>authenticated?</code> method in the User model, which plays a role similar to that of the <code>authenticate</code> method provided by <code>has_secure_password</code> for authenticating a user (<a href="basic_login_fragment.html#code-log_in_success" class="hyperref">Listing <span class="ref">8.15</span></a>).<span class="intersentencespace"></span> The implementation appears in <a href="advanced_login_fragment.html#code-authenticated_p" class="hyperref">Listing <span class="ref">9.6</span></a>.<span class="intersentencespace"></span> (Although the <code>authenticated?</code> method in <a href="advanced_login_fragment.html#code-authenticated_p" class="hyperref">Listing <span class="ref">9.6</span></a> is tied specifically to the remember digest, it will turn out to be useful in other contexts as well, and we’ll generalize it in <a href="account_activation_fragment.html#cha-account_activation" class="hyperref">Chapter <span class="ref">11</span></a>.)</p>
<div class="codelisting" id="code-authenticated_p" data-tralics-id="uid1113" data-number="9.6"><div class="heading"><span class="number">Listing 9.6:</span> 

<span class="description">Adding an <code>authenticated?</code> method to the User model.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">attr_accessor</span> <span class="ss">:remember_token</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
  <span class="n">has_secure_password</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">minimum</span><span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>

  <span class="c1"># Returns the hash digest of the given string.</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">digest</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">SecurePassword</span><span class="o">.</span><span class="n">min_cost</span> <span class="p">?</span> <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">::</span><span class="no">MIN_COST</span> <span class="p">:</span>
                                                  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">.</span><span class="n">cost</span>
    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="ss">cost</span><span class="p">:</span> <span class="n">cost</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Returns a random token.</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">new_token</span>
    <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
  <span class="k">end</span>

  <span class="c1"># Remembers a user in the database for use in persistent sessions.</span>
  <span class="k">def</span> <span class="nf">remember</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_digest</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">remember_token</span><span class="p">))</span>
  <span class="k">end</span>

  <span class="c1"># Returns true if the given token matches the digest.</span>
  <span class="k">def</span> <span class="nf">authenticated?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
<span class="hll">    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">remember_digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that the <code>remember_token</code> argument in the <code>authenticated?</code> method defined in <a href="advanced_login_fragment.html#code-authenticated_p" class="hyperref">Listing <span class="ref">9.6</span></a> is not the same as the accessor that we defined in <a href="advanced_login_fragment.html#code-user_model_remember" class="hyperref">Listing <span class="ref">9.3</span></a> using <code>attr_accessor :remember_token</code>; instead, it is a variable local to the method.<span class="intersentencespace"></span> (Because the argument refers to the remember token, it is not uncommon to use a method argument that has the same name.)<span class="intersentencespace"></span> Also note the use of the <code>remember_digest</code> attribute, which is the same as <code>self.remember_digest</code> and, like <code>name</code> and <code>email</code> in <a href="modeling_users_fragment.html#cha-modeling_users" class="hyperref">Chapter <span class="ref">6</span></a>, is created automatically by Active Record based on the name of the corresponding database column (<a href="advanced_login_fragment.html#code-add_remember_digest_to_users_generated" class="hyperref">Listing <span class="ref">9.1</span></a>).</p>
<p>We’re now in a position to remember a logged-in user, which we’ll do by adding a <code>remember</code> helper to go along with <code>log_in</code>, as shown in <a href="advanced_login_fragment.html#code-log_in_with_remember" class="hyperref">Listing <span class="ref">9.7</span></a>.</p>
<div class="codelisting" id="code-log_in_with_remember" data-tralics-id="uid1114" data-number="9.7"><div class="heading"><span class="number">Listing 9.7:</span> 

<span class="description">Logging in and remembering a user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="n">log_in</span> <span class="n">user</span>
<span class="hll">      <span class="n">remember</span> <span class="n">user</span>
</span>      <span class="n">redirect_to</span> <span class="n">user</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">log_out</span>
    <span class="n">redirect_to</span> <span class="n">root_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>As with <code>log_in</code>, <a href="advanced_login_fragment.html#code-log_in_with_remember" class="hyperref">Listing <span class="ref">9.7</span></a> defers the real work to the Sessions helper, where we define a <code>remember</code> method that calls <code>user.remember</code>, thereby generating a remember token and saving its digest to the database.<span class="intersentencespace"></span> It then uses <code>cookies</code> to create permanent cookies for the user id and remember token as described above.<span class="intersentencespace"></span> The result appears in <a href="advanced_login_fragment.html#code-remember_method" class="hyperref">Listing <span class="ref">9.8</span></a>.</p>
<div class="codelisting" id="code-remember_method" data-tralics-id="uid1115" data-number="9.8"><div class="heading"><span class="number">Listing 9.8:</span> 

<span class="description">Remembering the user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="c1"># Logs in the given user.</span>
  <span class="k">def</span> <span class="nf">log_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
  <span class="k">end</span>

  <span class="c1"># Remembers a user in a persistent session.</span>
  <span class="k">def</span> <span class="nf">remember</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="hll">    <span class="n">user</span><span class="o">.</span><span class="n">remember</span>
</span><span class="hll">    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</span><span class="hll">    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
</span>  <span class="k">end</span>

  <span class="c1"># Returns the current logged-in user (if any).</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Returns true if the user is logged in, false otherwise.</span>
  <span class="k">def</span> <span class="nf">logged_in?</span>
    <span class="o">!</span><span class="n">current_user</span><span class="o">.</span><span class="n">nil?</span>
  <span class="k">end</span>

  <span class="c1"># Logs out the current user.</span>
  <span class="k">def</span> <span class="nf">log_out</span>
    <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>With the code in <a href="advanced_login_fragment.html#code-remember_method" class="hyperref">Listing <span class="ref">9.8</span></a>, a user logging in will be remembered in the sense that their browser will get a valid remember token, but it doesn’t yet do us any good because the <code>current_user</code> method defined in <a href="basic_login_fragment.html#code-current_user" class="hyperref">Listing <span class="ref">8.16</span></a> knows only about the temporary session:</p>
<div class="code"><div class="highlight"><pre><span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>In the case of persistent sessions, we want to retrieve the user from the temporary session if <code>session[:user_id]</code> exists, but otherwise we should look for <code>cookies[:user_id]</code> to retrieve (and log in) the user corresponding to the persistent session.<span class="intersentencespace"></span> We can accomplish this as follows:</p>
<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span>
  <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
<span class="k">elsif</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
    <span class="n">log_in</span> <span class="n">user</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p>(This follows the same <code>user &amp;&amp; user.authenticated</code> pattern we saw in <a href="basic_login_fragment.html#code-find_authenticate_user" class="hyperref">Listing <span class="ref">8.7</span></a>.)<span class="intersentencespace"></span> The code above will work, but note the repeated use of both <code>session</code> and <code>cookies</code>.<span class="intersentencespace"></span> We can eliminate this duplication as follows:</p>
<div class="code"><div class="highlight"><pre><span class="hll"><span class="k">if</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span>  <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
<span class="hll"><span class="k">elsif</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span>  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
    <span class="n">log_in</span> <span class="n">user</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p>This uses the common but potentially confusing construction</p>
<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>Despite appearances, this is <em>not</em> a comparison (which would use double-equals <code>==</code>), but rather is an <em>assignment</em>.<span class="intersentencespace"></span> If you were to read it in words, you wouldn’t say “If user id equals session of user id…”, but rather something like “If session of user id exists (while setting user id to session of user id)…”.<sup id="cha-9_footnote-ref-10" class="footnote"><a href="#cha-9_footnote-10">10</a></sup></p>
<p>Defining the <code>current_user</code> helper as discussed above leads to the implementation shown in <a href="advanced_login_fragment.html#code-persistent_current_user" class="hyperref">Listing <span class="ref">9.9</span></a>.</p>
<div class="codelisting" id="code-persistent_current_user" data-tralics-id="uid1117" data-number="9.9"><div class="heading"><span class="number">Listing 9.9:</span> 

<span class="description">Updating <code>current_user</code> for persistent sessions.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="c1"># Logs in the given user.</span>
  <span class="k">def</span> <span class="nf">log_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
  <span class="k">end</span>

  <span class="c1"># Remembers a user in a persistent session.</span>
  <span class="k">def</span> <span class="nf">remember</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">user</span><span class="o">.</span><span class="n">remember</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
  <span class="k">end</span>

  <span class="c1"># Returns the user corresponding to the remember token cookie.</span>
  <span class="k">def</span> <span class="nf">current_user</span>
<span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span><span class="hll">      <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
</span><span class="hll">    <span class="k">elsif</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span><span class="hll">      <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
</span><span class="hll">      <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</span><span class="hll">        <span class="n">log_in</span> <span class="n">user</span>
</span><span class="hll">        <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
</span><span class="hll">      <span class="k">end</span>
</span><span class="hll">    <span class="k">end</span>
</span>  <span class="k">end</span>

  <span class="c1"># Returns true if the user is logged in, false otherwise.</span>
  <span class="k">def</span> <span class="nf">logged_in?</span>
    <span class="o">!</span><span class="n">current_user</span><span class="o">.</span><span class="n">nil?</span>
  <span class="k">end</span>

  <span class="c1"># Logs out the current user.</span>
  <span class="k">def</span> <span class="nf">log_out</span>
    <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>With the code as in <a href="advanced_login_fragment.html#code-persistent_current_user" class="hyperref">Listing <span class="ref">9.9</span></a>, newly logged in users are correctly remembered, as you can verify by logging in, closing the browser, and checking that you’re still logged in when you restart the sample application and revisit the sample application.<span class="intersentencespace"></span> If you want, you can even inspect the browser cookies to see the result directly (<a href="advanced_login_fragment.html#fig-cookie_in_browser" class="hyperref">Figure <span class="ref">9.2</span></a>).<sup id="cha-9_footnote-ref-11" class="footnote"><a href="#cha-9_footnote-11">11</a></sup></p>
<div class="center figure" id="fig-cookie_in_browser" data-tralics-id="uid1119" data-number="9.2">
<div class="graphics image box"><img src="images/figures/cookie_in_browser_chrome.png" alt="images/figures/cookie_in_browser_chrome"></div><div class="caption"><span class="header">Figure 9.2: </span><span class="description">The remember token cookie in the local browser.
</span></div></div>
<p>There’s only one problem with our application as it stands: short of clearing their browser cookies (or waiting 20 years), there’s no way for users to log out.<span class="intersentencespace"></span> This is exactly the sort of thing our test suite should catch, and indeed it should currently be <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid1120" data-tralics-id="uid1120" data-number="9.10"><div class="heading"><span class="number">Listing 9.10:</span> <span class="description"><span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div>
<div id="sec-exercises_login_with_remembering" data-tralics-id="uid1121" class="subsubsection" data-number="9.1.2.1"><h4><a href="#sec-exercises_login_with_remembering" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>By finding the cookie in your local browser, verify that a remember token and encrypted user id are present after logging in. <span class="exercise" id="ex-24db9d"></span>
</li>
<li>At the console, verify directly that the <code>authenticated?</code> method defined in <a href="advanced_login_fragment.html#code-authenticated_p" class="hyperref">Listing <span class="ref">9.6</span></a> works correctly. <span class="exercise" id="ex-b9298f"></span>
</li></ol>
</div></div>
<div id="sec-forgetting_users" data-tralics-id="uid1124" class="subsection" data-number="9.1.3"><h3><a href="advanced_login_fragment.html#sec-forgetting_users" class="heading hyperref"><span class="number">9.1.3 </span>Forgetting users</a></h3>
<p>To allow users to log out, we’ll define methods to forget users in analogy with the ones to remember them.<span class="intersentencespace"></span> The resulting <code>user.forget</code> method just undoes <code>user.remember</code> by updating the remember digest with <code>nil</code>, as shown in <a href="advanced_login_fragment.html#code-user_model_forget" class="hyperref">Listing <span class="ref">9.11</span></a>.</p>
<div class="codelisting" id="code-user_model_forget" data-tralics-id="uid1125" data-number="9.11"><div class="heading"><span class="number">Listing 9.11:</span> 

<span class="description">Adding a <code>forget</code> method to the User model.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">attr_accessor</span> <span class="ss">:remember_token</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
  <span class="n">has_secure_password</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">minimum</span><span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>

  <span class="c1"># Returns the hash digest of the given string.</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">digest</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">SecurePassword</span><span class="o">.</span><span class="n">min_cost</span> <span class="p">?</span> <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">::</span><span class="no">MIN_COST</span> <span class="p">:</span>
                                                  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">.</span><span class="n">cost</span>
    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="ss">cost</span><span class="p">:</span> <span class="n">cost</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Returns a random token.</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">new_token</span>
    <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
  <span class="k">end</span>

  <span class="c1"># Remembers a user in the database for use in persistent sessions.</span>
  <span class="k">def</span> <span class="nf">remember</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_digest</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">remember_token</span><span class="p">))</span>
  <span class="k">end</span>

  <span class="c1"># Returns true if the given token matches the digest.</span>
  <span class="k">def</span> <span class="nf">authenticated?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">remember_digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Forgets a user.</span>
  <span class="k">def</span> <span class="nf">forget</span>
<span class="hll">    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_digest</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>With the code in <a href="advanced_login_fragment.html#code-user_model_forget" class="hyperref">Listing <span class="ref">9.11</span></a>, we’re now ready to forget a permanent session by adding a <code>forget</code> helper and calling it from the <code>log_out</code> helper (<a href="advanced_login_fragment.html#code-log_out_with_forget" class="hyperref">Listing <span class="ref">9.12</span></a>).<span class="intersentencespace"></span> As seen in <a href="advanced_login_fragment.html#code-log_out_with_forget" class="hyperref">Listing <span class="ref">9.12</span></a>, the <code>forget</code> helper calls <code>user.forget</code> and then deletes the <code>user_id</code> and <code>remember_token</code> cookies.</p>
<div class="codelisting" id="code-log_out_with_forget" data-tralics-id="uid1126" data-number="9.12"><div class="heading"><span class="number">Listing 9.12:</span> 

<span class="description">Logging out from a persistent session.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="c1"># Logs in the given user.</span>
  <span class="k">def</span> <span class="nf">log_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Forgets a persistent session.</span>
  <span class="k">def</span> <span class="nf">forget</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="hll">    <span class="n">user</span><span class="o">.</span><span class="n">forget</span>
</span><span class="hll">    <span class="n">cookies</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span>
</span><span class="hll">    <span class="n">cookies</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="c1"># Logs out the current user.</span>
  <span class="k">def</span> <span class="nf">log_out</span>
<span class="hll">    <span class="n">forget</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
</span>    <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>At this point, the tests suite should be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid1127" data-tralics-id="uid1127" data-number="9.13"><div class="heading"><span class="number">Listing 9.13:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div>
<div id="sec-exercises_forgetting_users" data-tralics-id="uid1128" class="subsubsection" data-number="9.1.3.1"><h4><a href="#sec-exercises_forgetting_users" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>After logging out, verify that the corresponding cookies have been removed from your browser. <span class="exercise" id="ex-66308a"></span>
</li></ol>
</div></div>
<div id="sec-two_subtle_bugs" data-tralics-id="uid1130" class="subsection" data-number="9.1.4"><h3><a href="advanced_login_fragment.html#sec-two_subtle_bugs" class="heading hyperref"><span class="number">9.1.4 </span>Two subtle bugs</a></h3>
<p>There are two closely related subtleties left to address.<span class="intersentencespace"></span> The first subtlety is that, even though the “Log out” link appears only when logged-in, a user could potentially have multiple browser windows open to the site.<span class="intersentencespace"></span> If the user logged out in one window, thereby setting <code>current_user</code> to <code>nil</code>, clicking the “Log out” link in a second window would result in an error because of <code>forget(current_user)</code> in the <code>log_out</code> method (<a href="advanced_login_fragment.html#code-log_out_with_forget" class="hyperref">Listing <span class="ref">9.12</span></a>).<sup id="cha-9_footnote-ref-12" class="footnote"><a href="#cha-9_footnote-12">12</a></sup><span class="intersentencespace"></span> We can avoid this by logging out only if the user is logged in.</p>
<p>The second subtlety is that a user could be logged in (and remembered) in multiple browsers, such as Chrome and Firefox, which causes a problem if the user logs out in the first browser but not the second, and then closes and re-opens the second one.<sup id="cha-9_footnote-ref-13" class="footnote"><a href="#cha-9_footnote-13">13</a></sup><span class="intersentencespace"></span> For example, suppose that the user logs out in Firefox, thereby setting the remember digest to <code>nil</code> (via <code>user.forget</code> in <a href="advanced_login_fragment.html#code-user_model_forget" class="hyperref">Listing <span class="ref">9.11</span></a>).<span class="intersentencespace"></span> The application will still work in Firefox; because the <code>log_out</code> method in <a href="advanced_login_fragment.html#code-log_out_with_forget" class="hyperref">Listing <span class="ref">9.12</span></a> deletes the user’s id, both highlighted conditionals are <code>false</code>:</p>
<div class="code"><div class="highlight"><pre><span class="c1"># Returns the user corresponding to the remember token cookie.</span>
<span class="k">def</span> <span class="nf">current_user</span>
<span class="hll">  <span class="k">if</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span>    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
<span class="hll">  <span class="k">elsif</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span>    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
      <span class="n">log_in</span> <span class="n">user</span>
      <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p>As a result, evaluation falls off the end of the <code>current_user</code> method, thereby returning <code>nil</code> as required.</p>
<p>In contrast, if we close Chrome, we set <code>session[:user_id]</code> to <code>nil</code> (because all <code>session</code> variables expire automatically on browser close), but the <code>user_id</code> <em>cookie</em> will still be present.<span class="intersentencespace"></span> This means that the corresponding user will still be pulled out of the database when Chrome is re-launched:</p>
<div class="code"><div class="highlight"><pre><span class="c1"># Returns the user corresponding to the remember token cookie.</span>
<span class="k">def</span> <span class="nf">current_user</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
<span class="hll">  <span class="k">elsif</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span><span class="hll">    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
</span><span class="hll">    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</span>      <span class="n">log_in</span> <span class="n">user</span>
      <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p>Consequently, the inner <code>if</code> conditional will be evaluated:</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>In particular, because <code>user</code> isn’t <code>nil</code>, the <em>second</em> expression will be evaluated, which raises an error.<span class="intersentencespace"></span> This is because the user’s remember digest was deleted as part of logging out (<a href="advanced_login_fragment.html#code-user_model_forget" class="hyperref">Listing <span class="ref">9.11</span></a>) in Firefox, so when we access the application in Chrome we end up calling</p>
<div class="code"><div class="highlight"><pre><span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">remember_digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
</pre></div></div>
<p>with a <code>nil</code> remember digest, thereby raising an exception inside the bcrypt library.<span class="intersentencespace"></span> To fix this, we want <code>authenticated?</code> to return <code>false</code> instead.</p>
<p>These are exactly the sorts of subtleties that benefit from test-driven development, so we’ll write tests to catch the two errors before correcting them.<span class="intersentencespace"></span> We first get the integration test from <a href="basic_login_fragment.html#code-user_logout_test" class="hyperref">Listing <span class="ref">8.31</span></a> to <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>, as shown in <a href="advanced_login_fragment.html#code-test_double_logout" class="hyperref">Listing <span class="ref">9.14</span></a>.</p>
<div class="codelisting" id="code-test_double_logout" data-tralics-id="uid1133" data-number="9.14"><div class="heading"><span class="number">Listing 9.14:</span> 

<span class="description">A test for user logout.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_login_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersLoginTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"login with valid information followed by logout"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">login_path</span>
    <span class="n">post</span> <span class="n">login_path</span><span class="p">,</span> <span class="ss">params</span><span class="p">:</span> <span class="p">{</span> <span class="ss">session</span><span class="p">:</span> <span class="p">{</span> <span class="ss">email</span><span class="p">:</span>    <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                                          <span class="ss">password</span><span class="p">:</span> <span class="s1">'password'</span> <span class="p">}</span> <span class="p">}</span>
    <span class="n">assert</span> <span class="n">is_logged_in?</span>
    <span class="n">assert_redirected_to</span> <span class="vi">@user</span>
    <span class="n">follow_redirect!</span>
    <span class="n">assert_template</span> <span class="s1">'users/show'</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">login_path</span><span class="p">,</span> <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">logout_path</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">delete</span> <span class="n">logout_path</span>
    <span class="n">assert_not</span> <span class="n">is_logged_in?</span>
    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
<span class="hll">    <span class="c1"># Simulate a user clicking logout in a second window.</span>
</span><span class="hll">    <span class="n">delete</span> <span class="n">logout_path</span>
</span>    <span class="n">follow_redirect!</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">login_path</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">logout_path</span><span class="p">,</span>      <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The second call to <code>delete logout_path</code> in <a href="advanced_login_fragment.html#code-test_double_logout" class="hyperref">Listing <span class="ref">9.14</span></a> should raise an error due to the missing <code>current_user</code>, leading to a <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span> test suite:</p>
<div class="codelisting" id="uid1134" data-tralics-id="uid1134" data-number="9.15"><div class="heading"><span class="number">Listing 9.15:</span> <span class="description"><span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div><p>The application code simply involves calling <code>log_out</code> only if <code>logged_in?</code> is true, as shown in <a href="advanced_login_fragment.html#code-destroy_forget" class="hyperref">Listing <span class="ref">9.16</span></a>.</p>
<div class="codelisting" id="code-destroy_forget" data-tralics-id="uid1135" data-number="9.16"><div class="heading"><span class="number">Listing 9.16:</span> 

<span class="description">Only logging out if logged in.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
<span class="hll">    <span class="n">log_out</span> <span class="k">if</span> <span class="n">logged_in?</span>
</span>    <span class="n">redirect_to</span> <span class="n">root_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The second case, involving a scenario with two different browsers, is harder to simulate with an integration test, but it’s easy to check in the User model test directly.<span class="intersentencespace"></span> All we need is to start with a user that has no remember digest (which is true for the <code>@user</code> variable defined in the <code>setup</code> method) and then call <code>authenticated?</code>, as shown in <a href="advanced_login_fragment.html#code-test_authenticated_invalid_token" class="hyperref">Listing <span class="ref">9.17</span></a>.<span class="intersentencespace"></span> (Note that we’ve just left the remember token blank; it doesn’t matter what its value is, because the error occurs before it ever gets used.)</p>
<div class="codelisting" id="code-test_authenticated_invalid_token" data-tralics-id="uid1136" data-number="9.17"><div class="heading"><span class="number">Listing 9.17:</span> 

<span class="description">A test of <code>authenticated?</code> with a nonexistent digest.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                     <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="hll">  <span class="nb">test</span> <span class="s2">"authenticated? should return false for a user with nil digest"</span> <span class="k">do</span>
</span><span class="hll">    <span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="k">end</span>
</pre></div></div></div><p>Because <code>BCrypt::Password.new(nil)</code> raises an error, the test suite should now be <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid1137" data-tralics-id="uid1137" data-number="9.18"><div class="heading"><span class="number">Listing 9.18:</span> <span class="description"><span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div><p>To fix the error and get to <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>, all we need to do is return <code>false</code> if the remember digest is <code>nil</code>, as shown in <a href="advanced_login_fragment.html#code-authenticated_p_fixed" class="hyperref">Listing <span class="ref">9.19</span></a>.</p>
<div class="codelisting" id="code-authenticated_p_fixed" data-tralics-id="uid1138" data-number="9.19"><div class="heading"><span class="number">Listing 9.19:</span> 

<span class="description">Updating <code>authenticated?</code> to handle a nonexistent digest.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Returns true if the given token matches the digest.</span>
  <span class="k">def</span> <span class="nf">authenticated?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
<span class="hll">    <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">remember_digest</span><span class="o">.</span><span class="n">nil?</span>
</span>    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">remember_digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Forgets a user.</span>
  <span class="k">def</span> <span class="nf">forget</span>
    <span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_digest</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>This uses the <code>return</code> keyword to return immediately if the remember digest is <code>nil</code>, which is a common way to emphasize that the rest of the method gets ignored in that case.<span class="intersentencespace"></span> The equivalent code</p>
<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="n">remember_digest</span><span class="o">.</span><span class="n">nil?</span>
  <span class="kp">false</span>
<span class="k">else</span>
  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">remember_digest</span><span class="p">)</span><span class="o">.</span><span class="n">is_password?</span><span class="p">(</span><span class="n">remember_token</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p>would also work fine, but I prefer the explicitness of the version in <a href="advanced_login_fragment.html#code-authenticated_p_fixed" class="hyperref">Listing <span class="ref">9.19</span></a> (which also happens to be slightly shorter).</p>
<p>With the code in <a href="advanced_login_fragment.html#code-authenticated_p_fixed" class="hyperref">Listing <span class="ref">9.19</span></a>, our full test suite should be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>, and both subtleties should now be addressed:</p>
<div class="codelisting" id="uid1139" data-tralics-id="uid1139" data-number="9.20"><div class="heading"><span class="number">Listing 9.20:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div>
<div id="sec-exercises_two_subtle_bugs" data-tralics-id="uid1140" class="subsubsection" data-number="9.1.4.1"><h4><a href="#sec-exercises_two_subtle_bugs" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Comment out the fix in <a href="advanced_login_fragment.html#code-destroy_forget" class="hyperref">Listing <span class="ref">9.16</span></a> and then verify that the first subtle bug is present by opening two logged-in tabs, logging out in one, and then clicking “Log out” link in the other. <span class="exercise" id="ex-9e210e"></span>
</li>
<li>Comment out the fix in <a href="advanced_login_fragment.html#code-authenticated_p_fixed" class="hyperref">Listing <span class="ref">9.19</span></a> and verify that the second subtle bug is present by logging out in one browser and closing and opening the second browser. <span class="exercise" id="ex-38d59c"></span>
</li>
<li>Uncomment the fixes and confirm that the test suite goes from <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span> to <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>. <span class="exercise" id="ex-cf8af9"></span>
</li></ol>
</div></div></div><div id="sec-remember_me_checkbox" data-tralics-id="cid51" class="section" data-number="9.2"><h2><a href="advanced_login_fragment.html#sec-remember_me_checkbox" class="heading hyperref"><span class="number">9.2 </span>“Remember me” checkbox</a></h2>
<p>With the code in <a href="advanced_login_fragment.html#sec-forgetting_users" class="hyperref">Section <span class="ref">9.1.3</span></a>, our application has a complete, professional-grade authentication system.<span class="intersentencespace"></span> As a final step, we’ll see how to make staying logged in optional using a “remember me” checkbox.<span class="intersentencespace"></span> A mockup of the login form with such a checkbox appears in <a href="advanced_login_fragment.html#fig-login_remember_me_mockup" class="hyperref">Figure <span class="ref">9.3</span></a>.</p>
<div class="center figure" id="fig-login_remember_me_mockup" data-tralics-id="uid1144" data-number="9.3">
<div class="graphics image box"><img src="images/figures/login_remember_me_mockup.png" alt="images/figures/login_remember_me_mockup"></div><div class="caption"><span class="header">Figure 9.3: </span><span class="description">A mockup of a “remember me” checkbox.
</span></div></div>
<p>To write the implementation, we start by adding a checkbox to the login form from <a href="basic_login_fragment.html#code-login_form" class="hyperref">Listing <span class="ref">8.4</span></a>.<span class="intersentencespace"></span> As with labels, text fields, password fields, and submit buttons, checkboxes can be created with a Rails helper method.<span class="intersentencespace"></span> In order to get the styling right, though, we have to <em>nest</em> the checkbox inside the label, as follows:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:remember_me</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"checkbox inline"</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">check_box</span> <span class="ss">:remember_me</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;span&gt;</span>Remember me on this computer<span class="nt">&lt;/span&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>Putting this into the login form gives the code shown in <a href="advanced_login_fragment.html#code-remember_me_checkbox" class="hyperref">Listing <span class="ref">9.21</span></a>.</p>
<div class="codelisting" id="code-remember_me_checkbox" data-tralics-id="uid1145" data-number="9.21"><div class="heading"><span class="number">Listing 9.21:</span> 

<span class="description">Adding a “remember me” checkbox to the login form.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/sessions/new.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Log in"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Log in<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6 col-md-offset-3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">url</span><span class="p">:</span> <span class="n">login_path</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">email_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

<span class="hll">      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:remember_me</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"checkbox inline"</span> <span class="k">do</span> <span class="cp">%&gt;</span>
</span><span class="hll">        <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">check_box</span> <span class="ss">:remember_me</span> <span class="cp">%&gt;</span>
</span><span class="hll">        <span class="nt">&lt;span&gt;</span>Remember me on this computer<span class="nt">&lt;/span&gt;</span>
</span><span class="hll">      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Log in"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="nt">&lt;p&gt;</span>New user? <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign up now!"</span><span class="p">,</span> <span class="n">signup_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div><p>In <a href="advanced_login_fragment.html#code-remember_me_checkbox" class="hyperref">Listing <span class="ref">9.21</span></a>, we’ve included the CSS classes <code>checkbox</code> and <code>inline</code>, which Bootstrap uses to put the checkbox and the text (“Remember me on this computer”) in the same line.<span class="intersentencespace"></span> In order to complete the styling, we need just a few more CSS rules, as shown in <a href="advanced_login_fragment.html#code-remember_me_css" class="hyperref">Listing <span class="ref">9.22</span></a>.<span class="intersentencespace"></span> The resulting login form appears in <a href="advanced_login_fragment.html#fig-login_form_remember_me" class="hyperref">Figure <span class="ref">9.4</span></a>.</p>
<div class="codelisting" id="code-remember_me_css" data-tralics-id="uid1146" data-number="9.22"><div class="heading"><span class="number">Listing 9.22:</span> 

<span class="description">CSS for the “remember me” checkbox.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/assets/stylesheets/custom.scss</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="o">/*</span> <span class="nt">forms</span> <span class="o">*/</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.checkbox</span> <span class="p">{</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">-10</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="nt">span</span> <span class="p">{</span>
    <span class="na">margin-left</span><span class="o">:</span> <span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
    <span class="na">font-weight</span><span class="o">:</span> <span class="no">normal</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nn">#session_remember_me</span> <span class="p">{</span>
  <span class="na">width</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
  <span class="na">margin-left</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div></div><div class="center figure" id="fig-login_form_remember_me" data-tralics-id="uid1147" data-number="9.4">
<div class="graphics image"><img src="images/figures/login_form_remember_me.png" alt="images/figures/login_form_remember_me"></div><div class="caption"><span class="header">Figure 9.4: </span><span class="description">The login form with an added “remember me” checkbox.
</span></div></div>
<p>Having edited the login form, we’re now ready to remember users if they check the checkbox and forget them otherwise.<span class="intersentencespace"></span> Incredibly, because of all our work in the previous sections, the implementation can be reduced to one line.<span class="intersentencespace"></span> We start by noting that the <code>params</code> hash for submitted login forms now includes a value based on the checkbox (as you can verify by submitting the form in <a href="advanced_login_fragment.html#code-remember_me_checkbox" class="hyperref">Listing <span class="ref">9.21</span></a> with invalid information and inspecting the values in the debug section of the page).<span class="intersentencespace"></span> In particular, the value of</p>
<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:remember_me</span><span class="o">]</span>
</pre></div></div>
<p>is <code>’1’</code> if the box is checked and <code>’0’</code> if it isn’t.</p>
<p>By testing the relevant value of the <code>params</code> hash, we can now remember or forget the user based on the value of the submission:<sup id="cha-9_footnote-ref-14" class="footnote"><a href="#cha-9_footnote-14">14</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="o">==</span> <span class="s1">'1'</span>
  <span class="n">remember</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="k">else</span>
  <span class="n">forget</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p>As explained in <a href="advanced_login_fragment.html#aside-ternary_operator" class="hyperref">Box <span class="ref">9.2</span></a>, this sort of <code>if</code>-<code>then</code> branching structure can be converted to one line using the <em>ternary operator</em> as follows:<sup id="cha-9_footnote-ref-15" class="footnote"><a href="#cha-9_footnote-15">15</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="o">==</span> <span class="s1">'1'</span> <span class="p">?</span> <span class="n">remember</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">:</span> <span class="n">forget</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div></div>
<p>Adding this to the Sessions controller’s <code>create</code> method leads to the amazingly compact code shown in <a href="advanced_login_fragment.html#code-remember_me_ternary" class="hyperref">Listing <span class="ref">9.23</span></a>.<span class="intersentencespace"></span> (Now you’re in a position to understand the code in <a href="basic_login_fragment.html#code-digest_method" class="hyperref">Listing <span class="ref">8.21</span></a>, which uses the ternary operator to define the bcrypt <code>cost</code> variable.)</p>
<div class="codelisting" id="code-remember_me_ternary" data-tralics-id="uid1150" data-number="9.23"><div class="heading"><span class="number">Listing 9.23:</span> 

<span class="description">Handling the submission of the “remember me” checkbox.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="n">log_in</span> <span class="n">user</span>
<span class="hll">      <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="o">==</span> <span class="s1">'1'</span> <span class="p">?</span> <span class="n">remember</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">:</span> <span class="n">forget</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span>      <span class="n">redirect_to</span> <span class="n">user</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">log_out</span> <span class="k">if</span> <span class="n">logged_in?</span>
    <span class="n">redirect_to</span> <span class="n">root_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>With the implementation in <a href="advanced_login_fragment.html#code-remember_me_ternary" class="hyperref">Listing <span class="ref">9.23</span></a>, our login system is complete, as you can verify by checking or unchecking the box in your browser.</p>
<div class="aside" id="aside-ternary_operator" data-tralics-id="uid1151" data-number="9.2"><div class="heading"><span class="number">Box 9.2.</span> 

<span class="description">10 types of people</span></div>
<p>There’s an old joke that there are 10 kinds of people in the world: those who understand binary and those who don’t (10, of course, being 2 in binary).<span class="intersentencespace"></span> In this spirit, we can say that there are 10 kinds of people in the world: those who like the ternary operator, those who don’t, and those who don’t yet know about it.<span class="intersentencespace"></span> (If you happen to be in the third category, soon you won’t be any longer.)</p>
<p>When you do a lot of programming, you quickly learn that one of the most common bits of control flow goes something like this:</p>
<pre>  if boolean?
    do_one_thing
  else
    do_something_else
  end</pre>
<p>Ruby, like many other languages (including C/C++, Perl, PHP, and Java), allows you to replace this with a much more compact expression using the <em>ternary operator</em> (so called because it consists of three parts):</p>
<pre>  boolean? ? do_one_thing : do_something_else</pre>
<p>You can also use the ternary operator to replace assignment, so that</p>
<pre>  if boolean?
    var = foo
  else
    var = bar
  end</pre>
<p>becomes</p>
<pre>  var = boolean? ? foo : bar</pre>
<p>Finally, it’s often convenient to use the ternary operator in a function’s return value:</p>
<pre>  def foo
    do_stuff
    boolean? ? "bar" : "baz"
  end</pre>
<p>Since Ruby implicitly returns the value of the last expression in a function, here the <code class="tt">foo</code> method returns <code class="tt">"bar"</code> or <code class="tt">"baz"</code> depending on whether <code class="tt">boolean?</code> is <code class="tt">true</code> or <code class="tt">false</code>.</p>

</div>
<div id="sec-exercises_remember_me" data-tralics-id="uid1152" class="subsubsection" data-number="9.2.4.2"><h4><a href="#sec-exercises_remember_me" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>By inspecting your browser’s cookies directly, verify that the “remember me” checkbox is having its intended effect. <span class="exercise" id="ex-0c1e96"></span>
</li>
<li>At the console, invent examples showing both possible behaviors of the ternary operator (<a href="advanced_login_fragment.html#aside-ternary_operator" class="hyperref">Box <span class="ref">9.2</span></a>). <span class="exercise" id="ex-63ac73"></span>
</li></ol>
</div></div><div id="sec-remember_tests" data-tralics-id="cid52" class="section" data-number="9.3"><h2><a href="advanced_login_fragment.html#sec-remember_tests" class="heading hyperref"><span class="number">9.3 </span>Remember tests</a></h2>
<p>Although our “remember me” functionality is now working, it’s important to write some tests to verify its behavior.<span class="intersentencespace"></span> One reason is to catch implementation errors, as discussed in a moment.<span class="intersentencespace"></span> Even more important, though, is that the core user persistence code is in fact completely untested at present.<span class="intersentencespace"></span> Fixing these issues will require some trickery, but the result will be a far more powerful test suite.</p>
<div id="sec-testing_the_remember_me_box" data-tralics-id="uid1155" class="subsection" data-number="9.3.1"><h3><a href="advanced_login_fragment.html#sec-testing_the_remember_me_box" class="heading hyperref"><span class="number">9.3.1 </span>Testing the “remember me” box</a></h3>
<p>When I originally implemented the checkbox handling in <a href="advanced_login_fragment.html#code-remember_me_ternary" class="hyperref">Listing <span class="ref">9.23</span></a>, instead of the correct</p>
<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="o">==</span> <span class="s1">'1'</span> <span class="p">?</span> <span class="n">remember</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">:</span> <span class="n">forget</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div></div>
<p>I actually used</p>
<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="p">?</span> <span class="n">remember</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">:</span> <span class="n">forget</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div></div>
<p>In this context, <code>params[:session][:remember_me]</code> is either <code>’0’</code> or <code>’1’</code>, both of which are <code>true</code> in a boolean context, so the resulting expression is <em>always true</em>, and the application acts as if the checkbox is always checked.<span class="intersentencespace"></span> This is exactly the kind of error a test can catch.</p>
<p>Because remembering users requires that they be logged in, our first step is to define a helper to log users in inside tests.<span class="intersentencespace"></span> In <a href="basic_login_fragment.html#code-user_login_test_valid_information" class="hyperref">Listing <span class="ref">8.23</span></a>, we logged a user in using the <code>post</code> method and a valid <code>session</code> hash, but it’s cumbersome to do this every time.<span class="intersentencespace"></span> To avoid needless repetition, we’ll write a helper method called <code>log_in_as</code> to log in for us.</p>
<p>Our method for logging a user in depends on the type of test.<span class="intersentencespace"></span> Inside controller tests, we can manipulate the <code>session</code> method directly, assigning <code>user.id</code> to the <code>:user_id</code> key (as first seen in <a href="basic_login_fragment.html#code-log_in_function" class="hyperref">Listing <span class="ref">8.14</span></a>):</p>
<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">log_in_as</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
<span class="k">end</span>
</pre></div></div>
<p>We call the method <code>log_in_as</code> to avoid any confusion with the application code’s <code>log_in</code> method as defined in <a href="basic_login_fragment.html#code-log_in_function" class="hyperref">Listing <span class="ref">8.14</span></a>.<span class="intersentencespace"></span> Its location is in the <code>ActiveSupport::TestCase</code> class inside the <code>test_helper</code> file, the same location as the <code>is_logged_in?</code> helper from <a href="basic_login_fragment.html#code-test_helper_sessions" class="hyperref">Listing <span class="ref">8.26</span></a>:</p>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="n">fixtures</span> <span class="ss">:all</span>

  <span class="c1"># Returns true if a test user is logged in.</span>
  <span class="k">def</span> <span class="nf">is_logged_in?</span>
    <span class="o">!</span><span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">].</span><span class="n">nil?</span>
  <span class="k">end</span>

  <span class="c1"># Log in as a particular user.</span>
  <span class="k">def</span> <span class="nf">log_in_as</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p>We won’t actually need this version of the method in this chapter, but we’ll put it to use in <a href="updating_and_deleting_users_fragment.html#cha-updating_showing_and_deleting_users" class="hyperref">Chapter <span class="ref">10</span></a>.</p>
<p>Inside integration tests, we can’t manipulate <code>session</code> directly, but we can <code>post</code> to the sessions path as in <a href="basic_login_fragment.html#code-user_login_test_valid_information" class="hyperref">Listing <span class="ref">8.23</span></a>, which leads to the <code>log_in_as</code> method shown here:</p>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="c1"># Log in as a particular user.</span>
  <span class="k">def</span> <span class="nf">log_in_as</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="ss">password</span><span class="p">:</span> <span class="s1">'password'</span><span class="p">,</span> <span class="ss">remember_me</span><span class="p">:</span> <span class="s1">'1'</span><span class="p">)</span>
    <span class="n">post</span> <span class="n">login_path</span><span class="p">,</span> <span class="ss">params</span><span class="p">:</span> <span class="p">{</span> <span class="ss">session</span><span class="p">:</span> <span class="p">{</span> <span class="ss">email</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                                          <span class="ss">password</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
                                          <span class="ss">remember_me</span><span class="p">:</span> <span class="n">remember_me</span> <span class="p">}</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p>Because it’s located inside the <code>ActionDispatch::IntegrationTest</code> class, this is the version of <code>log_in_as</code> that will be called inside integration tests.<span class="intersentencespace"></span> We use the same method name in both cases because it lets us do things like use code from a controller test in an integration without making any changes to the login method.</p>
<p>Putting these two methods together yields the parallel <code>log_in_as</code> helpers shown in <a href="advanced_login_fragment.html#code-test_helper_log_in" class="hyperref">Listing <span class="ref">9.24</span></a>.</p>
<div class="codelisting" id="code-test_helper_log_in" data-tralics-id="uid1156" data-number="9.24"><div class="heading"><span class="number">Listing 9.24:</span> 

<span class="description">Adding a <code>log_in_as</code> helper.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">test/test_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">ENV</span><span class="o">[</span><span class="s1">'RAILS_ENV'</span><span class="o">]</span> <span class="o">||=</span> <span class="s1">'test'</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="k">class</span> <span class="nc">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="n">fixtures</span> <span class="ss">:all</span>

  <span class="c1"># Returns true if a test user is logged in.</span>
  <span class="k">def</span> <span class="nf">is_logged_in?</span>
    <span class="o">!</span><span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">].</span><span class="n">nil?</span>
  <span class="k">end</span>

  <span class="c1"># Log in as a particular user.</span>
<span class="hll">  <span class="k">def</span> <span class="nf">log_in_as</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span>    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="c1"># Log in as a particular user.</span>
<span class="hll">  <span class="k">def</span> <span class="nf">log_in_as</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="ss">password</span><span class="p">:</span> <span class="s1">'password'</span><span class="p">,</span> <span class="ss">remember_me</span><span class="p">:</span> <span class="s1">'1'</span><span class="p">)</span>
</span>    <span class="n">post</span> <span class="n">login_path</span><span class="p">,</span> <span class="ss">params</span><span class="p">:</span> <span class="p">{</span> <span class="ss">session</span><span class="p">:</span> <span class="p">{</span> <span class="ss">email</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                                          <span class="ss">password</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
                                          <span class="ss">remember_me</span><span class="p">:</span> <span class="n">remember_me</span> <span class="p">}</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that, for maximum flexibility, the second <code>log_in_as</code> method in <a href="advanced_login_fragment.html#code-test_helper_log_in" class="hyperref">Listing <span class="ref">9.24</span></a> accepts keyword arguments (as in <a href="sign_up_fragment.html#code-gravatar_keyword" class="hyperref">Listing <span class="ref">7.13</span></a>), with default values for the password and for the “remember me” checkbox set to <code>’password’</code> and <code>’1’</code>, respectively.</p>
<p>To verify the behavior of the “remember me” checkbox, we’ll write two tests, one each for submitting with and without the checkbox checked.<span class="intersentencespace"></span> This is easy using the login helper defined in <a href="advanced_login_fragment.html#code-test_helper_log_in" class="hyperref">Listing <span class="ref">9.24</span></a>, with the two cases appearing as</p>
<div class="code"><div class="highlight"><pre><span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="ss">remember_me</span><span class="p">:</span> <span class="s1">'1'</span><span class="p">)</span>
</pre></div></div>
<p>and</p>
<div class="code"><div class="highlight"><pre><span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="ss">remember_me</span><span class="p">:</span> <span class="s1">'0'</span><span class="p">)</span>
</pre></div></div>
<p>(Because <code>’1’</code> is the default value of <code>remember_me</code>, we could omit the corresponding option in the first case above, but I’ve included it to make the parallel structure more apparent.)</p>
<p>After logging in, we can check if the user has been remembered by looking for the <code>remember_token</code> key in the <code>cookies</code>.<span class="intersentencespace"></span> Ideally, we would check that the cookie’s value is equal to the user’s remember token, but as currently designed there’s no way for the test to get access to it: the <code>user</code> variable in the controller has a remember token attribute, but (because <code>remember_token</code> is virtual) the <code>@user</code> variable in the test doesn’t.<span class="intersentencespace"></span> Fixing this minor blemish is left as an exercise (<a href="advanced_login_fragment.html#sec-exercises_testing_the_remember_me_box" class="hyperref">Section <span class="ref">9.3.1.1</span></a>), but for now we can just test to see if the relevant cookie is <code>nil</code> or not.</p>
<p>There’s one more subtlety, which is that for some reason inside tests the <code>cookies</code> method doesn’t work with symbols as keys, so that</p>
<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span>
</pre></div></div>
<p>is always <code>nil</code>.<span class="intersentencespace"></span> Luckily, <code>cookies</code> <em>does</em> work with string keys, so that</p>
<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">[</span><span class="s1">'remember_token'</span><span class="o">]</span>
</pre></div></div>
<p>has the value we need.<span class="intersentencespace"></span> The resulting tests appear in <a href="advanced_login_fragment.html#code-remember_me_test" class="hyperref">Listing <span class="ref">9.25</span></a>.<span class="intersentencespace"></span> (Recall from <a href="basic_login_fragment.html#code-user_login_test_valid_information" class="hyperref">Listing <span class="ref">8.23</span></a> that <code>users(:michael)</code> references the fixture user from <a href="basic_login_fragment.html#code-real_user_fixture" class="hyperref">Listing <span class="ref">8.22</span></a>.)</p>
<div class="codelisting" id="code-remember_me_test" data-tralics-id="uid1157" data-number="9.25"><div class="heading"><span class="number">Listing 9.25:</span> 

<span class="description">A test of the “remember me” checkbox.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_login_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersLoginTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"login with remembering"</span> <span class="k">do</span>
<span class="hll">    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="ss">remember_me</span><span class="p">:</span> <span class="s1">'1'</span><span class="p">)</span>
</span><span class="hll">    <span class="n">assert_not_empty</span> <span class="n">cookies</span><span class="o">[</span><span class="s1">'remember_token'</span><span class="o">]</span>
</span>  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"login without remembering"</span> <span class="k">do</span>
<span class="hll">    <span class="c1"># Log in to set the cookie.</span>
</span><span class="hll">    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="ss">remember_me</span><span class="p">:</span> <span class="s1">'1'</span><span class="p">)</span>
</span><span class="hll">    <span class="c1"># Log in again and verify that the cookie is deleted.</span>
</span><span class="hll">    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="ss">remember_me</span><span class="p">:</span> <span class="s1">'0'</span><span class="p">)</span>
</span><span class="hll">    <span class="n">assert_empty</span> <span class="n">cookies</span><span class="o">[</span><span class="s1">'remember_token'</span><span class="o">]</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Assuming you didn’t make the same implementation mistake I did, the tests should be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid1158" data-tralics-id="uid1158" data-number="9.26"><div class="heading"><span class="number">Listing 9.26:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div>
<div id="sec-exercises_testing_the_remember_me_box" data-tralics-id="uid1159" class="subsubsection" data-number="9.3.1.1"><h4><a href="#sec-exercises_testing_the_remember_me_box" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>As mentioned above, the application currently doesn’t have any way to access the virtual <code>remember_token</code> attribute in the integration test in <a href="advanced_login_fragment.html#code-remember_me_test" class="hyperref">Listing <span class="ref">9.25</span></a>.<span class="intersentencespace"></span> It is possible, though, using a special test method called <code>assigns</code>.<span class="intersentencespace"></span> Inside a test, you can access <em>instance</em> variables defined in the controller by using <code>assigns</code> with the corresponding symbol.<span class="intersentencespace"></span> For example, if the <code>create</code> action defines an <code>@user</code> variable, we can access it in the test using <code>assigns(:user)</code>.<span class="intersentencespace"></span> Right now, the Sessions controller <code>create</code> action defines a normal (non-instance) variable called <code>user</code>, but if we change it to an instance variable we can test that <code>cookies</code> correctly contains the user’s remember token.<span class="intersentencespace"></span> By filling in the missing elements in <a href="advanced_login_fragment.html#code-login_create_user_instance" class="hyperref">Listing <span class="ref">9.27</span></a> and <a href="advanced_login_fragment.html#code-improved_remember_me_test" class="hyperref">Listing <span class="ref">9.28</span></a> (indicated with question marks <code>?</code> and <code>FILL_IN</code>), complete this improved test of the “remember me” checkbox. <span class="exercise" id="ex-4c19e7"></span>
</li></ol>
<div class="codelisting" id="code-login_create_user_instance" data-tralics-id="uid1161" data-number="9.27"><div class="heading"><span class="number">Listing 9.27:</span> 

<span class="description">A template for using an instance variable in the <code>create</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
<span class="hll">    <span class="p">?</span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
</span><span class="hll">    <span class="k">if</span> <span class="p">?</span><span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="p">?</span><span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
</span><span class="hll">      <span class="n">log_in</span> <span class="p">?</span><span class="n">user</span>
</span><span class="hll">      <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="o">==</span> <span class="s1">'1'</span> <span class="p">?</span> <span class="n">remember</span><span class="p">(?</span><span class="n">user</span><span class="p">)</span> <span class="p">:</span> <span class="n">forget</span><span class="p">(?</span><span class="n">user</span><span class="p">)</span>
</span><span class="hll">      <span class="n">redirect_to</span> <span class="p">?</span><span class="n">user</span>
</span>    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">log_out</span> <span class="k">if</span> <span class="n">logged_in?</span>
    <span class="n">redirect_to</span> <span class="n">root_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="code-improved_remember_me_test" data-tralics-id="uid1162" data-number="9.28"><div class="heading"><span class="number">Listing 9.28:</span> 

<span class="description">A template for an improved “remember me” test.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_login_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersLoginTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"login with remembering"</span> <span class="k">do</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="ss">remember_me</span><span class="p">:</span> <span class="s1">'1'</span><span class="p">)</span>
<span class="hll">    <span class="n">assert_equal</span> <span class="no">FILL_IN</span><span class="p">,</span> <span class="n">assigns</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">FILL_IN</span>
</span>  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"login without remembering"</span> <span class="k">do</span>
    <span class="c1"># Log in to set the cookie.</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="ss">remember_me</span><span class="p">:</span> <span class="s1">'1'</span><span class="p">)</span>
    <span class="c1"># Log in again and verify that the cookie is deleted.</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="ss">remember_me</span><span class="p">:</span> <span class="s1">'0'</span><span class="p">)</span>
    <span class="n">assert_empty</span> <span class="n">cookies</span><span class="o">[</span><span class="s1">'remember_token'</span><span class="o">]</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div></div></div>
<div id="sec-testing_the_remember_branch" data-tralics-id="uid1163" class="subsection" data-number="9.3.2"><h3><a href="advanced_login_fragment.html#sec-testing_the_remember_branch" class="heading hyperref"><span class="number">9.3.2 </span>Testing the remember branch</a></h3>
<p>In <a href="advanced_login_fragment.html#sec-login_with_remembering" class="hyperref">Section <span class="ref">9.1.2</span></a>, we verified by hand that the persistent session implemented in the preceding sections is working, but in fact the relevant branch in the <code>current_user</code> method is currently completely untested.<span class="intersentencespace"></span> My favorite way to handle this kind of situation is to raise an exception in the suspected untested block of code: if the code isn’t covered, the tests will still pass; if it is covered, the resulting error will identify the relevant test.<span class="intersentencespace"></span> The result in the present case appears in <a href="advanced_login_fragment.html#code-branch_raise" class="hyperref">Listing <span class="ref">9.29</span></a>.</p>
<div class="codelisting" id="code-branch_raise" data-tralics-id="uid1164" data-number="9.29"><div class="heading"><span class="number">Listing 9.29:</span> 

<span class="description">Raising an exception in an untested branch.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Returns the user corresponding to the remember token cookie.</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
      <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="k">elsif</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
<span class="hll">      <span class="k">raise</span>       <span class="c1"># The tests still pass, so this branch is currently untested.</span>
</span>      <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
        <span class="n">log_in</span> <span class="n">user</span>
        <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>At this point, the tests are <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid1165" data-tralics-id="uid1165" data-number="9.30"><div class="heading"><span class="number">Listing 9.30:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div><p>This is a problem, of course, because the code in <a href="advanced_login_fragment.html#code-branch_raise" class="hyperref">Listing <span class="ref">9.29</span></a> is broken.<span class="intersentencespace"></span> Moreover, persistent sessions are cumbersome to check by hand, so if we ever want to refactor the <code>current_user</code> method (as we will in <a href="account_activation_fragment.html#cha-account_activation" class="hyperref">Chapter <span class="ref">11</span></a>) it’s important to test it.</p>
<p>Because the <code>log_in_as</code> helper method defined in <a href="advanced_login_fragment.html#code-test_helper_log_in" class="hyperref">Listing <span class="ref">9.24</span></a> automatically sets <code>session[:user_id]</code>, testing the “remember” branch of the <code>current_user</code> method is difficult in an integration test.<span class="intersentencespace"></span> Luckily, we can bypass this restriction by testing the <code>current_user</code> method directly in a Sessions helper test, whose file we have to create:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> touch <span class="nb">test</span>/helpers/sessions_helper_test.rb
</pre></div></div>
<p>The test sequence is simple:</p>
<ol>
<li>Define a <code>user</code> variable using the fixtures.<span class="intersentencespace"></span>
</li>
<li>Call the <code>remember</code> method to remember the given user.<span class="intersentencespace"></span>
</li>
<li>Verify that <code>current_user</code> is equal to the given user.<span class="intersentencespace"></span>
</li></ol>
<p>Because the <code>remember</code> method doesn’t set <code>session[:user_id]</code>, this procedure will test the desired “remember” branch.<span class="intersentencespace"></span> The result appears in <a href="advanced_login_fragment.html#code-persistent_sessions_test" class="hyperref">Listing <span class="ref">9.31</span></a>.</p>
<div class="codelisting" id="code-persistent_sessions_test" data-tralics-id="uid1169" data-number="9.31"><div class="heading"><span class="number">Listing 9.31:</span> 

<span class="description">A test for persistent sessions.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">test/helpers/sessions_helper_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">SessionsHelperTest</span> <span class="o">&lt;</span> <span class="no">ActionView</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="n">remember</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"current_user returns right user when session is nil"</span> <span class="k">do</span>
    <span class="n">assert_equal</span> <span class="vi">@user</span><span class="p">,</span> <span class="n">current_user</span>
    <span class="n">assert</span> <span class="n">is_logged_in?</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"current_user returns nil when remember digest is wrong"</span> <span class="k">do</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_digest</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">new_token</span><span class="p">))</span>
    <span class="n">assert_nil</span> <span class="n">current_user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that we’ve added a second test, which checks that the current user is <code>nil</code> if the user’s remember digest doesn’t correspond correctly to the remember token, thereby testing the <code>authenticated?</code> expression in the nested <code>if</code> statement:</p>
<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>Incidentally, in <a href="advanced_login_fragment.html#code-persistent_sessions_test" class="hyperref">Listing <span class="ref">9.31</span></a> we could write</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_equal</span> <span class="n">current_user</span><span class="p">,</span> <span class="vi">@user</span>
</pre></div></div>
<p>instead, and it would work just the same, but (as mentioned briefly in <a href="filling_in_the_layout_fragment.html#sec-exercises_layout_link_tests" class="hyperref">Section <span class="ref">5.3.4.1</span></a>) the conventional order for the arguments to <code>assert_equal</code> is <em>expected</em>, <em>actual</em>:</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_equal</span> <span class="o">&lt;</span><span class="n">expected</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">actual</span><span class="o">&gt;</span>
</pre></div></div>
<p>which in the case of <a href="advanced_login_fragment.html#code-persistent_sessions_test" class="hyperref">Listing <span class="ref">9.31</span></a> gives</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_equal</span> <span class="vi">@user</span><span class="p">,</span> <span class="n">current_user</span>
</pre></div></div>
<p>With the code as in <a href="advanced_login_fragment.html#code-persistent_sessions_test" class="hyperref">Listing <span class="ref">9.31</span></a>, the test is <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span> as required:</p>
<div class="codelisting" id="uid1170" data-tralics-id="uid1170" data-number="9.32"><div class="heading"><span class="number">Listing 9.32:</span> <span class="description"><span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test test/helpers/sessions_helper_test.rb
</pre></div></div></div><p>We can get the tests in <a href="advanced_login_fragment.html#code-persistent_sessions_test" class="hyperref">Listing <span class="ref">9.31</span></a> to pass by removing the <code>raise</code> and restoring the original <code>current_user</code> method, as shown in <a href="advanced_login_fragment.html#code-branch_no_raise" class="hyperref">Listing <span class="ref">9.33</span></a>.</p>
<div class="codelisting" id="code-branch_no_raise" data-tralics-id="uid1171" data-number="9.33"><div class="heading"><span class="number">Listing 9.33:</span> 

<span class="description">Removing the raised exception.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Returns the user corresponding to the remember token cookie.</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
      <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
<span class="hll">    <span class="k">elsif</span> <span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span>      <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_id</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
        <span class="n">log_in</span> <span class="n">user</span>
        <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>At this point, the test suite should be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid1172" data-tralics-id="uid1172" data-number="9.34"><div class="heading"><span class="number">Listing 9.34:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div><p>Now that the “remember” branch of <code>current_user</code> is tested, we can be confident of catching regressions without having to check by hand.</p>
<div id="sec-exercises_testing_the_remember_branch" data-tralics-id="uid1173" class="subsubsection" data-number="9.3.2.1"><h4><a href="#sec-exercises_testing_the_remember_branch" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Verify by removing the <code>authenticated?</code> expression in <a href="advanced_login_fragment.html#code-branch_no_raise" class="hyperref">Listing <span class="ref">9.33</span></a> that the second test in <a href="advanced_login_fragment.html#code-persistent_sessions_test" class="hyperref">Listing <span class="ref">9.31</span></a> fails, thereby confirming that it tests the right thing. <span class="exercise" id="ex-35a6a6"></span>
</li></ol>
</div></div></div><div id="sec-advanced_login_conclusion" data-tralics-id="cid53" class="section" data-number="9.4"><h2><a href="advanced_login_fragment.html#sec-advanced_login_conclusion" class="heading hyperref"><span class="number">9.4 </span>Conclusion</a></h2>
<p>We’ve covered a lot of ground in the last three chapters, transforming our promising but unformed application into a site capable of the full suite of signup and login behaviors.<span class="intersentencespace"></span> All that is needed to complete the authentication functionality is to restrict access to pages based on login status and user identity.<span class="intersentencespace"></span> We’ll accomplish this task en route to giving users the ability to edit their information, which is the main goal of <a href="updating_and_deleting_users_fragment.html#cha-updating_showing_and_deleting_users" class="hyperref">Chapter <span class="ref">10</span></a>.</p>
<p>Before moving on, merge your changes back into the master branch:</p>
<div class="code"><div class="highlight"><pre>$ rails test
$ git add -A
$ git commit -m "Implement advanced login"
$ git checkout master
$ git merge advanced-login
$ git push
</pre></div></div>
<p>Before deploying to Heroku, it’s worth noting that the application will briefly be in an invalid state after pushing but before the migration is finished.<span class="intersentencespace"></span> On a production site with significant traffic, it’s a good idea to turn <a href="https://devcenter.heroku.com/articles/maintenance-mode" target="_blank" rel="noopener"><em>maintenance mode</em></a> on before making the changes:</p>
<div class="code"><div class="highlight"><pre>$ heroku maintenance:on
$ git push heroku
$ heroku run rails db:migrate
$ heroku maintenance:off
</pre></div></div>
<p>This arranges to show a standard error page during the deployment and migration.<span class="intersentencespace"></span> (We won’t bother with this step again, but it’s good to see it at least once.)<span class="intersentencespace"></span> For more information, see the Heroku documentation on <a href="https://devcenter.heroku.com/articles/error-pages" target="_blank" rel="noopener">error pages</a>.</p>
<div id="sec-advanced_login_what_we_learned_in_this_chapter" data-tralics-id="uid1175" class="subsection" data-number="9.4.1"><h3><a href="advanced_login_fragment.html#sec-advanced_login_what_we_learned_in_this_chapter" class="heading hyperref"><span class="number">9.4.1 </span>What we learned in this chapter</a></h3>
<ul>
<li>Rails can maintain state from one page to the next using persistent cookies via the <code>cookies</code> method.
</li>
<li>We associate to each user a remember token and a corresponding remember digest for use in persistent sessions.<span class="intersentencespace"></span>
</li>
<li>Using the <code>cookies</code> method, we create a persistent session by placing a permanent remember token cookie on the browser.<span class="intersentencespace"></span>
</li>
<li>Login status is determined by the presence of a current user based on the temporary session’s user id or the permanent session’s unique remember token.<span class="intersentencespace"></span>
</li>
<li>The application signs users out by deleting the session’s user id and removing the permanent cookie from the browser.<span class="intersentencespace"></span>
</li>
<li>The ternary operator is a compact way to write simple if-then statements.<span class="intersentencespace"></span>
</li></ul>
</div></div><div id="cha-9_footnotes">
  <ol class="footnotes">
    <li id="cha-9_footnote-1">Session hijacking was widely publicized by the <a href="http://codebutler.com/firesheep" target="_blank" rel="noopener">Firesheep</a> application, which showed that remember tokens at many high-profile sites were visible when connected to public Wi-Fi networks. <a class="arrow" href="#cha-9_footnote-ref-1">↑</a></li>
    <li id="cha-9_footnote-2">Rails 5 introduced a <code>has_secure_token</code> method that automatically generates random tokens, but it stores the <em>unhashed</em> values in the database, and hence is unsuitable for our present purposes. <a class="arrow" href="#cha-9_footnote-ref-2">↑</a></li>
    <li id="cha-9_footnote-3">This choice is based on the <a href="http://railscasts.com/episodes/274-remember-me-reset-password" target="_blank" rel="noopener">RailsCast on remember me</a>. <a class="arrow" href="#cha-9_footnote-ref-3">↑</a></li>
    <li id="cha-9_footnote-4">In any case, with bcrypt’s <a href="https://en.wikipedia.org/wiki/Salt_%28cryptography%29" target="_blank" rel="noopener">salted hashes</a> there’s no way for us to tell if two users’ passwords match. <a class="arrow" href="#cha-9_footnote-ref-4">↑</a></li>
    <li id="cha-9_footnote-5">With unique remember tokens, an attacker always needs <em>both</em> the user id and the remember token cookies to hijack the session. <a class="arrow" href="#cha-9_footnote-ref-5">↑</a></li>
    <li id="cha-9_footnote-6">This hasn’t stopped some developers from adding a check to verify that no collision has occurred, but such efforts result from failing to grasp just how small <span class="inline_math">\( 10^{-40} \)</span> is.<span class="intersentencespace"></span> For example, if we generated a billion tokens a second for the entire age of the Universe, the expected number of collisions would still be on the order of <span class="inline_math">\( 10^{-23} \)</span>. <a class="arrow" href="#cha-9_footnote-ref-6">↑</a></li>
    <li id="cha-9_footnote-7">As a general rule, if a method doesn’t need an instance of an object, it should be a class method.<span class="intersentencespace"></span> Indeed, this decision will prove to be wise in <a href="account_activation_fragment.html#sec-account_activation_emails" class="hyperref">Section <span class="ref">11.2</span></a>. <a class="arrow" href="#cha-9_footnote-ref-7">↑</a></li>
    <li id="cha-9_footnote-8"><a href="https://en.wikipedia.org/wiki/Digital_signature" target="_blank" rel="noopener">Signing</a> and <a href="https://en.wikipedia.org/wiki/Encryption" target="_blank" rel="noopener">encrypting</a> are different operations in general, but as of Rails 4 the <code>signed</code> method <a href="http://api.rubyonrails.org/classes/ActionDispatch/Session/CookieStore.html" target="_blank" rel="noopener">does both</a> by default. <a class="arrow" href="#cha-9_footnote-ref-8">↑</a></li>
    <li id="cha-9_footnote-9">As noted in <a href="modeling_users_fragment.html#sec-a_hashed_password" class="hyperref">Section <span class="ref">6.3.1</span></a>, “unencrypted password” is a misnomer, as the secure password is <em>hashed</em>, not encrypted. <a class="arrow" href="#cha-9_footnote-ref-9">↑</a></li>
    <li id="cha-9_footnote-10">I generally use the convention of putting such assignments in parentheses, which is a visual reminder that it’s not a comparison. <a class="arrow" href="#cha-9_footnote-ref-10">↑</a></li>
    <li id="cha-9_footnote-11">Google “&lt;your browser name&gt; inspect cookies” to learn how to inspect the cookies on your system. <a class="arrow" href="#cha-9_footnote-ref-11">↑</a></li>
    <li id="cha-9_footnote-12">Thanks to reader Paulo Célio Júnior for pointing this out. <a class="arrow" href="#cha-9_footnote-ref-12">↑</a></li>
    <li id="cha-9_footnote-13">Thanks to reader Niels de Ron for pointing this out. <a class="arrow" href="#cha-9_footnote-ref-13">↑</a></li>
    <li id="cha-9_footnote-14">Note that this means unchecking the box will log out the user on all browsers on all computers.<span class="intersentencespace"></span> The alternate design of remembering user login sessions on each browser independently is potentially more convenient for users, but it’s less secure, and is also more complicated to implement.<span class="intersentencespace"></span> Ambitious readers are invited to try their hand at implementing it. <a class="arrow" href="#cha-9_footnote-ref-14">↑</a></li>
    <li id="cha-9_footnote-15">Before we wrote <code>remember user</code> without parentheses, but when used with the ternary operator omitting them results in a syntax error. <a class="arrow" href="#cha-9_footnote-ref-15">↑</a></li>
  </ol>
</div>sʙ
g|      XX=g#X  }a,:https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial_4th_edition/html/advanced_login_fragment.html?X-Amz-Expires=604800&X-Amz-Date=20170205T121142Z&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20170205/us-west-2/s3/aws4_request&X-Amz-SignedHeaders=host&X-Amz-Signature=ebd10a2d0707ffb38ae33304f9069596c24348e954f2d16f7673da2eaa057017 security-info FnhllAKWRHGAlo+ESXykKAAAAAAAAAAAwAAAAAAAAEaphjoj9ApAYLLhYqsrhSapAAQAAgAAAAAAAAAAAAAAACw4N6+LhUposNgK7YiYWzI/H82DxalM0aJQdnbKfH40ZgoyJpFcT/u7IImFpjLfBfjtg2TO2UxuhrpIr1PDk+YAAAAAAAAGGzCCBhcwggT/oAMCAQICEAkMEh1kGcxPzNQuULyfEo0wDQYJKoZIhvcNAQELBQAwZDELMAkGA1UEBhMCVVMxFTATBgNVBAoTDERpZ2lDZXJ0IEluYzEZMBcGA1UECxMQd3d3LmRpZ2ljZXJ0LmNvbTEjMCEGA1UEAxMaRGlnaUNlcnQgQmFsdGltb3JlIENBLTIgRzIwHhcNMTYwNzE4MDAwMDAwWhcNMTcxMDI2MTIwMDAwWjB1MQswCQYDVQQGEwJVUzETMBEGA1UECBMKV2FzaGluZ3RvbjEQMA4GA1UEBxMHU2VhdHRsZTEYMBYGA1UEChMPQW1hem9uLmNvbSBJbmMuMSUwIwYDVQQDDBwqLnMzLXVzLXdlc3QtMi5hbWF6b25hd3MuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtPtaIwJ9+anWiEq/qLdHgQkQ51FdpjU3C/o1HSP3DGHcijP8q6gpOQ2GIT4xaAOOEstz5v5WY8kOfEE0UXsyB8LxmNyu4nPz4gEE1jCKXaFaMQUexl2nz1hNBCzabnDV10EB2+XPOWPw1troTgtKWuBxZ4EaC7dQXkgpqSqzcio33y9sZHlcEa2ok0DMgxTaEY0ryVdODJMlTIVoFwzkiedRV3dl7yRK8EqWMfWnVJzJ2JVMRqakWjQeLE+8oeo4F0m6BEch9qpIA8JV20oFv0cQLM6QQNFzX2EN/2v5uBtrB5g/g39+5Yu+kgkfhedTSkFunjEGol8G7jssC3jijwIDAQABo4ICsjCCAq4wHwYDVR0jBBgwFoAUwBKyKHRoRmfpcCV0GgBFWwZ9XEQwHQYDVR0OBBYEFF1JaGNuDmFfuVhgXPTd3tg4yz2iMIHhBgNVHREEgdkwgdaCGnMzLXVzLXdlc3QtMi5hbWF6b25hd3MuY29tghwqLnMzLXVzLXdlc3QtMi5hbWF6b25hd3MuY29tghpzMy51cy13ZXN0LTIuYW1hem9uYXdzLmNvbYIcKi5zMy51cy13ZXN0LTIuYW1hem9uYXdzLmNvbYIkczMuZHVhbHN0YWNrLnVzLXdlc3QtMi5hbWF6b25hd3MuY29tgiYqLnMzLmR1YWxzdGFjay51cy13ZXN0LTIuYW1hem9uYXdzLmNvbYISKi5zMy5hbWF6b25hd3MuY29tMA4GA1UdDwEB/wQEAwIFoDAdBgNVHSUEFjAUBggrBgEFBQcDAQYIKwYBBQUHAwIwgYEGA1UdHwR6MHgwOqA4oDaGNGh0dHA6Ly9jcmwzLmRpZ2ljZXJ0LmNvbS9EaWdpQ2VydEJhbHRpbW9yZUNBLTJHMi5jcmwwOqA4oDaGNGh0dHA6Ly9jcmw0LmRpZ2ljZXJ0LmNvbS9EaWdpQ2VydEJhbHRpbW9yZUNBLTJHMi5jcmwwTAYDVR0gBEUwQzA3BglghkgBhv1sAQEwKjAoBggrBgEFBQcCARYcaHR0cHM6Ly93d3cuZGlnaWNlcnQuY29tL0NQUzAIBgZngQwBAgIweQYIKwYBBQUHAQEEbTBrMCQGCCsGAQUFBzABhhhodHRwOi8vb2NzcC5kaWdpY2VydC5jb20wQwYIKwYBBQUHMAKGN2h0dHA6Ly9jYWNlcnRzLmRpZ2ljZXJ0LmNvbS9EaWdpQ2VydEJhbHRpbW9yZUNBLTJHMi5jcnQwDAYDVR0TAQH/BAIwADANBgkqhkiG9w0BAQsFAAOCAQEAYH38ntfWdhwWcuD895IsKMmdlnbReTnnEKe6n6tldoxpWEJkjMA0hURZnZrbr5FL3ar6bWF9wnFKMYPxMfjhNzpB8/lbp63yZSDmVpDIsOIRWjkdcMsnpBHDHQWPV9T7fIgxT4WqAK92O3kQs1+bmsuXISBelIMev1G02BYa7EDD8JZyoltleTcs8rzvRRgE37GfxAtu07fxQqyDSvj7ojpSoIUmTVDVJMTGCkSemYpdR3DqTzmsej6eV7TbLdvFTjFnRJ4Zdehb17CoVvkOTB1v/oXaabIIi3UEsDu3UpxdB7mU4G1qgy8XDMitAtpBL6+EIw0QKw5+JoSuzbybEgAAAIAAAACAAAAAJVRMU19FQ0RIRV9SU0FfV0lUSF9BRVNfMTI4X0dDTV9TSEEyNTYAAAABAAA= request-method GET request-Origin https://www.railstutorial.org response-head HTTP/1.1 200 OK
x-amz-id-2: 8tN2GvEPESnPpBMmrV6OztZagtRDH40QwRKVvEhUunLHDd4gMa3eAEkOm9ChRExjB6oMUxem5PA=
x-amz-request-id: D5C18ED90DD01BC0
Date: Sun, 05 Feb 2017 12:11:49 GMT
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: GET
Access-Control-Max-Age: 3000
Vary: Origin, Access-Control-Request-Headers, Access-Control-Request-Method
Last-Modified: Thu, 22 Dec 2016 05:27:44 GMT
Etag: "dabfba4d91559c9bf437e39832e16de0"
Accept-Ranges: bytes
Content-Type: text/html
Content-Length: 182416
Server: AmazonS3
 uncompressed-len 0  Ȑ