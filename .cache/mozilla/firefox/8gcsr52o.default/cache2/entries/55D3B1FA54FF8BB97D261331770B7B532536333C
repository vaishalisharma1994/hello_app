<div id="cha-basic_login" data-tralics-id="cid44" class="chapter" data-number="8" data-chapter="basic_login"><h1><a href="basic_login_fragment.html#cha-basic_login" class="heading hyperref"><span class="number">Chapter 8 </span>Basic login</a></h1>
<p>Now that new users can sign up for our site (<a href="sign_up_fragment.html#cha-sign_up" class="hyperref">Chapter <span class="ref">7</span></a>), it’s time to give them the ability to log in and log out.<span class="intersentencespace"></span> In this chapter, we’ll implement a basic but still fully functional login system: the application will maintain the logged-in state until the browser is closed by the user.<span class="intersentencespace"></span> The resulting authentication system will allow us to customize the site and implement an authorization model based on login status and identity of the current user.<span class="intersentencespace"></span> For example, we’ll be able to update the site header with login/logout links and a profile link.</p>
<p>In <a href="updating_and_deleting_users_fragment.html#cha-updating_showing_and_deleting_users" class="hyperref">Chapter <span class="ref">10</span></a>, we’ll impose a security model in which only logged-in users can visit the user index page, only the correct user can access the page for editing their information, and only administrative users can delete other users from the database.<span class="intersentencespace"></span> Finally, in <a href="user_microposts_fragment.html#cha-user_microposts" class="hyperref">Chapter <span class="ref">13</span></a>, we’ll use the identity of a logged-in user to create microposts associated with that user, and in <a href="following_users_fragment.html#cha-following_users" class="hyperref">Chapter <span class="ref">14</span></a> we’ll allow the current user to follow other users of the application (thereby receiving a feed of their microposts).</p>
<p>The authentication system from this chapter will also serve a foundation for the more advanced login system developed in <a href="advanced_login_fragment.html#cha-advanced_login" class="hyperref">Chapter <span class="ref">9</span></a>.<span class="intersentencespace"></span> Instead of “forgetting” users on browser close, <a href="advanced_login_fragment.html#cha-advanced_login" class="hyperref">Chapter <span class="ref">9</span></a> will start by <em>automatically</em> remembering users, and will then <em>optionally</em> remember users based on the value of a “remember me” checkbox.<span class="intersentencespace"></span> As a result, taken together <a href="basic_login_fragment.html#cha-basic_login" class="hyperref">Chapter <span class="ref">8</span></a> and <a href="advanced_login_fragment.html#cha-advanced_login" class="hyperref">Chapter <span class="ref">9</span></a> develop all three of the most common types of login systems on the Web.</p>
</div><div id="sec-sessions_and_failed_login" data-tralics-id="cid45" class="section" data-number="8.1"><h2><a href="basic_login_fragment.html#sec-sessions_and_failed_login" class="heading hyperref"><span class="number">8.1 </span>Sessions</a></h2>
<p><a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol" target="_blank" rel="noopener">HTTP</a> is a <a href="https://en.wikipedia.org/wiki/Stateless_protocol" target="_blank" rel="noopener"><em>stateless protocol</em></a>, treating each request as an independent transaction that is unable to use information from any previous requests.<span class="intersentencespace"></span> This means there is no way <a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#HTTP_session_state" target="_blank" rel="noopener">within the hypertext transfer protocol</a> to remember a user’s identity from page to page; instead, web applications requiring user login must use a <a href="http://en.wikipedia.org/wiki/Session_(computer_science)" target="_blank" rel="noopener"><em>session</em></a>, which is a semi-permanent connection between two computers (such as a client computer running a web browser and a server running Rails).</p>
<p>The most common techniques for implementing sessions in Rails involve using <a href="http://en.wikipedia.org/wiki/HTTP_cookie" target="_blank" rel="noopener"><em>cookies</em></a>, which are small pieces of text placed on the user’s browser.<span class="intersentencespace"></span> Because cookies persist from one page to the next, they can store information (such as a user id) that can be used by the application to retrieve the logged-in user from the database.<span class="intersentencespace"></span> In this section and in <a href="basic_login_fragment.html#sec-logging_in" class="hyperref">Section <span class="ref">8.2</span></a>, we’ll use the Rails method called <code>session</code> to make temporary sessions that expire automatically on browser close.<sup id="cha-8_footnote-ref-1" class="footnote"><a href="#cha-8_footnote-1">1</a></sup><span class="intersentencespace"></span> In <a href="advanced_login_fragment.html#cha-advanced_login" class="hyperref">Chapter <span class="ref">9</span></a>, we’ll learn how to make longer-lived sessions using the closely related <code>cookies</code> method.</p>
<p>It’s convenient to model sessions as a RESTful resource: visiting the login page will render a form for <em>new</em> sessions, logging in will <em>create</em> a session, and logging out will <em>destroy</em> it.<span class="intersentencespace"></span> Unlike the Users resource, which uses a database back-end (via the User model) to persist data, the Sessions resource will use cookies, and much of the work involved in login comes from building this cookie-based authentication machinery.<span class="intersentencespace"></span> In this section and the next, we’ll prepare for this work by constructing a Sessions controller, a login form, and the relevant controller actions.<span class="intersentencespace"></span> We’ll then complete user login in <a href="basic_login_fragment.html#sec-logging_in" class="hyperref">Section <span class="ref">8.2</span></a> by adding the necessary session-manipulation code.</p>
<p>As in previous chapters, we’ll do our work on a topic branch and merge in the changes at the end:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b basic-login
</pre></div></div>
<div id="sec-sessions_controller" data-tralics-id="uid974" class="subsection" data-number="8.1.1"><h3><a href="basic_login_fragment.html#sec-sessions_controller" class="heading hyperref"><span class="number">8.1.1 </span>Sessions controller</a></h3>
<p>The elements of logging in and out correspond to particular REST actions of the Sessions controller: the login form is handled by the <code>new</code> action (covered in this section), actually logging in is handled by sending a <code class="tt">POST</code> request to the <code>create</code> action (<a href="basic_login_fragment.html#sec-logging_in" class="hyperref">Section <span class="ref">8.2</span></a>), and logging out is handled by sending a <code class="tt">DELETE</code> request to the <code>destroy</code> action (<a href="basic_login_fragment.html#sec-logging_out" class="hyperref">Section <span class="ref">8.3</span></a>).<span class="intersentencespace"></span> (Recall the association of HTTP verbs with REST actions from <a href="sign_up_fragment.html#table-RESTful_users" class="hyperref">Table <span class="ref">7.1</span></a>.)</p>
<p>To get started, we’ll generate a Sessions controller with a <code>new</code> action (<a href="basic_login_fragment.html#code-generate_sessions_controller" class="hyperref">Listing <span class="ref">8.1</span></a>).</p>
<div class="codelisting" id="code-generate_sessions_controller" data-tralics-id="uid975" data-number="8.1"><div class="heading"><span class="number">Listing 8.1:</span> 

<span class="description">Generating the Sessions controller.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller Sessions new
</pre></div></div></div><p>(Including <code>new</code> actually generates <em>views</em> as well, which is why we don’t include actions like <code>create</code> and <code>destroy</code> that don’t correspond to views.)<span class="intersentencespace"></span> Following the model from <a href="sign_up_fragment.html#sec-signup_form" class="hyperref">Section <span class="ref">7.2</span></a> for the signup page, our plan is to create a login form for creating new sessions, as mocked up in <a href="basic_login_fragment.html#fig-login_mockup" class="hyperref">Figure <span class="ref">8.1</span></a>.</p>
<div class="center figure" id="fig-login_mockup" data-tralics-id="uid976" data-number="8.1">
<div class="graphics image box"><img src="images/figures/login_mockup.png" alt="images/figures/login_mockup"></div><div class="caption"><span class="header">Figure 8.1: </span><span class="description">A mockup of the login form.
</span></div></div>
<p>Unlike the Users resource, which used the special <code>resources</code> method to obtain a full suite of RESTful routes automatically (<a href="sign_up_fragment.html#code-users_resource" class="hyperref">Listing <span class="ref">7.3</span></a>), the Sessions resource will use only named routes, handling <code class="tt">GET</code> and <code class="tt">POST</code> requests with the <code>login</code> route and <code class="tt">DELETE</code> request with the <code>logout</code> route.<span class="intersentencespace"></span> The result appears in <a href="basic_login_fragment.html#code-sessions_resource" class="hyperref">Listing <span class="ref">8.2</span></a> (which also deletes the unneeded routes generated by <code>rails generate controller</code>).</p>
<div class="codelisting" id="code-sessions_resource" data-tralics-id="uid977" data-number="8.2"><div class="heading"><span class="number">Listing 8.2:</span> 

<span class="description">Adding a resource to get the standard RESTful actions for sessions.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">root</span>   <span class="s1">'static_pages#home'</span>
  <span class="n">get</span>    <span class="s1">'/help'</span><span class="p">,</span>    <span class="ss">to</span><span class="p">:</span> <span class="s1">'static_pages#help'</span>
  <span class="n">get</span>    <span class="s1">'/about'</span><span class="p">,</span>   <span class="ss">to</span><span class="p">:</span> <span class="s1">'static_pages#about'</span>
  <span class="n">get</span>    <span class="s1">'/contact'</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">'static_pages#contact'</span>
  <span class="n">get</span>    <span class="s1">'/signup'</span><span class="p">,</span>  <span class="ss">to</span><span class="p">:</span> <span class="s1">'users#new'</span>
<span class="hll">  <span class="n">get</span>    <span class="s1">'/login'</span><span class="p">,</span>   <span class="ss">to</span><span class="p">:</span> <span class="s1">'sessions#new'</span>
</span><span class="hll">  <span class="n">post</span>   <span class="s1">'/login'</span><span class="p">,</span>   <span class="ss">to</span><span class="p">:</span> <span class="s1">'sessions#create'</span>
</span><span class="hll">  <span class="n">delete</span> <span class="s1">'/logout'</span><span class="p">,</span>  <span class="ss">to</span><span class="p">:</span> <span class="s1">'sessions#destroy'</span>
</span>  <span class="n">resources</span> <span class="ss">:users</span>
<span class="k">end</span>
</pre></div></div></div><p>With the routes in <a href="basic_login_fragment.html#code-sessions_resource" class="hyperref">Listing <span class="ref">8.2</span></a>, we also need to update the test generated in <a href="basic_login_fragment.html#code-generate_sessions_controller" class="hyperref">Listing <span class="ref">8.1</span></a> with the new login route, as shown in <a href="basic_login_fragment.html#code-users_controller_test_login_route" class="hyperref">Listing <span class="ref">8.3</span></a>.</p>
<div class="codelisting" id="code-users_controller_test_login_route" data-tralics-id="uid978" data-number="8.3"><div class="heading"><span class="number">Listing 8.3:</span> 

<span class="description">Updating the Sessions controller test to use the signup route.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/controllers/sessions_controller_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">SessionsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="nb">test</span> <span class="s2">"should get new"</span> <span class="k">do</span>
<span class="hll">    <span class="n">get</span> <span class="n">login_path</span>
</span>    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The routes defined in <a href="basic_login_fragment.html#code-sessions_resource" class="hyperref">Listing <span class="ref">8.2</span></a> correspond to URLs and actions similar to those for users (<a href="sign_up_fragment.html#table-RESTful_users" class="hyperref">Table <span class="ref">7.1</span></a>), as shown in <a href="basic_login_fragment.html#table-RESTful_sessions" class="hyperref">Table <span class="ref">8.1</span></a>.</p>
<div class="table" id="table-RESTful_sessions" data-tralics-id="uid979" data-number="8.1"><table class="tabular">
<tbody><tr class="bottom_border"><td class="align_left"><strong>HTTP request</strong></td>
<td class="align_left"><strong>URL</strong></td>
<td class="align_left"><strong>Named route</strong></td>
<td class="align_left"><strong>Action</strong></td>
<td class="align_left"><strong>Purpose</strong></td>
</tr><tr><td class="align_left"><code class="tt">GET</code></td>
<td class="align_left">/login</td>
<td class="align_left"><code>login_path</code></td>
<td class="align_left"><code>new</code></td>
<td class="align_left">page for a new session (login)</td>
</tr><tr><td class="align_left"><code class="tt">POST</code></td>
<td class="align_left">/login</td>
<td class="align_left"><code>login_path</code></td>
<td class="align_left"><code>create</code></td>
<td class="align_left">create a new session (login)</td>
</tr><tr><td class="align_left"><code class="tt">DELETE</code></td>
<td class="align_left">/logout</td>
<td class="align_left"><code>logout_path</code></td>
<td class="align_left"><code>destroy</code></td>
<td class="align_left">delete a session (log out)</td>
</tr></tbody></table><div class="caption"><span class="header">Table 8.1: </span><span class="description">Routes provided by the sessions rules in <a href="basic_login_fragment.html#code-sessions_resource" class="hyperref">Listing <span class="ref">8.2</span></a>.
</span></div></div>
<p>Since we’ve now added several custom named routes, it’s useful to look at the complete list of the routes for our application, which we can generate using <code>rails routes</code>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails routes
<span class="go">   Prefix Verb   URI Pattern               Controller#Action</span>
<span class="go">     root GET    /                         static_pages#home</span>
<span class="go">     help GET    /help(.:format)           static_pages#help</span>
<span class="go">    about GET    /about(.:format)          static_pages#about</span>
<span class="go">  contact GET    /contact(.:format)        static_pages#contact</span>
<span class="go">   signup GET    /signup(.:format)         users#new</span>
<span class="go">    login GET    /login(.:format)          sessions#new</span>
<span class="go">          POST   /login(.:format)          sessions#create</span>
<span class="go">   logout DELETE /logout(.:format)         sessions#destroy</span>
<span class="go">    users GET    /users(.:format)          users#index</span>
<span class="go">          POST   /users(.:format)          users#create</span>
<span class="go"> new_user GET    /users/new(.:format)      users#new</span>
<span class="go">edit_user GET    /users/:id/edit(.:format) users#edit</span>
<span class="go">     user GET    /users/:id(.:format)      users#show</span>
<span class="go">          PATCH  /users/:id(.:format)      users#update</span>
<span class="go">          PUT    /users/:id(.:format)      users#update</span>
<span class="go">          DELETE /users/:id(.:format)      users#destroy</span>
</pre></div></div>
<p>It’s not necessary to understand the results in detail, but viewing the routes in this manner gives us a high-level overview of the actions supported by our application.</p>
<div id="sec-exercises_sessions_controller" data-tralics-id="uid980" class="subsubsection" data-number="8.1.1.1"><h4><a href="#sec-exercises_sessions_controller" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>What is the difference between <code>GET login_path</code> and <code>POST login_path</code>? <span class="exercise" id="ex-36ca59"></span>
</li>
<li>By piping the results of <code>rails routes</code> to <code>grep</code>, list all the routes associated with the Users resource.<span class="intersentencespace"></span> Do the same for Sessions.<span class="intersentencespace"></span> How many routes does each resource have?<span class="intersentencespace"></span> <em>Hint</em>: Refer to the <a href="https://www.learnenough.com/command-line-tutorial#sec-grepping" target="_blank" rel="noopener">section on grep</a> in <a href="http://learnenough.com/command-line-tutorial" target="_blank" rel="noopener"><em>Learn Enough Command Line to Be Dangerous</em></a>. <span class="exercise" id="ex-061c5c"></span>
</li></ol>
</div></div>
<div id="sec-login_form" data-tralics-id="uid983" class="subsection" data-number="8.1.2"><h3><a href="basic_login_fragment.html#sec-login_form" class="heading hyperref"><span class="number">8.1.2 </span>Login form</a></h3>
<p>Having defined the relevant controller and route, now we’ll fill in the view for new sessions, i.e., the login form.<span class="intersentencespace"></span> Comparing <a href="basic_login_fragment.html#fig-login_mockup" class="hyperref">Figure <span class="ref">8.1</span></a> with <a href="sign_up_fragment.html#fig-signup_mockup" class="hyperref">Figure <span class="ref">7.11</span></a>, we see that the login form is similar in appearance to the signup form, except with two fields (email and password) in place of four.</p>
<p>As seen in <a href="basic_login_fragment.html#fig-login_failure_mockup" class="hyperref">Figure <span class="ref">8.2</span></a>, when the login information is invalid we want to re-render the login page and display an error message.<span class="intersentencespace"></span> In <a href="sign_up_fragment.html#sec-signup_error_messages" class="hyperref">Section <span class="ref">7.3.3</span></a>, we used an error-messages partial to display error messages, but we saw in that section that those messages are provided automatically by Active Record.<span class="intersentencespace"></span> This won’t work for session creation errors because the session isn’t an Active Record object, so we’ll render the error as a flash message instead.</p>
<div class="center figure" id="fig-login_failure_mockup" data-tralics-id="uid984" data-number="8.2">
<div class="graphics image box"><img src="images/figures/login_failure_mockup.png" alt="images/figures/login_failure_mockup"></div><div class="caption"><span class="header">Figure 8.2: </span><span class="description">A mockup of login failure.
</span></div></div>
<p>Recall from <a href="sign_up_fragment.html#code-signup_form" class="hyperref">Listing <span class="ref">7.15</span></a> that the signup form uses the <code>form_for</code> helper, taking as an argument the user instance variable <code>@user</code>:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>The main difference between the session form and the signup form is that we have no Session model, and hence no analogue for the <code>@user</code> variable.<span class="intersentencespace"></span> This means that, in constructing the new session form, we have to give <code>form_for</code> slightly more information; in particular, whereas</p>
<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</pre></div></div>
<p>allows Rails to infer that the <code>action</code> of the form should be to <code class="tt">POST</code> to the URL /users, in the case of sessions we need to indicate the <em>name</em> of the resource and the corresponding URL:<sup id="cha-8_footnote-ref-2" class="footnote"><a href="#cha-8_footnote-2">2</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">url</span><span class="p">:</span> <span class="n">login_path</span><span class="p">)</span>
</pre></div></div>
<p>With the proper <code>form_for</code> in hand, it’s easy to make a login form to match the mockup in <a href="basic_login_fragment.html#fig-login_mockup" class="hyperref">Figure <span class="ref">8.1</span></a> using the signup form (<a href="sign_up_fragment.html#code-signup_form" class="hyperref">Listing <span class="ref">7.15</span></a>) as a model, as shown in <a href="basic_login_fragment.html#code-login_form" class="hyperref">Listing <span class="ref">8.4</span></a>.</p>
<div class="codelisting" id="code-login_form" data-tralics-id="uid986" data-number="8.4"><div class="heading"><span class="number">Listing 8.4:</span> 

<span class="description">Code for the login form.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/sessions/new.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Log in"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Log in<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6 col-md-offset-3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">url</span><span class="p">:</span> <span class="n">login_path</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">email_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Log in"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="nt">&lt;p&gt;</span>New user? <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign up now!"</span><span class="p">,</span> <span class="n">signup_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div><p>Note that we’ve added a link to the signup page for convenience.<span class="intersentencespace"></span> With the code in <a href="basic_login_fragment.html#code-login_form" class="hyperref">Listing <span class="ref">8.4</span></a>, the login form appears as in <a href="basic_login_fragment.html#fig-login_form" class="hyperref">Figure <span class="ref">8.3</span></a>.<span class="intersentencespace"></span> (Because the “Log in” navigation link hasn’t yet been filled in, you’ll have to type the /login URL directly into your address bar.<span class="intersentencespace"></span> We’ll fix this blemish in <a href="basic_login_fragment.html#sec-changing_the_layout_links" class="hyperref">Section <span class="ref">8.2.3</span></a>.)</p>
<div class="center figure" id="fig-login_form" data-tralics-id="uid987" data-number="8.3">
<div class="graphics image"><img src="images/figures/login_form.png" alt="images/figures/login_form"></div><div class="caption"><span class="header">Figure 8.3: </span><span class="description">The login form.
</span></div></div>
<p>The generated form HTML appears in <a href="basic_login_fragment.html#code-login_form_html" class="hyperref">Listing <span class="ref">8.5</span></a>.</p>
<div class="codelisting" id="code-login_form_html" data-tralics-id="uid988" data-number="8.5"><div class="heading"><span class="number">Listing 8.5:</span> 

<span class="description">HTML for the login form produced by <a href="basic_login_fragment.html#code-login_form" class="hyperref">Listing <span class="ref">8.4</span></a>.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">accept-charset=</span><span class="s">"UTF-8"</span> <span class="na">action=</span><span class="s">"/login"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"utf8"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"&amp;#x2713;"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"authenticity_token"</span> <span class="na">type=</span><span class="s">"hidden"</span>
         <span class="na">value=</span><span class="s">"NNb6+J/j46LcrgYUC60wQ2titMuJQ5lLqyAbnbAUkdo="</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"session_email"</span><span class="nt">&gt;</span>Email<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">id=</span><span class="s">"session_email"</span>
         <span class="na">name=</span><span class="s">"session[email]"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"session_password"</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"session_password"</span> <span class="na">name=</span><span class="s">"session[password]"</span>
         <span class="na">type=</span><span class="s">"password"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"btn btn-primary"</span> <span class="na">name=</span><span class="s">"commit"</span> <span class="na">type=</span><span class="s">"submit"</span>
       <span class="na">value=</span><span class="s">"Log in"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div></div></div><p>Comparing <a href="basic_login_fragment.html#code-login_form_html" class="hyperref">Listing <span class="ref">8.5</span></a> with <a href="sign_up_fragment.html#code-signup_form_html" class="hyperref">Listing <span class="ref">7.17</span></a>, you might be able to guess that submitting this form will result in a <code>params</code> hash where <code>params[:session][:email]</code> and <code>params[:session][:password]</code> correspond to the email and password fields.</p>
<div id="sec-exercises_login_form" data-tralics-id="uid989" class="subsubsection" data-number="8.1.2.1"><h4><a href="#sec-exercises_login_form" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Submissions from the form defined in <a href="basic_login_fragment.html#code-login_form" class="hyperref">Listing <span class="ref">8.4</span></a> will be routed to the Session controller’s <code>create</code> action.<span class="intersentencespace"></span> How does Rails know to do this?<span class="intersentencespace"></span> <em>Hint</em>: Refer to <a href="basic_login_fragment.html#table-RESTful_sessions" class="hyperref">Table <span class="ref">8.1</span></a> and the first line of <a href="basic_login_fragment.html#code-login_form_html" class="hyperref">Listing <span class="ref">8.5</span></a>. <span class="exercise" id="ex-f0615e"></span>
</li></ol>
</div></div>
<div id="sec-finding_and_authenticating_a_user" data-tralics-id="uid991" class="subsection" data-number="8.1.3"><h3><a href="basic_login_fragment.html#sec-finding_and_authenticating_a_user" class="heading hyperref"><span class="number">8.1.3 </span>Finding and authenticating a user</a></h3>
<p>As in the case of creating users (signup), the first step in creating sessions (login) is to handle <em>invalid</em> input.<span class="intersentencespace"></span> We’ll start by reviewing what happens when a form gets submitted, and then arrange for helpful error messages to appear in the case of login failure (as mocked up in <a href="basic_login_fragment.html#fig-login_failure_mockup" class="hyperref">Figure <span class="ref">8.2</span></a>.)<span class="intersentencespace"></span> Then we’ll lay the foundation for successful login (<a href="basic_login_fragment.html#sec-logging_in" class="hyperref">Section <span class="ref">8.2</span></a>) by evaluating each login submission based on the validity of its email/password combination.</p>
<p>Let’s start by defining a minimalist <code>create</code> action for the Sessions controller, along with empty <code>new</code> and <code>destroy</code> actions (<a href="basic_login_fragment.html#code-initial_create_session" class="hyperref">Listing <span class="ref">8.6</span></a>).<span class="intersentencespace"></span> The <code>create</code> action in <a href="basic_login_fragment.html#code-initial_create_session" class="hyperref">Listing <span class="ref">8.6</span></a> does nothing but render the <code>new</code> view, but it’s enough to get us started.<span class="intersentencespace"></span> Submitting the /sessions/new form then yields the result shown in <a href="basic_login_fragment.html#fig-initial_failed_login_rails_3" class="hyperref">Figure <span class="ref">8.4</span></a>.</p>
<div class="codelisting" id="code-initial_create_session" data-tralics-id="uid992" data-number="8.6"><div class="heading"><span class="number">Listing 8.6:</span> 

<span class="description">A preliminary version of the Sessions <code>create</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
<span class="hll">    <span class="n">render</span> <span class="s1">'new'</span>
</span>  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><div class="center figure" id="fig-initial_failed_login_rails_3" data-tralics-id="uid993" data-number="8.4">
<div class="graphics image"><img src="images/figures/initial_failed_login_3rd_edition.png" alt="images/figures/initial_failed_login_3rd_edition"></div><div class="caption"><span class="header">Figure 8.4: </span><span class="description">The initial failed login, with <code>create</code> as in <a href="basic_login_fragment.html#code-initial_create_session" class="hyperref">Listing <span class="ref">8.6</span></a>.
</span></div></div>
<p>Carefully inspecting the debug information in <a href="basic_login_fragment.html#fig-initial_failed_login_rails_3" class="hyperref">Figure <span class="ref">8.4</span></a> shows that, as hinted at the end of <a href="basic_login_fragment.html#sec-login_form" class="hyperref">Section <span class="ref">8.1.2</span></a>, the submission results in a <code>params</code> hash containing the email and password under the key <code>session</code>, which (omitting some irrelevant details used internally by Rails) appears as follows:</p>
<div class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">session</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="s">'user@example.com'</span>
  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="s">'foobar'</span>
<span class="l-Scalar-Plain">commit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Log in</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">create</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sessions</span>
</pre></div></div>
<p>As with the case of user signup (<a href="sign_up_fragment.html#fig-signup_failure" class="hyperref">Figure <span class="ref">7.15</span></a>), these parameters form a <em>nested</em> hash like the one we saw in <a href="rails_flavored_ruby_fragment.html#code-nested_hashes" class="hyperref">Listing <span class="ref">4.13</span></a>.<span class="intersentencespace"></span> In particular, <code>params</code> contains a nested hash of the form</p>
<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="ss">session</span><span class="p">:</span> <span class="p">{</span> <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span> <span class="p">}</span> <span class="p">}</span>
</pre></div></div>
<p>This means that</p>
<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">]</span>
</pre></div></div>
<p>is itself a hash:</p>
<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span> <span class="p">}</span>
</pre></div></div>
<p>As a result,</p>
<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">]</span>
</pre></div></div>
<p>is the submitted email address and</p>
<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span>
</pre></div></div>
<p>is the submitted password.</p>
<p>In other words, inside the <code>create</code> action the <code>params</code> hash has all the information needed to authenticate users by email and password.<span class="intersentencespace"></span> Not coincidentally, we already have exactly the methods we need: the <code>User.find_by</code> method provided by Active Record (<a href="modeling_users_fragment.html#sec-finding_user_objects" class="hyperref">Section <span class="ref">6.1.4</span></a>) and the <code>authenticate</code> method provided by <code>has_secure_password</code> (<a href="modeling_users_fragment.html#sec-creating_and_authenticating_a_user" class="hyperref">Section <span class="ref">6.3.4</span></a>).<span class="intersentencespace"></span> Recalling that <code>authenticate</code> returns <code>false</code> for an invalid authentication (<a href="modeling_users_fragment.html#sec-creating_and_authenticating_a_user" class="hyperref">Section <span class="ref">6.3.4</span></a>), our strategy for user login can be summarized as shown in <a href="basic_login_fragment.html#code-find_authenticate_user" class="hyperref">Listing <span class="ref">8.7</span></a>.</p>
<div class="codelisting" id="code-find_authenticate_user" data-tralics-id="uid994" data-number="8.7"><div class="heading"><span class="number">Listing 8.7:</span> 

<span class="description">Finding and authenticating a user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
<span class="hll">    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
</span><span class="hll">    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
</span>      <span class="c1"># Log the user in and redirect to the user's show page.</span>
    <span class="k">else</span>
      <span class="c1"># Create an error message.</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The first highlighted line in <a href="basic_login_fragment.html#code-find_authenticate_user" class="hyperref">Listing <span class="ref">8.7</span></a> pulls the user out of the database using the submitted email address.<span class="intersentencespace"></span> (Recall from <a href="modeling_users_fragment.html#sec-uniqueness_validation" class="hyperref">Section <span class="ref">6.2.5</span></a> that email addresses are saved as all lower-case, so here we use the <code>downcase</code> method to ensure a match when the submitted address is valid.)<span class="intersentencespace"></span> The next line can be a bit confusing but is fairly common in idiomatic Rails programming:</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>This uses <code>&amp;&amp;</code> (logical <em>and</em>) to determine if the resulting user is valid.<span class="intersentencespace"></span> Taking into account that any object other than <code>nil</code> and <code>false</code> itself is <code>true</code> in a boolean context (<a href="rails_flavored_ruby_fragment.html#sec-objects_and_message_passing" class="hyperref">Section <span class="ref">4.2.3</span></a>), the possibilities appear as in <a href="basic_login_fragment.html#table-user_and_and" class="hyperref">Table <span class="ref">8.2</span></a>.<span class="intersentencespace"></span> We see from <a href="basic_login_fragment.html#table-user_and_and" class="hyperref">Table <span class="ref">8.2</span></a> that the <code>if</code> statement is <code>true</code> only if a user with the given email both exists in the database and has the given password, exactly as required.</p>
<div class="table" id="table-user_and_and" data-tralics-id="uid995" data-number="8.2"><table class="tabular">
<tbody><tr class="bottom_border"><td class="align_left"><strong>User</strong></td>
<td class="align_left"><strong>Password</strong></td>
<td class="align_left"><strong>a &amp;&amp; b</strong></td>
</tr><tr><td class="align_left">nonexistent</td>
<td class="align_left"><em>anything</em></td>
<td class="align_left"><code>(nil &amp;&amp; [anything]) == false</code></td>
</tr><tr><td class="align_left">valid user</td>
<td class="align_left">wrong password</td>
<td class="align_left"><code>(true &amp;&amp; false) == false</code></td>
</tr><tr><td class="align_left">valid user</td>
<td class="align_left">right password</td>
<td class="align_left"><code>(true &amp;&amp; true) == true</code></td>
</tr></tbody></table><div class="caption"><span class="header">Table 8.2: </span><span class="description">Possible results of <code>user &amp;&amp; user.authenticate(…)</code>.
</span></div></div>
<div id="sec-exercises_finding_and_authenticating_a_user" data-tralics-id="uid996" class="subsubsection" data-number="8.1.3.1"><h4><a href="#sec-exercises_finding_and_authenticating_a_user" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Using the Rails console, confirm each of the values in <a href="basic_login_fragment.html#table-user_and_and" class="hyperref">Table <span class="ref">8.2</span></a>.<span class="intersentencespace"></span> Start with <code>user = nil</code>, and then use <code>user = User.first</code>.<span class="intersentencespace"></span> <em>Hint</em>: To coerce the result to a boolean value, use the bang-bang trick from <a href="rails_flavored_ruby_fragment.html#sec-objects_and_message_passing" class="hyperref">Section <span class="ref">4.2.3</span></a>, as in <code>!!(user &amp;&amp; user.authenticate(’foobar’))</code>. <span class="exercise" id="ex-b87d43"></span>
</li></ol>
</div></div>
<div id="sec-rendering_with_a_flash_message" data-tralics-id="uid998" class="subsection" data-number="8.1.4"><h3><a href="basic_login_fragment.html#sec-rendering_with_a_flash_message" class="heading hyperref"><span class="number">8.1.4 </span>Rendering with a flash message</a></h3>
<p>Recall from <a href="sign_up_fragment.html#sec-signup_error_messages" class="hyperref">Section <span class="ref">7.3.3</span></a> that we displayed signup errors using the User model error messages.<span class="intersentencespace"></span> These errors are associated with a particular Active Record object, but this strategy won’t work here because the session isn’t an Active Record model.<span class="intersentencespace"></span> Instead, we’ll put a message in the flash to be displayed upon failed login.<span class="intersentencespace"></span> A first, slightly incorrect, attempt appears in <a href="basic_login_fragment.html#code-failed_login_attempt" class="hyperref">Listing <span class="ref">8.8</span></a>.</p>
<div class="codelisting" id="code-failed_login_attempt" data-tralics-id="uid999" data-number="8.8"><div class="heading"><span class="number">Listing 8.8:</span> 

<span class="description">An (unsuccessful) attempt at handling failed login.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="c1"># Log the user in and redirect to the user's show page.</span>
    <span class="k">else</span>
<span class="hll">      <span class="n">flash</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span> <span class="c1"># Not quite right!</span>
</span>      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Because of the flash message display in the site layout (<a href="sign_up_fragment.html#code-layout_flash" class="hyperref">Listing <span class="ref">7.31</span></a>), the <code>flash[:danger]</code> message automatically gets displayed; because of the Bootstrap CSS, it automatically gets nice styling (<a href="basic_login_fragment.html#fig-failed_login_flash" class="hyperref">Figure <span class="ref">8.5</span></a>).</p>
<div class="center figure" id="fig-failed_login_flash" data-tralics-id="uid1000" data-number="8.5">
<div class="graphics image"><img src="images/figures/failed_login_flash_3rd_edition.png" alt="images/figures/failed_login_flash_3rd_edition"></div><div class="caption"><span class="header">Figure 8.5: </span><span class="description">The flash message for a failed login.
</span></div></div>
<p>Unfortunately, as noted in the text and in the comment in <a href="basic_login_fragment.html#code-failed_login_attempt" class="hyperref">Listing <span class="ref">8.8</span></a>, this code isn’t quite right.<span class="intersentencespace"></span> The page looks fine, though, so what’s the problem?<span class="intersentencespace"></span> The issue is that the contents of the flash persist for one <em>request</em>, but—unlike a redirect, which we used in <a href="sign_up_fragment.html#code-signup_flash" class="hyperref">Listing <span class="ref">7.29</span></a>—re-rendering a template with <code>render</code> doesn’t count as a request.<span class="intersentencespace"></span> The result is that the flash message persists one request longer than we want.<span class="intersentencespace"></span> For example, if we submit invalid login information and then click on the Home page, the flash gets displayed a second time (<a href="basic_login_fragment.html#fig-flash_persistence" class="hyperref">Figure <span class="ref">8.6</span></a>).<span class="intersentencespace"></span> Fixing this blemish is the task of <a href="basic_login_fragment.html#sec-a_flash_test" class="hyperref">Section <span class="ref">8.1.5</span></a>.</p>
<div class="center figure" id="fig-flash_persistence" data-tralics-id="uid1001" data-number="8.6">
<div class="graphics image"><img src="images/figures/flash_persistence_3rd_edition.png" alt="images/figures/flash_persistence_3rd_edition"></div><div class="caption"><span class="header">Figure 8.6: </span><span class="description">An example of flash persistence.
</span></div></div>
</div>
<div id="sec-a_flash_test" data-tralics-id="uid1002" class="subsection" data-number="8.1.5"><h3><a href="basic_login_fragment.html#sec-a_flash_test" class="heading hyperref"><span class="number">8.1.5 </span>A flash test</a></h3>
<p>The incorrect flash behavior is a minor bug in our application.<span class="intersentencespace"></span> According to the testing guidelines from <a href="static_pages_fragment.html#aside-when_to_test" class="hyperref">Box <span class="ref">3.3</span></a>, this is exactly the sort of situation where we should write a test to catch the error so that it doesn’t recur.<span class="intersentencespace"></span> We’ll thus write a short integration test for the login form submission before proceeding.<span class="intersentencespace"></span> In addition to documenting the bug and preventing a regression, this will also give us a good foundation for further integration tests of login and logout.</p>
<p>We start by generating an integration test for our application’s login behavior:</p>
<div class="code"><div class="highlight"><pre><span class="hll"><span class="gp">$</span> rails generate integration_test users_login
</span><span class="go">      invoke  test_unit</span>
<span class="go">      create    test/integration/users_login_test.rb</span>
</pre></div></div>
<p>Next, we need a test to capture the sequence shown in <a href="basic_login_fragment.html#fig-failed_login_flash" class="hyperref">Figure <span class="ref">8.5</span></a> and <a href="basic_login_fragment.html#fig-flash_persistence" class="hyperref">Figure <span class="ref">8.6</span></a>.<span class="intersentencespace"></span> The basic steps appear as follows:</p>
<ol>
<li>Visit the login path.<span class="intersentencespace"></span>
</li>
<li>Verify that the new sessions form renders properly.<span class="intersentencespace"></span>
</li>
<li>Post to the sessions path with an invalid <code>params</code> hash.<span class="intersentencespace"></span>
</li>
<li>Verify that the new sessions form gets re-rendered and that a flash message appears.<span class="intersentencespace"></span>
</li>
<li>Visit another page (such as the Home page).<span class="intersentencespace"></span>
</li>
<li>Verify that the flash message <em>doesn’t</em> appear on the new page.<span class="intersentencespace"></span>
</li></ol>
<p>A test implementing the above steps appears in <a href="basic_login_fragment.html#code-flash_persistence_test" class="hyperref">Listing <span class="ref">8.9</span></a>.</p>
<div class="codelisting" id="code-flash_persistence_test" data-tralics-id="uid1009" data-number="8.9"><div class="heading"><span class="number">Listing 8.9:</span> 

<span class="description">A test to catch unwanted flash persistence.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_login_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersLoginTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="nb">test</span> <span class="s2">"login with invalid information"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">login_path</span>
    <span class="n">assert_template</span> <span class="s1">'sessions/new'</span>
    <span class="n">post</span> <span class="n">login_path</span><span class="p">,</span> <span class="ss">params</span><span class="p">:</span> <span class="p">{</span> <span class="ss">session</span><span class="p">:</span> <span class="p">{</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span> <span class="ss">password</span><span class="p">:</span> <span class="s2">""</span> <span class="p">}</span> <span class="p">}</span>
    <span class="n">assert_template</span> <span class="s1">'sessions/new'</span>
    <span class="n">assert_not</span> <span class="n">flash</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">get</span> <span class="n">root_path</span>
    <span class="n">assert</span> <span class="n">flash</span><span class="o">.</span><span class="n">empty?</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>After adding the test in <a href="basic_login_fragment.html#code-flash_persistence_test" class="hyperref">Listing <span class="ref">8.9</span></a>, the login test should be <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid1010" data-tralics-id="uid1010" data-number="8.10"><div class="heading"><span class="number">Listing 8.10:</span> <span class="description"><span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test test/integration/users_login_test.rb
</pre></div></div></div><p>This shows how to run one (and only one) test file using <code>rails test</code> and the full path to the file.</p>
<p>The way to get the failing test in <a href="basic_login_fragment.html#code-flash_persistence_test" class="hyperref">Listing <span class="ref">8.9</span></a> to pass is to replace <code>flash</code> with the special variant <code>flash.now</code>, which is specifically designed for displaying flash messages on rendered pages.<span class="intersentencespace"></span> Unlike the contents of <code>flash</code>, the contents of <code>flash.now</code> disappear as soon as there is an additional request, which is exactly the behavior we’ve tested in <a href="basic_login_fragment.html#code-flash_persistence_test" class="hyperref">Listing <span class="ref">8.9</span></a>.<span class="intersentencespace"></span> With this substitution, the corrected application code appears as in <a href="basic_login_fragment.html#code-correct_login_failure" class="hyperref">Listing <span class="ref">8.11</span></a>.</p>
<div class="codelisting" id="code-correct_login_failure" data-tralics-id="uid1011" data-number="8.11"><div class="heading"><span class="number">Listing 8.11:</span> 

<span class="description">Correct code for failed login.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="c1"># Log the user in and redirect to the user's show page.</span>
    <span class="k">else</span>
<span class="hll">      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
</span>      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>We can then verify that both the login integration test and the full test suite are <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid1012" data-tralics-id="uid1012" data-number="8.12"><div class="heading"><span class="number">Listing 8.12:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test test/integration/users_login_test.rb
$ rails test
</pre></div></div></div>
<div id="sec-exercises_a_flash_test" data-tralics-id="uid1013" class="subsubsection" data-number="8.1.5.1"><h4><a href="#sec-exercises_a_flash_test" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Verify in your browser that the sequence from <a href="basic_login_fragment.html#sec-rendering_with_a_flash_message" class="hyperref">Section <span class="ref">8.1.4</span></a> works correctly, i.e., that the flash message disappears when you click on a second page. <span class="exercise" id="ex-2e6353"></span>
</li></ol>
</div></div></div><div id="sec-logging_in" data-tralics-id="cid46" class="section" data-number="8.2"><h2><a href="basic_login_fragment.html#sec-logging_in" class="heading hyperref"><span class="number">8.2 </span>Logging in</a></h2>
<p>Now that our login form can handle invalid submissions, the next step is to handle valid submissions correctly by actually logging a user in.<span class="intersentencespace"></span> In this section, we’ll log the user in with a temporary session cookie that expires automatically upon browser close.<span class="intersentencespace"></span> In <a href="advanced_login_fragment.html#sec-remember_me" class="hyperref">Section <span class="ref">9.1</span></a>, we’ll add sessions that persist even after closing the browser.</p>
<p>Implementing sessions will involve defining a large number of related functions for use across multiple controllers and views.<span class="intersentencespace"></span> You may recall from <a href="rails_flavored_ruby_fragment.html#sec-back_to_the_title_helper" class="hyperref">Section <span class="ref">4.2.5</span></a> that Ruby provides a <em>module</em> facility for packaging such functions in one place.<span class="intersentencespace"></span> Conveniently, a Sessions helper module was generated automatically when generating the Sessions controller (<a href="basic_login_fragment.html#sec-sessions_controller" class="hyperref">Section <span class="ref">8.1.1</span></a>).<span class="intersentencespace"></span> Moreover, such helpers are automatically included in Rails views; by including the module into the base class of all controllers (the Application controller), we arrange to make them available in our controllers as well (<a href="basic_login_fragment.html#code-sessions_helper_include" class="hyperref">Listing <span class="ref">8.13</span></a>).<sup id="cha-8_footnote-ref-3" class="footnote"><a href="#cha-8_footnote-3">3</a></sup></p>
<div class="codelisting" id="code-sessions_helper_include" data-tralics-id="uid1016" data-number="8.13"><div class="heading"><span class="number">Listing 8.13:</span> 

<span class="description">Including the Sessions helper module into the Application controller.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/application_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">protect_from_forgery</span> <span class="ss">with</span><span class="p">:</span> <span class="ss">:exception</span>
<span class="hll">  <span class="kp">include</span> <span class="no">SessionsHelper</span>
</span><span class="k">end</span>
</pre></div></div></div><p>With this configuration complete, we’re now ready to write the code to log users in.</p>
<div id="sec-a_working_log_in_method" data-tralics-id="uid1017" class="subsection" data-number="8.2.1"><h3><a href="basic_login_fragment.html#sec-a_working_log_in_method" class="heading hyperref"><span class="number">8.2.1 </span>The <code class="tt">log_in</code> method</a></h3>
<p>Logging a user in is simple with the help of the <code>session</code> method defined by Rails.<span class="intersentencespace"></span> (This method is separate and distinct from the Sessions controller generated in <a href="basic_login_fragment.html#sec-sessions_controller" class="hyperref">Section <span class="ref">8.1.1</span></a>.)<span class="intersentencespace"></span> We can treat <code>session</code> as if it were a hash, and assign to it as follows:</p>
<div class="code"><div class="highlight"><pre><span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</pre></div></div>
<p>This places a temporary cookie on the user’s browser containing an encrypted version of the user’s id, which allows us to retrieve the id on subsequent pages using <code>session[:user_id]</code>.<span class="intersentencespace"></span> In contrast to the persistent cookie created by the <code>cookies</code> method (<a href="advanced_login_fragment.html#sec-remember_me" class="hyperref">Section <span class="ref">9.1</span></a>), the temporary cookie created by the <code>session</code> method expires immediately when the browser is closed.</p>
<p>Because we’ll want to use the same login technique in a couple of different places, we’ll define a method called <code>log_in</code> in the Sessions helper, as shown in <a href="basic_login_fragment.html#code-log_in_function" class="hyperref">Listing <span class="ref">8.14</span></a>.</p>
<div class="codelisting" id="code-log_in_function" data-tralics-id="uid1018" data-number="8.14"><div class="heading"><span class="number">Listing 8.14:</span> 

<span class="description">The <code>log_in</code> function.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="c1"># Logs in the given user.</span>
  <span class="k">def</span> <span class="nf">log_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="hll">    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Because temporary cookies created using the <code>session</code> method are automatically encrypted, the code in <a href="basic_login_fragment.html#code-log_in_function" class="hyperref">Listing <span class="ref">8.14</span></a> is secure, and there is no way for an attacker to use the session information to log in as the user.<span class="intersentencespace"></span> This applies only to temporary sessions initiated with the <code>session</code> method, though, and is <em>not</em> the case for persistent sessions created using the <code>cookies</code> method.<span class="intersentencespace"></span> Permanent cookies are vulnerable to a <em>session hijacking</em> attack, so in <a href="advanced_login_fragment.html#cha-advanced_login" class="hyperref">Chapter <span class="ref">9</span></a> we’ll have to be much more careful about the information we place on the user’s browser.</p>
<p>With the <code>log_in</code> method defined in <a href="basic_login_fragment.html#code-log_in_function" class="hyperref">Listing <span class="ref">8.14</span></a>, we’re now ready to complete the session <code>create</code> action by logging the user in and redirecting to the user’s profile page.<span class="intersentencespace"></span> The result appears in <a href="basic_login_fragment.html#code-log_in_success" class="hyperref">Listing <span class="ref">8.15</span></a>.<sup id="cha-8_footnote-ref-4" class="footnote"><a href="#cha-8_footnote-4">4</a></sup></p>
<div class="codelisting" id="code-log_in_success" data-tralics-id="uid1020" data-number="8.15"><div class="heading"><span class="number">Listing 8.15:</span> 

<span class="description">Logging in a user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
<span class="hll">      <span class="n">log_in</span> <span class="n">user</span>
</span><span class="hll">      <span class="n">redirect_to</span> <span class="n">user</span>
</span>    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note the compact redirect</p>
<div class="code"><div class="highlight"><pre><span class="n">redirect_to</span> <span class="n">user</span>
</pre></div></div>
<p>which we saw before in <a href="sign_up_fragment.html#sec-the_finished_signup_form" class="hyperref">Section <span class="ref">7.4.1</span></a>.<span class="intersentencespace"></span> Rails automatically converts this to the route for the user’s profile page:</p>
<div class="code"><div class="highlight"><pre><span class="n">user_url</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div></div>
<p>With the <code>create</code> action defined in <a href="basic_login_fragment.html#code-log_in_success" class="hyperref">Listing <span class="ref">8.15</span></a>, the login form defined in <a href="basic_login_fragment.html#code-login_form" class="hyperref">Listing <span class="ref">8.4</span></a> should now be working.<span class="intersentencespace"></span> It doesn’t have any effects on the application display, though, so short of inspecting the browser session directly there’s no way to tell that you’re logged in.<span class="intersentencespace"></span> As a first step toward enabling more visible changes, in <a href="basic_login_fragment.html#sec-current_user" class="hyperref">Section <span class="ref">8.2.2</span></a> we’ll retrieve the current user from the database using the id in the session.<span class="intersentencespace"></span> In <a href="basic_login_fragment.html#sec-changing_the_layout_links" class="hyperref">Section <span class="ref">8.2.3</span></a>, we’ll change the links on the application layout, including a URL to the current user’s profile.</p>
<div id="sec-exercises_a_working_log_in_method" data-tralics-id="uid1021" class="subsubsection" data-number="8.2.1.1"><h4><a href="#sec-exercises_a_working_log_in_method" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Log in with a valid user and inspect your browser’s cookies.<span class="intersentencespace"></span> What is the value of the session content?<span class="intersentencespace"></span> <em>Hint</em>: If you don’t know how to view your browser’s cookies, Google for it (<a href="beginning_fragment.html#aside-technical_sophistication" class="hyperref">Box <span class="ref">1.1</span></a>). <span class="exercise" id="ex-f3b33f"></span>
</li>
<li>What is the value of the <code>Expires</code> attribute from the previous exercise? <span class="exercise" id="ex-2f4f14"></span>
</li></ol>
</div></div>
<div id="sec-current_user" data-tralics-id="uid1024" class="subsection" data-number="8.2.2"><h3><a href="basic_login_fragment.html#sec-current_user" class="heading hyperref"><span class="number">8.2.2 </span>Current user</a></h3>
<p>Having placed the user’s id securely in the temporary session, we are now in a position to retrieve it on subsequent pages, which we’ll do by defining a <code>current_user</code> method to find the user in the database corresponding to the session id.<span class="intersentencespace"></span> The purpose of <code>current_user</code> is to allow constructions such as</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>and</p>
<div class="code"><div class="highlight"><pre><span class="n">redirect_to</span> <span class="n">current_user</span>
</pre></div></div>
<p>To find the current user, one possibility is to use the <code>find</code> method, as on the user profile page (<a href="sign_up_fragment.html#code-user_show_action" class="hyperref">Listing <span class="ref">7.5</span></a>):</p>
<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>But recall from <a href="modeling_users_fragment.html#sec-finding_user_objects" class="hyperref">Section <span class="ref">6.1.4</span></a> that <code>find</code> raises an exception if the user id doesn’t exist.<span class="intersentencespace"></span> This behavior is appropriate on the user profile page because it will only happen if the id is invalid, but in the present case <code>session[:user_id]</code> will often be <code>nil</code> (i.e., for non-logged-in users).<span class="intersentencespace"></span> To handle this possibility, we’ll use the same <code>find_by</code> method used to find by email address in the <code>create</code> method, with <code>id</code> in place of <code>email</code>:</p>
<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>Rather than raising an exception, this method returns <code>nil</code> (indicating no such user) if the id is invalid.</p>
<p>We could now define the <code>current_user</code> method as follows:</p>
<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">current_user</span>
  <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p>This would work fine, but it would hit the database multiple times if, e.g., <code>current_user</code> appeared multiple times on a page.<span class="intersentencespace"></span> Instead, we’ll follow a common Ruby convention by storing the result of <code>User.find_by</code> in an instance variable, which hits the database the first time but returns the instance variable immediately on subsequent invocations:<sup id="cha-8_footnote-ref-5" class="footnote"><a href="#cha-8_footnote-5">5</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="vi">@current_user</span><span class="o">.</span><span class="n">nil?</span>
  <span class="vi">@current_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
<span class="k">else</span>
  <span class="vi">@current_user</span>
<span class="k">end</span>
</pre></div></div>
<p>Recalling the <em>or</em> operator <code class="tt">||</code> seen in <a href="rails_flavored_ruby_fragment.html#sec-objects_and_message_passing" class="hyperref">Section <span class="ref">4.2.3</span></a>, we can rewrite this as follows:</p>
<div class="code"><div class="highlight"><pre><span class="vi">@current_user</span> <span class="o">=</span> <span class="vi">@current_user</span> <span class="o">||</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>Because a User object is true in a boolean context, the call to <code>find_by</code> only gets executed if <code>@current_user</code> hasn’t yet been assigned.</p>
<p>Although the preceding code would work, it’s not idiomatically correct Ruby; instead, the proper way to write the assignment to <code>@current_user</code> is like this:</p>
<div class="code"><div class="highlight"><pre><span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</pre></div></div>
<p>This uses the potentially confusing but frequently used <code>||=</code> (“or equals”) operator (<a href="basic_login_fragment.html#aside-or_equals" class="hyperref">Box <span class="ref">8.1</span></a>).</p>
<div class="aside" id="aside-or_equals" data-tralics-id="uid1026" data-number="8.1"><div class="heading"><span class="number">Box 8.1.</span> 

<span class="description">What the *$@!<span class="intersentencespace"></span> is <code class="tt">||=</code> ?<span class="intersentencespace"></span> </span></div>
<p>The <code class="tt">||=</code> (“or equals”) assignment operator is a common Ruby idiom and is thus important for aspiring Rails developers to recognize.<span class="intersentencespace"></span> Although at first it may seem mysterious, <em>or equals</em> is easy to understand by analogy.</p>
<p>We start by noting the common pattern of incrementing a variable:</p>
<pre>  x = x + 1</pre>
<p>Many languages provide a syntactic shortcut for this operation; in Ruby (and in C, C++, Perl, Python, Java, etc.), it can also appear as follows:</p>
<pre>  x += 1</pre>
<p>Analogous constructs exist for other operators as well:</p>
<pre>  $ rails console
  &gt;&gt; x = 1
  =&gt; 1
  &gt;&gt; x += 1
  =&gt; 2
  &gt;&gt; x *= 3
  =&gt; 6
  &gt;&gt; x -= 8
  =&gt; -2
  &gt;&gt; x /= 2
  =&gt; -1</pre>
<p>In each case, the pattern is that <code class="tt">x = x O y</code> and <code class="tt">x O= y</code> are equivalent for any operator <code class="tt">O</code>.</p>
<p>Another common Ruby pattern is assigning to a variable if it’s <code class="tt">nil</code> but otherwise leaving it alone.<span class="intersentencespace"></span> Recalling the <em>or</em> operator <code class="tt">||</code> seen in <a href="rails_flavored_ruby_fragment.html#sec-objects_and_message_passing" class="hyperref">Section <span class="ref">4.2.3</span></a>, we can write this as follows:</p>
<pre>  &gt;&gt; @foo
  =&gt; nil
  &gt;&gt; @foo = @foo || "bar"
  =&gt; "bar"
  &gt;&gt; @foo = @foo || "baz"
  =&gt; "bar"</pre>
<p>Since <code class="tt">nil</code> is false in a boolean context, the first assignment to <code class="tt">@foo</code> is <code class="tt">nil || "bar"</code>, which evaluates to <code class="tt">"bar"</code>.<span class="intersentencespace"></span> Similarly, the second assignment is <code class="tt">@foo || "baz"</code>, i.e., <code class="tt">"bar" || "baz"</code>, which also evaluates to <code class="tt">"bar"</code>.<span class="intersentencespace"></span> This is because anything other than <code class="tt">nil</code> or <code class="tt">false</code> is <code class="tt">true</code> in a boolean context, and the series of <code class="tt">||</code> expressions terminates after the first true expression is evaluated.<span class="intersentencespace"></span> (This practice of evaluating <code class="tt">||</code> expressions from left to right and stopping on the first true value is known as <em>short-circuit evaluation</em>.<span class="intersentencespace"></span> The same principle applies to <code class="tt">&amp;&amp;</code> statements, except in this case evaluation stops on the first <em>false</em> value.)</p>
<p>Comparing the console sessions for the various operators, we see that <code class="tt">@foo = @foo || "bar"</code> follows the <code class="tt">x = x O y</code> pattern with <code class="tt">||</code> in the place of <code class="tt">O</code>:</p>
<pre>  x    =   x   +   1      -&gt;     x     +=   1
  x    =   x   *   3      -&gt;     x     *=   3
  x    =   x   -   8      -&gt;     x     -=   8
  x    =   x   /   2      -&gt;     x     /=   2
  @foo = @foo || "bar"    -&gt;     @foo ||= "bar"</pre>
<p>Thus we see that <span class="inline_verbatim">@foo = @foo || "bar"</span> and <span class="inline_verbatim">@foo ||= "bar"</span> are equivalent.<span class="intersentencespace"></span> In the context of the current user, this suggests the following construction:</p>
<pre>@current_user ||= User.find_by(id: session[:user_id])</pre>
<p>Voilà !</p>
<p>(<a href="https://xkcd.com/1475/" target="_blank" rel="noopener">Technically</a>, Ruby evaluates the expression <code class="tt">@foo || @foo = "bar"</code>, which avoids an unnecessary assignment when <code class="tt">@foo</code> is not <code class="tt">nil</code> or <code class="tt">false</code>.<span class="intersentencespace"></span> But this expression doesn’t explain the <code class="tt">||=</code> notation as well, so the above discussion uses the nearly equivalent <code class="tt">@foo = @foo || "bar"</code>.)</p>

</div><p>Applying the results of the above discussion yields the succinct <code>current_user</code> method shown in <a href="basic_login_fragment.html#code-current_user" class="hyperref">Listing <span class="ref">8.16</span></a>.</p>
<div class="codelisting" id="code-current_user" data-tralics-id="uid1027" data-number="8.16"><div class="heading"><span class="number">Listing 8.16:</span> 

<span class="description">Finding the current user in the session.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="c1"># Logs in the given user.</span>
  <span class="k">def</span> <span class="nf">log_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
  <span class="k">end</span>

  <span class="c1"># Returns the current logged-in user (if any).</span>
  <span class="k">def</span> <span class="nf">current_user</span>
<span class="hll">    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>With the working <code>current_user</code> method in <a href="basic_login_fragment.html#code-current_user" class="hyperref">Listing <span class="ref">8.16</span></a>, we’re now in a position to make changes to our application based on user login status.</p>
<div id="sec-exercises_current_user" data-tralics-id="uid1028" class="subsubsection" data-number="8.2.2.1"><h4><a href="#sec-exercises_current_user" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Confirm at the console that <code>User.find_by(id: ...)</code><span class="intersentencespace"></span> returns <code>nil</code> when the corresponding user doesn’t exist. <span class="exercise" id="ex-3b50ae"></span>
</li>
<li>In a Rails console, create a <code>session</code> hash with key <code>:user_id</code>.<span class="intersentencespace"></span> By following the steps in <a href="basic_login_fragment.html#code-console_session_simulation" class="hyperref">Listing <span class="ref">8.17</span></a>, confirm that the <code>||=</code> operator works as required. <span class="exercise" id="ex-cdb219"></span>
</li></ol>
<div class="codelisting" id="code-console_session_simulation" data-tralics-id="uid1031" data-number="8.17"><div class="heading"><span class="number">Listing 8.17:</span> 

<span class="description">Simulating <code>session</code> in the console.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">session</span> <span class="o">=</span> <span class="p">{}</span>
<span class="gp">&gt;&gt; </span><span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="kp">nil</span>
<span class="gp">&gt;&gt; </span><span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
<span class="hll"><span class="go">&lt;What happens here?&gt;</span>
</span><span class="gp">&gt;&gt; </span><span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">id</span>
<span class="gp">&gt;&gt; </span><span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
<span class="hll"><span class="go">&lt;What happens here?&gt;</span>
</span><span class="gp">&gt;&gt; </span><span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
<span class="hll"><span class="go">&lt;What happens here?&gt;</span>
</span></pre></div></div></div></div></div>
<div id="sec-changing_the_layout_links" data-tralics-id="uid1032" class="subsection" data-number="8.2.3"><h3><a href="basic_login_fragment.html#sec-changing_the_layout_links" class="heading hyperref"><span class="number">8.2.3 </span>Changing the layout links</a></h3>
<p>The first practical application of logging in involves changing the layout links based on login status.<span class="intersentencespace"></span> In particular, as seen in the <a href="basic_login_fragment.html#fig-login_success_mockup" class="hyperref">Figure <span class="ref">8.7</span></a> mockup,<sup id="cha-8_footnote-ref-6" class="footnote"><a href="#cha-8_footnote-6">6</a></sup> we’ll add links for logging out, for user settings, for listing all users, and for the current user’s profile page.<span class="intersentencespace"></span> Note in <a href="basic_login_fragment.html#fig-login_success_mockup" class="hyperref">Figure <span class="ref">8.7</span></a> that the logout and profile links appear in a dropdown “Account” menu; we’ll see in <a href="basic_login_fragment.html#code-layout_login_logout_links" class="hyperref">Listing <span class="ref">8.19</span></a> how to make such a menu with Bootstrap.</p>
<div class="center figure" id="fig-login_success_mockup" data-tralics-id="uid1034" data-number="8.7">
<div class="graphics image box"><img src="images/figures/login_success_mockup.png" alt="images/figures/login_success_mockup"></div><div class="caption"><span class="header">Figure 8.7: </span><span class="description">A mockup of the user profile after a successful login.
</span></div></div>
<p>At this point, in real life I would consider writing an integration test to capture the behavior described above.<span class="intersentencespace"></span> As noted in <a href="static_pages_fragment.html#aside-when_to_test" class="hyperref">Box <span class="ref">3.3</span></a>, as you become more familiar with the testing tools in Rails you may find yourself more inclined to write tests first.<span class="intersentencespace"></span> In this case, though, such a test involves several new ideas, so for now it’s best deferred to its own section (<a href="basic_login_fragment.html#sec-testing_layout_changes" class="hyperref">Section <span class="ref">8.2.4</span></a>).</p>
<p>The way to change the links in the site layout involves using an
if-else statement inside embedded Ruby to show one set of links if the user is logged in and another set of links otherwise:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">logged_in?</span> <span class="cp">%&gt;</span>
  # Links for logged-in users
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  # Links for non-logged-in-users
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>This kind of code requires the existence of a <code>logged_in?</code> boolean method, which we’ll now define.</p>
<p>A user is logged in if there is a current user in the session, i.e., if <code>current_user</code> is not <code>nil</code>.<span class="intersentencespace"></span> Checking for this requires the use of the “not” operator (<a href="rails_flavored_ruby_fragment.html#sec-objects_and_message_passing" class="hyperref">Section <span class="ref">4.2.3</span></a>), written using an exclamation point <code>!</code> and usually read as “bang”.<span class="intersentencespace"></span> The resulting <code>logged_in?</code> method appears in <a href="basic_login_fragment.html#code-logged_in_p" class="hyperref">Listing <span class="ref">8.18</span></a>.</p>
<div class="codelisting" id="code-logged_in_p" data-tralics-id="uid1035" data-number="8.18"><div class="heading"><span class="number">Listing 8.18:</span> 

<span class="description">The <code>logged_in?</code> helper method.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="c1"># Logs in the given user.</span>
  <span class="k">def</span> <span class="nf">log_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
  <span class="k">end</span>

  <span class="c1"># Returns the current logged-in user (if any).</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Returns true if the user is logged in, false otherwise.</span>
  <span class="k">def</span> <span class="nf">logged_in?</span>
<span class="hll">    <span class="o">!</span><span class="n">current_user</span><span class="o">.</span><span class="n">nil?</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>With the addition in <a href="basic_login_fragment.html#code-logged_in_p" class="hyperref">Listing <span class="ref">8.18</span></a>, we’re now ready to change the layout links if a user is logged in.<span class="intersentencespace"></span> There are four new links, two of which are stubbed out (to be completed in <a href="updating_and_deleting_users_fragment.html#cha-updating_showing_and_deleting_users" class="hyperref">Chapter <span class="ref">10</span></a>):</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Users"</span><span class="p">,</span>    <span class="s1">'#'</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Settings"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>The logout link, meanwhile, uses the logout path defined in <a href="basic_login_fragment.html#code-sessions_resource" class="hyperref">Listing <span class="ref">8.2</span></a>:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log out"</span><span class="p">,</span> <span class="n">logout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>Notice that the logout link passes a hash argument indicating that it should submit with an HTTP <code class="tt">DELETE</code> request.<sup id="cha-8_footnote-ref-7" class="footnote"><a href="#cha-8_footnote-7">7</a></sup><span class="intersentencespace"></span> We’ll also add a profile link as follows:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Profile"</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>Here we could write</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Profile"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>but as usual Rails allows us to link directly to the user by automatically converting <code>current_user</code> into <code>user_path(current_user)</code> in this context.<span class="intersentencespace"></span> Finally, when users <em>aren’t</em> logged in, we’ll use the login path defined in <a href="basic_login_fragment.html#code-sessions_resource" class="hyperref">Listing <span class="ref">8.2</span></a> to make a link to the login form:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log in"</span><span class="p">,</span> <span class="n">login_path</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>Putting everything together gives the updated header partial shown in <a href="basic_login_fragment.html#code-layout_login_logout_links" class="hyperref">Listing <span class="ref">8.19</span></a>.</p>
<div class="codelisting" id="code-layout_login_logout_links" data-tralics-id="uid1037" data-number="8.19"><div class="heading"><span class="number">Listing 8.19:</span> 

<span class="description">Changing the layout links for logged-in users.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/layouts/_header.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"navbar navbar-fixed-top navbar-inverse"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"sample app"</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">"logo"</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;nav&gt;</span>
      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav navbar-right"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Home"</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Help"</span><span class="p">,</span> <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
<span class="hll">        <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">logged_in?</span> <span class="cp">%&gt;</span>
</span><span class="hll">          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Users"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
</span>          <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">class=</span><span class="s">"dropdown-toggle"</span> <span class="na">data-toggle=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
              Account <span class="nt">&lt;b</span> <span class="na">class=</span><span class="s">"caret"</span><span class="nt">&gt;&lt;/b&gt;</span>
            <span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"dropdown-menu"</span><span class="nt">&gt;</span>
<span class="hll">              <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Profile"</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
</span><span class="hll">              <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Settings"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
</span>              <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"divider"</span><span class="nt">&gt;&lt;/li&gt;</span>
              <span class="nt">&lt;li&gt;</span>
<span class="hll">                <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log out"</span><span class="p">,</span> <span class="n">logout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">"delete"</span> <span class="cp">%&gt;</span>
</span>              <span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;/ul&gt;</span>
          <span class="nt">&lt;/li&gt;</span>
<span class="hll">        <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
</span><span class="hll">          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log in"</span><span class="p">,</span> <span class="n">login_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
</span><span class="hll">        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</span>      <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;/nav&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div></div></div><p>As part of including the new links into the layout, <a href="basic_login_fragment.html#code-layout_login_logout_links" class="hyperref">Listing <span class="ref">8.19</span></a> takes advantage of Bootstrap’s ability to make dropdown menus.<sup id="cha-8_footnote-ref-8" class="footnote"><a href="#cha-8_footnote-8">8</a></sup><span class="intersentencespace"></span> Note in particular the inclusion of the special Bootstrap CSS classes such as <code>dropdown</code>, <code>dropdown-menu</code>, etc.<span class="intersentencespace"></span> To activate the dropdown menu, we need to include Bootstrap’s custom JavaScript library in the Rails asset pipeline’s <code>application.js</code> file, as shown in <a href="basic_login_fragment.html#code-bootstrap_js" class="hyperref">Listing <span class="ref">8.20</span></a>.</p>
<div class="codelisting" id="code-bootstrap_js" data-tralics-id="uid1039" data-number="8.20"><div class="heading"><span class="number">Listing 8.20:</span> 

<span class="description">Adding the Bootstrap JavaScript library to <code>application.js</code>.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/assets/javascripts/application.js</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="c1">//= require jquery</span>
<span class="c1">//= require jquery_ujs</span>
<span class="hll"><span class="c1">//= require bootstrap</span>
</span><span class="c1">//= require turbolinks</span>
<span class="c1">//= require_tree .</span>
</pre></div></div></div><p>At this point, you should visit the login path and log in as a valid user (username <code>example@railstutorial.org</code>, password <code>foobar</code>), which effectively tests the code in the previous three sections.<sup id="cha-8_footnote-ref-9" class="footnote"><a href="#cha-8_footnote-9">9</a></sup><span class="intersentencespace"></span> With the code in <a href="basic_login_fragment.html#code-layout_login_logout_links" class="hyperref">Listing <span class="ref">8.19</span></a> and <a href="basic_login_fragment.html#code-bootstrap_js" class="hyperref">Listing <span class="ref">8.20</span></a>, you should see the dropdown menu and links for logged-in users, as shown in <a href="basic_login_fragment.html#fig-profile_with_logout_link" class="hyperref">Figure <span class="ref">8.8</span></a>.</p>
<p>If you quit your browser completely, you should also be able to verify that the application forgets your login status, requiring you to log in again to see the changes described above.<sup id="cha-8_footnote-ref-10" class="footnote"><a href="#cha-8_footnote-10">10</a></sup></p>
<div class="center figure" id="fig-profile_with_logout_link" data-tralics-id="uid1042" data-number="8.8">
<div class="graphics image"><img src="images/figures/profile_with_logout_link_3rd_edition.png" alt="images/figures/profile_with_logout_link_3rd_edition"></div><div class="caption"><span class="header">Figure 8.8: </span><span class="description">A logged-in user with new links and a dropdown menu.
</span></div></div>
<div id="sec-exercises_changing_the_layout_links" data-tralics-id="uid1043" class="subsubsection" data-number="8.2.3.1"><h4><a href="#sec-exercises_changing_the_layout_links" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Using the cookie inspector in your browser (<a href="basic_login_fragment.html#sec-exercises_a_working_log_in_method" class="hyperref">Section <span class="ref">8.2.1.1</span></a>), remove the session cookie and confirm that the layout links revert to the non-logged-in state. <span class="exercise" id="ex-86a90a"></span>
</li>
<li>Log in again, confirming that the layout links change correctly.<span class="intersentencespace"></span> Then quit your browser and start it again to confirm that the layout links revert to the non-logged-in state.<span class="intersentencespace"></span> (If your browser has a “remember where I left off” feature that automatically restores the session, be sure to disable it in this step (<a href="beginning_fragment.html#aside-technical_sophistication" class="hyperref">Box <span class="ref">1.1</span></a>).) <span class="exercise" id="ex-df67d8"></span>
</li></ol>
</div></div>
<div id="sec-testing_layout_changes" data-tralics-id="uid1046" class="subsection" data-number="8.2.4"><h3><a href="basic_login_fragment.html#sec-testing_layout_changes" class="heading hyperref"><span class="number">8.2.4 </span>Testing layout changes</a></h3>
<p>Having verified by hand that the application is behaving properly upon successful login, before moving on we’ll write an integration test to capture that behavior and catch regressions.<span class="intersentencespace"></span> We’ll build on the test from <a href="basic_login_fragment.html#code-flash_persistence_test" class="hyperref">Listing <span class="ref">8.9</span></a> and write a series of steps to verify the following sequence of actions:</p>
<ol>
<li>Visit the login path.<span class="intersentencespace"></span>
</li>
<li>Post valid information to the sessions path.<span class="intersentencespace"></span>
</li>
<li>Verify that the login link disappears.<span class="intersentencespace"></span>
</li>
<li>Verify that a logout link appears
</li>
<li>Verify that a profile link appears.<span class="intersentencespace"></span>
</li></ol>
<p>In order to see these changes, our test needs to log in as a previously registered user, which means that such a user must already exist in the database.<span class="intersentencespace"></span> The default Rails way to do this is to use <em>fixtures</em>, which are a way of organizing data to be loaded into the test database.<span class="intersentencespace"></span> We discovered in <a href="modeling_users_fragment.html#sec-uniqueness_validation" class="hyperref">Section <span class="ref">6.2.5</span></a> that we needed to delete the default fixtures so that our email uniqueness tests would pass (<a href="modeling_users_fragment.html#code-empty_fixtures" class="hyperref">Listing <span class="ref">6.31</span></a>).<span class="intersentencespace"></span> Now we’re ready to start filling in that empty file with custom fixtures of our own.</p>
<p>In the present case, we need only one user, whose information should consist of a valid name and email address.<span class="intersentencespace"></span> Because we’ll need to log the user in, we also have to include a valid password to compare with the password submitted to the Sessions controller’s <code>create</code> action.<span class="intersentencespace"></span> Referring to the data model in <a href="modeling_users_fragment.html#fig-user_model_password_digest" class="hyperref">Figure <span class="ref">6.8</span></a>, we see that this means creating a <code>password_digest</code> attribute for the user fixture, which we’ll accomplish by defining a <code>digest</code> method of our own.</p>
<p>As discussed in <a href="modeling_users_fragment.html#sec-a_hashed_password" class="hyperref">Section <span class="ref">6.3.1</span></a>, the password digest is created using bcrypt (via <code>has_secure_password</code>), so we’ll need to create the fixture password using the same method.<span class="intersentencespace"></span> By inspecting the <a href="https://github.com/rails/rails/blob/master/activemodel/lib/active_model/secure_password.rb" target="_blank" rel="noopener">secure password source code</a>, we find that this method is</p>
<div class="code"><div class="highlight"><pre><span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="ss">cost</span><span class="p">:</span> <span class="n">cost</span><span class="p">)</span>
</pre></div></div>
<p>where <code>string</code> is the string to be hashed and <code>cost</code> is the <em>cost parameter</em> that determines the computational cost to calculate the hash.<span class="intersentencespace"></span> Using a high cost makes it computationally intractable to use the hash to determine the original password, which is an important security precaution in a production environment, but in tests we want the <code>digest</code> method to be as fast as possible.<span class="intersentencespace"></span> The secure password source code has a line for this as well:</p>
<div class="code"><div class="highlight"><pre><span class="n">cost</span> <span class="o">=</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">SecurePassword</span><span class="o">.</span><span class="n">min_cost</span> <span class="p">?</span> <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">::</span><span class="no">MIN_COST</span> <span class="p">:</span>
                                              <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">.</span><span class="n">cost</span>
</pre></div></div>
<p>This rather obscure code, which you don’t need to understand in detail, arranges for precisely the behavior described above: it uses the minimum cost parameter in tests and a normal (high) cost parameter in production.<span class="intersentencespace"></span> (We’ll learn more about the strange <code>?</code>-<code>:</code> notation in <a href="advanced_login_fragment.html#sec-remember_me_checkbox" class="hyperref">Section <span class="ref">9.2</span></a>.)</p>
<p>There are several places we could put the resulting <code>digest</code> method, but we’ll have an opportunity in <a href="advanced_login_fragment.html#sec-remember_token" class="hyperref">Section <span class="ref">9.1.1</span></a> to reuse <code>digest</code> in the User model.<span class="intersentencespace"></span> This suggests placing the method in <code>user.rb</code>.<span class="intersentencespace"></span> Because we won’t necessarily have access to a user object when calculating the digest (as will be the case in the fixtures file), we’ll attach the <code>digest</code> method to the User class itself, which (as we saw briefly in <a href="rails_flavored_ruby_fragment.html#sec-constructors" class="hyperref">Section <span class="ref">4.4.1</span></a>) makes it a <em>class method</em>.<span class="intersentencespace"></span> The result appears in <a href="basic_login_fragment.html#code-digest_method" class="hyperref">Listing <span class="ref">8.21</span></a>.</p>
<div class="codelisting" id="code-digest_method" data-tralics-id="uid1052" data-number="8.21"><div class="heading"><span class="number">Listing 8.21:</span> 

<span class="description">Adding a digest method for use in fixtures.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
  <span class="n">has_secure_password</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">minimum</span><span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>

  <span class="c1"># Returns the hash digest of the given string.</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">digest</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<span class="hll">    <span class="n">cost</span> <span class="o">=</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">SecurePassword</span><span class="o">.</span><span class="n">min_cost</span> <span class="p">?</span> <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">::</span><span class="no">MIN_COST</span> <span class="p">:</span>
</span><span class="hll">                                                  <span class="no">BCrypt</span><span class="o">::</span><span class="no">Engine</span><span class="o">.</span><span class="n">cost</span>
</span><span class="hll">    <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="ss">cost</span><span class="p">:</span> <span class="n">cost</span><span class="p">)</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>With the <code>digest</code> method from <a href="basic_login_fragment.html#code-digest_method" class="hyperref">Listing <span class="ref">8.21</span></a>, we are now ready to create a user fixture for a valid user, as shown in <a href="basic_login_fragment.html#code-real_user_fixture" class="hyperref">Listing <span class="ref">8.22</span></a>.<sup id="cha-8_footnote-ref-11" class="footnote"><a href="#cha-8_footnote-11">11</a></sup></p>
<div class="codelisting" id="code-real_user_fixture" data-tralics-id="uid1054" data-number="8.22"><div class="heading"><span class="number">Listing 8.22:</span> 

<span class="description">A fixture for testing user login.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">test/fixtures/users.yml</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="l-Scalar-Plain">michael</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Michael Example</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael@example.com</span>
  <span class="l-Scalar-Plain">password_digest</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= User.digest('password') %&gt;</span>
</pre></div></div></div><p>Note in particular that fixtures support embedded Ruby, which allows us to use</p>
<div class="code"><div class="highlight"><pre><span class="o">&lt;%=</span> <span class="no">User</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="s1">'password'</span><span class="p">)</span> <span class="o">%&gt;</span>
</pre></div></div>
<p>to create the valid password digest for the test user.</p>
<p>Although we’ve defined the <code>password_digest</code> attribute required by <code>has_secure_password</code>, sometimes it’s convenient to refer to the plain (virtual) password as well.<span class="intersentencespace"></span> Unfortunately, this is impossible to arrange with fixtures, and adding a <code>password</code> attribute to <a href="basic_login_fragment.html#code-real_user_fixture" class="hyperref">Listing <span class="ref">8.22</span></a> causes Rails to complain that there is no such column in the database (which is true).<span class="intersentencespace"></span> We’ll make do by adopting the convention that all fixture users have the same password (<code>’password’</code>).</p>
<p>Having created a fixture with a valid user, we can retrieve it inside a test as follows:</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
</pre></div></div>
<p>Here <code>users</code> corresponds to the fixture filename <code>users.yml</code>, while the symbol <code>:michael</code> references user with the key shown in <a href="basic_login_fragment.html#code-real_user_fixture" class="hyperref">Listing <span class="ref">8.22</span></a>.</p>
<p>With the fixture user as above, we can now write a test for the layout links by converting the sequence enumerated at the beginning of this section into code, as shown in <a href="basic_login_fragment.html#code-user_login_test_valid_information" class="hyperref">Listing <span class="ref">8.23</span></a>.</p>
<div class="codelisting" id="code-user_login_test_valid_information" data-tralics-id="uid1055" data-number="8.23"><div class="heading"><span class="number">Listing 8.23:</span> 

<span class="description">A test for user logging in with valid information.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_login_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersLoginTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

<span class="hll">  <span class="k">def</span> <span class="nf">setup</span>
</span><span class="hll">    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
</span><span class="hll">  <span class="k">end</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"login with valid information"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">login_path</span>
    <span class="n">post</span> <span class="n">login_path</span><span class="p">,</span> <span class="ss">params</span><span class="p">:</span> <span class="p">{</span> <span class="ss">session</span><span class="p">:</span> <span class="p">{</span> <span class="ss">email</span><span class="p">:</span>    <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                                          <span class="ss">password</span><span class="p">:</span> <span class="s1">'password'</span> <span class="p">}</span> <span class="p">}</span>
    <span class="n">assert_redirected_to</span> <span class="vi">@user</span>
    <span class="n">follow_redirect!</span>
    <span class="n">assert_template</span> <span class="s1">'users/show'</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">login_path</span><span class="p">,</span> <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">logout_path</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Here we’ve used</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_redirected_to</span> <span class="vi">@user</span>
</pre></div></div>
<p>to check the right redirect target and</p>
<div class="code"><div class="highlight"><pre><span class="n">follow_redirect!</span>
</pre></div></div>
<p>to actually visit the target page.<span class="intersentencespace"></span> <a href="basic_login_fragment.html#code-user_login_test_valid_information" class="hyperref">Listing <span class="ref">8.23</span></a> also verifies that the login link disappears by verifying that there are <em>zero</em> login path links on the page:</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">login_path</span><span class="p">,</span> <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span>
</pre></div></div>
<p>By including the extra <code>count: 0</code> option, we tell <code>assert_select</code> that we expect there to be zero links matching the given pattern.<span class="intersentencespace"></span> (Compare this to <code>count: 2</code> in <a href="filling_in_the_layout_fragment.html#code-layout_links_test" class="hyperref">Listing <span class="ref">5.32</span></a>, which checks for exactly two matching links.)</p>
<p>Because the application code was already working, this test should be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid1056" data-tralics-id="uid1056" data-number="8.24"><div class="heading"><span class="number">Listing 8.24:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test test/integration/users_login_test.rb
</pre></div></div></div>
<div id="sec-exercises_testing_layout_changes" data-tralics-id="uid1057" class="subsubsection" data-number="8.2.4.1"><h4><a href="#sec-exercises_testing_layout_changes" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Delete the bang <code>!</code> in the Session helper’s <code>logged_in?</code> method and confirm that the test in <a href="basic_login_fragment.html#code-user_login_test_valid_information" class="hyperref">Listing <span class="ref">8.23</span></a> is <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>. <span class="exercise" id="ex-55faf3"></span>
</li>
<li>Restore the <code>!</code> to get back to <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>. <span class="exercise" id="ex-2f5db3"></span>
</li></ol>
</div></div>
<div id="sec-login_upon_signup" data-tralics-id="uid1060" class="subsection" data-number="8.2.5"><h3><a href="basic_login_fragment.html#sec-login_upon_signup" class="heading hyperref"><span class="number">8.2.5 </span>Login upon signup</a></h3>
<p>Although our authentication system is now working, newly registered users might be confused, as they are not logged in by default.<span class="intersentencespace"></span> Because it would be strange to force users to log in immediately after signing up, we’ll log in new users automatically as part of the signup process.<span class="intersentencespace"></span> To arrange this behavior, all we need to do is add a call to <code>log_in</code> in the Users controller <code>create</code> action, as shown in <a href="basic_login_fragment.html#code-login_upon_signup" class="hyperref">Listing <span class="ref">8.25</span></a>.<sup id="cha-8_footnote-ref-12" class="footnote"><a href="#cha-8_footnote-12">12</a></sup></p>
<div class="codelisting" id="code-login_upon_signup" data-tralics-id="uid1062" data-number="8.25"><div class="heading"><span class="number">Listing 8.25:</span> 

<span class="description">Logging in the user upon signup.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
<span class="hll">      <span class="n">log_in</span> <span class="vi">@user</span>
</span>      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Welcome to the Sample App!"</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>To test the behavior from <a href="basic_login_fragment.html#code-login_upon_signup" class="hyperref">Listing <span class="ref">8.25</span></a>, we can add a line to the test from <a href="sign_up_fragment.html#code-a_test_for_valid_submission" class="hyperref">Listing <span class="ref">7.33</span></a> to check that the user is logged in.<span class="intersentencespace"></span> It’s helpful in this context to define an <code>is_logged_in?</code> helper method to parallel the <code>logged_in?</code> helper defined in <a href="basic_login_fragment.html#code-logged_in_p" class="hyperref">Listing <span class="ref">8.18</span></a>, which returns <code>true</code> if there’s a user id in the (test) session and false otherwise (<a href="basic_login_fragment.html#code-test_helper_sessions" class="hyperref">Listing <span class="ref">8.26</span></a>).<span class="intersentencespace"></span> (Because helper methods aren’t available in tests, we can’t use the <code>current_user</code> as in <a href="basic_login_fragment.html#code-logged_in_p" class="hyperref">Listing <span class="ref">8.18</span></a>, but the <code>session</code> method is available, so we use that instead.)<span class="intersentencespace"></span> Here we use <code>is_logged_in?</code> instead of <code>logged_in?</code> so that the test helper and Sessions helper methods have different names, which prevents them from being mistaken for each other.<sup id="cha-8_footnote-ref-13" class="footnote"><a href="#cha-8_footnote-13">13</a></sup></p>
<div class="codelisting" id="code-test_helper_sessions" data-tralics-id="uid1064" data-number="8.26"><div class="heading"><span class="number">Listing 8.26:</span> 

<span class="description">A boolean method for login status inside tests.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">test/test_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">ENV</span><span class="o">[</span><span class="s1">'RAILS_ENV'</span><span class="o">]</span> <span class="o">||=</span> <span class="s1">'test'</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="k">class</span> <span class="nc">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="n">fixtures</span> <span class="ss">:all</span>

  <span class="c1"># Returns true if a test user is logged in.</span>
<span class="hll">  <span class="k">def</span> <span class="nf">is_logged_in?</span>
</span><span class="hll">    <span class="o">!</span><span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">].</span><span class="n">nil?</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="k">end</span>
</pre></div></div></div><p>With the code in <a href="basic_login_fragment.html#code-test_helper_sessions" class="hyperref">Listing <span class="ref">8.26</span></a>, we can assert that the user is logged in after signup using the line shown in <a href="basic_login_fragment.html#code-login_after_signup_test" class="hyperref">Listing <span class="ref">8.27</span></a>.</p>
<div class="codelisting" id="code-login_after_signup_test" data-tralics-id="uid1065" data-number="8.27"><div class="heading"><span class="number">Listing 8.27:</span> 

<span class="description">A test of login after signup.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_signup_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersSignupTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"valid signup information"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">signup_path</span>
    <span class="n">assert_difference</span> <span class="s1">'User.count'</span><span class="p">,</span> <span class="mi">1</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">users_path</span><span class="p">,</span> <span class="ss">params</span><span class="p">:</span> <span class="p">{</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span>  <span class="s2">"Example User"</span><span class="p">,</span>
                                         <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                                         <span class="ss">password</span><span class="p">:</span>              <span class="s2">"password"</span><span class="p">,</span>
                                         <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"password"</span> <span class="p">}</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="n">follow_redirect!</span>
    <span class="n">assert_template</span> <span class="s1">'users/show'</span>
<span class="hll">    <span class="n">assert</span> <span class="n">is_logged_in?</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>At this point, the test suite should still be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid1066" data-tralics-id="uid1066" data-number="8.28"><div class="heading"><span class="number">Listing 8.28:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div>
<div id="sec-exercises_login_upon_signup" data-tralics-id="uid1067" class="subsubsection" data-number="8.2.5.1"><h4><a href="#sec-exercises_login_upon_signup" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Is the test suite <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span> or <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span> if you comment out the <code>log_in</code> line in <a href="basic_login_fragment.html#code-login_upon_signup" class="hyperref">Listing <span class="ref">8.25</span></a>? <span class="exercise" id="ex-c5176d"></span>
</li>
<li>By using your <a href="https://www.learnenough.com/text-editor-tutorial" target="_blank" rel="noopener">text editor</a>’s ability to <a href="https://www.learnenough.com/text-editor-tutorial#sec-commenting_out" target="_blank" rel="noopener">comment out</a> code, toggle back and forth between commenting out code in <a href="basic_login_fragment.html#code-login_upon_signup" class="hyperref">Listing <span class="ref">8.25</span></a> and confirm that the test suite toggles between <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span> and <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>.<span class="intersentencespace"></span> (You will need to save the file between toggles.) <span class="exercise" id="ex-2ef552"></span>
</li></ol>
</div></div></div><div id="sec-logging_out" data-tralics-id="cid47" class="section" data-number="8.3"><h2><a href="basic_login_fragment.html#sec-logging_out" class="heading hyperref"><span class="number">8.3 </span>Logging out</a></h2>
<p>As discussed in <a href="basic_login_fragment.html#sec-sessions_and_failed_login" class="hyperref">Section <span class="ref">8.1</span></a>, our authentication model is to keep users logged in until they log out explicitly.<span class="intersentencespace"></span> In this section, we’ll add this necessary logout capability.<span class="intersentencespace"></span> Because the “Log out” link has already been defined (<a href="basic_login_fragment.html#code-layout_login_logout_links" class="hyperref">Listing <span class="ref">8.19</span></a>), all we need is to write a valid controller action to destroy user sessions.</p>
<p>So far, the Sessions controller actions have followed the RESTful convention of using <code>new</code> for a login page and <code>create</code> to complete the login.<span class="intersentencespace"></span> We’ll continue this theme by using a <code>destroy</code> action to delete sessions, i.e., to log out.<span class="intersentencespace"></span> Unlike the login functionality, which we use in both <a href="basic_login_fragment.html#code-log_in_success" class="hyperref">Listing <span class="ref">8.15</span></a> and <a href="basic_login_fragment.html#code-login_upon_signup" class="hyperref">Listing <span class="ref">8.25</span></a>, we’ll only be logging out in one place, so we’ll put the relevant code directly in the <code>destroy</code> action.<span class="intersentencespace"></span> As we’ll see in <a href="advanced_login_fragment.html#sec-remember_tests" class="hyperref">Section <span class="ref">9.3</span></a>, this design (with a little refactoring) will also make the authentication machinery easier to test.</p>
<p>Logging out involves undoing the effects of the <code>log_in</code> method from <a href="basic_login_fragment.html#code-log_in_function" class="hyperref">Listing <span class="ref">8.14</span></a>, which involves deleting the user id from the session.<sup id="cha-8_footnote-ref-14" class="footnote"><a href="#cha-8_footnote-14">14</a></sup><span class="intersentencespace"></span> To do this, we use the <code>delete</code> method as follows:</p>
<div class="code"><div class="highlight"><pre><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span>
</pre></div></div>
<p>We’ll also set the current user to <code>nil</code>, although in the present case this won’t matter because of an immediate redirect to the root URL.<sup id="cha-8_footnote-ref-15" class="footnote"><a href="#cha-8_footnote-15">15</a></sup><span class="intersentencespace"></span> As with <code>log_in</code> and associated methods, we’ll put the resulting <code>log_out</code> method in the Sessions helper module, as shown in <a href="basic_login_fragment.html#code-log_out_method" class="hyperref">Listing <span class="ref">8.29</span></a>.</p>
<div class="codelisting" id="code-log_out_method" data-tralics-id="uid1072" data-number="8.29"><div class="heading"><span class="number">Listing 8.29:</span> 

<span class="description">The <code>log_out</code> method.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="c1"># Logs in the given user.</span>
  <span class="k">def</span> <span class="nf">log_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Logs out the current user.</span>
  <span class="k">def</span> <span class="nf">log_out</span>
<span class="hll">    <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span>
</span><span class="hll">    <span class="vi">@current_user</span> <span class="o">=</span> <span class="kp">nil</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>We can put the <code>log_out</code> method to use in the Sessions controller’s <code>destroy</code> action, as shown in <a href="basic_login_fragment.html#code-destroy_session" class="hyperref">Listing <span class="ref">8.30</span></a>.</p>
<div class="codelisting" id="code-destroy_session" data-tralics-id="uid1073" data-number="8.30"><div class="heading"><span class="number">Listing 8.30:</span> 

<span class="description">Destroying a session (user logout).<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="n">log_in</span> <span class="n">user</span>
      <span class="n">redirect_to</span> <span class="n">user</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
<span class="hll">    <span class="n">log_out</span>
</span><span class="hll">    <span class="n">redirect_to</span> <span class="n">root_url</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>To test the logout machinery, we can add some steps to the user login test from <a href="basic_login_fragment.html#code-user_login_test_valid_information" class="hyperref">Listing <span class="ref">8.23</span></a>.<span class="intersentencespace"></span> After logging in, we use <code>delete</code> to issue a <code class="tt">DELETE</code> request to the logout path (<a href="basic_login_fragment.html#table-RESTful_sessions" class="hyperref">Table <span class="ref">8.1</span></a>) and verify that the user is logged out and redirected to the root URL.<span class="intersentencespace"></span> We also check that the login link reappears and that the logout and profile links disappear.<span class="intersentencespace"></span> The new steps appear in <a href="basic_login_fragment.html#code-user_logout_test" class="hyperref">Listing <span class="ref">8.31</span></a>.</p>
<div class="codelisting" id="code-user_logout_test" data-tralics-id="uid1074" data-number="8.31"><div class="heading"><span class="number">Listing 8.31:</span> 

<span class="description">A test for user logout.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_login_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersLoginTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="hll">  <span class="nb">test</span> <span class="s2">"login with valid information followed by logout"</span> <span class="k">do</span>
</span>    <span class="n">get</span> <span class="n">login_path</span>
    <span class="n">post</span> <span class="n">login_path</span><span class="p">,</span> <span class="ss">params</span><span class="p">:</span> <span class="p">{</span> <span class="ss">session</span><span class="p">:</span> <span class="p">{</span> <span class="ss">email</span><span class="p">:</span>    <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                                          <span class="ss">password</span><span class="p">:</span> <span class="s1">'password'</span> <span class="p">}</span> <span class="p">}</span>
<span class="hll">    <span class="n">assert</span> <span class="n">is_logged_in?</span>
</span>    <span class="n">assert_redirected_to</span> <span class="vi">@user</span>
    <span class="n">follow_redirect!</span>
    <span class="n">assert_template</span> <span class="s1">'users/show'</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">login_path</span><span class="p">,</span> <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">logout_path</span>
    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
<span class="hll">    <span class="n">delete</span> <span class="n">logout_path</span>
</span><span class="hll">    <span class="n">assert_not</span> <span class="n">is_logged_in?</span>
</span><span class="hll">    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
</span><span class="hll">    <span class="n">follow_redirect!</span>
</span><span class="hll">    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">login_path</span>
</span><span class="hll">    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">logout_path</span><span class="p">,</span>      <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span>
</span><span class="hll">    <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>(Now that we have <code>is_logged_in?</code> available in tests, we’ve also thrown in a bonus <code>assert is_logged_in?</code> immediately after posting valid information to the sessions path.)</p>
<p>With the session <code>destroy</code> action thus defined and tested, the initial signup/login/logout triumvirate is complete, and the test suite should be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid1075" data-tralics-id="uid1075" data-number="8.32"><div class="heading"><span class="number">Listing 8.32:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div>
<div id="sec-exercises_logging_out" data-tralics-id="uid1076" class="subsubsection" data-number="8.3.5.2"><h4><a href="#sec-exercises_logging_out" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Confirm in a browser that the “Log out” link causes the correct changes in the site layout.<span class="intersentencespace"></span> What is the correspondence between these changes and the final three steps in <a href="basic_login_fragment.html#code-user_logout_test" class="hyperref">Listing <span class="ref">8.31</span></a>? <span class="exercise" id="ex-0ed3ee"></span>
</li>
<li>By checking the site cookies, confirm that the session is correctly removed after logging out. <span class="exercise" id="ex-9fb8a3"></span>
</li></ol>
</div></div><div id="sec-basic_login_conclusion" data-tralics-id="cid48" class="section" data-number="8.4"><h2><a href="basic_login_fragment.html#sec-basic_login_conclusion" class="heading hyperref"><span class="number">8.4 </span>Conclusion</a></h2>
<p>With the material in this chapter, our sample application has a fully functional login and authentication system.<span class="intersentencespace"></span> In the next chapter, we’ll take our app to the next level by adding the ability to remember users for longer than a single browser session.</p>
<p>Before moving on, merge your changes back into the master branch:</p>
<div class="code"><div class="highlight"><pre>$ rails test
$ git add -A
$ git commit -m "Implement basic login"
$ git checkout master
$ git merge basic-login
</pre></div></div>
<p>Then push up to the remote repository:</p>
<div class="code"><div class="highlight"><pre>$ rails test
$ git push
</pre></div></div>
<p>Finally, deploy to Heroku as usual:</p>
<div class="code"><div class="highlight"><pre>$ git push heroku
</pre></div></div>
<div id="sec-basic_login_what_we_learned_in_this_chapter" data-tralics-id="uid1079" class="subsection" data-number="8.4.1"><h3><a href="basic_login_fragment.html#sec-basic_login_what_we_learned_in_this_chapter" class="heading hyperref"><span class="number">8.4.1 </span>What we learned in this chapter</a></h3>
<ul>
<li>Rails can maintain state from one page to the next using temporary cookies via the <code>session</code> method.<span class="intersentencespace"></span>
</li>
<li>The login form is designed to create a new session to log a user in.<span class="intersentencespace"></span>
</li>
<li>The <code>flash.now</code> method is used for flash messages on rendered pages.<span class="intersentencespace"></span>
</li>
<li>Test-driven development is useful when debugging by reproducing the bug in a test.<span class="intersentencespace"></span>
</li>
<li>Using the <code>session</code> method, we can securely place a user id on the browser to create a temporary session.<span class="intersentencespace"></span>
</li>
<li>We can change features such as links on the layouts based on login status.<span class="intersentencespace"></span>
</li>
<li>Integration tests can verify correct routes, database updates, and proper changes to the layout.<span class="intersentencespace"></span>
</li></ul>
</div></div><div id="cha-8_footnotes">
  <ol class="footnotes">
    <li id="cha-8_footnote-1">Some browsers offer an option to restore such sessions via a “continue where you left off” feature, but of course Rails has no control over this behavior. <a class="arrow" href="#cha-8_footnote-ref-1">↑</a></li>
    <li id="cha-8_footnote-2">A second option is to use <code>form_tag</code> in place of <code>form_for</code>, which might be even more idiomatically correct Rails, but it has less in common with the signup form, and at this stage I want to emphasize the parallel structure. <a class="arrow" href="#cha-8_footnote-ref-2">↑</a></li>
    <li id="cha-8_footnote-3">I like this technique because it connects to the pure Ruby way of including modules, but Rails 4 introduced a technique called <em>concerns</em> that can also be used for this purpose.<span class="intersentencespace"></span> To learn how to use concerns, run a search for “<a href="http://lmgtfy.com/?q=how+to+use+concerns+in+rails" target="_blank" rel="noopener">how to use concerns in Rails</a>”. <a class="arrow" href="#cha-8_footnote-ref-3">↑</a></li>
    <li id="cha-8_footnote-4">The <code>log_in</code> method is available in the Sessions controller because of the module inclusion in <a href="basic_login_fragment.html#code-sessions_helper_include" class="hyperref">Listing <span class="ref">8.13</span></a>. <a class="arrow" href="#cha-8_footnote-ref-4">↑</a></li>
    <li id="cha-8_footnote-5">This practice of remembering variable assignments from one method invocation to the next is known as <a href="http://en.wikipedia.org/wiki/Memoization" target="_blank" rel="noopener"><em>memoization</em></a>.<span class="intersentencespace"></span> (Note that this is a technical term; in particular, it’s <em>not</em> a misspelling of “memorization”—a subtlety lost on the hapless copyeditor of a previous edition of this book.) <a class="arrow" href="#cha-8_footnote-ref-5">↑</a></li>
    <li id="cha-8_footnote-6">Image retrieved from https://www.flickr.com/photos/elevy/14730820387 on 2016-06-03.<span class="intersentencespace"></span> Copyright © 2014 by Elias Levy and used unaltered under the terms of the <a href="https://creativecommons.org/licenses/by/2.0/" target="_blank" rel="noopener">Creative Commons Attribution 2.0 Generic</a> license. <a class="arrow" href="#cha-8_footnote-ref-6">↑</a></li>
    <li id="cha-8_footnote-7">Web browsers can’t actually issue <code class="tt">DELETE</code> requests; Rails fakes it with JavaScript. <a class="arrow" href="#cha-8_footnote-ref-7">↑</a></li>
    <li id="cha-8_footnote-8">See the <a href="http://getbootstrap.com/components/" target="_blank" rel="noopener">Bootstrap components page</a> for more information. <a class="arrow" href="#cha-8_footnote-ref-8">↑</a></li>
    <li id="cha-8_footnote-9">You may have to restart the webserver to get this to work (<a href="beginning_fragment.html#aside-technical_sophistication" class="hyperref">Box <span class="ref">1.1</span></a>). <a class="arrow" href="#cha-8_footnote-ref-9">↑</a></li>
    <li id="cha-8_footnote-10">If you’re using the cloud IDE, I recommend using a different browser to test the login behavior so that you don’t have to close down the browser running the IDE. <a class="arrow" href="#cha-8_footnote-ref-10">↑</a></li>
    <li id="cha-8_footnote-11">It’s worth noting that indentation in fixture files must take the form of spaces, not tabs, so take care when copying code like that shown in <a href="basic_login_fragment.html#code-real_user_fixture" class="hyperref">Listing <span class="ref">8.22</span></a>. <a class="arrow" href="#cha-8_footnote-ref-11">↑</a></li>
    <li id="cha-8_footnote-12">As with the Sessions controller, the <code>log_in</code> method is available in the Users controller because of the module inclusion in <a href="basic_login_fragment.html#code-sessions_helper_include" class="hyperref">Listing <span class="ref">8.13</span></a>. <a class="arrow" href="#cha-8_footnote-ref-12">↑</a></li>
    <li id="cha-8_footnote-13">For example, I once had a test suite that was <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span> even after accidentally deleting the main <code>log_in</code> method in the Sessions helper.<span class="intersentencespace"></span> The reason is that the tests were happily using a test helper with the same name, thereby passing even though the application was completely broken.<span class="intersentencespace"></span> As with <code>is_logged_in?</code>, we’ll avoid this issue by defining the test helper <code>log_in_as</code> in <a href="advanced_login_fragment.html#code-test_helper_log_in" class="hyperref">Listing <span class="ref">9.24</span></a>. <a class="arrow" href="#cha-8_footnote-ref-13">↑</a></li>
    <li id="cha-8_footnote-14">Some browsers offer a “<a href="http://stackoverflow.com/questions/20449641/rails-4-session-value-never-expires-or-dies-when-browser-closes" target="_blank" rel="noopener">remember where I left off</a>” feature, which restores the session automatically, so be sure to disable any such feature before trying to log out. <a class="arrow" href="#cha-8_footnote-ref-14">↑</a></li>
    <li id="cha-8_footnote-15">Setting <code>@current_user</code> to <code>nil</code> would only matter if <code>@current_user</code> were created before the <code>destroy</code> action (which it isn’t) <em>and</em> if we didn’t issue an immediate redirect (which we do).<span class="intersentencespace"></span> This is an unlikely combination of events, and with the application as presently constructed it isn’t necessary, but because it’s security-related I include it for completeness. <a class="arrow" href="#cha-8_footnote-ref-15">↑</a></li>
  </ol>
</div>
+]      XX=dOXI  za,:https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial_4th_edition/html/basic_login_fragment.html?X-Amz-Expires=604800&X-Amz-Date=20170201T124321Z&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20170201/us-west-2/s3/aws4_request&X-Amz-SignedHeaders=host&X-Amz-Signature=76bfc6601a70e39747bab361e56bb0e9830c4bb8cc51c453d3e9656c1a962a2f security-info FnhllAKWRHGAlo+ESXykKAAAAAAAAAAAwAAAAAAAAEaphjoj9ApAYLLhYqsrhSapAAQAAgAAAAAAAAAAAAAAACw4N6+LhUposNgK7YiYWzI/H82DxalM0aJQdnbKfH40ZgoyJpFcT/u7IImFpjLfBfjtg2TO2UxuhrpIr1PDk+YAAAAAAAAGGzCCBhcwggT/oAMCAQICEAkMEh1kGcxPzNQuULyfEo0wDQYJKoZIhvcNAQELBQAwZDELMAkGA1UEBhMCVVMxFTATBgNVBAoTDERpZ2lDZXJ0IEluYzEZMBcGA1UECxMQd3d3LmRpZ2ljZXJ0LmNvbTEjMCEGA1UEAxMaRGlnaUNlcnQgQmFsdGltb3JlIENBLTIgRzIwHhcNMTYwNzE4MDAwMDAwWhcNMTcxMDI2MTIwMDAwWjB1MQswCQYDVQQGEwJVUzETMBEGA1UECBMKV2FzaGluZ3RvbjEQMA4GA1UEBxMHU2VhdHRsZTEYMBYGA1UEChMPQW1hem9uLmNvbSBJbmMuMSUwIwYDVQQDDBwqLnMzLXVzLXdlc3QtMi5hbWF6b25hd3MuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtPtaIwJ9+anWiEq/qLdHgQkQ51FdpjU3C/o1HSP3DGHcijP8q6gpOQ2GIT4xaAOOEstz5v5WY8kOfEE0UXsyB8LxmNyu4nPz4gEE1jCKXaFaMQUexl2nz1hNBCzabnDV10EB2+XPOWPw1troTgtKWuBxZ4EaC7dQXkgpqSqzcio33y9sZHlcEa2ok0DMgxTaEY0ryVdODJMlTIVoFwzkiedRV3dl7yRK8EqWMfWnVJzJ2JVMRqakWjQeLE+8oeo4F0m6BEch9qpIA8JV20oFv0cQLM6QQNFzX2EN/2v5uBtrB5g/g39+5Yu+kgkfhedTSkFunjEGol8G7jssC3jijwIDAQABo4ICsjCCAq4wHwYDVR0jBBgwFoAUwBKyKHRoRmfpcCV0GgBFWwZ9XEQwHQYDVR0OBBYEFF1JaGNuDmFfuVhgXPTd3tg4yz2iMIHhBgNVHREEgdkwgdaCGnMzLXVzLXdlc3QtMi5hbWF6b25hd3MuY29tghwqLnMzLXVzLXdlc3QtMi5hbWF6b25hd3MuY29tghpzMy51cy13ZXN0LTIuYW1hem9uYXdzLmNvbYIcKi5zMy51cy13ZXN0LTIuYW1hem9uYXdzLmNvbYIkczMuZHVhbHN0YWNrLnVzLXdlc3QtMi5hbWF6b25hd3MuY29tgiYqLnMzLmR1YWxzdGFjay51cy13ZXN0LTIuYW1hem9uYXdzLmNvbYISKi5zMy5hbWF6b25hd3MuY29tMA4GA1UdDwEB/wQEAwIFoDAdBgNVHSUEFjAUBggrBgEFBQcDAQYIKwYBBQUHAwIwgYEGA1UdHwR6MHgwOqA4oDaGNGh0dHA6Ly9jcmwzLmRpZ2ljZXJ0LmNvbS9EaWdpQ2VydEJhbHRpbW9yZUNBLTJHMi5jcmwwOqA4oDaGNGh0dHA6Ly9jcmw0LmRpZ2ljZXJ0LmNvbS9EaWdpQ2VydEJhbHRpbW9yZUNBLTJHMi5jcmwwTAYDVR0gBEUwQzA3BglghkgBhv1sAQEwKjAoBggrBgEFBQcCARYcaHR0cHM6Ly93d3cuZGlnaWNlcnQuY29tL0NQUzAIBgZngQwBAgIweQYIKwYBBQUHAQEEbTBrMCQGCCsGAQUFBzABhhhodHRwOi8vb2NzcC5kaWdpY2VydC5jb20wQwYIKwYBBQUHMAKGN2h0dHA6Ly9jYWNlcnRzLmRpZ2ljZXJ0LmNvbS9EaWdpQ2VydEJhbHRpbW9yZUNBLTJHMi5jcnQwDAYDVR0TAQH/BAIwADANBgkqhkiG9w0BAQsFAAOCAQEAYH38ntfWdhwWcuD895IsKMmdlnbReTnnEKe6n6tldoxpWEJkjMA0hURZnZrbr5FL3ar6bWF9wnFKMYPxMfjhNzpB8/lbp63yZSDmVpDIsOIRWjkdcMsnpBHDHQWPV9T7fIgxT4WqAK92O3kQs1+bmsuXISBelIMev1G02BYa7EDD8JZyoltleTcs8rzvRRgE37GfxAtu07fxQqyDSvj7ojpSoIUmTVDVJMTGCkSemYpdR3DqTzmsej6eV7TbLdvFTjFnRJ4Zdehb17CoVvkOTB1v/oXaabIIi3UEsDu3UpxdB7mU4G1qgy8XDMitAtpBL6+EIw0QKw5+JoSuzbybEgAAAIAAAACAAAAAJVRMU19FQ0RIRV9SU0FfV0lUSF9BRVNfMTI4X0dDTV9TSEEyNTYAAAABAAA= request-method GET request-Origin https://www.railstutorial.org response-head HTTP/1.1 200 OK
x-amz-id-2: 5vSx3pBRhRTiHVmieBsi1dkycqK/6nuOTY43t0MGr9KTT0aaFGe576sxSnzD2BCNkm619DFbZZc=
x-amz-request-id: 5C078AD5CDB26B67
Date: Wed, 01 Feb 2017 12:43:30 GMT
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: GET
Access-Control-Max-Age: 3000
Vary: Origin, Access-Control-Request-Headers, Access-Control-Request-Method
Last-Modified: Thu, 22 Dec 2016 05:27:49 GMT
Etag: "e7e11b0559bf65268d4ea03428b442bd"
Accept-Ranges: bytes
Content-Type: text/html
Content-Length: 164992
Server: AmazonS3
 uncompressed-len 0  