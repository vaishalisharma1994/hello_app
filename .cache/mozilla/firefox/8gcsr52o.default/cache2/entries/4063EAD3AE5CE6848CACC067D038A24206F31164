<div id="cha-modeling_users" data-tralics-id="cid32" class="chapter" data-number="6" data-chapter="modeling_users"><h1><a href="modeling_users_fragment.html#cha-modeling_users" class="heading hyperref"><span class="number">Chapter 6 </span>Modeling users</a></h1>
<p>In <a href="filling_in_the_layout_fragment.html#cha-filling_in_the_layout" class="hyperref">Chapter <span class="ref">5</span></a>, we ended with a stub page for creating new users (<a href="filling_in_the_layout_fragment.html#sec-user_signup" class="hyperref">Section <span class="ref">5.4</span></a>).<span class="intersentencespace"></span> Over the course of the next six chapters, we’ll fulfill the promise implicit in this incipient signup page.<span class="intersentencespace"></span> In this chapter, we’ll take the first critical step by creating a <em>data model</em> for users of our site, together with a way to store that data.<span class="intersentencespace"></span> In <a href="sign_up_fragment.html#cha-sign_up" class="hyperref">Chapter <span class="ref">7</span></a>, we’ll give users the ability to sign up for our site and create a user profile page.<span class="intersentencespace"></span> Once users can sign up, we’ll let them log in and log out as well (<a href="basic_login_fragment.html#cha-basic_login" class="hyperref">Chapter <span class="ref">8</span></a> and <a href="advanced_login_fragment.html#cha-advanced_login" class="hyperref">Chapter <span class="ref">9</span></a>), and in <a href="updating_and_deleting_users_fragment.html#cha-updating_showing_and_deleting_users" class="hyperref">Chapter <span class="ref">10</span></a> (<a href="updating_and_deleting_users_fragment.html#sec-requiring_logged_in_users" class="hyperref">Section <span class="ref">10.2.1</span></a>) we’ll learn how to protect pages from improper access.<span class="intersentencespace"></span> Finally, in <a href="account_activation_fragment.html#cha-account_activation" class="hyperref">Chapter <span class="ref">11</span></a> and <a href="password_reset_fragment.html#cha-password_reset" class="hyperref">Chapter <span class="ref">12</span></a> we’ll add account activations (thereby confirming a valid email address) and password resets.<span class="intersentencespace"></span> Taken together, the material in <a href="modeling_users_fragment.html#cha-modeling_users" class="hyperref">Chapter <span class="ref">6</span></a> through <a href="password_reset_fragment.html#cha-password_reset" class="hyperref">Chapter <span class="ref">12</span></a> develops a full Rails login and authentication system.<span class="intersentencespace"></span> As you may know, there are various pre-built authentication solutions for Rails; <a href="modeling_users_fragment.html#aside-roll_your_own" class="hyperref">Box <span class="ref">6.1</span></a> explains why, at least at first, it’s probably a better idea to roll your own.</p>
<div class="aside" id="aside-roll_your_own" data-tralics-id="uid664" data-number="6.1"><div class="heading"><span class="number">Box 6.1.</span> 

<span class="description">Rolling your own authentication system</span></div>
<p>Virtually all web applications require a login and authentication system of some sort.<span class="intersentencespace"></span> As a result, most web frameworks have a plethora of options for implementing such systems, and Rails is no exception.<span class="intersentencespace"></span> Examples of authentication and authorization systems include <a href="http://github.com/thoughtbot/clearance" target="_blank" rel="noopener">Clearance</a>, <a href="http://github.com/binarylogic/authlogic" target="_blank" rel="noopener">Authlogic</a>, <a href="http://github.com/plataformatec/devise" target="_blank" rel="noopener">Devise</a>, and <a href="http://railscasts.com/episodes/192-authorization-with-cancan" target="_blank" rel="noopener">CanCan</a> (as well as non-Rails-specific solutions built on top of <a href="http://en.wikipedia.org/wiki/OpenID" target="_blank" rel="noopener">OpenID</a> or <a href="http://en.wikipedia.org/wiki/Oauth" target="_blank" rel="noopener">OAuth</a>).<span class="intersentencespace"></span> It’s reasonable to ask why we should reinvent the wheel.<span class="intersentencespace"></span> Why not just use an off-the-shelf solution instead of rolling our own?</p>
<p>For one, practical experience shows that authentication on most sites requires extensive customization, and modifying a third-party product is often more work than writing the system from scratch.<span class="intersentencespace"></span> In addition, off-the-shelf systems can be “black boxes”, with potentially mysterious innards; when you write your own system, you are far more likely to understand it.<span class="intersentencespace"></span> Moreover, recent additions to Rails (<a href="modeling_users_fragment.html#sec-adding_a_secure_password" class="hyperref">Section <span class="ref">6.3</span></a>) make it easy to write a custom authentication system.<span class="intersentencespace"></span> Finally, if you <em>do</em> end up using a third-party system later on, you’ll be in a much better position to understand and modify it if you’ve first built one yourself.<span class="intersentencespace"></span></p>

</div></div><div id="sec-user_model" data-tralics-id="cid33" class="section" data-number="6.1"><h2><a href="modeling_users_fragment.html#sec-user_model" class="heading hyperref"><span class="number">6.1 </span>User model</a></h2>
<p>Although the ultimate goal of the next three chapters is to make a signup page for our site (as mocked up in <a href="modeling_users_fragment.html#fig-signup_mockup_preview" class="hyperref">Figure <span class="ref">6.1</span></a>), it would do little good now to accept information for new users: we don’t currently have any place to put it.<span class="intersentencespace"></span> Thus, the first step in signing up users is to make a data structure to capture and store their information.</p>
<div class="center figure" id="fig-signup_mockup_preview" data-tralics-id="uid665" data-number="6.1">
<div class="graphics image box"><img src="images/figures/signup_mockup_bootstrap.png" alt="images/figures/signup_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 6.1: </span><span class="description">A mockup of the user signup page.
</span></div></div>
<p>In Rails, the default data structure for a data model is called, naturally enough, a <em>model</em> (the M in MVC from <a href="beginning_fragment.html#sec-mvc" class="hyperref">Section <span class="ref">1.3.3</span></a>).<span class="intersentencespace"></span> The default Rails solution to the problem of persistence is to use a <em>database</em> for long-term data storage, and the default library for interacting with the database is called <em>Active Record</em>.<sup id="cha-6_footnote-ref-1" class="footnote"><a href="#cha-6_footnote-1">1</a></sup><span class="intersentencespace"></span> Active Record comes with a host of methods for creating, saving, and finding data objects, all without having to use the structured query language (SQL)<sup id="cha-6_footnote-ref-2" class="footnote"><a href="#cha-6_footnote-2">2</a></sup> used by <a href="http://en.wikipedia.org/wiki/Relational_database" target="_blank" rel="noopener">relational databases</a>.<span class="intersentencespace"></span> Moreover, Rails has a feature called <em>migrations</em> to allow data definitions to be written in pure Ruby, without having to learn an SQL data definition language (DDL).<span class="intersentencespace"></span> The effect is that Rails insulates you almost entirely from the details of the database.<span class="intersentencespace"></span> In this book, by using SQLite for development and PostgreSQL (via Heroku) for deployment (<a href="beginning_fragment.html#sec-deploying" class="hyperref">Section <span class="ref">1.5</span></a>), we have developed this theme even further, to the point where we barely ever have to think about how Rails stores data, even for production applications.</p>
<p>As usual, if you’re following along using Git for version control, now would be a good time to make a topic branch for modeling users:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b modeling-users
</pre></div></div>
<div id="sec-database_migrations" data-tralics-id="uid668" class="subsection" data-number="6.1.1"><h3><a href="modeling_users_fragment.html#sec-database_migrations" class="heading hyperref"><span class="number">6.1.1 </span>Database migrations</a></h3>
<p>You may recall from <a href="rails_flavored_ruby_fragment.html#sec-a_user_class" class="hyperref">Section <span class="ref">4.4.5</span></a> that we have already encountered, via a custom-built <code>User</code> class, user objects with <code>name</code> and <code>email</code> attributes.<span class="intersentencespace"></span> That class served as a useful example, but it lacked the critical property of <em>persistence</em>: when we created a User object at the Rails console, it disappeared as soon as we exited.<span class="intersentencespace"></span> Our goal in this section is to create a model for users that won’t disappear quite so easily.</p>
<p>As with the User class in <a href="rails_flavored_ruby_fragment.html#sec-a_user_class" class="hyperref">Section <span class="ref">4.4.5</span></a>, we’ll start by modeling a user with two attributes, a <code>name</code> and an <code>email</code> address, the latter of which we’ll use as a unique username.<sup id="cha-6_footnote-ref-3" class="footnote"><a href="#cha-6_footnote-3">3</a></sup><span class="intersentencespace"></span> (We’ll add an attribute for passwords in <a href="modeling_users_fragment.html#sec-adding_a_secure_password" class="hyperref">Section <span class="ref">6.3</span></a>.)<span class="intersentencespace"></span> In <a href="rails_flavored_ruby_fragment.html#code-example_user" class="hyperref">Listing <span class="ref">4.17</span></a>, we did this with Ruby’s <code>attr_accessor</code> method:</p>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span>
  <span class="kp">attr_accessor</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
<p>In contrast, when using Rails to model users we don’t need to identify the attributes explicitly.<span class="intersentencespace"></span> As noted briefly above, to store data Rails uses a relational database by default, which consists of <em>tables</em> composed of data <em>rows</em>, where each row has <em>columns</em> of data attributes.<span class="intersentencespace"></span> For example, to store users with names and email addresses, we’ll create a <code>users</code> table with <code>name</code> and <code>email</code> columns (with each row corresponding to one user).<span class="intersentencespace"></span> An example of such a table appears in <a href="modeling_users_fragment.html#fig-users_table" class="hyperref">Figure <span class="ref">6.2</span></a>, corresponding to the data model shown in <a href="modeling_users_fragment.html#fig-user_model_sketch" class="hyperref">Figure <span class="ref">6.3</span></a>.<span class="intersentencespace"></span> (<a href="modeling_users_fragment.html#fig-user_model_sketch" class="hyperref">Figure <span class="ref">6.3</span></a> is just a sketch; the full data model appears in <a href="modeling_users_fragment.html#fig-user_model_initial" class="hyperref">Figure <span class="ref">6.4</span></a>.)<span class="intersentencespace"></span> By naming the columns <code>name</code> and <code>email</code>, we’ll let Active Record figure out the User object attributes for us.</p>
<div class="center figure" id="fig-users_table" data-tralics-id="uid670" data-number="6.2">
<div class="graphics image"><img src="images/figures/users_table.png" alt="images/figures/users_table"></div><div class="caption"><span class="header">Figure 6.2: </span><span class="description">A diagram of sample data in a <code>users</code> table.
</span></div></div>
<div class="center figure" id="fig-user_model_sketch" data-tralics-id="uid671" data-number="6.3">
<div class="graphics image"><img src="images/figures/user_model_sketch.png" alt="images/figures/user_model_sketch"></div><div class="caption"><span class="header">Figure 6.3: </span><span class="description">A sketch of the User data model.
</span></div></div>
<p>You may recall from <a href="filling_in_the_layout_fragment.html#code-generate_users_controller" class="hyperref">Listing <span class="ref">5.38</span></a> that we created a Users controller (along with a <code>new</code> action) using the command</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller Users new
</pre></div></div>
<p>The analogous command for making a model is <code>generate model</code>, which we can use to generate a User model with <code>name</code> and <code>email</code> attributes, as shown in <a href="modeling_users_fragment.html#code-generate_user_model" class="hyperref">Listing <span class="ref">6.1</span></a>.</p>
<div class="codelisting" id="code-generate_user_model" data-tralics-id="uid672" data-number="6.1"><div class="heading"><span class="number">Listing 6.1:</span> 

<span class="description">Generating a User model.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate model User name:string email:string
<span class="go">      invoke  active_record</span>
<span class="go">      create    db/migrate/20160523010738_create_users.rb</span>
<span class="go">      create    app/models/user.rb</span>
<span class="go">      invoke    test_unit</span>
<span class="go">      create      test/models/user_test.rb</span>
<span class="go">      create      test/fixtures/users.yml</span>
</pre></div></div></div><p>(Note that, in contrast to the plural convention for controller names, model names are singular: a <em>Users</em> controller, but a <em>User</em> model.)<span class="intersentencespace"></span> By passing the optional parameters <code>name:string</code> and <code>email:string</code>, we tell Rails about the two attributes we want, along with which types those attributes should be (in this case, <code>string</code>).<span class="intersentencespace"></span> Compare this with including the action names in <a href="static_pages_fragment.html#code-generating_pages" class="hyperref">Listing <span class="ref">3.6</span></a> and <a href="filling_in_the_layout_fragment.html#code-generate_users_controller" class="hyperref">Listing <span class="ref">5.38</span></a>.</p>
<p>One of the results of the <code>generate</code> command in <a href="modeling_users_fragment.html#code-generate_user_model" class="hyperref">Listing <span class="ref">6.1</span></a> is a new file called a <em>migration</em>.<span class="intersentencespace"></span> Migrations provide a way to alter the structure of the database incrementally, so that our data model can adapt to changing requirements.<span class="intersentencespace"></span> In the case of the User model, the migration is created automatically by the model generation script; it creates a <code>users</code> table with two columns, <code>name</code> and <code>email</code>, as shown in <a href="modeling_users_fragment.html#code-users_migration" class="hyperref">Listing <span class="ref">6.2</span></a>.<span class="intersentencespace"></span> (We’ll see starting in <a href="modeling_users_fragment.html#sec-uniqueness_validation" class="hyperref">Section <span class="ref">6.2.5</span></a> how to make a migration from scratch.)</p>
<div class="codelisting" id="code-users_migration" data-tralics-id="uid673" data-number="6.2"><div class="heading"><span class="number">Listing 6.2:</span> 

<span class="description">Migration for the User model (to create a <code>users</code> table).<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">db/migrate/[timestamp]_create_users.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="o">[</span><span class="mi">5</span><span class="o">.</span><span class="mi">0</span><span class="o">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:users</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:email</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that the name of the migration file is prefixed by a <em>timestamp</em> based on when the migration was generated.<span class="intersentencespace"></span> In the early days of migrations, the filenames were prefixed with incrementing integers, which caused conflicts for collaborating teams if multiple programmers had migrations with the same number.<span class="intersentencespace"></span> Barring the improbable scenario of migrations generated the same second, using timestamps conveniently avoids such collisions.</p>
<p>The migration itself consists of a <code>change</code> method that determines the change to be made to the database.<span class="intersentencespace"></span> In the case of <a href="modeling_users_fragment.html#code-users_migration" class="hyperref">Listing <span class="ref">6.2</span></a>, <code>change</code> uses a Rails method called <code>create_table</code> to create a table in the database for storing users.<span class="intersentencespace"></span> The <code>create_table</code> method accepts a block (<a href="rails_flavored_ruby_fragment.html#sec-blocks" class="hyperref">Section <span class="ref">4.3.2</span></a>) with one block variable, in this case called <code>t</code> (for “table”).<span class="intersentencespace"></span> Inside the block, the <code>create_table</code> method uses the <code>t</code> object to create <code>name</code> and <code>email</code> columns in the database, both of type <code>string</code>.<sup id="cha-6_footnote-ref-4" class="footnote"><a href="#cha-6_footnote-4">4</a></sup><span class="intersentencespace"></span> Here the table name is plural (<code>users</code>) even though the model name is singular (User), which reflects a linguistic convention followed by Rails: a model represents a single user, whereas a database table consists of many users.<span class="intersentencespace"></span> The final line in the block, <code>t.timestamps</code>, is a special command that creates two <em>magic columns</em> called <code>created_at</code> and <code>updated_at</code>, which are timestamps that automatically record when a given user is created and updated.<span class="intersentencespace"></span> (We’ll see concrete examples of the magic columns starting in <a href="modeling_users_fragment.html#sec-creating_user_objects" class="hyperref">Section <span class="ref">6.1.3</span></a>.)<span class="intersentencespace"></span> The full data model represented by the migration in <a href="modeling_users_fragment.html#code-users_migration" class="hyperref">Listing <span class="ref">6.2</span></a> is shown in <a href="modeling_users_fragment.html#fig-user_model_initial" class="hyperref">Figure <span class="ref">6.4</span></a>.<span class="intersentencespace"></span> (Note the addition of the magic columns, which weren’t present in the sketch shown in <a href="modeling_users_fragment.html#fig-user_model_sketch" class="hyperref">Figure <span class="ref">6.3</span></a>.)</p>
<div class="center figure" id="fig-user_model_initial" data-tralics-id="uid675" data-number="6.4"><span class="graphics"><img src="images/figures/user_model_initial_3rd_edition.png" alt="user_model_initial_3rd_edition"></span>
<div class="caption"><span class="header">Figure 6.4: </span><span class="description">The User data model produced by <a href="modeling_users_fragment.html#code-users_migration" class="hyperref">Listing <span class="ref">6.2</span></a>.
</span></div></div>
<p>We can run the migration, known as “migrating up”, using the <code>db:migrate</code> command as follows:</p>
<div class="code"><div class="highlight"><pre>$ rails db:migrate
</pre></div></div>
<p>(You may recall that we ran this command in a similar context in <a href="toy_app_fragment.html#sec-demo_users_resource" class="hyperref">Section <span class="ref">2.2</span></a>.)<span class="intersentencespace"></span> The first time <code>db:migrate</code> is run, it creates a file called <code>db/development.sqlite3</code>, which is an <a href="http://sqlite.org/" target="_blank" rel="noopener">SQLite</a><sup id="cha-6_footnote-ref-5" class="footnote"><a href="#cha-6_footnote-5">5</a></sup> database.<span class="intersentencespace"></span> We can see the structure of the database by opening <code>development.sqlite3</code> with <a href="http://sqlitebrowser.org/" target="_blank" rel="noopener">DB Browser for SQLite</a>.<span class="intersentencespace"></span> (If you’re using the cloud IDE, you should first download the database file to the local disk, as shown in <a href="modeling_users_fragment.html#fig-sqlite_download" class="hyperref">Figure <span class="ref">6.5</span></a>.)<span class="intersentencespace"></span> The result appears in <a href="modeling_users_fragment.html#fig-sqlite_database_browser" class="hyperref">Figure <span class="ref">6.6</span></a>; compare with the diagram in <a href="modeling_users_fragment.html#fig-user_model_initial" class="hyperref">Figure <span class="ref">6.4</span></a>.<span class="intersentencespace"></span> You might note that there’s one column in <a href="modeling_users_fragment.html#fig-sqlite_database_browser" class="hyperref">Figure <span class="ref">6.6</span></a> not accounted for in the migration: the <code>id</code> column.<span class="intersentencespace"></span> As noted briefly in <a href="toy_app_fragment.html#sec-demo_users_resource" class="hyperref">Section <span class="ref">2.2</span></a>, this column is created automatically, and is used by Rails to identify each row uniquely.</p>
<div class="center figure" id="fig-sqlite_download" data-tralics-id="uid677" data-number="6.5">
<div class="graphics image"><img src="images/figures/sqlite_download.png" alt="images/figures/sqlite_download"></div><div class="caption"><span class="header">Figure 6.5: </span><span class="description">Downloading a file from the cloud IDE.
</span></div></div>
<div class="center figure" id="fig-sqlite_database_browser" data-tralics-id="uid678" data-number="6.6">
<div class="graphics image"><img src="images/figures/sqlite_database_browser_3rd_edition.png" alt="images/figures/sqlite_database_browser_3rd_edition"></div><div class="caption"><span class="header">Figure 6.6: </span><span class="description">The <a href="http://sqlitebrowser.org/" target="_blank" rel="noopener">DB Browser for SQLite</a> with our new <code>users</code> table.
</span></div></div>
<div id="sec-exercises_database_migrations" data-tralics-id="uid679" class="subsubsection" data-number="6.1.1.1"><h4><a href="#sec-exercises_database_migrations" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Rails uses a file called <code>schema.rb</code> in the <code>db/</code> directory to keep track of the structure of the database (called the <em>schema</em>, hence the filename).<span class="intersentencespace"></span> Examine your local copy of <code>db/schema.rb</code> and compare its contents to the migration code in <a href="modeling_users_fragment.html#code-users_migration" class="hyperref">Listing <span class="ref">6.2</span></a>. <span class="exercise" id="ex-35a9f1"></span>
</li>
<li>Most migrations (including all the ones in this tutorial) are <em>reversible</em>, which means we can “migrate down” and undo them with a single command, called <code>db:rollback</code>:
<div class="code"><div class="highlight"><pre>  $ rails db:rollback
</pre></div></div>
After running this command, examine <code>db/schema.rb</code> to confirm that the rollback was successful.<span class="intersentencespace"></span> (See <a href="static_pages_fragment.html#aside-undoing_things" class="hyperref">Box <span class="ref">3.1</span></a> for another technique useful for reversing migrations.)<span class="intersentencespace"></span> Under the hood, this command executes the <code>drop_table</code> command to remove the users table from the database.<span class="intersentencespace"></span> The reason this works is that the <code>change</code> method knows that <code>drop_table</code> is the inverse of <code>create_table</code>, which means that the rollback migration can be easily inferred.<span class="intersentencespace"></span> In the case of an irreversible migration, such as one to remove a database column, it is necessary to define separate <code>up</code> and <code>down</code> methods in place of the single <code>change</code> method.<span class="intersentencespace"></span> Read about <a href="http://guides.rubyonrails.org/migrations.html" target="_blank" rel="noopener">migrations in the Rails Guides</a> for more information. <span class="exercise" id="ex-f4bec3"></span>
</li>
<li>Re-run the migration by executing <code>rails db:migrate</code> again.<span class="intersentencespace"></span> Confirm that the contents of <code>db/schema.rb</code> have been restored. <span class="exercise" id="ex-86400a"></span>
</li></ol>
</div></div>
<div id="sec-the_model_file" data-tralics-id="uid683" class="subsection" data-number="6.1.2"><h3><a href="modeling_users_fragment.html#sec-the_model_file" class="heading hyperref"><span class="number">6.1.2 </span>The model file</a></h3>
<p>We’ve seen how the User model generation in <a href="modeling_users_fragment.html#code-generate_user_model" class="hyperref">Listing <span class="ref">6.1</span></a> generated a migration file (<a href="modeling_users_fragment.html#code-users_migration" class="hyperref">Listing <span class="ref">6.2</span></a>), and we saw in <a href="modeling_users_fragment.html#fig-sqlite_database_browser" class="hyperref">Figure <span class="ref">6.6</span></a> the results of running this migration: it updated a file called <code>development.sqlite3</code> by creating a table <code>users</code> with columns <code>id</code>, <code>name</code>, <code>email</code>, <code>created_at</code>, and <code>updated_at</code>.<span class="intersentencespace"></span> <a href="modeling_users_fragment.html#code-generate_user_model" class="hyperref">Listing <span class="ref">6.1</span></a> also created the model itself.<span class="intersentencespace"></span> The rest of this section is dedicated to understanding it.</p>
<p>We begin by looking at the code for the User model, which lives in the file <code>user.rb</code> inside the <code>app/models/</code> directory.<span class="intersentencespace"></span> It is, to put it mildly, very compact (<a href="modeling_users_fragment.html#code-raw_user_model" class="hyperref">Listing <span class="ref">6.3</span></a>).</p>
<div class="codelisting" id="code-raw_user_model" data-tralics-id="uid684" data-number="6.3"><div class="heading"><span class="number">Listing 6.3:</span> 

<span class="description">The brand new User model.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</pre></div></div></div><p>Recall from <a href="rails_flavored_ruby_fragment.html#sec-a_class_of_our_own" class="hyperref">Section <span class="ref">4.4.2</span></a> that the syntax <code>class User &lt; ApplicationRecord</code> means that the <code>User</code> class <em>inherits</em> from the <code>ApplicationRecord</code> class, which in turn inherits from <code>ActiveRecord::Base</code> (<a href="toy_app_fragment.html#fig-demo_model_inheritance" class="hyperref">Figure <span class="ref">2.18</span></a>), so that the User model automatically has all the functionality of the <code>ActiveRecord::Base</code> class.<span class="intersentencespace"></span> Of course, this knowledge doesn’t do us any good unless we know what <code>ActiveRecord::Base</code> contains, so let’s get started with some concrete examples.</p>
<div id="sec-exercises_the_model_file" data-tralics-id="uid685" class="subsubsection" data-number="6.1.2.1"><h4><a href="#sec-exercises_the_model_file" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>In a Rails console, use the technique from <a href="rails_flavored_ruby_fragment.html#sec-a_controller_class" class="hyperref">Section <span class="ref">4.4.4</span></a> to confirm that <code>User.new</code> is of class <code>User</code> and inherits from <code>ApplicationRecord</code>. <span class="exercise" id="ex-88f89c"></span>
</li>
<li>Confirm that <code>ApplicationRecord</code> inherits from <code>ActiveRecord::Base</code>. <span class="exercise" id="ex-45a954"></span>
</li></ol>
</div></div>
<div id="sec-creating_user_objects" data-tralics-id="uid688" class="subsection" data-number="6.1.3"><h3><a href="modeling_users_fragment.html#sec-creating_user_objects" class="heading hyperref"><span class="number">6.1.3 </span>Creating user objects</a></h3>
<p>As in <a href="rails_flavored_ruby_fragment.html#cha-rails_flavored_ruby" class="hyperref">Chapter <span class="ref">4</span></a>, our tool of choice for exploring data models is the Rails console.<span class="intersentencespace"></span> Since we don’t (yet) want to make any changes to our database, we’ll start the console in a <em>sandbox</em>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails console --sandbox
<span class="go">Loading development environment in sandbox</span>
<span class="go">Any modifications you make will be rolled back on exit</span>
<span class="gp">&gt;</span>&gt;
</pre></div></div>
<p>As indicated by the helpful message “Any modifications you make will be rolled back on exit”, when started in a sandbox the console will “roll back” (i.e., undo) any database changes introduced during the session.</p>
<p>In the console session in <a href="rails_flavored_ruby_fragment.html#sec-a_user_class" class="hyperref">Section <span class="ref">4.4.5</span></a>, we created a new user object with <code>User.new</code>, which we had access to only after requiring the example user file in <a href="rails_flavored_ruby_fragment.html#code-example_user" class="hyperref">Listing <span class="ref">4.17</span></a>.<span class="intersentencespace"></span> With models, the situation is different; as you may recall from <a href="rails_flavored_ruby_fragment.html#sec-a_controller_class" class="hyperref">Section <span class="ref">4.4.4</span></a>, the Rails console automatically loads the Rails environment, which includes the models.<span class="intersentencespace"></span> This means that we can make a new user object without any further work:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">new</span>
<span class="go">=&gt; #&lt;User id: nil, name: nil, email: nil, created_at: nil, updated_at: nil&gt;</span>
</pre></div></div>
<p>We see here the default console representation of a user object.</p>
<p>When called with no arguments, <code>User.new</code> returns an object with all <code>nil</code> attributes.<span class="intersentencespace"></span> In <a href="rails_flavored_ruby_fragment.html#sec-a_user_class" class="hyperref">Section <span class="ref">4.4.5</span></a>, we designed the example User class to take an <em>initialization hash</em> to set the object attributes; that design choice was motivated by Active Record, which allows objects to be initialized in the same way:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Michael Hartl"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"mhartl@example.com"</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: nil, name: "Michael Hartl", email: "mhartl@example.com",</span>
<span class="go">created_at: nil, updated_at: nil&gt;</span>
</pre></div></div>
<p>Here we see that the name and email attributes have been set as expected.</p>
<p>The notion of <em>validity</em> is important for understanding Active Record model objects.<span class="intersentencespace"></span> We’ll explore this subject in more depth in <a href="modeling_users_fragment.html#sec-user_validations" class="hyperref">Section <span class="ref">6.2</span></a>, but for now it’s worth noting that our initial <code>user</code> object is valid, which we can verify by calling the boolean <code>valid?</code> method on it:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">valid?</span>
<span class="go">true</span>
</pre></div></div>
<p>So far, we haven’t touched the database: <code>User.new</code> only creates an object <em>in memory</em>, while <code>user.valid?</code> merely checks to see if the object is valid.<span class="intersentencespace"></span> In order to save the User object to the database, we need to call the <code>save</code> method on the <code>user</code> variable:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">   (0.1ms)  SAVEPOINT active_record_1</span>
<span class="go">  SQL (0.8ms)  INSERT INTO "users" ("name", "email", "created_at",</span>
<span class="go">  "updated_at") VALUES (?, ?, ?, ?)  [["name", "Michael Hartl"],</span>
<span class="go">  ["email", "mhartl@example.com"], ["created_at", 2016-05-23 19:05:58 UTC],</span>
<span class="go">  ["updated_at", 2016-05-23 19:05:58 UTC]]</span>
<span class="go">   (0.1ms)  RELEASE SAVEPOINT active_record_1</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p>The <code>save</code> method returns <code>true</code> if it succeeds and <code>false</code> otherwise.<span class="intersentencespace"></span> (Currently, all saves should succeed because there are as yet no validations; we’ll see cases in <a href="modeling_users_fragment.html#sec-user_validations" class="hyperref">Section <span class="ref">6.2</span></a> when some will fail.)<span class="intersentencespace"></span> For reference, the Rails console also shows the SQL command corresponding to <code>user.save</code> (namely, <code>INSERT INTO "users"</code>…).<span class="intersentencespace"></span> We’ll hardly ever need raw SQL in this book,<sup id="cha-6_footnote-ref-6" class="footnote"><a href="#cha-6_footnote-6">6</a></sup> and I’ll omit discussion of the SQL commands from now on, but you can learn a lot by reading the SQL corresponding to Active Record commands.</p>
<p>You may have noticed that the new user object had <code>nil</code> values for the <code>id</code> and the magic columns <code>created_at</code> and <code>updated_at</code> attributes.<span class="intersentencespace"></span> Let’s see if our <code>save</code> changed anything:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span>
<span class="go">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "mhartl@example.com",</span>
<span class="go">created_at: "2016-05-23 19:05:58", updated_at: "2016-05-23 19:05:58"&gt;</span>
</pre></div></div>
<p>We see that the <code>id</code> has been assigned a value of <code>1</code>, while the magic columns have been assigned the current time and date.<sup id="cha-6_footnote-ref-7" class="footnote"><a href="#cha-6_footnote-7">7</a></sup><span class="intersentencespace"></span> Currently, the created and updated timestamps are identical; we’ll see them differ in <a href="modeling_users_fragment.html#sec-updating_user_objects" class="hyperref">Section <span class="ref">6.1.5</span></a>.</p>
<p>As with the User class in <a href="rails_flavored_ruby_fragment.html#sec-a_user_class" class="hyperref">Section <span class="ref">4.4.5</span></a>, instances of the User model allow access to their attributes using a dot notation:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">name</span>
<span class="go">=&gt; "Michael Hartl"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; "mhartl@example.com"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">updated_at</span>
<span class="go">=&gt; Mon, 23 May 2016 19:05:58 UTC +00:00</span>
</pre></div></div>
<p>As we’ll see in <a href="sign_up_fragment.html#cha-sign_up" class="hyperref">Chapter <span class="ref">7</span></a>, it’s often convenient to make and save a model in two steps as we have above, but Active Record also lets you combine them into one step with <code>User.create</code>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"A Nother"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"another@example.org"</span><span class="p">)</span>
<span class="go">#&lt;User id: 2, name: "A Nother", email: "another@example.org", created_at:</span>
<span class="go">"2016-05-23 19:18:46", updated_at: "2016-05-23 19:18:46"&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">foo</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Foo"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"foo@bar.com"</span><span class="p">)</span>
<span class="go">#&lt;User id: 3, name: "Foo", email: "foo@bar.com", created_at: "2016-05-23</span>
<span class="go">19:19:06", updated_at: "2016-05-23 19:19:06"&gt;</span>
</pre></div></div>
<p>Note that <code>User.create</code>, rather than returning <code>true</code> or <code>false</code>, returns the User object itself, which we can optionally assign to a variable (such as <code>foo</code> in the second command above).</p>
<p>The inverse of <code>create</code> is <code>destroy</code>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">foo</span><span class="o">.</span><span class="n">destroy</span>
<span class="go">   (0.1ms)  SAVEPOINT active_record_1</span>
<span class="go">  SQL (0.2ms)  DELETE FROM "users" WHERE "users"."id" = ?  [["id", 3]]</span>
<span class="go">   (0.1ms)  RELEASE SAVEPOINT active_record_1</span>
<span class="go">=&gt; #&lt;User id: 3, name: "Foo", email: "foo@bar.com", created_at: "2016-05-23</span>
<span class="go">19:19:06", updated_at: "2016-05-23 19:19:06"&gt;</span>
</pre></div></div>
<p>Like <code>create</code>, <code>destroy</code> returns the object in question, though I can’t recall ever having used the return value of <code>destroy</code>.<span class="intersentencespace"></span> In addition, the destroyed object still exists in memory:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">foo</span>
<span class="go">=&gt; #&lt;User id: 3, name: "Foo", email: "foo@bar.com", created_at: "2016-05-23</span>
<span class="go">19:19:06", updated_at: "2016-05-23 19:19:06"&gt;</span>
</pre></div></div>
<p>So how do we know if we really destroyed an object?<span class="intersentencespace"></span> And for saved and non-destroyed objects, how can we retrieve users from the database?<span class="intersentencespace"></span> To answer these questions, we need to learn how to use Active Record to find user objects.</p>
<div id="sec-exercises_creating_user_objects" data-tralics-id="uid691" class="subsubsection" data-number="6.1.3.1"><h4><a href="#sec-exercises_creating_user_objects" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Confirm that <code>user.name</code> and <code>user.email</code> are of class <code>String</code>. <span class="exercise" id="ex-ffd724"></span>
</li>
<li>Of what class are the <code>created_at</code> and <code>updated_at</code> attributes? <span class="exercise" id="ex-840d5b"></span>
</li></ol>
</div></div>
<div id="sec-finding_user_objects" data-tralics-id="uid694" class="subsection" data-number="6.1.4"><h3><a href="modeling_users_fragment.html#sec-finding_user_objects" class="heading hyperref"><span class="number">6.1.4 </span>Finding user objects</a></h3>
<p>Active Record provides several options for finding objects.<span class="intersentencespace"></span> Let’s use them to find the first user we created while verifying that the third user (<code>foo</code>) has been destroyed.<span class="intersentencespace"></span> We’ll start with the existing user:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "mhartl@example.com",</span>
<span class="go">created_at: "2016-05-23 19:05:58", updated_at: "2016-05-23 19:05:58"&gt;</span>
</pre></div></div>
<p>Here we’ve passed the id of the user to <code>User.find</code>; Active Record returns the user with that id.</p>
<p>Let’s see if the user with an <code>id</code> of <code>3</code> still exists in the database:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="go">ActiveRecord::RecordNotFound: Couldn't find User with ID=3</span>
</pre></div></div>
<p>Since we destroyed our third user in <a href="modeling_users_fragment.html#sec-creating_user_objects" class="hyperref">Section <span class="ref">6.1.3</span></a>, Active Record can’t find it in the database.<span class="intersentencespace"></span> Instead, <code>find</code> raises an <em>exception</em>, which is a way of indicating an exceptional event in the execution of a program—in this case, a nonexistent Active Record id, which causes <code>find</code> to raise an <code>ActiveRecord::RecordNotFound</code> exception.<sup id="cha-6_footnote-ref-8" class="footnote"><a href="#cha-6_footnote-8">8</a></sup></p>
<p>In addition to the generic <code>find</code>, Active Record also allows us to find users by specific attributes:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="s2">"mhartl@example.com"</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "mhartl@example.com",</span>
<span class="go">created_at: "2016-05-23 19:05:58", updated_at: "2016-05-23 19:05:58"&gt;</span>
</pre></div></div>
<p>Since we will be using email addresses as usernames, this sort of <code>find</code> will be useful when we learn how to let users log in to our site (<a href="sign_up_fragment.html#cha-sign_up" class="hyperref">Chapter <span class="ref">7</span></a>).<span class="intersentencespace"></span> If you’re worried that <code>find_by</code> will be inefficient if there are a large number of users, you’re ahead of the game; we’ll cover this issue, and its solution via database indices, in <a href="modeling_users_fragment.html#sec-uniqueness_validation" class="hyperref">Section <span class="ref">6.2.5</span></a>.</p>
<p>We’ll end with a couple of more general ways of finding users.<span class="intersentencespace"></span> First, there’s <code>first</code>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="go">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "mhartl@example.com",</span>
<span class="go">created_at: "2016-05-23 19:05:58", updated_at: "2016-05-23 19:05:58"&gt;</span>
</pre></div></div>
<p>Naturally, <code>first</code> just returns the first user in the database.<span class="intersentencespace"></span> There’s also <code>all</code>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">all</span>
<span class="go">=&gt; #&lt;ActiveRecord::Relation [#&lt;User id: 1, name: "Michael Hartl",</span>
<span class="go">email: "mhartl@example.com", created_at: "2016-05-23 19:05:58",</span>
<span class="go">updated_at: "2016-05-23 19:05:58"&gt;, #&lt;User id: 2, name: "A Nother",</span>
<span class="go">email: "another@example.org", created_at: "2016-05-23 19:18:46",</span>
<span class="go">updated_at: "2016-05-23 19:18:46"&gt;]&gt;</span>
</pre></div></div>
<p>As you can see from the console output, <code>User.all</code> returns all the users in the database as an object of class <code>ActiveRecord::Relation</code>, which is effectively an array (<a href="rails_flavored_ruby_fragment.html#sec-arrays_and_ranges" class="hyperref">Section <span class="ref">4.3.1</span></a>).</p>
<div id="sec-exercises_finding_user_objects" data-tralics-id="uid696" class="subsubsection" data-number="6.1.4.1"><h4><a href="#sec-exercises_finding_user_objects" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Find the user by <code>name</code>.<span class="intersentencespace"></span> Confirm that <code>find_by_name</code> works as well.<span class="intersentencespace"></span> (You will often encounter this older style of <code>find_by</code> in legacy Rails applications.) <span class="exercise" id="ex-a37224"></span>
</li>
<li>For most practical purposes, <code>User.all</code> acts like an array, but confirm that in fact it’s of class <code>User::ActiveRecord_Relation</code>. <span class="exercise" id="ex-b3c50e"></span>
</li>
<li>Confirm that you can find the length of <code>User.all</code> by passing it the <code>length</code> method (<a href="rails_flavored_ruby_fragment.html#sec-objects_and_message_passing" class="hyperref">Section <span class="ref">4.2.3</span></a>).<span class="intersentencespace"></span> Ruby’s ability to manipulate objects based on how they act rather than on their formal class type is called <em>duck typing</em>, based on the aphorism that “If it looks like a duck, and it quacks like a duck, it’s probably a duck.” <span class="exercise" id="ex-087c14"></span>
</li></ol>
</div></div>
<div id="sec-updating_user_objects" data-tralics-id="uid700" class="subsection" data-number="6.1.5"><h3><a href="modeling_users_fragment.html#sec-updating_user_objects" class="heading hyperref"><span class="number">6.1.5 </span>Updating user objects</a></h3>
<p>Once we’ve created objects, we often want to update them.<span class="intersentencespace"></span> There are two basic ways to do this.<span class="intersentencespace"></span> First, we can assign attributes individually, as we did in <a href="rails_flavored_ruby_fragment.html#sec-a_user_class" class="hyperref">Section <span class="ref">4.4.5</span></a>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span>           <span class="c1"># Just a reminder about our user's attributes</span>
<span class="go">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "mhartl@example.com",</span>
<span class="go">created_at: "2016-05-23 19:05:58", updated_at: "2016-05-23 19:05:58"&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">"mhartl@example.net"</span>
<span class="go">=&gt; "mhartl@example.net"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p>Note that the final step is necessary to write the changes to the database.<span class="intersentencespace"></span> We can see what happens without a save by using <code>reload</code>, which reloads the object based on the database information:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; "mhartl@example.net"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">"foo@bar.com"</span>
<span class="go">=&gt; "foo@bar.com"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; "mhartl@example.net"</span>
</pre></div></div>
<p>Now that we’ve updated the user by running <code>user.save</code>, the magic columns differ, as promised in <a href="modeling_users_fragment.html#sec-creating_user_objects" class="hyperref">Section <span class="ref">6.1.3</span></a>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">created_at</span>
<span class="go">=&gt; "2016-05-23 19:05:58"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">updated_at</span>
<span class="go">=&gt; "2016-05-23 19:08:23"</span>
</pre></div></div>
<p>The second main way to update multiple attributes is to use <code>update_attributes</code>:<sup id="cha-6_footnote-ref-9" class="footnote"><a href="#cha-6_footnote-9">9</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"The Dude"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"dude@abides.org"</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">name</span>
<span class="go">=&gt; "The Dude"</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; "dude@abides.org"</span>
</pre></div></div>
<p>The <code>update_attributes</code> method accepts a hash of attributes, and on success performs both the update and the save in one step (returning <code>true</code> to indicate that the save went through).<span class="intersentencespace"></span> Note that if any of the validations fail, such as when a password is required to save a record (as implemented in <a href="modeling_users_fragment.html#sec-adding_a_secure_password" class="hyperref">Section <span class="ref">6.3</span></a>), the call to <code>update_attributes</code> will fail.<span class="intersentencespace"></span> If we need to update only a single attribute, using the singular <code>update_attribute</code> bypasses this restriction:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="s2">"El Duderino"</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">name</span>
<span class="go">=&gt; "El Duderino"</span>
</pre></div></div>
<div id="sec-exercises_updating_user_objects" data-tralics-id="uid702" class="subsubsection" data-number="6.1.5.1"><h4><a href="#sec-exercises_updating_user_objects" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Update the user’s name using assignment and a call to <code>save</code>. <span class="exercise" id="ex-aca2fa"></span>
</li>
<li>Update the user’s email address using a call to <code>update_attributes</code>. <span class="exercise" id="ex-dc4b1e"></span>
</li>
<li>Confirm that you can change the magic columns directly by updating the <code>created_at</code> column using assignment and a save.<span class="intersentencespace"></span> Use the value <code>1.year.ago</code>, which is a Rails way to create a timestamp one year before the present time. <span class="exercise" id="ex-61f14b"></span>
</li></ol>
</div></div></div><div id="sec-user_validations" data-tralics-id="cid34" class="section" data-number="6.2"><h2><a href="modeling_users_fragment.html#sec-user_validations" class="heading hyperref"><span class="number">6.2 </span>User validations</a></h2>
<p>The User model we created in <a href="modeling_users_fragment.html#sec-user_model" class="hyperref">Section <span class="ref">6.1</span></a> now has working <code>name</code> and <code>email</code> attributes, but they are completely generic: any string (including an empty one) is currently valid in either case.<span class="intersentencespace"></span> And yet, names and email addresses are more specific than this.<span class="intersentencespace"></span> For example, <code>name</code> should be non-blank, and <code>email</code> should match the specific format characteristic of email addresses.<span class="intersentencespace"></span> Moreover, since we’ll be using email addresses as unique usernames when users log in, we shouldn’t allow email duplicates in the database.</p>
<p>In short, we shouldn’t allow <code>name</code> and <code>email</code> to be just any strings; we should enforce certain constraints on their values.<span class="intersentencespace"></span> Active Record allows us to impose such constraints using <em>validations</em> (seen briefly before in <a href="toy_app_fragment.html#sec-putting_the_micro_in_microposts" class="hyperref">Section <span class="ref">2.3.2</span></a>).<span class="intersentencespace"></span> In this section, we’ll cover several of the most common cases, validating <em>presence</em>, <em>length</em>, <em>format</em> and <em>uniqueness</em>.<span class="intersentencespace"></span> In <a href="modeling_users_fragment.html#sec-has_secure_password" class="hyperref">Section <span class="ref">6.3.2</span></a> we’ll add a final common validation, <em>confirmation</em>.<span class="intersentencespace"></span> And we’ll see in <a href="sign_up_fragment.html#sec-unsuccessful_signups" class="hyperref">Section <span class="ref">7.3</span></a> how validations give us convenient error messages when users make submissions that violate them.</p>
<div id="sec-a_validity_test" data-tralics-id="uid706" class="subsection" data-number="6.2.1"><h3><a href="modeling_users_fragment.html#sec-a_validity_test" class="heading hyperref"><span class="number">6.2.1 </span>A validity test</a></h3>
<p>As noted in <a href="static_pages_fragment.html#aside-when_to_test" class="hyperref">Box <span class="ref">3.3</span></a>, test-driven development isn’t always the right tool for the job, but model validations are exactly the kind of features for which TDD is a perfect fit.<span class="intersentencespace"></span> It’s difficult to be confident that a given validation is doing exactly what we expect it to without writing a failing test and then getting it to pass.</p>
<p>Our method will be to start with a <em>valid</em> model object, set one of its attributes to something we want to be invalid, and then test that it in fact is invalid.<span class="intersentencespace"></span> As a safety net, we’ll first write a test to make sure the initial model object is valid.<span class="intersentencespace"></span> This way, when the validation tests fail we’ll know it’s for the right reason (and not because the initial object was invalid in the first place).</p>
<p>To get us started, the command in <a href="modeling_users_fragment.html#code-generate_user_model" class="hyperref">Listing <span class="ref">6.1</span></a> produced an initial test for testing users, though in this case it’s practically blank (<a href="modeling_users_fragment.html#code-default_user_test" class="hyperref">Listing <span class="ref">6.4</span></a>).</p>
<div class="codelisting" id="code-default_user_test" data-tralics-id="uid707" data-number="6.4"><div class="heading"><span class="number">Listing 6.4:</span> 

<span class="description">The practically blank default User test.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># test "the truth" do</span>
  <span class="c1">#   assert true</span>
  <span class="c1"># end</span>
<span class="k">end</span>
</pre></div></div></div><p>To write a test for a valid object, we’ll create an initially valid User model object <code>@user</code> using the special <code>setup</code> method (discussed briefly in the <a href="static_pages_fragment.html#cha-static_pages" class="hyperref">Chapter <span class="ref">3</span></a> exercises), which automatically gets run before each test.<span class="intersentencespace"></span> Because <code>@user</code> is an instance variable, it’s automatically available in all the tests, and we can test its validity using the <code>valid?</code> method (<a href="modeling_users_fragment.html#sec-creating_user_objects" class="hyperref">Section <span class="ref">6.1.3</span></a>).<span class="intersentencespace"></span> The result appears in <a href="modeling_users_fragment.html#code-valid_user_test" class="hyperref">Listing <span class="ref">6.5</span></a>.</p>
<div class="codelisting" id="code-valid_user_test" data-tralics-id="uid708" data-number="6.5"><div class="heading"><span class="number">Listing 6.5:</span> 

<span class="description">A test for an initially valid user.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should be valid"</span> <span class="k">do</span>
    <span class="n">assert</span> <span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p><a href="modeling_users_fragment.html#code-valid_user_test" class="hyperref">Listing <span class="ref">6.5</span></a> uses the plain <code>assert</code> method, which in this case succeeds if <code>@user.valid?</code> returns <code>true</code> and fails if it returns <code>false</code>.</p>
<p>Because our User model doesn’t currently have any validations, the initial test should pass:</p>
<div class="codelisting" id="uid709" data-tralics-id="uid709" data-number="6.6"><div class="heading"><span class="number">Listing 6.6:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test:models
</pre></div></div></div><p>Here we’ve used <code>rails test:models</code> to run just the model tests (compare to <code>rails test:integration</code> from <a href="filling_in_the_layout_fragment.html#sec-layout_link_tests" class="hyperref">Section <span class="ref">5.3.4</span></a>).</p>
<div id="sec-exercises_a_validity_test" data-tralics-id="uid710" class="subsubsection" data-number="6.2.1.1"><h4><a href="#sec-exercises_a_validity_test" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>In the console, confirm that a new user is currently valid. <span class="exercise" id="ex-81b3d0"></span>
</li>
<li>Confirm that the user created in <a href="modeling_users_fragment.html#sec-creating_user_objects" class="hyperref">Section <span class="ref">6.1.3</span></a> is also valid. <span class="exercise" id="ex-48a701"></span>
</li></ol>
</div></div>
<div id="sec-presence_validation" data-tralics-id="uid713" class="subsection" data-number="6.2.2"><h3><a href="modeling_users_fragment.html#sec-presence_validation" class="heading hyperref"><span class="number">6.2.2 </span>Validating presence</a></h3>
<p>Perhaps the most elementary validation is <em>presence</em>, which simply verifies that a given attribute is present.<span class="intersentencespace"></span> For example, in this section we’ll ensure that both the name and email fields are present before a user gets saved to the database.<span class="intersentencespace"></span> In <a href="sign_up_fragment.html#sec-signup_error_messages" class="hyperref">Section <span class="ref">7.3.3</span></a>, we’ll see how to propagate this requirement up to the signup form for creating new users.</p>
<p>We’ll start with a test for the presence of a <code>name</code> attribute by building on the test in <a href="modeling_users_fragment.html#code-valid_user_test" class="hyperref">Listing <span class="ref">6.5</span></a>.<span class="intersentencespace"></span> As seen in <a href="modeling_users_fragment.html#code-name_presence_test" class="hyperref">Listing <span class="ref">6.7</span></a>, all we need to do is set the <code>@user</code> variable’s <code>name</code> attribute to a blank string (in this case, a string of spaces) and then check (using the <code>assert_not</code> method) that the resulting User object is not valid.</p>
<div class="codelisting" id="code-name_presence_test" data-tralics-id="uid714" data-number="6.7"><div class="heading"><span class="number">Listing 6.7:</span> 

<span class="description">A test for validation of the <code>name</code> attribute.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should be valid"</span> <span class="k">do</span>
    <span class="n">assert</span> <span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>

<span class="hll">  <span class="nb">test</span> <span class="s2">"name should be present"</span> <span class="k">do</span>
</span><span class="hll">    <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"     "</span>
</span><span class="hll">    <span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="k">end</span>
</pre></div></div></div><p>At this point, the model tests should be <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid715" data-tralics-id="uid715" data-number="6.8"><div class="heading"><span class="number">Listing 6.8:</span> <span class="description"><span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test:models
</pre></div></div></div><p>As we saw briefly before in the <a href="toy_app_fragment.html#cha-a_toy_app" class="hyperref">Chapter <span class="ref">2</span></a> exercises, the way to validate the presence of the name attribute is to use the <code>validates</code> method with argument <code>presence: true</code>, as shown in <a href="modeling_users_fragment.html#code-validates_presence_of_name" class="hyperref">Listing <span class="ref">6.9</span></a>.<span class="intersentencespace"></span> The <code>presence: true</code> argument is a one-element <em>options hash</em>; recall from <a href="rails_flavored_ruby_fragment.html#sec-css_revisited" class="hyperref">Section <span class="ref">4.3.4</span></a> that curly braces are optional when passing hashes as the final argument in a method.<span class="intersentencespace"></span> (As noted in <a href="filling_in_the_layout_fragment.html#sec-adding_to_the_layout" class="hyperref">Section <span class="ref">5.1.1</span></a>, the use of options hashes is a recurring theme in Rails.)</p>
<div class="codelisting" id="code-validates_presence_of_name" data-tralics-id="uid716" data-number="6.9"><div class="heading"><span class="number">Listing 6.9:</span> 

<span class="description">Validating the presence of a <code>name</code> attribute.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="hll">  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
</span><span class="k">end</span>
</pre></div></div></div><p><a href="modeling_users_fragment.html#code-validates_presence_of_name" class="hyperref">Listing <span class="ref">6.9</span></a> may look like magic, but <code>validates</code> is just a method.<span class="intersentencespace"></span> An equivalent formulation of <a href="modeling_users_fragment.html#code-validates_presence_of_name" class="hyperref">Listing <span class="ref">6.9</span></a> using parentheses is as follows:</p>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p>Let’s drop into the console to see the effects of adding a validation to our User model:<sup id="cha-6_footnote-ref-10" class="footnote"><a href="#cha-6_footnote-10">10</a></sup></p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"mhartl@example.com"</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">valid?</span>
<span class="go">=&gt; false</span>
</pre></div></div>
<p>Here we check the validity of the <code>user</code> variable using the <code>valid?</code> method, which returns <code>false</code> when the object fails one or more validations, and <code>true</code> when all validations pass.<span class="intersentencespace"></span> In this case, we only have one validation, so we know which one failed, but it can still be helpful to check using the <code>errors</code> object generated on failure:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span>
<span class="go">=&gt; ["Name can't be blank"]</span>
</pre></div></div>
<p>(The error message is a hint that Rails validates the presence of an attribute using the <code>blank?</code> method, which we saw at the end of <a href="rails_flavored_ruby_fragment.html#sec-modifying_built_in_classes" class="hyperref">Section <span class="ref">4.4.3</span></a>.)</p>
<p>Because the user isn’t valid, an attempt to save the user to the database automatically fails:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; false</span>
</pre></div></div>
<p>As a result, the test in <a href="modeling_users_fragment.html#code-name_presence_test" class="hyperref">Listing <span class="ref">6.7</span></a> should now be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid718" data-tralics-id="uid718" data-number="6.10"><div class="heading"><span class="number">Listing 6.10:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test:models
</pre></div></div></div><p>Following the model in <a href="modeling_users_fragment.html#code-name_presence_test" class="hyperref">Listing <span class="ref">6.7</span></a>, writing a test for <code>email</code> attribute presence is easy (<a href="modeling_users_fragment.html#code-email_presence_test" class="hyperref">Listing <span class="ref">6.11</span></a>), as is the application code to get it to pass (<a href="modeling_users_fragment.html#code-validates_presence_of_email" class="hyperref">Listing <span class="ref">6.12</span></a>).</p>
<div class="codelisting" id="code-email_presence_test" data-tralics-id="uid719" data-number="6.11"><div class="heading"><span class="number">Listing 6.11:</span> 

<span class="description">A test for validation of the <code>email</code> attribute.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should be valid"</span> <span class="k">do</span>
    <span class="n">assert</span> <span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"name should be present"</span> <span class="k">do</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>

<span class="hll">  <span class="nb">test</span> <span class="s2">"email should be present"</span> <span class="k">do</span>
</span><span class="hll">    <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">"     "</span>
</span><span class="hll">    <span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="code-validates_presence_of_email" data-tralics-id="uid720" data-number="6.12"><div class="heading"><span class="number">Listing 6.12:</span> 

<span class="description">Validating the presence of an <code>email</code> attribute.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
<span class="hll">  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
</span><span class="k">end</span>
</pre></div></div></div><p>At this point, the presence validations are complete, and the test suite should be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid721" data-tralics-id="uid721" data-number="6.13"><div class="heading"><span class="number">Listing 6.13:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div>
<div id="sec-exercises_presence_validation" data-tralics-id="uid722" class="subsubsection" data-number="6.2.2.1"><h4><a href="#sec-exercises_presence_validation" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Make a new user called <code>u</code> and confirm that it’s initially invalid.<span class="intersentencespace"></span> What are the full error messages? <span class="exercise" id="ex-cc4567"></span>
</li>
<li>Confirm that <code>u.errors.messages</code> is a hash of errors.<span class="intersentencespace"></span> How would you access just the email errors? <span class="exercise" id="ex-248e6d"></span>
</li></ol>
</div></div>
<div id="sec-length_validation" data-tralics-id="uid725" class="subsection" data-number="6.2.3"><h3><a href="modeling_users_fragment.html#sec-length_validation" class="heading hyperref"><span class="number">6.2.3 </span>Length validation</a></h3>
<p>We’ve constrained our User model to require a name for each user, but we should go further: the user’s names will be displayed on the sample site, so we should enforce some limit on their length.<span class="intersentencespace"></span> With all the work we did in <a href="modeling_users_fragment.html#sec-presence_validation" class="hyperref">Section <span class="ref">6.2.2</span></a>, this step is easy.</p>
<p>There’s no science to picking a maximum length; we’ll just pull <code>50</code> out of thin air as a reasonable upper bound, which means verifying that names of <code>51</code> characters are too long.<span class="intersentencespace"></span> In addition, although it’s unlikely ever to be a problem, there’s a chance that a user’s email address could overrun the maximum length of strings, which for many databases is 255.<span class="intersentencespace"></span> Because the format validation in <a href="modeling_users_fragment.html#sec-format_validation" class="hyperref">Section <span class="ref">6.2.4</span></a> won’t enforce such a constraint, we’ll add one in this section for completeness.<span class="intersentencespace"></span> <a href="modeling_users_fragment.html#code-length_validation_test" class="hyperref">Listing <span class="ref">6.14</span></a> shows the resulting tests.</p>
<div class="codelisting" id="code-length_validation_test" data-tralics-id="uid726" data-number="6.14"><div class="heading"><span class="number">Listing 6.14:</span> 

<span class="description">A test for <code>name</code> length validation.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"name should not be too long"</span> <span class="k">do</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"a"</span> <span class="o">*</span> <span class="mi">51</span>
    <span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"email should not be too long"</span> <span class="k">do</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">"a"</span> <span class="o">*</span> <span class="mi">244</span> <span class="o">+</span> <span class="s2">"@example.com"</span>
    <span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>For convenience, we’ve used “string multiplication” in <a href="modeling_users_fragment.html#code-length_validation_test" class="hyperref">Listing <span class="ref">6.14</span></a> to make a string 51 characters long.<span class="intersentencespace"></span> We can see how this works using the console:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">"a"</span> <span class="o">*</span> <span class="mi">51</span>
<span class="go">=&gt; "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s2">"a"</span> <span class="o">*</span> <span class="mi">51</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>
<span class="go">=&gt; 51</span>
</pre></div></div>
<p>The email length validation arranges to make a valid email address that’s one character too long:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">"a"</span> <span class="o">*</span> <span class="mi">244</span> <span class="o">+</span> <span class="s2">"@example.com"</span>
<span class="go">=&gt; "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span>
<span class="go">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span>
<span class="go">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span>
<span class="go">aaaaaaaaaaa@example.com"</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s2">"a"</span> <span class="o">*</span> <span class="mi">244</span> <span class="o">+</span> <span class="s2">"@example.com"</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>
<span class="go">=&gt; 256</span>
</pre></div></div>
<p>At this point, the tests in <a href="modeling_users_fragment.html#code-length_validation_test" class="hyperref">Listing <span class="ref">6.14</span></a> should be <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid727" data-tralics-id="uid727" data-number="6.15"><div class="heading"><span class="number">Listing 6.15:</span> <span class="description"><span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div><p>To get them to pass, we need to use the validation argument to constrain length, which is just <code>length</code>, along with the <code>maximum</code> parameter to enforce the upper bound (<a href="modeling_users_fragment.html#code-length_validation" class="hyperref">Listing <span class="ref">6.16</span></a>).</p>
<div class="codelisting" id="code-length_validation" data-tralics-id="uid728" data-number="6.16"><div class="heading"><span class="number">Listing 6.16:</span> 

<span class="description">Adding a length validation for the <code>name</code> attribute.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="hll">  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
</span><span class="hll">  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">}</span>
</span><span class="k">end</span>
</pre></div></div></div><p>Now the tests should be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid729" data-tralics-id="uid729" data-number="6.17"><div class="heading"><span class="number">Listing 6.17:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div><p>With our test suite passing again, we can move on to a more challenging validation: email format.</p>
<div id="sec-exercises_length_validation" data-tralics-id="uid730" class="subsubsection" data-number="6.2.3.1"><h4><a href="#sec-exercises_length_validation" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Make a new user with too-long name and email and confirm that it’s not valid. <span class="exercise" id="ex-1a1a36"></span>
</li>
<li>What are the error messages generated by the length validation? <span class="exercise" id="ex-f985db"></span>
</li></ol>
</div></div>
<div id="sec-format_validation" data-tralics-id="uid733" class="subsection" data-number="6.2.4"><h3><a href="modeling_users_fragment.html#sec-format_validation" class="heading hyperref"><span class="number">6.2.4 </span>Format validation</a></h3>
<p>Our validations for the <code>name</code> attribute enforce only minimal constraints—any non-blank name under 51 characters will do—but of course the <code>email</code> attribute must satisfy the more stringent requirement of being a valid email address.<span class="intersentencespace"></span> So far we’ve only rejected blank email addresses; in this section, we’ll require email addresses to conform to the familiar pattern <code>user@example.com</code>.</p>
<p>Neither the tests nor the validation will be exhaustive, just good enough to accept most valid email addresses and reject most invalid ones.<span class="intersentencespace"></span> We’ll start with a couple of tests involving collections of valid and invalid addresses.<span class="intersentencespace"></span> To make these collections, it’s worth knowing about the useful <code>%w[]</code> technique for making arrays of strings, as seen in this console session:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="sx">%w[foo bar baz]</span>
<span class="go">=&gt; ["foo", "bar", "baz"]</span>
<span class="gp">&gt;&gt; </span><span class="n">addresses</span> <span class="o">=</span> <span class="sx">%w[USER@foo.COM THE_US-ER@foo.bar.org first.last@foo.jp]</span>
<span class="go">=&gt; ["USER@foo.COM", "THE_US-ER@foo.bar.org", "first.last@foo.jp"]</span>
<span class="gp">&gt;&gt; </span><span class="n">addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">address</span><span class="o">|</span>
<span class="gp">?&gt; </span>  <span class="nb">puts</span> <span class="n">address</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">USER@foo.COM</span>
<span class="go">THE_US-ER@foo.bar.org</span>
<span class="go">first.last@foo.jp</span>
</pre></div></div>
<p>Here we’ve iterated over the elements of the <code>addresses</code> array using the <code>each</code> method (<a href="rails_flavored_ruby_fragment.html#sec-blocks" class="hyperref">Section <span class="ref">4.3.2</span></a>).<span class="intersentencespace"></span> With this technique in hand, we’re ready to write some basic email format validation tests.</p>
<p>Because email format validation is tricky and error-prone, we’ll start with some passing tests for <em>valid</em> email addresses to catch any errors in the validation.<span class="intersentencespace"></span> In other words, we want to make sure not just that invalid email addresses like <em>user@example,com</em> are rejected, but also that valid addresses like <em>user@example.com</em> are accepted, even after we impose the validation constraint.<span class="intersentencespace"></span> (Right now, of course, they’ll be accepted because all non-blank email addresses are currently valid.)<span class="intersentencespace"></span> The result for a representative sample of valid email addresses appears in <a href="modeling_users_fragment.html#code-email_format_valid_tests" class="hyperref">Listing <span class="ref">6.18</span></a>.</p>
<div class="codelisting" id="code-email_format_valid_tests" data-tralics-id="uid734" data-number="6.18"><div class="heading"><span class="number">Listing 6.18:</span> 

<span class="description">Tests for valid email formats.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"email validation should accept valid addresses"</span> <span class="k">do</span>
    <span class="n">valid_addresses</span> <span class="o">=</span> <span class="sx">%w[user@example.com USER@foo.COM A_US-ER@foo.bar.org</span>
<span class="sx">                         first.last@foo.jp alice+bob@baz.cn]</span>
    <span class="n">valid_addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">valid_address</span><span class="o">|</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">valid_address</span>
      <span class="n">assert</span> <span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="n">valid_address</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2"> should be valid"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that we’ve included an optional second argument to the assertion with a custom error message, which in this case identifies the address causing the test to fail:</p>
<div class="code"><div class="highlight"><pre><span class="n">assert</span> <span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="n">valid_address</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2"> should be valid"</span>
</pre></div></div>
<p>(This uses the interpolated <code>inspect</code> method mentioned in <a href="rails_flavored_ruby_fragment.html#sec-hashes_and_symbols" class="hyperref">Section <span class="ref">4.3.3</span></a>.)<span class="intersentencespace"></span> Including the specific address that causes any failure is especially useful in a test with an <code>each</code> loop like <a href="modeling_users_fragment.html#code-email_format_valid_tests" class="hyperref">Listing <span class="ref">6.18</span></a>; otherwise, any failure would merely identify the line number, which is the same for all the email addresses, and which wouldn’t be sufficient to identify the source of the problem.</p>
<p>Next we’ll add tests for the <em>invalidity</em> of a variety of invalid email addresses, such as <em>user@example,com</em> (comma in place of dot) and <em>user_at_foo.org</em> (missing the ‘@’ sign).<span class="intersentencespace"></span> As in <a href="modeling_users_fragment.html#code-email_format_valid_tests" class="hyperref">Listing <span class="ref">6.18</span></a>, <a href="modeling_users_fragment.html#code-email_format_validation_tests" class="hyperref">Listing <span class="ref">6.19</span></a> includes a custom error message to identify the exact address causing any failure.</p>
<div class="codelisting" id="code-email_format_validation_tests" data-tralics-id="uid735" data-number="6.19"><div class="heading"><span class="number">Listing 6.19:</span> 

<span class="description">Tests for email format validation.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"email validation should reject invalid addresses"</span> <span class="k">do</span>
    <span class="n">invalid_addresses</span> <span class="o">=</span> <span class="sx">%w[user@example,com user_at_foo.org user.name@example.</span>
<span class="sx">                           foo@bar_baz.com foo@bar+baz.com]</span>
    <span class="n">invalid_addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">invalid_address</span><span class="o">|</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">invalid_address</span>
      <span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="n">invalid_address</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2"> should be invalid"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>At this point, the tests should be <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid736" data-tralics-id="uid736" data-number="6.20"><div class="heading"><span class="number">Listing 6.20:</span> <span class="description"><span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div><p>The application code for email format validation uses the <code>format</code> validation, which works like this:</p>
<div class="code"><div class="highlight"><pre><span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="sr">/&lt;regular expression&gt;/</span> <span class="p">}</span>
</pre></div></div>
<p>This validates the attribute with the given <em>regular expression</em> (or <em>regex</em>), which is a powerful (and often cryptic) language for matching patterns in strings.<span class="intersentencespace"></span> This means we need to construct a regular expression to match valid email addresses while <em>not</em> matching invalid ones.</p>
<p>There actually exists a full regex for matching email addresses according to the official email standard, but it’s enormous, obscure, and quite possibly counter-productive.<sup id="cha-6_footnote-ref-11" class="footnote"><a href="#cha-6_footnote-11">11</a></sup><span class="intersentencespace"></span> In this tutorial, we’ll adopt a more pragmatic regex that has proven to be robust in practice.<span class="intersentencespace"></span> Here’s what it looks like:</p>
<div class="code"><div class="highlight"><pre><span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
</pre></div></div>
<p>To help understand where this comes from, <a href="modeling_users_fragment.html#table-valid_email_regex" class="hyperref">Table <span class="ref">6.1</span></a> breaks it into bite-sized pieces.<sup id="cha-6_footnote-ref-12" class="footnote"><a href="#cha-6_footnote-12">12</a></sup></p>
<div class="table" id="table-valid_email_regex" data-tralics-id="uid739" data-number="6.1"><table class="tabular">
<tbody><tr class="bottom_border"><td class="align_left"><strong>Expression</strong></td>
<td class="align_left"><strong>Meaning</strong></td>
</tr><tr><td class="align_left"><span class="inline_verbatim">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span></td>
<td class="align_left">full regex</td>
</tr><tr><td class="align_left"><span class="inline_verbatim">/</span></td>
<td class="align_left">start of regex</td>
</tr><tr><td class="align_left"><span class="inline_verbatim">\A</span></td>
<td class="align_left">match start of a string</td>
</tr><tr><td class="align_left"><span class="inline_verbatim">[\w+\-.]+</span></td>
<td class="align_left">at least one word character, plus, hyphen, or dot</td>
</tr><tr><td class="align_left"><span class="inline_verbatim">@</span></td>
<td class="align_left">literal “at sign”</td>
</tr><tr><td class="align_left"><span class="inline_verbatim">[a-z\d\-.]+</span></td>
<td class="align_left">at least one letter, digit, hyphen, or dot</td>
</tr><tr><td class="align_left"><span class="inline_verbatim">\.</span></td>
<td class="align_left">literal dot</td>
</tr><tr><td class="align_left"><span class="inline_verbatim">[a-z]+</span></td>
<td class="align_left">at least one letter</td>
</tr><tr><td class="align_left"><span class="inline_verbatim">\z</span></td>
<td class="align_left">match end of a string</td>
</tr><tr><td class="align_left"><span class="inline_verbatim">/</span></td>
<td class="align_left">end of regex</td>
</tr><tr><td class="align_left"><span class="inline_verbatim">i</span></td>
<td class="align_left">case-insensitive</td>
</tr></tbody></table><div class="caption"><span class="header">Table 6.1: </span><span class="description">Breaking down the valid email regex.
</span></div></div>
<p>Although you can learn a lot by studying <a href="modeling_users_fragment.html#table-valid_email_regex" class="hyperref">Table <span class="ref">6.1</span></a>, to really understand regular expressions I consider using an interactive regular expression matcher like <a href="http://www.rubular.com/" target="_blank" rel="noopener">Rubular</a> to be essential (<a href="modeling_users_fragment.html#fig-rubular" class="hyperref">Figure <span class="ref">6.7</span></a>).<sup id="cha-6_footnote-ref-13" class="footnote"><a href="#cha-6_footnote-13">13</a></sup><span class="intersentencespace"></span> The Rubular website has a beautiful interactive interface for making regular expressions, along with a handy regex quick reference.<span class="intersentencespace"></span> I encourage you to study <a href="modeling_users_fragment.html#table-valid_email_regex" class="hyperref">Table <span class="ref">6.1</span></a> with a browser window open to Rubular—no amount of reading about regular expressions can replace playing with them interactively.<span class="intersentencespace"></span> (<em>Note</em>: If you use the regex from <a href="modeling_users_fragment.html#table-valid_email_regex" class="hyperref">Table <span class="ref">6.1</span></a> in Rubular, I recommend leaving off the <span class="inline_verbatim">\A</span> and <span class="inline_verbatim">\z</span> characters so that you can match more than one email address at a time in the given test string.<span class="intersentencespace"></span> Also note that the regex consists of the characters <em>inside</em> the slashes <code>/.../</code>, so you should omit those when using Rubular.)</p>
<div class="center figure" id="fig-rubular" data-tralics-id="uid741" data-number="6.7">
<div class="graphics image box"><img src="images/figures/rubular.png" alt="images/figures/rubular"></div><div class="caption"><span class="header">Figure 6.7: </span><span class="description">The awesome <a href="http://www.rubular.com/" target="_blank" rel="noopener">Rubular</a> regular expression editor.
</span></div></div>
<p>Applying the regular expression from <a href="modeling_users_fragment.html#table-valid_email_regex" class="hyperref">Table <span class="ref">6.1</span></a> to the <code>email</code> format validation yields the code in <a href="modeling_users_fragment.html#code-validates_format_of_email" class="hyperref">Listing <span class="ref">6.21</span></a>.</p>
<div class="codelisting" id="code-validates_format_of_email" data-tralics-id="uid742" data-number="6.21"><div class="heading"><span class="number">Listing 6.21:</span> 

<span class="description">Validating the email format with a regular expression.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
<span class="hll">  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
</span>  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
<span class="hll">                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">}</span>
</span><span class="k">end</span>
</pre></div></div></div><p>Here the regex <code>VALID_EMAIL_REGEX</code> is a <em>constant</em>, indicated in Ruby by a name starting with a capital letter.<span class="intersentencespace"></span> The code</p>
<div class="code"><div class="highlight"><pre>  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">}</span>
</pre></div></div>
<p>ensures that only email addresses that match the pattern will be considered valid.<span class="intersentencespace"></span> (The expression above has one minor weakness: it allows invalid addresses that contain consecutive dots, such as <code>foo@bar..com</code>.<span class="intersentencespace"></span> Updating the regex in <a href="modeling_users_fragment.html#code-validates_format_of_email" class="hyperref">Listing <span class="ref">6.21</span></a> to fix this blemish is left as an exercise (<a href="modeling_users_fragment.html#sec-exercises_format_validation" class="hyperref">Section <span class="ref">6.2.4.1</span></a>).)</p>
<p>At this point, the tests should be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid743" data-tralics-id="uid743" data-number="6.22"><div class="heading"><span class="number">Listing 6.22:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test:models
</pre></div></div></div><p>This means that there’s only one constraint left: enforcing email uniqueness.</p>
<div id="sec-exercises_format_validation" data-tralics-id="uid744" class="subsubsection" data-number="6.2.4.1"><h4><a href="#sec-exercises_format_validation" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>By pasting in the valid addresses from <a href="modeling_users_fragment.html#code-email_format_valid_tests" class="hyperref">Listing <span class="ref">6.18</span></a> and invalid addresses from <a href="modeling_users_fragment.html#code-email_format_validation_tests" class="hyperref">Listing <span class="ref">6.19</span></a> into the test string area at Rubular, confirm that the regex from <a href="modeling_users_fragment.html#code-validates_format_of_email" class="hyperref">Listing <span class="ref">6.21</span></a> matches all of the valid addresses and none of the invalid ones. <span class="exercise" id="ex-4a2e50"></span>
</li>
<li>As noted above, the email regex in <a href="modeling_users_fragment.html#code-validates_format_of_email" class="hyperref">Listing <span class="ref">6.21</span></a> allows invalid email addresses with consecutive dots in the domain name, i.e., addresses of the form <em>foo@bar..com</em>.<span class="intersentencespace"></span> Add this address to the list of invalid addresses in <a href="modeling_users_fragment.html#code-email_format_validation_tests" class="hyperref">Listing <span class="ref">6.19</span></a> to get a failing test, and then use the more complicated regex shown in <a href="modeling_users_fragment.html#code-better_email_regex" class="hyperref">Listing <span class="ref">6.23</span></a> to get the test to pass. <span class="exercise" id="ex-158e59"></span>
</li>
<li>Add <em>foo@bar..com</em> to the list of addresses at Rubular, and confirm that the regex shown in <a href="modeling_users_fragment.html#code-better_email_regex" class="hyperref">Listing <span class="ref">6.23</span></a> matches all the valid addresses and none of the invalid ones. <span class="exercise" id="ex-ca235a"></span>
</li></ol>
<div class="codelisting" id="code-better_email_regex" data-tralics-id="uid748" data-number="6.23"><div class="heading"><span class="number">Listing 6.23:</span> 

<span class="description">Disallowing double dots in email domain names.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
<span class="hll">  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-]+(\.[a-z\d\-]+)*\.[a-z]+\z/i</span>
</span>  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span>   <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span>     <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div></div></div></div>
<div id="sec-uniqueness_validation" data-tralics-id="uid749" class="subsection" data-number="6.2.5"><h3><a href="modeling_users_fragment.html#sec-uniqueness_validation" class="heading hyperref"><span class="number">6.2.5 </span>Uniqueness validation</a></h3>
<p>To enforce uniqueness of email addresses (so that we can use them as usernames), we’ll be using the <code>:unique</code> option to the <code>validates</code> method.<span class="intersentencespace"></span> But be warned: there’s a <em>major</em> caveat, so don’t just skim this section—read it carefully.</p>
<p>We’ll start with some short tests.<span class="intersentencespace"></span> In our previous model tests, we’ve mainly used <code>User.new</code>, which just creates a Ruby object in memory, but for uniqueness tests we actually need to put a record into the database.<sup id="cha-6_footnote-ref-14" class="footnote"><a href="#cha-6_footnote-14">14</a></sup><span class="intersentencespace"></span> The initial duplicate email test appears in <a href="modeling_users_fragment.html#code-validates_uniqueness_of_email_test" class="hyperref">Listing <span class="ref">6.24</span></a>.</p>
<div class="codelisting" id="code-validates_uniqueness_of_email_test" data-tralics-id="uid751" data-number="6.24"><div class="heading"><span class="number">Listing 6.24:</span> 

<span class="description">A test for the rejection of duplicate email addresses.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="hll">  <span class="nb">test</span> <span class="s2">"email addresses should be unique"</span> <span class="k">do</span>
</span><span class="hll">    <span class="n">duplicate_user</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">dup</span>
</span><span class="hll">    <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
</span><span class="hll">    <span class="n">assert_not</span> <span class="n">duplicate_user</span><span class="o">.</span><span class="n">valid?</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="k">end</span>
</pre></div></div></div><p>The method here is to make a user with the same email address as <code>@user</code> using <code>@user.dup</code>, which creates a duplicate user with the same attributes.<span class="intersentencespace"></span> Since we then save <code>@user</code>, the duplicate user has an email address that already exists in the database, and hence should not be valid.</p>
<p>We can get the new test in <a href="modeling_users_fragment.html#code-validates_uniqueness_of_email_test" class="hyperref">Listing <span class="ref">6.24</span></a> to pass by adding <code>uniqueness: true</code> to the <code>email</code> validation, as shown in <a href="modeling_users_fragment.html#code-validates_uniqueness_of_email" class="hyperref">Listing <span class="ref">6.25</span></a>.</p>
<div class="codelisting" id="code-validates_uniqueness_of_email" data-tralics-id="uid752" data-number="6.25"><div class="heading"><span class="number">Listing 6.25:</span> 

<span class="description">Validating the uniqueness of email addresses.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
<span class="hll">                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="kp">true</span>
</span><span class="k">end</span>
</pre></div></div></div><p>We’re not quite done, though.<span class="intersentencespace"></span> Email addresses are typically processed as if they were case-insensitive—i.e., <code>foo@bar.com</code> is treated the same as <code>FOO@BAR.COM</code> or <code>FoO@BAr.coM</code>—so our validation should incorporate this as well.<sup id="cha-6_footnote-ref-15" class="footnote"><a href="#cha-6_footnote-15">15</a></sup><span class="intersentencespace"></span> It’s thus important to test for case-insensitivity, which we do with the code in <a href="modeling_users_fragment.html#code-validates_uniqueness_of_email_case_insensitive_test" class="hyperref">Listing <span class="ref">6.26</span></a>.</p>
<div class="codelisting" id="code-validates_uniqueness_of_email_case_insensitive_test" data-tralics-id="uid754" data-number="6.26"><div class="heading"><span class="number">Listing 6.26:</span> 

<span class="description">Testing case-insensitive email uniqueness.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"email addresses should be unique"</span> <span class="k">do</span>
    <span class="n">duplicate_user</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">dup</span>
<span class="hll">    <span class="n">duplicate_user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
</span>    <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
    <span class="n">assert_not</span> <span class="n">duplicate_user</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Here we are using the <code>upcase</code> method on strings (seen briefly in <a href="rails_flavored_ruby_fragment.html#sec-blocks" class="hyperref">Section <span class="ref">4.3.2</span></a>).<span class="intersentencespace"></span> This test does the same thing as the initial duplicate email test, but with an upper-case email address instead.<span class="intersentencespace"></span> If this test feels a little abstract, go ahead and fire up the console:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
<span class="go">=&gt; "USER@EXAMPLE.COM"</span>
<span class="gp">&gt;&gt; </span><span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">dup</span>
<span class="gp">&gt;&gt; </span><span class="n">duplicate_user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
<span class="gp">&gt;&gt; </span><span class="n">duplicate_user</span><span class="o">.</span><span class="n">valid?</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p>Of course, <code>duplicate_user.valid?</code> is currently <code>true</code> because the uniqueness validation is case-sensitive, but we want it to be <code>false</code>.<span class="intersentencespace"></span> Fortunately, <code>:uniqueness</code> accepts an option, <code>:case_sensitive</code>, for just this purpose (<a href="modeling_users_fragment.html#code-validates_uniqueness_of_email_case_insensitive" class="hyperref">Listing <span class="ref">6.27</span></a>).</p>
<div class="codelisting" id="code-validates_uniqueness_of_email_case_insensitive" data-tralics-id="uid755" data-number="6.27"><div class="heading"><span class="number">Listing 6.27:</span> 

<span class="description">Validating the uniqueness of email addresses, ignoring case.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
<span class="hll">                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
</span><span class="k">end</span>
</pre></div></div></div><p>Note that we have simply replaced <code>true</code> in <a href="modeling_users_fragment.html#code-validates_uniqueness_of_email" class="hyperref">Listing <span class="ref">6.25</span></a> with <code>case_sensitive: false</code> in <a href="modeling_users_fragment.html#code-validates_uniqueness_of_email_case_insensitive" class="hyperref">Listing <span class="ref">6.27</span></a>.<span class="intersentencespace"></span> (Rails infers that <code>uniqueness</code> should be <code>true</code> as well.)</p>
<p>At this point, our application—with an important caveat—enforces email uniqueness, and our test suite should pass:</p>
<div class="codelisting" id="uid756" data-tralics-id="uid756" data-number="6.28"><div class="heading"><span class="number">Listing 6.28:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div><p>There’s just one small problem, which is that <em>the Active Record uniqueness validation does not guarantee uniqueness at the database level</em>.<span class="intersentencespace"></span> Here’s a scenario that explains why:</p>
<ol>
<li>Alice signs up for the sample app, with address alice@wonderland.com.<span class="intersentencespace"></span>
</li>
<li>Alice accidentally clicks on “Submit” <em>twice</em>, sending two requests in quick succession.<span class="intersentencespace"></span>
</li>
<li>The following sequence occurs: request 1 creates a user in memory that passes validation, request 2 does the same, request 1’s user gets saved, request 2’s user gets saved.<span class="intersentencespace"></span>
</li>
<li>Result: two user records with the exact same email address, despite the uniqueness validation
</li></ol>
<p>If the above sequence seems implausible, believe me, it isn’t: it can happen on any Rails website with significant traffic (which I once learned the hard way).<span class="intersentencespace"></span> Luckily, the solution is straightforward to implement: we just need to enforce uniqueness at the database level as well as at the model level.<span class="intersentencespace"></span> Our method is to create a database <em>index</em> on the email column (<a href="modeling_users_fragment.html#aside-database_indices" class="hyperref">Box <span class="ref">6.2</span></a>), and then require that the index be unique.</p>
<div class="aside" id="aside-database_indices" data-tralics-id="uid761" data-number="6.2"><div class="heading"><span class="number">Box 6.2.</span> 

<span class="description">Database indices</span></div>
<p>When creating a column in a database, it is important to consider whether we will need to <em>find</em> records by that column.<span class="intersentencespace"></span> Consider, for example, the <code class="tt">email</code> attribute created by the migration in <a href="modeling_users_fragment.html#code-users_migration" class="hyperref">Listing <span class="ref">6.2</span></a>.<span class="intersentencespace"></span> When we allow users to log in to the sample app starting in <a href="sign_up_fragment.html#cha-sign_up" class="hyperref">Chapter <span class="ref">7</span></a>, we will need to find the user record corresponding to the submitted email address.<span class="intersentencespace"></span> Unfortunately, based on the naïve data model, the only way to find a user by email address is to look through <em>each</em> user row in the database and compare its email attribute to the given email—which means we might have to examine <em>every</em> row (since the user could be the last one in the database).<span class="intersentencespace"></span> This is known in the database business as a <em>full-table scan</em>, and for a real site with thousands of users it is a <a href="http://catb.org/jargon/html/B/Bad-Thing.html" target="_blank" rel="noopener">Bad Thing</a>.</p>
<p>Putting an index on the email column fixes the problem.<span class="intersentencespace"></span> To understand a database index, it’s helpful to consider the analogy of a book index.<span class="intersentencespace"></span> In a book, to find all the occurrences of a given string, say “foobar”, you would have to scan each page for “foobar”—the paper version of a full-table scan.<span class="intersentencespace"></span> With a book index, on the other hand, you can just look up “foobar” in the index to see all the pages containing “foobar”.<span class="intersentencespace"></span> A database index works essentially the same way.</p>

</div><p>The email index represents an update to our data modeling requirements, which (as discussed in <a href="modeling_users_fragment.html#sec-database_migrations" class="hyperref">Section <span class="ref">6.1.1</span></a>) is handled in Rails using migrations.<span class="intersentencespace"></span> We saw in <a href="modeling_users_fragment.html#sec-database_migrations" class="hyperref">Section <span class="ref">6.1.1</span></a> that generating the User model automatically created a new migration (<a href="modeling_users_fragment.html#code-users_migration" class="hyperref">Listing <span class="ref">6.2</span></a>); in the present case, we are adding structure to an existing model, so we need to create a migration directly using the <code>migration</code> generator:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_index_to_users_email
</pre></div></div>
<p>Unlike the migration for users, the email uniqueness migration is not pre-defined, so we need to fill in its contents with <a href="modeling_users_fragment.html#code-email_uniqueness_index" class="hyperref">Listing <span class="ref">6.29</span></a>.<sup id="cha-6_footnote-ref-16" class="footnote"><a href="#cha-6_footnote-16">16</a></sup></p>
<div class="codelisting" id="code-email_uniqueness_index" data-tralics-id="uid763" data-number="6.29"><div class="heading"><span class="number">Listing 6.29:</span> 

<span class="description">The migration for enforcing email uniqueness.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">db/migrate/[timestamp]_add_index_to_users_email.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddIndexToUsersEmail</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="o">[</span><span class="mi">5</span><span class="o">.</span><span class="mi">0</span><span class="o">]</span>
  <span class="k">def</span> <span class="nf">change</span>
<span class="hll">    <span class="n">add_index</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">unique</span><span class="p">:</span> <span class="kp">true</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>This uses a Rails method called <code>add_index</code> to add an index on the <code>email</code> column of the <code>users</code> table.<span class="intersentencespace"></span> The index by itself doesn’t enforce uniqueness, but the option <code>unique: true</code> does.</p>
<p>The final step is to migrate the database:</p>
<div class="code"><div class="highlight"><pre>$ rails db:migrate
</pre></div></div>
<p>(If this fails, try exiting any running sandbox console sessions, which can lock the database and prevent migrations.)</p>
<p>At this point, the test suite should be <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span> due to a violation of the uniqueness constraint in the <em>fixtures</em>, which contain sample data for the test database.<span class="intersentencespace"></span> User fixtures were generated automatically in <a href="modeling_users_fragment.html#code-generate_user_model" class="hyperref">Listing <span class="ref">6.1</span></a>, and as shown in <a href="modeling_users_fragment.html#code-default_fixtures" class="hyperref">Listing <span class="ref">6.30</span></a> the email addresses are not unique.<span class="intersentencespace"></span> (They’re not <em>valid</em> either, but fixture data doesn’t get run through the validations.)</p>
<div class="codelisting" id="code-default_fixtures" data-tralics-id="uid764" data-number="6.30"><div class="heading"><span class="number">Listing 6.30:</span> 

<span class="description">The default user fixtures.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/fixtures/users.yml</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="c1"># Read about fixtures at http://api.rubyonrails.org/classes/ActiveRecord/</span>
<span class="c1"># FixtureSet.html</span>

<span class="l-Scalar-Plain">one</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">MyString</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">MyString</span>

<span class="l-Scalar-Plain">two</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">MyString</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">MyString</span>
</pre></div></div></div><p>Because we won’t need fixtures until <a href="basic_login_fragment.html#cha-basic_login" class="hyperref">Chapter <span class="ref">8</span></a>, for now we’ll just remove them, leaving an empty fixtures file (<a href="modeling_users_fragment.html#code-empty_fixtures" class="hyperref">Listing <span class="ref">6.31</span></a>).</p>
<div class="codelisting" id="code-empty_fixtures" data-tralics-id="uid765" data-number="6.31"><div class="heading"><span class="number">Listing 6.31:</span> 

<span class="description">An empty fixtures file.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/fixtures/users.yml</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="c1"># empty</span>
</pre></div></div></div><p>Having addressed the uniqueness caveat, there’s one more change we need to make to be assured of email uniqueness.<span class="intersentencespace"></span> Some database adapters use case-sensitive indices, considering the strings “Foo@ExAMPle.CoM” and “foo@example.com” to be distinct, but our application treats those addresses as the same.<span class="intersentencespace"></span> To avoid this incompatibility, we’ll standardize on all lower-case addresses, converting “Foo@ExAMPle.CoM” to “foo@example.com” before saving it to the database.<span class="intersentencespace"></span> The way to do this is with a <a href="http://en.wikipedia.org/wiki/Callback_(computer_science)" target="_blank" rel="noopener"><em>callback</em></a>, which is a method that gets invoked at a particular point in the lifecycle of an Active Record object.<span class="intersentencespace"></span> In the present case, that point is before the object is saved, so we’ll use a <code>before_save</code> callback to downcase the email attribute before saving the user.<sup id="cha-6_footnote-ref-17" class="footnote"><a href="#cha-6_footnote-17">17</a></sup><span class="intersentencespace"></span> The result appears in <a href="modeling_users_fragment.html#code-email_downcase" class="hyperref">Listing <span class="ref">6.32</span></a>.<span class="intersentencespace"></span> (This is just a first implementation; we’ll discuss this subject again in <a href="account_activation_fragment.html#sec-account_activations_resource" class="hyperref">Section <span class="ref">11.1</span></a>, where we’ll use the preferred <em>method reference</em> convention for defining callbacks.)</p>
<div class="codelisting" id="code-email_downcase" data-tralics-id="uid767" data-number="6.32"><div class="heading"><span class="number">Listing 6.32:</span> 

<span class="description">Ensuring email uniqueness by downcasing the email attribute.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="hll">  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
</span>  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div></div><p>The code in <a href="modeling_users_fragment.html#code-email_downcase" class="hyperref">Listing <span class="ref">6.32</span></a> passes a block to the <code>before_save</code> callback and sets the user’s email address to a lower-case version of its current value using the <code>downcase</code> string method.<span class="intersentencespace"></span> (Writing a test for email downcasing is left as an exercise (<a href="modeling_users_fragment.html#sec-exercises_uniqueness_validation" class="hyperref">Section <span class="ref">6.2.5.1</span></a>).)</p>
<p>In <a href="modeling_users_fragment.html#code-email_downcase" class="hyperref">Listing <span class="ref">6.32</span></a>, we could have written the assignment as</p>
<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">downcase</span>
</pre></div></div>
<p>(where <code>self</code> refers to the current user), but inside the User model the <code>self</code> keyword is optional on the right-hand side:</p>
<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span>
</pre></div></div>
<p>We encountered this idea briefly in the context of <code>reverse</code> in the <code>palindrome</code> method (<a href="rails_flavored_ruby_fragment.html#sec-a_class_of_our_own" class="hyperref">Section <span class="ref">4.4.2</span></a>), which also noted that <code>self</code> is <em>not</em> optional in an assignment, so</p>
<div class="code"><div class="highlight"><pre><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span>
</pre></div></div>
<p>wouldn’t work.<span class="intersentencespace"></span> (We’ll discuss this subject in more depth in <a href="advanced_login_fragment.html#sec-remember_me" class="hyperref">Section <span class="ref">9.1</span></a>.)</p>
<p>At this point, the Alice scenario above will work fine: the database will save a user record based on the first request, and it will reject the second save because the duplicate email address violates the uniqueness constraint.<span class="intersentencespace"></span> (An error will appear in the Rails log, but that doesn’t do any harm.)<span class="intersentencespace"></span> Moreover, adding this index on the email attribute accomplishes a second goal, alluded to briefly in <a href="modeling_users_fragment.html#sec-finding_user_objects" class="hyperref">Section <span class="ref">6.1.4</span></a>: as noted in <a href="modeling_users_fragment.html#aside-database_indices" class="hyperref">Box <span class="ref">6.2</span></a>, the index on the <code>email</code> attribute fixes a potential efficiency problem by preventing a full-table scan when finding users by email address.</p>
<div id="sec-exercises_uniqueness_validation" data-tralics-id="uid768" class="subsubsection" data-number="6.2.5.1"><h4><a href="#sec-exercises_uniqueness_validation" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Add a test for the email downcasing from <a href="modeling_users_fragment.html#code-email_downcase" class="hyperref">Listing <span class="ref">6.32</span></a>, as shown in <a href="modeling_users_fragment.html#code-email_downcase_test" class="hyperref">Listing <span class="ref">6.33</span></a>.<span class="intersentencespace"></span> This test uses the <code>reload</code> method for reloading a value from the database and the <code>assert_equal</code> method for testing equality.<span class="intersentencespace"></span> To verify that <a href="modeling_users_fragment.html#code-email_downcase_test" class="hyperref">Listing <span class="ref">6.33</span></a> tests the right thing, comment out the <code>before_save</code> line to get to <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>, then uncomment it to get to <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>. <span class="exercise" id="ex-3727c0"></span>
</li>
<li>By running the test suite, verify that the <code>before_save</code> callback can be written using the “bang” method <code>email.downcase!</code> to modify the <code>email</code> attribute directly, as shown in <a href="modeling_users_fragment.html#code-downcase_bang" class="hyperref">Listing <span class="ref">6.34</span></a>. <span class="exercise" id="ex-21aeec"></span>
</li></ol>
<div class="codelisting" id="code-email_downcase_test" data-tralics-id="uid771" data-number="6.33"><div class="heading"><span class="number">Listing 6.33:</span> 

<span class="description">A test for the email downcasing from <a href="modeling_users_fragment.html#code-email_downcase" class="hyperref">Listing <span class="ref">6.32</span></a>.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"email addresses should be unique"</span> <span class="k">do</span>
    <span class="n">duplicate_user</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">dup</span>
    <span class="n">duplicate_user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
    <span class="n">assert_not</span> <span class="n">duplicate_user</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>

<span class="hll">  <span class="nb">test</span> <span class="s2">"email addresses should be saved as lower-case"</span> <span class="k">do</span>
</span><span class="hll">    <span class="n">mixed_case_email</span> <span class="o">=</span> <span class="s2">"Foo@ExAMPle.CoM"</span>
</span><span class="hll">    <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">mixed_case_email</span>
</span><span class="hll">    <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
</span><span class="hll">    <span class="n">assert_equal</span> <span class="n">mixed_case_email</span><span class="o">.</span><span class="n">downcase</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">email</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="code-downcase_bang" data-tralics-id="uid772" data-number="6.34"><div class="heading"><span class="number">Listing 6.34:</span> 

<span class="description">An alternate callback implementation.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="hll">  <span class="n">before_save</span> <span class="p">{</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase!</span> <span class="p">}</span>
</span>  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div></div></div></div></div><div id="sec-adding_a_secure_password" data-tralics-id="cid35" class="section" data-number="6.3"><h2><a href="modeling_users_fragment.html#sec-adding_a_secure_password" class="heading hyperref"><span class="number">6.3 </span>Adding a secure password</a></h2>
<p>Now that we’ve defined validations for the name and email fields, we’re ready to add the last of the basic User attributes: a secure password.<span class="intersentencespace"></span> The method is to require each user to have a password (with a password confirmation), and then store a <em>hashed</em> version of the password in the database.<span class="intersentencespace"></span> (There is some potential for confusion here.<span class="intersentencespace"></span> In the present context, a <em>hash</em> refers not to the Ruby data structure from <a href="rails_flavored_ruby_fragment.html#sec-hashes_and_symbols" class="hyperref">Section <span class="ref">4.3.3</span></a> but rather to the result of applying an irreversible <a href="http://en.wikipedia.org/wiki/Hash_function" target="_blank" rel="noopener">hash function</a> to input data.)<span class="intersentencespace"></span> We’ll also add a way to <em>authenticate</em> a user based on a given password, a method we’ll use in <a href="basic_login_fragment.html#cha-basic_login" class="hyperref">Chapter <span class="ref">8</span></a> to allow users to log in to the site.</p>
<p>The method for authenticating users will be to take a submitted password, hash it, and compare the result to the hashed value stored in the database.<span class="intersentencespace"></span> If the two match, then the submitted password is correct and the user is authenticated.<span class="intersentencespace"></span> By comparing hashed values instead of raw passwords, we will be able to authenticate users without storing the passwords themselves.<span class="intersentencespace"></span> This means that, even if our database is compromised, our users’ passwords will still be secure.</p>
<div id="sec-a_hashed_password" data-tralics-id="uid773" class="subsection" data-number="6.3.1"><h3><a href="modeling_users_fragment.html#sec-a_hashed_password" class="heading hyperref"><span class="number">6.3.1 </span>A hashed password</a></h3>
<p>Most of the secure password machinery will be implemented using a single Rails method called <code>has_secure_password</code>, which we’ll include in the User model as follows:</p>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">has_secure_password</span>
<span class="k">end</span>
</pre></div></div>
<p>When included in a model as above, this one method adds the following functionality:</p>
<ul>
<li>The ability to save a securely hashed <code>password_digest</code> attribute to the database
</li>
<li>A pair of virtual attributes<sup id="cha-6_footnote-ref-18" class="footnote"><a href="#cha-6_footnote-18">18</a></sup> (<code>password</code> and <code>password_confirmation</code>), including presence validations upon object creation and a validation requiring that they match
</li>
<li>An <code>authenticate</code> method that returns the user when the password is correct (and <code>false</code> otherwise)
</li></ul>
<p>The only requirement for <code>has_secure_password</code> to work its magic is for the corresponding model to have an attribute called <code>password_digest</code>.<span class="intersentencespace"></span> (The name <em>digest</em> comes from the terminology of <a href="http://en.wikipedia.org/wiki/Cryptographic_hash_function" target="_blank" rel="noopener">cryptographic hash functions</a>.<span class="intersentencespace"></span> In this context, <em>hashed password</em> and <em>password digest</em> are synonyms.)<sup id="cha-6_footnote-ref-19" class="footnote"><a href="#cha-6_footnote-19">19</a></sup> In the case of the User model, this leads to the data model shown in <a href="modeling_users_fragment.html#fig-user_model_password_digest" class="hyperref">Figure <span class="ref">6.8</span></a>.</p>
<div class="center figure" id="fig-user_model_password_digest" data-tralics-id="uid779" data-number="6.8"><span class="graphics"><img src="images/figures/user_model_password_digest_3rd_edition.png" alt="user_model_password_digest_3rd_edition"></span>
<div class="caption"><span class="header">Figure 6.8: </span><span class="description">The User data model with an added <code>password_digest</code> attribute.
</span></div></div>
<p>To implement the data model in <a href="modeling_users_fragment.html#fig-user_model_password_digest" class="hyperref">Figure <span class="ref">6.8</span></a> , we first generate an appropriate migration for the <code>password_digest</code> column.<span class="intersentencespace"></span> We can choose any migration name we want, but it’s convenient to end the name with <code>to_users</code>, since in this case Rails automatically constructs a migration to add columns to the <code>users</code> table.<span class="intersentencespace"></span> The result, with migration name <code>add_password_digest_to_users</code>, appears as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_password_digest_to_users password_digest:string
</pre></div></div>
<p>Here we’ve also supplied the argument <code>password_digest:string</code> with the name and type of attribute we want to create.<span class="intersentencespace"></span> (Compare this to the original generation of the <code>users</code> table in <a href="modeling_users_fragment.html#code-generate_user_model" class="hyperref">Listing <span class="ref">6.1</span></a>, which included the arguments <code>name:string</code> and <code>email:string</code>.)<span class="intersentencespace"></span> By including <code>password_digest:string</code>, we’ve given Rails enough information to construct the entire migration for us, as seen in <a href="modeling_users_fragment.html#code-password_migration" class="hyperref">Listing <span class="ref">6.35</span></a>.</p>
<div class="codelisting" id="code-password_migration" data-tralics-id="uid780" data-number="6.35"><div class="heading"><span class="number">Listing 6.35:</span> 

<span class="description">The migration to add a <code>password_digest</code> column.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">db/migrate/[timestamp]_add_password_digest_to_users.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddPasswordDigestToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="o">[</span><span class="mi">5</span><span class="o">.</span><span class="mi">0</span><span class="o">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:password_digest</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p><a href="modeling_users_fragment.html#code-password_migration" class="hyperref">Listing <span class="ref">6.35</span></a> uses the <code>add_column</code> method to add a <code>password_digest</code> column to the <code>users</code> table.<span class="intersentencespace"></span> To apply it, we just migrate the database:</p>
<div class="code"><div class="highlight"><pre>$ rails db:migrate
</pre></div></div>
<p>To make the password digest, <code>has_secure_password</code> uses a state-of-the-art hash function called <a href="http://en.wikipedia.org/wiki/Bcrypt" target="_blank" rel="noopener">bcrypt</a>.<span class="intersentencespace"></span> By hashing the password with bcrypt, we ensure that an attacker won’t be able to log in to the site even if they manage to obtain a copy of the database.<span class="intersentencespace"></span> To use bcrypt in the sample application, we need to add the <code>bcrypt</code> gem to our <code>Gemfile</code> (<a href="modeling_users_fragment.html#code-bcrypt_ruby" class="hyperref">Listing <span class="ref">6.36</span></a>).<sup id="cha-6_footnote-ref-20" class="footnote"><a href="#cha-6_footnote-20">20</a></sup></p>
<div class="codelisting" id="code-bcrypt_ruby" data-tralics-id="uid782" data-number="6.36"><div class="heading"><span class="number">Listing 6.36:</span> 

<span class="description">Adding <code>bcrypt</code> to the <code>Gemfile</code>.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span>          <span class="s1">'5.0.1'</span>
<span class="n">gem</span> <span class="s1">'bcrypt'</span><span class="p">,</span>         <span class="s1">'3.1.11'</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div></div></div><p>Then run <code>bundle install</code> as usual:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div></div>
</div>
<div id="sec-has_secure_password" data-tralics-id="uid783" class="subsection" data-number="6.3.2"><h3><a href="modeling_users_fragment.html#sec-has_secure_password" class="heading hyperref"><span class="number">6.3.2 </span>User has secure password</a></h3>
<p>Now that we’ve supplied the User model with the required <code>password_digest</code> attribute and installed bcrypt, we’re ready to add <code>has_secure_password</code> to the User model, as shown in <a href="modeling_users_fragment.html#code-has_secure_password" class="hyperref">Listing <span class="ref">6.37</span></a>.</p>
<div class="codelisting" id="code-has_secure_password" data-tralics-id="uid784" data-number="6.37"><div class="heading"><span class="number">Listing 6.37:</span> 

<span class="description">Adding <code>has_secure_password</code> to the User model.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
<span class="hll">  <span class="n">has_secure_password</span>
</span><span class="k">end</span>
</pre></div></div></div><p>As indicated by the <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span> indicator in <a href="modeling_users_fragment.html#code-has_secure_password" class="hyperref">Listing <span class="ref">6.37</span></a>, the tests are now failing, as you can confirm at the command line:</p>
<div class="codelisting" id="uid785" data-tralics-id="uid785" data-number="6.38"><div class="heading"><span class="number">Listing 6.38:</span> <span class="description"><span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div><p>The reason is that, as noted in <a href="modeling_users_fragment.html#sec-a_hashed_password" class="hyperref">Section <span class="ref">6.3.1</span></a>, <code>has_secure_password</code> enforces validations on the virtual <code>password</code> and <code>password_confirmation</code> attributes, but the tests in <a href="modeling_users_fragment.html#code-validates_uniqueness_of_email_case_insensitive_test" class="hyperref">Listing <span class="ref">6.26</span></a> create an <code>@user</code> variable without these attributes:</p>
<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">setup</span>
  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p>So, to get the test suite passing again, we just need to add a password and its confirmation, as shown in <a href="modeling_users_fragment.html#code-test_with_password_confirmation" class="hyperref">Listing <span class="ref">6.39</span></a>.</p>
<div class="codelisting" id="code-test_with_password_confirmation" data-tralics-id="uid786" data-number="6.39"><div class="heading"><span class="number">Listing 6.39:</span> 

<span class="description">Adding a password and its confirmation.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
<span class="hll">                     <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
</span>  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that the first line inside the <code>setup</code> method includes an additional comma at the end, as required by Ruby’s hash syntax (<a href="rails_flavored_ruby_fragment.html#sec-hashes_and_symbols" class="hyperref">Section <span class="ref">4.3.3</span></a>).<span class="intersentencespace"></span> Leaving this comma off will produce a syntax error, and you should use your technical sophistication (<a href="beginning_fragment.html#aside-technical_sophistication" class="hyperref">Box <span class="ref">1.1</span></a>) to identify and resolve such errors if (or, more realistically, when) they occur.</p>
<p>At this point the tests should be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid787" data-tralics-id="uid787" data-number="6.40"><div class="heading"><span class="number">Listing 6.40:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div><p>We’ll see in just a moment the benefits of adding <code>has_secure_password</code> to the User model (<a href="modeling_users_fragment.html#sec-creating_and_authenticating_a_user" class="hyperref">Section <span class="ref">6.3.4</span></a>), but first we’ll add a minimal requirement on password security.</p>
<div id="sec-exercises_has_secure_password" data-tralics-id="uid788" class="subsubsection" data-number="6.3.2.1"><h4><a href="#sec-exercises_has_secure_password" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Confirm that a user with valid name and email still isn’t valid overall. <span class="exercise" id="ex-2a0eec"></span>
</li>
<li>What are the error messages for a user with no password? <span class="exercise" id="ex-61d09e"></span>
</li></ol>
</div></div>
<div id="sec-minimum_password_standards" data-tralics-id="uid791" class="subsection" data-number="6.3.3"><h3><a href="modeling_users_fragment.html#sec-minimum_password_standards" class="heading hyperref"><span class="number">6.3.3 </span>Minimum password standards</a></h3>
<p>It’s good practice in general to enforce some minimum standards on passwords to make them harder to guess.<span class="intersentencespace"></span> There are many options for <a href="http://lmgtfy.com/?q=rails+enforce+password+strength" target="_blank" rel="noopener">enforcing password strength in Rails</a>, but for simplicity we’ll just enforce a minimum length and the requirement that the password not be blank.<span class="intersentencespace"></span> Picking a length of 6 as a reasonable minimum leads to the validation test shown in <a href="modeling_users_fragment.html#code-minimum_password_length_test" class="hyperref">Listing <span class="ref">6.41</span></a>.</p>
<div class="codelisting" id="code-minimum_password_length_test" data-tralics-id="uid792" data-number="6.41"><div class="heading"><span class="number">Listing 6.41:</span> 

<span class="description">Testing for a minimum password length.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Example User"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"user@example.com"</span><span class="p">,</span>
                     <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="hll">  <span class="nb">test</span> <span class="s2">"password should be present (nonblank)"</span> <span class="k">do</span>
</span><span class="hll">    <span class="vi">@user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">" "</span> <span class="o">*</span> <span class="mi">6</span>
</span><span class="hll">    <span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span>
</span><span class="hll">  <span class="k">end</span>
</span>
<span class="hll">  <span class="nb">test</span> <span class="s2">"password should have a minimum length"</span> <span class="k">do</span>
</span><span class="hll">    <span class="vi">@user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">"a"</span> <span class="o">*</span> <span class="mi">5</span>
</span><span class="hll">    <span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="k">end</span>
</pre></div></div></div><p>Note the use of the compact multiple assignment</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">"a"</span> <span class="o">*</span> <span class="mi">5</span>
</pre></div></div>
<p>in <a href="modeling_users_fragment.html#code-minimum_password_length_test" class="hyperref">Listing <span class="ref">6.41</span></a>.<span class="intersentencespace"></span> This arranges to assign a particular value to the password and its confirmation at the same time (in this case, a string of length 5, constructed using string multiplication as in <a href="modeling_users_fragment.html#code-length_validation_test" class="hyperref">Listing <span class="ref">6.14</span></a>).</p>
<p>You may be able to guess the code for enforcing a <code>minimum</code> length constraint by referring to the corresponding <code>maximum</code> validation for the user’s name (<a href="modeling_users_fragment.html#code-length_validation" class="hyperref">Listing <span class="ref">6.16</span></a>):</p>
<div class="code"><div class="highlight"><pre><span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">minimum</span><span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>
</pre></div></div>
<p>Combining this with a <code>presence</code> validation (<a href="modeling_users_fragment.html#sec-presence_validation" class="hyperref">Section <span class="ref">6.2.2</span></a>) to ensure nonblank passwords, this leads to the User model shown in <a href="modeling_users_fragment.html#code-password_implementation" class="hyperref">Listing <span class="ref">6.42</span></a>.<span class="intersentencespace"></span> (It turns out the <code>has_secure_password</code> method includes a presence validation, but unfortunately it only applies to records with <em>empty</em> passwords, which allows users to create invalid passwords like <code>’ ’</code> (six spaces).)</p>
<div class="codelisting" id="code-password_implementation" data-tralics-id="uid793" data-number="6.42"><div class="heading"><span class="number">Listing 6.42:</span> 

<span class="description">The complete implementation for secure passwords.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
  <span class="n">has_secure_password</span>
<span class="hll">  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">minimum</span><span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>
</span><span class="k">end</span>
</pre></div></div></div><p>At this point, the tests should be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid794" data-tralics-id="uid794" data-number="6.43"><div class="heading"><span class="number">Listing 6.43:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test:models
</pre></div></div></div>
<div id="sec-exercises_minimum_password_length" data-tralics-id="uid795" class="subsubsection" data-number="6.3.3.1"><h4><a href="#sec-exercises_minimum_password_length" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Confirm that a user with valid name and email but a too-short password isn’t valid. <span class="exercise" id="ex-57db46"></span>
</li>
<li>What are the associated error messages? <span class="exercise" id="ex-782852"></span>
</li></ol>
</div></div>
<div id="sec-creating_and_authenticating_a_user" data-tralics-id="uid798" class="subsection" data-number="6.3.4"><h3><a href="modeling_users_fragment.html#sec-creating_and_authenticating_a_user" class="heading hyperref"><span class="number">6.3.4 </span>Creating and authenticating a user</a></h3>
<p>Now that the basic User model is complete, we’ll create a user in the database as preparation for making a page to show the user’s information in <a href="sign_up_fragment.html#sec-showing_users" class="hyperref">Section <span class="ref">7.1</span></a>.<span class="intersentencespace"></span> We’ll also take a more concrete look at the effects of adding <code>has_secure_password</code> to the User model, including an examination of the important <code>authenticate</code> method.</p>
<p>Since users can’t yet sign up for the sample application through the web—that’s the goal of <a href="sign_up_fragment.html#cha-sign_up" class="hyperref">Chapter <span class="ref">7</span></a>—we’ll use the Rails console to create a new user by hand.<span class="intersentencespace"></span> For convenience, we’ll use the <code>create</code> method discussed in <a href="modeling_users_fragment.html#sec-creating_user_objects" class="hyperref">Section <span class="ref">6.1.3</span></a>, but in the present case we’ll take care <em>not</em> to start in a sandbox so that the resulting user will be saved to the database.<span class="intersentencespace"></span> This means starting an ordinary <code>rails console</code> session and then creating a user with a valid name and email address together with a valid password and matching confirmation:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Michael Hartl"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"mhartl@example.com"</span><span class="p">,</span>
<span class="gp">?&gt; </span>            <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "mhartl@example.com",</span>
<span class="go">created_at: "2016-05-23 20:36:46", updated_at: "2016-05-23 20:36:46",</span>
<span class="go">password_digest: "$2a$10$xxucoRlMp06RLJSfWpZ8hO8Dt9AZXlGRi3usP3njQg3..."&gt;</span>
</pre></div></div>
<p>To check that this worked, let’s look at the resulting <code>users</code> table in the development database using DB Browser for SQLite, as shown in <a href="modeling_users_fragment.html#fig-sqlite_user_row" class="hyperref">Figure <span class="ref">6.9</span></a>.<sup id="cha-6_footnote-ref-21" class="footnote intersentence"><a href="#cha-6_footnote-21">21</a></sup><span class="intersentencespace"></span> (If you’re using the cloud IDE, you should download the database file as in <a href="modeling_users_fragment.html#fig-sqlite_download" class="hyperref">Figure <span class="ref">6.5</span></a>.)<span class="intersentencespace"></span> Note that the columns correspond to the attributes of the data model defined in <a href="modeling_users_fragment.html#fig-user_model_password_digest" class="hyperref">Figure <span class="ref">6.8</span></a>.</p>
<div class="center figure" id="fig-sqlite_user_row" data-tralics-id="uid804" data-number="6.9">
<div class="graphics image"><img src="images/figures/sqlite_user_row_with_password_4th_edition.png" alt="images/figures/sqlite_user_row_with_password_4th_edition"></div><div class="caption"><span class="header">Figure 6.9: </span><span class="description">A user row in the SQLite database <code>db/development.sqlite3</code>.
</span></div></div>
<p>Returning to the console, we can see the effect of <code>has_secure_password</code> from <a href="modeling_users_fragment.html#code-password_implementation" class="hyperref">Listing <span class="ref">6.42</span></a> by looking at the <code>password_digest</code> attribute:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="s2">"mhartl@example.com"</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">password_digest</span>
<span class="go">=&gt; "$2a$10$xxucoRlMp06RLJSfWpZ8hO8Dt9AZXlGRi3usP3njQg3yOcVFzb6oK"</span>
</pre></div></div>
<p>This is the hashed version of the password (<code>"foobar"</code>) used to initialize the user object.<span class="intersentencespace"></span> Because it’s constructed using bcrypt, it is computationally impractical to use the digest to discover the original password.<sup id="cha-6_footnote-ref-22" class="footnote"><a href="#cha-6_footnote-22">22</a></sup></p>
<p>As noted in <a href="modeling_users_fragment.html#sec-a_hashed_password" class="hyperref">Section <span class="ref">6.3.1</span></a>, <code>has_secure_password</code> automatically adds an <code>authenticate</code> method to the corresponding model objects.<span class="intersentencespace"></span> This method determines if a given password is valid for a particular user by computing its digest and comparing the result to <code>password_digest</code> in the database.<span class="intersentencespace"></span> In the case of the user we just created, we can try a couple of invalid passwords as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">"not_the_right_password"</span><span class="p">)</span>
<span class="go">false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">"foobaz"</span><span class="p">)</span>
<span class="go">false</span>
</pre></div></div>
<p>Here <code>user.authenticate</code> returns <code>false</code> for invalid password.<span class="intersentencespace"></span> If we instead authenticate with the correct password, <code>authenticate</code> returns the user itself:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">"foobar"</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "mhartl@example.com",</span>
<span class="go">created_at: "2016-05-23 20:36:46", updated_at: "2016-05-23 20:36:46",</span>
<span class="go">password_digest: "$2a$10$xxucoRlMp06RLJSfWpZ8hO8Dt9AZXlGRi3usP3njQg3..."&gt;</span>
</pre></div></div>
<p>In <a href="basic_login_fragment.html#cha-basic_login" class="hyperref">Chapter <span class="ref">8</span></a>, we’ll use the <code>authenticate</code> method to sign registered users into our site.<span class="intersentencespace"></span> In fact, it will turn out not to be important to us that <code>authenticate</code> returns the user itself; all that will matter is that it returns a value that is <code>true</code> in a boolean context.<span class="intersentencespace"></span> Recalling from <a href="rails_flavored_ruby_fragment.html#sec-objects_and_message_passing" class="hyperref">Section <span class="ref">4.2.3</span></a> that <code>!!</code> converts an object to its corresponding boolean value, we can see that <code>user.authenticate</code> does the job nicely:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="o">!!</span><span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">"foobar"</span><span class="p">)</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<div id="sec-exercises_creating_and_authenticating_a_user" data-tralics-id="uid806" class="subsubsection" data-number="6.3.4.1"><h4><a href="#sec-exercises_creating_and_authenticating_a_user" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Quit and restart the console, and then find the user created in this section. <span class="exercise" id="ex-5d5ccc"></span>
</li>
<li>Try changing the name by assigning a new name and calling <code>save</code>.<span class="intersentencespace"></span> Why didn’t it work? <span class="exercise" id="ex-e7c2df"></span>
</li>
<li>Update <code>user</code>’s name to use your name.<span class="intersentencespace"></span> <em>Hint</em>: The necessary technique is covered in <a href="modeling_users_fragment.html#sec-updating_user_objects" class="hyperref">Section <span class="ref">6.1.5</span></a>. <span class="exercise" id="ex-1a90c0"></span>
</li></ol>
</div></div></div><div id="sec-modeling_users_conclusion" data-tralics-id="cid36" class="section" data-number="6.4"><h2><a href="modeling_users_fragment.html#sec-modeling_users_conclusion" class="heading hyperref"><span class="number">6.4 </span>Conclusion</a></h2>
<p>Starting from scratch, in this chapter we created a working User model with name, email, and password attributes, together with validations enforcing several important constraints on their values.<span class="intersentencespace"></span> In addition, we have the ability to securely authenticate users using a given password.<span class="intersentencespace"></span> This is a remarkable amount of functionality for only twelve lines of code.</p>
<p>In the next chapter, <a href="sign_up_fragment.html#cha-sign_up" class="hyperref">Chapter <span class="ref">7</span></a>, we’ll make a working signup form to create new users, together with a page to display each user’s information.<span class="intersentencespace"></span> In <a href="basic_login_fragment.html#cha-basic_login" class="hyperref">Chapter <span class="ref">8</span></a>, we’ll then use the authentication machinery from <a href="modeling_users_fragment.html#sec-adding_a_secure_password" class="hyperref">Section <span class="ref">6.3</span></a> to let users log into the site.</p>
<p>If you’re using Git, now would be a good time to commit if you haven’t done so in a while:</p>
<div class="code"><div class="highlight"><pre>$ rails test
$ git add -A
$ git commit -m "Make a basic User model (including secure passwords)"
</pre></div></div>
<p>Then merge back into the master branch and push to the remote repository:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge modeling-users
<span class="gp">$</span> git push
</pre></div></div>
<p>To get the User model working in production, we need to run the migrations at Heroku, which we can do with <code>heroku run</code>:</p>
<div class="code"><div class="highlight"><pre>$ rails test
$ git push heroku
$ heroku run rails db:migrate
</pre></div></div>
<p>We can verify that this worked by running a console in production:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ heroku run console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Michael Hartl"</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="s2">"michael@example.com"</span><span class="p">,</span>
<span class="gp">?&gt; </span>            <span class="ss">password</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: "Michael Hartl", email: "michael@example.com",</span>
<span class="go">created_at: "2016-05-23 20:54:41", updated_at: "2016-05-23 20:54:41",</span>
<span class="go">password_digest: "$2a$10$74xFguZRoTZBXTUqs1FjpOf3OoLhrvgxC2wlohtTEcH..."&gt;</span>
</pre></div></div>
<div id="sec-modeling_users_what_we_learned_in_this_chapter" data-tralics-id="uid810" class="subsection" data-number="6.4.1"><h3><a href="modeling_users_fragment.html#sec-modeling_users_what_we_learned_in_this_chapter" class="heading hyperref"><span class="number">6.4.1 </span>What we learned in this chapter</a></h3>
<ul>
<li>Migrations allow us to modify our application’s data model.<span class="intersentencespace"></span>
</li>
<li>Active Record comes with a large number of methods for creating and manipulating data models.<span class="intersentencespace"></span>
</li>
<li>Active Record validations allow us to place constraints on the data in our models.<span class="intersentencespace"></span>
</li>
<li>Common validations include presence, length, and format.<span class="intersentencespace"></span>
</li>
<li>Regular expressions are cryptic but powerful.<span class="intersentencespace"></span>
</li>
<li>Defining a database index improves lookup efficiency while allowing enforcement of uniqueness at the database level.<span class="intersentencespace"></span>
</li>
<li>We can add a secure password to a model using the built-in <code>has_secure_password</code> method.<span class="intersentencespace"></span>
</li></ul>
</div></div><div id="cha-6_footnotes">
  <ol class="footnotes">
    <li id="cha-6_footnote-1">The name comes from the “<a href="http://en.wikipedia.org/wiki/Active_record_pattern" target="_blank" rel="noopener">active record pattern</a>”, identified and named in <em>Patterns of Enterprise Application Architecture</em> by Martin Fowler. <a class="arrow" href="#cha-6_footnote-ref-1">↑</a></li>
    <li id="cha-6_footnote-2">Officially pronounced “ess-cue-ell”, though the alternate pronunciation “sequel” is also common.<span class="intersentencespace"></span> You can differentiate an individual author’s preference by the choice of indefinite article: those who write “a SQL database” prefer “sequel”, whereas those who write “an SQL database” prefer “ess-cue-ell”.<span class="intersentencespace"></span> As you’ll soon see, I prefer the latter. <a class="arrow" href="#cha-6_footnote-ref-2">↑</a></li>
    <li id="cha-6_footnote-3">By using an email address as the username, we open the possibility of communicating with our users at a future date (<a href="account_activation_fragment.html#cha-account_activation" class="hyperref">Chapter <span class="ref">11</span></a> and <a href="password_reset_fragment.html#cha-password_reset" class="hyperref">Chapter <span class="ref">12</span></a>). <a class="arrow" href="#cha-6_footnote-ref-3">↑</a></li>
    <li id="cha-6_footnote-4">Don’t worry about exactly how the <code>t</code> object manages to do this; the beauty of <em>abstraction layers</em> is that we don’t have to know.<span class="intersentencespace"></span> We can just trust the <code>t</code> object to do its job. <a class="arrow" href="#cha-6_footnote-ref-4">↑</a></li>
    <li id="cha-6_footnote-5">Officially pronounced “ess-cue-ell-ite”, although the (mis)pronunciation “sequel-ite” is also common. <a class="arrow" href="#cha-6_footnote-ref-5">↑</a></li>
    <li id="cha-6_footnote-6">The only exception is in <a href="following_users_fragment.html#sec-scopes_subselects_and_a_lambda" class="hyperref">Section <span class="ref">14.3.3</span></a>. <a class="arrow" href="#cha-6_footnote-ref-6">↑</a></li>
    <li id="cha-6_footnote-7">The timestamps are recorded in <a href="http://en.wikipedia.org/wiki/Coordinated_Universal_Time" target="_blank" rel="noopener">Coordinated Universal Time</a> (UTC), which for most practical purposes is the same as <a href="http://en.wikipedia.org/wiki/Greenwich_Mean_Time" target="_blank" rel="noopener">Greenwich Mean Time</a>.<span class="intersentencespace"></span> From the <a href="http://tf.nist.gov/general/misc.htm" target="_blank" rel="noopener">NIST Time and Frequency FAQ</a>: <strong>Q:</strong> Why is UTC used as the acronym for Coordinated Universal Time instead of CUT? <strong>A:</strong> In 1970 the Coordinated Universal Time system was devised by an international advisory group of technical experts within the International Telecommunication Union (ITU).<span class="intersentencespace"></span> The ITU felt it was best to designate a single abbreviation for use in all languages in order to minimize confusion.<span class="intersentencespace"></span> Since unanimous agreement could not be achieved on using either the English word order, CUT, or the French word order, TUC, the acronym UTC was chosen as a compromise. <a class="arrow" href="#cha-6_footnote-ref-7">↑</a></li>
    <li id="cha-6_footnote-8">Exceptions and exception handling are somewhat advanced Ruby subjects, and we won’t need them much in this book.<span class="intersentencespace"></span> They are important, though, and I suggest learning about them using one of the Ruby books recommended in <a href="following_users_fragment.html#sec-guide_to_further_resources" class="hyperref">Section <span class="ref">14.4.1</span></a>. <a class="arrow" href="#cha-6_footnote-ref-8">↑</a></li>
    <li id="cha-6_footnote-9">The <code>update_attributes</code> method is an alias for the shorter <code>update</code> method, but I prefer the longer version because of its similarity to the singular version of the method, <code>update_attribute</code>. <a class="arrow" href="#cha-6_footnote-ref-9">↑</a></li>
    <li id="cha-6_footnote-10">I’ll omit the output of console commands when they are not particularly instructive—for example, the results of <code>User.new</code>. <a class="arrow" href="#cha-6_footnote-ref-10">↑</a></li>
    <li id="cha-6_footnote-11">For example, did you know that <code>"Michael Hartl"@example.com</code>, with quotation marks and a space in the middle, is a valid email address according to the standard?<span class="intersentencespace"></span> Incredibly, it is—but it’s absurd. <a class="arrow" href="#cha-6_footnote-ref-11">↑</a></li>
    <li id="cha-6_footnote-12">Note that, in <a href="modeling_users_fragment.html#table-valid_email_regex" class="hyperref">Table <span class="ref">6.1</span></a>, “letter” really means “lower-case letter”, but the <code>i</code> at the end of the regex enforces case-insensitive matching. <a class="arrow" href="#cha-6_footnote-ref-12">↑</a></li>
    <li id="cha-6_footnote-13">If you find it as useful as I do, I encourage you to <a href="http://bit.ly/donate-to-rubular" target="_blank" rel="noopener">donate to Rubular</a> to reward developer <a href="http://lovitt.net/" target="_blank" rel="noopener">Michael Lovitt</a> for his wonderful work. <a class="arrow" href="#cha-6_footnote-ref-13">↑</a></li>
    <li id="cha-6_footnote-14">As noted briefly in the introduction to this section, there is a dedicated test database, <code>db/test.sqlite3</code>, for this purpose. <a class="arrow" href="#cha-6_footnote-ref-14">↑</a></li>
    <li id="cha-6_footnote-15">Technically, only the domain part of the email address is case-insensitive: <em>foo@bar.com</em> is actually different from <em>Foo@bar.com</em>.<span class="intersentencespace"></span> In practice, though, it is a bad idea to rely on this fact; as noted at <a href="http://email.about.com/od/emailbehindthescenes/f/email_case_sens.htm" target="_blank" rel="noopener">about.com</a>, “Since the case sensitivity of email addresses can create a lot of confusion, interoperability problems and widespread headaches, it would be foolish to require email addresses to be typed with the correct case.<span class="intersentencespace"></span> Hardly any email service or ISP does enforce case sensitive email addresses, returning messages whose recipient’s email address was not typed correctly (in all upper case, for example).”<span class="intersentencespace"></span> Thanks to reader Riley Moses for pointing this out. <a class="arrow" href="#cha-6_footnote-ref-15">↑</a></li>
    <li id="cha-6_footnote-16">Of course, we could just edit the migration file for the <code>users</code> table in <a href="modeling_users_fragment.html#code-users_migration" class="hyperref">Listing <span class="ref">6.2</span></a>, but that would require rolling back and then migrating back up.<span class="intersentencespace"></span> The Rails Way™ is to use migrations every time we discover that our data model needs to change. <a class="arrow" href="#cha-6_footnote-ref-16">↑</a></li>
    <li id="cha-6_footnote-17">See the <a href="http://api.rubyonrails.org/v5.0.1/classes/ActiveRecord/Callbacks.html" target="_blank" rel="noopener">Rails API entry on callbacks</a> for more information on which callbacks Rails supports. <a class="arrow" href="#cha-6_footnote-ref-17">↑</a></li>
    <li id="cha-6_footnote-18">In this context, <em>virtual</em> means that the attributes exist on the model object but do not correspond to columns in the database. <a class="arrow" href="#cha-6_footnote-ref-18">↑</a></li>
    <li id="cha-6_footnote-19">Hashed password digests are often erroneously referred to as <em>encrypted passwords</em>.<span class="intersentencespace"></span> For example, the <a href="https://github.com/rails/rails/blob/master/activemodel/lib/active_model/secure_password.rb" target="_blank" rel="noopener">source code</a> of <code>has_secure_password</code> makes this mistake, as did the first two editions of this tutorial.<span class="intersentencespace"></span> This terminology is wrong because by design encryption is <em>reversible</em>—the ability to encrypt implies the ability to <em>decrypt</em> as well.<span class="intersentencespace"></span> In contrast, the whole point of calculating a password’s hash digest is to be <em>irreversible</em>, so that it is computationally intractable to infer the original password from the digest.<span class="intersentencespace"></span> (Thanks to reader Andy Philips for pointing out this issue and for encouraging me to fix the broken terminology.) <a class="arrow" href="#cha-6_footnote-ref-19">↑</a></li>
    <li id="cha-6_footnote-20">As always, you should use the version numbers listed at <a href="http://gemfiles-4th-ed.railstutorial.org/" target="_blank" rel="noopener">gemfiles-4th-ed.railstutorial.org</a> instead of the ones listed here. <a class="arrow" href="#cha-6_footnote-ref-20">↑</a></li>
    <li id="cha-6_footnote-21"><p>If for any reason something went wrong, you can always reset the database as follows:</p>
<ol>
<li>Quit the console.<span class="intersentencespace"></span>
</li>
<li>Run <code>$ rm -f development.sqlite3</code> at the command line to remove the database.<span class="intersentencespace"></span> (We’ll learn a more elegant method for doing this in <a href="sign_up_fragment.html#cha-sign_up" class="hyperref">Chapter <span class="ref">7</span></a>.)<span class="intersentencespace"></span>
</li>
<li>Re-run the migrations using <code>$ rails db:migrate</code>.<span class="intersentencespace"></span>
</li>
<li>Restart the console.<span class="intersentencespace"></span>
</li>
</ol>
 <a class="arrow" href="#cha-6_footnote-ref-21">↑</a></li>
    <li id="cha-6_footnote-22">By design, the bcrypt algorithm produces a <a href="https://en.wikipedia.org/wiki/Salt_(cryptography)" target="_blank" rel="noopener"><em>salted hash</em></a>, which protects against two important classes of attacks (<a href="https://en.wikipedia.org/wiki/Dictionary_attack" target="_blank" rel="noopener">dictionary attacks</a> and <a href="https://en.wikipedia.org/wiki/Rainbow_table" target="_blank" rel="noopener">rainbow table attacks</a>). <a class="arrow" href="#cha-6_footnote-ref-22">↑</a></li>
  </ol>
</div>r#      XX =eX  }a,:https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial_4th_edition/html/modeling_users_fragment.html?X-Amz-Expires=604800&X-Amz-Date=20170202T063615Z&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20170202/us-west-2/s3/aws4_request&X-Amz-SignedHeaders=host&X-Amz-Signature=0cb798c3e7b398da31d7410fc179bc6ad71c529ed7ef1932453b5eb9a61048d5 security-info FnhllAKWRHGAlo+ESXykKAAAAAAAAAAAwAAAAAAAAEaphjoj9ApAYLLhYqsrhSapAAQAAgAAAAAAAAAAAAAAACw4N6+LhUposNgK7YiYWzI/H82DxalM0aJQdnbKfH40ZgoyJpFcT/u7IImFpjLfBfjtg2TO2UxuhrpIr1PDk+YAAAAAAAAGGzCCBhcwggT/oAMCAQICEAkMEh1kGcxPzNQuULyfEo0wDQYJKoZIhvcNAQELBQAwZDELMAkGA1UEBhMCVVMxFTATBgNVBAoTDERpZ2lDZXJ0IEluYzEZMBcGA1UECxMQd3d3LmRpZ2ljZXJ0LmNvbTEjMCEGA1UEAxMaRGlnaUNlcnQgQmFsdGltb3JlIENBLTIgRzIwHhcNMTYwNzE4MDAwMDAwWhcNMTcxMDI2MTIwMDAwWjB1MQswCQYDVQQGEwJVUzETMBEGA1UECBMKV2FzaGluZ3RvbjEQMA4GA1UEBxMHU2VhdHRsZTEYMBYGA1UEChMPQW1hem9uLmNvbSBJbmMuMSUwIwYDVQQDDBwqLnMzLXVzLXdlc3QtMi5hbWF6b25hd3MuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtPtaIwJ9+anWiEq/qLdHgQkQ51FdpjU3C/o1HSP3DGHcijP8q6gpOQ2GIT4xaAOOEstz5v5WY8kOfEE0UXsyB8LxmNyu4nPz4gEE1jCKXaFaMQUexl2nz1hNBCzabnDV10EB2+XPOWPw1troTgtKWuBxZ4EaC7dQXkgpqSqzcio33y9sZHlcEa2ok0DMgxTaEY0ryVdODJMlTIVoFwzkiedRV3dl7yRK8EqWMfWnVJzJ2JVMRqakWjQeLE+8oeo4F0m6BEch9qpIA8JV20oFv0cQLM6QQNFzX2EN/2v5uBtrB5g/g39+5Yu+kgkfhedTSkFunjEGol8G7jssC3jijwIDAQABo4ICsjCCAq4wHwYDVR0jBBgwFoAUwBKyKHRoRmfpcCV0GgBFWwZ9XEQwHQYDVR0OBBYEFF1JaGNuDmFfuVhgXPTd3tg4yz2iMIHhBgNVHREEgdkwgdaCGnMzLXVzLXdlc3QtMi5hbWF6b25hd3MuY29tghwqLnMzLXVzLXdlc3QtMi5hbWF6b25hd3MuY29tghpzMy51cy13ZXN0LTIuYW1hem9uYXdzLmNvbYIcKi5zMy51cy13ZXN0LTIuYW1hem9uYXdzLmNvbYIkczMuZHVhbHN0YWNrLnVzLXdlc3QtMi5hbWF6b25hd3MuY29tgiYqLnMzLmR1YWxzdGFjay51cy13ZXN0LTIuYW1hem9uYXdzLmNvbYISKi5zMy5hbWF6b25hd3MuY29tMA4GA1UdDwEB/wQEAwIFoDAdBgNVHSUEFjAUBggrBgEFBQcDAQYIKwYBBQUHAwIwgYEGA1UdHwR6MHgwOqA4oDaGNGh0dHA6Ly9jcmwzLmRpZ2ljZXJ0LmNvbS9EaWdpQ2VydEJhbHRpbW9yZUNBLTJHMi5jcmwwOqA4oDaGNGh0dHA6Ly9jcmw0LmRpZ2ljZXJ0LmNvbS9EaWdpQ2VydEJhbHRpbW9yZUNBLTJHMi5jcmwwTAYDVR0gBEUwQzA3BglghkgBhv1sAQEwKjAoBggrBgEFBQcCARYcaHR0cHM6Ly93d3cuZGlnaWNlcnQuY29tL0NQUzAIBgZngQwBAgIweQYIKwYBBQUHAQEEbTBrMCQGCCsGAQUFBzABhhhodHRwOi8vb2NzcC5kaWdpY2VydC5jb20wQwYIKwYBBQUHMAKGN2h0dHA6Ly9jYWNlcnRzLmRpZ2ljZXJ0LmNvbS9EaWdpQ2VydEJhbHRpbW9yZUNBLTJHMi5jcnQwDAYDVR0TAQH/BAIwADANBgkqhkiG9w0BAQsFAAOCAQEAYH38ntfWdhwWcuD895IsKMmdlnbReTnnEKe6n6tldoxpWEJkjMA0hURZnZrbr5FL3ar6bWF9wnFKMYPxMfjhNzpB8/lbp63yZSDmVpDIsOIRWjkdcMsnpBHDHQWPV9T7fIgxT4WqAK92O3kQs1+bmsuXISBelIMev1G02BYa7EDD8JZyoltleTcs8rzvRRgE37GfxAtu07fxQqyDSvj7ojpSoIUmTVDVJMTGCkSemYpdR3DqTzmsej6eV7TbLdvFTjFnRJ4Zdehb17CoVvkOTB1v/oXaabIIi3UEsDu3UpxdB7mU4G1qgy8XDMitAtpBL6+EIw0QKw5+JoSuzbybEgAAAIAAAACAAAAAJVRMU19FQ0RIRV9SU0FfV0lUSF9BRVNfMTI4X0dDTV9TSEEyNTYAAAABAAA= request-method GET request-Origin https://www.railstutorial.org response-head HTTP/1.1 200 OK
x-amz-id-2: 1hi9HehYii94hUIBUYzPN3vvMmdThN7WqTTHOYf6LEYmHfGK0MTBQwQiN2hwtbC0HJCTLgrutyQ=
x-amz-request-id: 39B68349B870FE86
Date: Thu, 02 Feb 2017 08:38:54 GMT
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: GET
Access-Control-Max-Age: 3000
Vary: Origin, Access-Control-Request-Headers, Access-Control-Request-Method
Last-Modified: Fri, 13 Jan 2017 02:58:31 GMT
Etag: "e47a21850a76631968fff6e89308c0b9"
Accept-Ranges: bytes
Content-Type: text/html
Content-Length: 211517
Server: AmazonS3
 uncompressed-len 0  :=