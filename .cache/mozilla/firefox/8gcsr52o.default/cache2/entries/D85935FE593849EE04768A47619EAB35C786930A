<div id="cha-updating_showing_and_deleting_users" data-tralics-id="cid54" class="chapter" data-number="10" data-chapter="updating_and_deleting_users"><h1><a href="updating_and_deleting_users_fragment.html#cha-updating_showing_and_deleting_users" class="heading hyperref"><span class="number">Chapter 10 </span>Updating, showing, and deleting users</a></h1>
<p>In this chapter, we will complete the REST actions for the Users resource (<a href="sign_up_fragment.html#table-RESTful_users" class="hyperref">Table <span class="ref">7.1</span></a>) by adding <code>edit</code>, <code>update</code>, <code>index</code>, and <code>destroy</code> actions.<span class="intersentencespace"></span> We’ll start by giving users the ability to update their profiles, which will also provide a natural opportunity to enforce an authorization model (made possible by the authentication code in <a href="basic_login_fragment.html#cha-basic_login" class="hyperref">Chapter <span class="ref">8</span></a>).<span class="intersentencespace"></span> Then we’ll make a listing of all users (also requiring authentication), which will motivate the introduction of sample data and pagination.<span class="intersentencespace"></span> Finally, we’ll add the ability to destroy users, wiping them clear from the database.<span class="intersentencespace"></span> Since we can’t allow just any user to have such dangerous powers, we’ll take care to create a privileged class of administrative users authorized to delete other users.</p>
</div><div id="sec-updating_users" data-tralics-id="cid55" class="section" data-number="10.1"><h2><a href="updating_and_deleting_users_fragment.html#sec-updating_users" class="heading hyperref"><span class="number">10.1 </span>Updating users</a></h2>
<p>The pattern for editing user information closely parallels that for creating new users (<a href="sign_up_fragment.html#cha-sign_up" class="hyperref">Chapter <span class="ref">7</span></a>).<span class="intersentencespace"></span> Instead of a <code>new</code> action rendering a view for new users, we have an <code>edit</code> action rendering a view to edit users; instead of <code>create</code> responding to a <code class="tt">POST</code> request, we have an <code>update</code> action responding to a <code class="tt">PATCH</code> request (<a href="static_pages_fragment.html#aside-get_etc" class="hyperref">Box <span class="ref">3.2</span></a>).<span class="intersentencespace"></span> The biggest difference is that, while anyone can sign up, only the current user should be able to update their information.<span class="intersentencespace"></span> The authentication machinery from <a href="basic_login_fragment.html#cha-basic_login" class="hyperref">Chapter <span class="ref">8</span></a> will allow us to use a <em>before filter</em> to ensure that this is the case.</p>
<p>To get started, let’s start work on an <code>updating-users</code> topic branch:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b updating-users
</pre></div></div>
<div id="sec-edit_form" data-tralics-id="uid1182" class="subsection" data-number="10.1.1"><h3><a href="updating_and_deleting_users_fragment.html#sec-edit_form" class="heading hyperref"><span class="number">10.1.1 </span>Edit form</a></h3>
<p>We start with the edit form, whose mockup appears in <a href="updating_and_deleting_users_fragment.html#fig-edit_user_mockup" class="hyperref">Figure <span class="ref">10.1</span></a>.<sup id="cha-10_footnote-ref-1" class="footnote"><a href="#cha-10_footnote-1">1</a></sup><span class="intersentencespace"></span> To turn the mockup in <a href="updating_and_deleting_users_fragment.html#fig-edit_user_mockup" class="hyperref">Figure <span class="ref">10.1</span></a> into a working page, we need to fill in both the Users controller <code>edit</code> action and the user edit view.<span class="intersentencespace"></span> We start with the <code>edit</code> action, which requires pulling the relevant user out of the database.<span class="intersentencespace"></span> Note from <a href="sign_up_fragment.html#table-RESTful_users" class="hyperref">Table <span class="ref">7.1</span></a> that the proper URL for a user’s edit page is /users/1/edit (assuming the user’s id is <code class="tt">1</code>).<span class="intersentencespace"></span> Recall that the id of the user is available in the <code>params[:id]</code> variable, which means that we can find the user with the code in <a href="updating_and_deleting_users_fragment.html#code-initial_edit_action" class="hyperref">Listing <span class="ref">10.1</span></a>.</p>
<div class="center figure" id="fig-edit_user_mockup" data-tralics-id="uid1184" data-number="10.1">
<div class="graphics image box"><img src="images/figures/edit_user_mockup_bootstrap.png" alt="images/figures/edit_user_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 10.1: </span><span class="description">A mockup of the user edit page.
</span></div></div>
<div class="codelisting" id="code-initial_edit_action" data-tralics-id="uid1185" data-number="10.1"><div class="heading"><span class="number">Listing 10.1:</span> 

<span class="description">The user <code>edit</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">log_in</span> <span class="vi">@user</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Welcome to the Sample App!"</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">edit</span>
<span class="hll">    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The corresponding user edit view (which you will have to create by hand) is shown in <a href="updating_and_deleting_users_fragment.html#code-user_edit_view" class="hyperref">Listing <span class="ref">10.2</span></a>.<span class="intersentencespace"></span> Note how closely this resembles the new user view from <a href="sign_up_fragment.html#code-signup_form" class="hyperref">Listing <span class="ref">7.15</span></a>; the large overlap suggests factoring the repeated code into a partial, which is left as an exercise (<a href="updating_and_deleting_users_fragment.html#sec-exercises_edit_form" class="hyperref">Section <span class="ref">10.1.1.1</span></a>).</p>
<div class="codelisting" id="code-user_edit_view" data-tralics-id="uid1186" data-number="10.2"><div class="heading"><span class="number">Listing 10.2:</span> 

<span class="description">The user edit view.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/edit.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">"Edit user"</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Update your profile<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6 col-md-offset-3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">email_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">"Confirmation"</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Save changes"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"gravatar_edit"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://gravatar.com/emails"</span> <span class="na">target=</span><span class="s">"_blank"</span><span class="nt">&gt;</span>change<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div><p>Here we have reused the shared <code>error_messages</code> partial introduced in <a href="sign_up_fragment.html#sec-signup_error_messages" class="hyperref">Section <span class="ref">7.3.3</span></a>.<span class="intersentencespace"></span> By the way, the use of <code>target="_blank"</code> in the Gravatar link is a neat trick to get the browser to open the page in a new window or tab, which is sometimes convenient behavior when linking to third-party sites.<span class="intersentencespace"></span> (There’s a minor security issue associated with <code>target="_blank"</code>; dealing with this detail is left as an exercise (<a href="updating_and_deleting_users_fragment.html#sec-exercises_edit_form" class="hyperref">Section <span class="ref">10.1.1.1</span></a>).)</p>
<p>With the <code>@user</code> instance variable from <a href="updating_and_deleting_users_fragment.html#code-initial_edit_action" class="hyperref">Listing <span class="ref">10.1</span></a>, the edit page should render properly, as shown in <a href="updating_and_deleting_users_fragment.html#fig-edit_page" class="hyperref">Figure <span class="ref">10.2</span></a>.<span class="intersentencespace"></span> The “Name” and “Email” fields in <a href="updating_and_deleting_users_fragment.html#fig-edit_page" class="hyperref">Figure <span class="ref">10.2</span></a> also shows how Rails automatically pre-fills the Name and Email fields using the attributes of the existing <code>@user</code> variable.</p>
<div class="center figure" id="fig-edit_page" data-tralics-id="uid1187" data-number="10.2">
<div class="graphics image"><img src="images/figures/edit_page_3rd_edition.png" alt="images/figures/edit_page_3rd_edition"></div><div class="caption"><span class="header">Figure 10.2: </span><span class="description">The initial user edit page with pre-filled name and email.
</span></div></div>
<p>Looking at the HTML source for <a href="updating_and_deleting_users_fragment.html#fig-edit_page" class="hyperref">Figure <span class="ref">10.2</span></a>, we see a form tag as expected, as in <a href="updating_and_deleting_users_fragment.html#code-edit_form_html" class="hyperref">Listing <span class="ref">10.3</span></a> (slight details may differ).</p>
<div class="codelisting" id="code-edit_form_html" data-tralics-id="uid1188" data-number="10.3"><div class="heading"><span class="number">Listing 10.3:</span> 

<span class="description">HTML for the edit form defined in <a href="updating_and_deleting_users_fragment.html#code-user_edit_view" class="hyperref">Listing <span class="ref">10.2</span></a> and shown in <a href="updating_and_deleting_users_fragment.html#fig-edit_page" class="hyperref">Figure <span class="ref">10.2</span></a>.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">accept-charset=</span><span class="s">"UTF-8"</span> <span class="na">action=</span><span class="s">"/users/1"</span> <span class="na">class=</span><span class="s">"edit_user"</span>
      <span class="na">id=</span><span class="s">"edit_user_1"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"_method"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"patch"</span> <span class="nt">/&gt;</span>
  .
  .
  .
<span class="nt">&lt;/form&gt;</span>
</pre></div></div></div><p>Note here the hidden input field:</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"_method"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"patch"</span> <span class="nt">/&gt;</span>
</pre></div></div>
<p>Since web browsers can’t natively send <code class="tt">PATCH</code> requests (as required by the REST conventions from <a href="sign_up_fragment.html#table-RESTful_users" class="hyperref">Table <span class="ref">7.1</span></a>), Rails fakes it with a <code class="tt">POST</code> request and a hidden <code>input</code> field.<sup id="cha-10_footnote-ref-2" class="footnote"><a href="#cha-10_footnote-2">2</a></sup></p>
<p>There’s another subtlety to address here: the code <code>form_for(@user)</code> in <a href="updating_and_deleting_users_fragment.html#code-user_edit_view" class="hyperref">Listing <span class="ref">10.2</span></a> is <em>exactly</em> the same as the code in <a href="sign_up_fragment.html#code-signup_form" class="hyperref">Listing <span class="ref">7.15</span></a>—so how does Rails know to use a <code class="tt">POST</code> request for new users and a <code class="tt">PATCH</code> for editing users?<span class="intersentencespace"></span> The answer is that it is possible to tell whether a user is new or already exists in the database via Active Record’s <code>new_record?</code> boolean method:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">new_record?</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">new_record?</span>
<span class="go">=&gt; false</span>
</pre></div></div>
<p>When constructing a form using <code>form_for(@user)</code>, Rails uses <code class="tt">POST</code> if <code>@user.new_record?</code> is <code>true</code> and <code class="tt">PATCH</code> if it is <code>false</code>.</p>
<p>As a final touch, we’ll fill in the URL of the settings link in the site navigation.<span class="intersentencespace"></span> This is easy using the named route <code>edit_user_path</code> from <a href="sign_up_fragment.html#table-RESTful_users" class="hyperref">Table <span class="ref">7.1</span></a>, together with the handy <code>current_user</code> helper method defined in <a href="advanced_login_fragment.html#code-persistent_current_user" class="hyperref">Listing <span class="ref">9.9</span></a>:</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Settings"</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>The full application code appears in <a href="updating_and_deleting_users_fragment.html#code-settings_link" class="hyperref">Listing <span class="ref">10.4</span></a>).</p>
<div class="codelisting" id="code-settings_link" data-tralics-id="uid1190" data-number="10.4"><div class="heading"><span class="number">Listing 10.4:</span> 

<span class="description">Adding a URL to the “Settings” link in the site layout.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/layouts/_header.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"navbar navbar-fixed-top navbar-inverse"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"sample app"</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">"logo"</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;nav&gt;</span>
      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav navbar-right"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Home"</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Help"</span><span class="p">,</span> <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">logged_in?</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Users"</span><span class="p">,</span> <span class="s1">'#'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">class=</span><span class="s">"dropdown-toggle"</span> <span class="na">data-toggle=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
              Account <span class="nt">&lt;b</span> <span class="na">class=</span><span class="s">"caret"</span><span class="nt">&gt;&lt;/b&gt;</span>
            <span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"dropdown-menu"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Profile"</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
<span class="hll">              <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Settings"</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
</span>              <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"divider"</span><span class="nt">&gt;&lt;/li&gt;</span>
              <span class="nt">&lt;li&gt;</span>
                <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log out"</span><span class="p">,</span> <span class="n">logout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">"delete"</span> <span class="cp">%&gt;</span>
              <span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;/ul&gt;</span>
          <span class="nt">&lt;/li&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log in"</span><span class="p">,</span> <span class="n">login_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;/nav&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div></div></div>
<div id="sec-exercises_edit_form" data-tralics-id="uid1191" class="subsubsection" data-number="10.1.1.1"><h4><a href="#sec-exercises_edit_form" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>As noted above, there’s a minor security issue associated with using <code>target="_blank"</code> to open URLs, which is that the target site gains control of what’s known as the “<code>window</code> object” associated with the HTML document.<span class="intersentencespace"></span> The result is that the target site could potentially introduce malicious content, such as a <a href="https://en.wikipedia.org/wiki/Phishing" target="_blank" rel="noopener">phishing</a> page.<span class="intersentencespace"></span> This is extremely unlikely to happen when linking to a reputable site like Gravatar, but <a href="http://lmgtfy.com/?q=target+_blank+security" target="_blank" rel="noopener">it turns out</a> that we can eliminate the risk entirely by setting the <code>rel</code> attribute (“relationship”) to <code>"noopener"</code> in the origin link.<span class="intersentencespace"></span> Add this attribute to the Gravatar edit link in <a href="updating_and_deleting_users_fragment.html#code-user_edit_view" class="hyperref">Listing <span class="ref">10.2</span></a>. <span class="exercise" id="ex-33137d"></span>
</li>
<li>Remove the duplicated form code by refactoring the <code>new.html.erb</code> and <code>edit.html.erb</code> views to use the partial in <a href="updating_and_deleting_users_fragment.html#code-new_edit_partial" class="hyperref">Listing <span class="ref">10.5</span></a>, as shown in <a href="updating_and_deleting_users_fragment.html#code-new_user_with_partial" class="hyperref">Listing <span class="ref">10.6</span></a> and <a href="updating_and_deleting_users_fragment.html#code-edit_user_with_partial" class="hyperref">Listing <span class="ref">10.7</span></a>.<span class="intersentencespace"></span> Note the use of the <code>provide</code> method, which we used before in <a href="static_pages_fragment.html#sec-layouts_and_embedded_ruby" class="hyperref">Section <span class="ref">3.4.3</span></a> to eliminate duplication in the layout.<sup id="cha-10_footnote-ref-3" class="footnote"><a href="#cha-10_footnote-3">3</a></sup><span class="intersentencespace"></span> (If you solved the exercise corresponding to <a href="sign_up_fragment.html#code-post_signup_form" class="hyperref">Listing <span class="ref">7.27</span></a>, this exercise won’t work exactly as written, and you’ll have to apply your technical sophistication to resolve the discrepancy.<span class="intersentencespace"></span> My suggestion is to use the variable-passing technique shown in <a href="updating_and_deleting_users_fragment.html#code-new_edit_partial" class="hyperref">Listing <span class="ref">10.5</span></a> to pass the needed URL from <a href="updating_and_deleting_users_fragment.html#code-new_user_with_partial" class="hyperref">Listing <span class="ref">10.6</span></a> and <a href="updating_and_deleting_users_fragment.html#code-edit_user_with_partial" class="hyperref">Listing <span class="ref">10.7</span></a> to the form in <a href="updating_and_deleting_users_fragment.html#code-new_edit_partial" class="hyperref">Listing <span class="ref">10.5</span></a>.) <span class="exercise" id="ex-3ebe17"></span>
</li></ol>
<div class="codelisting" id="code-new_edit_partial" data-tralics-id="uid1195" data-number="10.5"><div class="heading"><span class="number">Listing 10.5:</span> 

<span class="description">A partial for the <code>new</code> and <code>edit</code> form.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/_form.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">object</span><span class="p">:</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">email_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">'form-control'</span> <span class="cp">%&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:button_text</span><span class="p">),</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div></div><div class="codelisting" id="code-new_user_with_partial" data-tralics-id="uid1196" data-number="10.6"><div class="heading"><span class="number">Listing 10.6:</span> 

<span class="description">The signup view with partial.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/new.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Sign up'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:button_text</span><span class="p">,</span> <span class="s1">'Create my account'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6 col-md-offset-3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'form'</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div><div class="codelisting" id="code-edit_user_with_partial" data-tralics-id="uid1197" data-number="10.7"><div class="heading"><span class="number">Listing 10.7:</span> 

<span class="description">The edit view with partial.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/edit.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'Edit user'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:button_text</span><span class="p">,</span> <span class="s1">'Save changes'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Update your profile<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6 col-md-offset-3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'form'</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"gravatar_edit"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://gravatar.com/emails"</span> <span class="na">target=</span><span class="s">"_blank"</span><span class="nt">&gt;</span>Change<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div></div></div>
<div id="sec-unsuccessful_edits" data-tralics-id="uid1198" class="subsection" data-number="10.1.2"><h3><a href="updating_and_deleting_users_fragment.html#sec-unsuccessful_edits" class="heading hyperref"><span class="number">10.1.2 </span>Unsuccessful edits</a></h3>
<p>In this section we’ll handle unsuccessful edits, following similar ideas to unsuccessful signups (<a href="sign_up_fragment.html#sec-unsuccessful_signups" class="hyperref">Section <span class="ref">7.3</span></a>).<span class="intersentencespace"></span> We start by creating an <code>update</code> action, which uses <code>update_attributes</code> (<a href="modeling_users_fragment.html#sec-updating_user_objects" class="hyperref">Section <span class="ref">6.1.5</span></a>) to update the user based on the submitted <code>params</code> hash, as shown in <a href="updating_and_deleting_users_fragment.html#code-user_update_action_unsuccessful" class="hyperref">Listing <span class="ref">10.8</span></a>.<span class="intersentencespace"></span> With invalid information, the update attempt returns <code>false</code>, so the <code>else</code> branch renders the edit page.<span class="intersentencespace"></span> We’ve seen this pattern before; the structure closely parallels the first version of the <code>create</code> action (<a href="sign_up_fragment.html#code-first_create_action" class="hyperref">Listing <span class="ref">7.18</span></a>).</p>
<div class="codelisting" id="code-user_update_action_unsuccessful" data-tralics-id="uid1199" data-number="10.8"><div class="heading"><span class="number">Listing 10.8:</span> 

<span class="description">The initial user <code>update</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
<span class="hll">    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
</span>      <span class="n">log_in</span> <span class="vi">@user</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Welcome to the Sample App!"</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
<span class="hll">      <span class="n">render</span> <span class="s1">'new'</span>
</span>    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">edit</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="hll">    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
</span>      <span class="c1"># Handle a successful update.</span>
    <span class="k">else</span>
<span class="hll">      <span class="n">render</span> <span class="s1">'edit'</span>
</span>    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note the use of <code>user_params</code> in the call to <code>update_attributes</code>, which uses strong parameters to prevent mass assignment vulnerability (as described in <a href="sign_up_fragment.html#sec-strong_parameters" class="hyperref">Section <span class="ref">7.3.2</span></a>).</p>
<p>Because of the existing User model validations and the error-messages partial in <a href="updating_and_deleting_users_fragment.html#code-user_edit_view" class="hyperref">Listing <span class="ref">10.2</span></a>, submission of invalid information results in helpful error messages (<a href="updating_and_deleting_users_fragment.html#fig-buggy_edit_with_invalid_information" class="hyperref">Figure <span class="ref">10.3</span></a>).</p>
<div class="center figure" id="fig-buggy_edit_with_invalid_information" data-tralics-id="uid1200" data-number="10.3">
<div class="graphics image"><img src="images/figures/edit_with_invalid_information_3rd_edition.png" alt="images/figures/edit_with_invalid_information_3rd_edition"></div><div class="caption"><span class="header">Figure 10.3: </span><span class="description">Error messages from submitting the update form.
</span></div></div>
<div id="sec-exercises_unssuccessful_edits" data-tralics-id="uid1201" class="subsubsection" data-number="10.1.2.1"><h4><a href="#sec-exercises_unssuccessful_edits" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Confirm by submitting various invalid combinations of username, email, and password that the edit form won’t accept invalid submissions. <span class="exercise" id="ex-1e592f"></span>
</li></ol>
</div></div>
<div id="sec-testing_unsuccessful_edits" data-tralics-id="uid1203" class="subsection" data-number="10.1.3"><h3><a href="updating_and_deleting_users_fragment.html#sec-testing_unsuccessful_edits" class="heading hyperref"><span class="number">10.1.3 </span>Testing unsuccessful edits</a></h3>
<p>We left <a href="updating_and_deleting_users_fragment.html#sec-unsuccessful_edits" class="hyperref">Section <span class="ref">10.1.2</span></a> with a working edit form.<span class="intersentencespace"></span> Following the testing guidelines from <a href="static_pages_fragment.html#aside-when_to_test" class="hyperref">Box <span class="ref">3.3</span></a>, we’ll now write an integration test to catch any regressions.<span class="intersentencespace"></span> Our first step is to generate an integration test as usual:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate integration_test users_edit
<span class="go">      invoke  test_unit</span>
<span class="go">      create    test/integration/users_edit_test.rb</span>
</pre></div></div>
<p>Then we’ll write a simple test of an unsuccessful edit, as shown in <a href="updating_and_deleting_users_fragment.html#code-unsuccessful_edit_test" class="hyperref">Listing <span class="ref">10.9</span></a>.<span class="intersentencespace"></span> The test in <a href="updating_and_deleting_users_fragment.html#code-unsuccessful_edit_test" class="hyperref">Listing <span class="ref">10.9</span></a> checks for the correct behavior by verifying that the edit template is rendered after getting the edit page and re-rendered upon submission of invalid information.<span class="intersentencespace"></span> Note the use of the <code>patch</code> method to issue a <code class="tt">PATCH</code> request, which follows the same pattern as <code>get</code>, <code>post</code>, and <code>delete</code>.</p>
<div class="codelisting" id="code-unsuccessful_edit_test" data-tralics-id="uid1204" data-number="10.9"><div class="heading"><span class="number">Listing 10.9:</span> 

<span class="description">A test for an unsuccessful edit.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_edit_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersEditTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"unsuccessful edit"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">assert_template</span> <span class="s1">'users/edit'</span>
    <span class="n">patch</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">params</span><span class="p">:</span> <span class="p">{</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span>  <span class="s2">""</span><span class="p">,</span>
                                              <span class="ss">email</span><span class="p">:</span> <span class="s2">"foo@invalid"</span><span class="p">,</span>
                                              <span class="ss">password</span><span class="p">:</span>              <span class="s2">"foo"</span><span class="p">,</span>
                                              <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"bar"</span> <span class="p">}</span> <span class="p">}</span>

    <span class="n">assert_template</span> <span class="s1">'users/edit'</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>At this point, the test suite should still be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid1205" data-tralics-id="uid1205" data-number="10.10"><div class="heading"><span class="number">Listing 10.10:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div>
<div id="sec-exercises_testing_unsuccessful_edits" data-tralics-id="uid1206" class="subsubsection" data-number="10.1.3.1"><h4><a href="#sec-exercises_testing_unsuccessful_edits" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Add a line in <a href="updating_and_deleting_users_fragment.html#code-unsuccessful_edit_test" class="hyperref">Listing <span class="ref">10.9</span></a> to test for the correct <em>number</em> of error messages.<span class="intersentencespace"></span> <em>Hint</em>: Use an <code>assert_select</code> (<a href="filling_in_the_layout_fragment.html#table-assert_select" class="hyperref">Table <span class="ref">5.2</span></a>) that tests for a <code>div</code> with class <code>alert</code> containing the text “The form contains 4 errors.” <span class="exercise" id="ex-faa5fa"></span>
</li></ol>
</div></div>
<div id="sec-successful_edits" data-tralics-id="uid1208" class="subsection" data-number="10.1.4"><h3><a href="updating_and_deleting_users_fragment.html#sec-successful_edits" class="heading hyperref"><span class="number">10.1.4 </span>Successful edits (with TDD)</a></h3>
<p>Now it’s time to get the edit form to work.<span class="intersentencespace"></span> Editing the profile images is already functional since we’ve outsourced image upload to the Gravatar website; we can edit Gravatars by clicking on the “change” link from <a href="updating_and_deleting_users_fragment.html#fig-edit_page" class="hyperref">Figure <span class="ref">10.2</span></a>, as shown in <a href="updating_and_deleting_users_fragment.html#fig-gravatar_cropper" class="hyperref">Figure <span class="ref">10.4</span></a>.<span class="intersentencespace"></span> Let’s get the rest of the user edit functionality working as well.</p>
<div class="center figure" id="fig-gravatar_cropper" data-tralics-id="uid1209" data-number="10.4">
<div class="graphics image"><img src="images/figures/gravatar_cropper_new.png" alt="images/figures/gravatar_cropper_new"></div><div class="caption"><span class="header">Figure 10.4: </span><span class="description">The <a href="http://gravatar.com/" target="_blank" rel="noopener">Gravatar</a> image-cropping interface, with a picture of <a href="http://www.michaelhartl.com/" target="_blank" rel="noopener">some dude</a>.
</span></div></div>
<p>As you get more comfortable with testing, you might find that it’s useful to write integration tests before writing the application code instead of after.<span class="intersentencespace"></span> In this context, such tests are sometimes known as <em>acceptance tests</em>, since they determine when a particular feature should be accepted as complete.<span class="intersentencespace"></span> To see how this works, we’ll complete the user edit feature using test-driven development.</p>
<p>We’ll test for the correct behavior of updating users by writing a test similar to the one shown in <a href="updating_and_deleting_users_fragment.html#code-unsuccessful_edit_test" class="hyperref">Listing <span class="ref">10.9</span></a>, only this time we’ll submit valid information.<span class="intersentencespace"></span> Then we’ll check for a nonempty flash message and a successful redirect to the profile page, while also verifying that the user’s information correctly changed in the database.<span class="intersentencespace"></span> The result appears in <a href="updating_and_deleting_users_fragment.html#code-successful_edit_test" class="hyperref">Listing <span class="ref">10.11</span></a>.<span class="intersentencespace"></span> Note that the password and confirmation in <a href="updating_and_deleting_users_fragment.html#code-successful_edit_test" class="hyperref">Listing <span class="ref">10.11</span></a> are blank, which is convenient for users who don’t want to update their passwords every time they update their names or email addresses.<span class="intersentencespace"></span> Note also the use of <code>@user.reload</code> (first seen in <a href="modeling_users_fragment.html#sec-updating_user_objects" class="hyperref">Section <span class="ref">6.1.5</span></a>) to reload the user’s values from the database and confirm that they were successfully updated.<span class="intersentencespace"></span> (This is the kind of detail you could easily forget initially, which is why acceptance testing (and TDD generally) require a certain level of experience to be effective.)</p>
<div class="codelisting" id="code-successful_edit_test" data-tralics-id="uid1210" data-number="10.11"><div class="heading"><span class="number">Listing 10.11:</span> 

<span class="description">A test of a successful edit.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_edit_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersEditTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"successful edit"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">assert_template</span> <span class="s1">'users/edit'</span>
    <span class="nb">name</span>  <span class="o">=</span> <span class="s2">"Foo Bar"</span>
    <span class="n">email</span> <span class="o">=</span> <span class="s2">"foo@bar.com"</span>
    <span class="n">patch</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">params</span><span class="p">:</span> <span class="p">{</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span>  <span class="nb">name</span><span class="p">,</span>
                                              <span class="ss">email</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
                                              <span class="ss">password</span><span class="p">:</span>              <span class="s2">""</span><span class="p">,</span>
                                              <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">""</span> <span class="p">}</span> <span class="p">}</span>
    <span class="n">assert_not</span> <span class="n">flash</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">assert_redirected_to</span> <span class="vi">@user</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">reload</span>
    <span class="n">assert_equal</span> <span class="nb">name</span><span class="p">,</span>  <span class="vi">@user</span><span class="o">.</span><span class="n">name</span>
    <span class="n">assert_equal</span> <span class="n">email</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The <code>update</code> action needed to get the tests in <a href="updating_and_deleting_users_fragment.html#code-successful_edit_test" class="hyperref">Listing <span class="ref">10.11</span></a> to pass is similar to the final form of the <code>create</code> action (<a href="basic_login_fragment.html#code-login_upon_signup" class="hyperref">Listing <span class="ref">8.25</span></a>), as seen in <a href="updating_and_deleting_users_fragment.html#code-user_update_action" class="hyperref">Listing <span class="ref">10.12</span></a>.</p>
<div class="codelisting" id="code-user_update_action" data-tralics-id="uid1211" data-number="10.12"><div class="heading"><span class="number">Listing 10.12:</span> 

<span class="description">The user <code>update</code> action.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">update</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
<span class="hll">      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Profile updated"</span>
</span><span class="hll">      <span class="n">redirect_to</span> <span class="vi">@user</span>
</span>    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'edit'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>As indicated in the caption to <a href="updating_and_deleting_users_fragment.html#code-user_update_action" class="hyperref">Listing <span class="ref">10.12</span></a>, the test suite is still <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>, which is the result of the password length validation (<a href="modeling_users_fragment.html#code-password_implementation" class="hyperref">Listing <span class="ref">6.42</span></a>) failing due to the empty password and confirmation in <a href="updating_and_deleting_users_fragment.html#code-successful_edit_test" class="hyperref">Listing <span class="ref">10.11</span></a>.<span class="intersentencespace"></span> To get the tests to <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>, we need to make an exception to the password validation if the password is empty.<span class="intersentencespace"></span> We can do this by passing the <code>allow_nil: true</code> option to <code>validates</code>, as seen in <a href="updating_and_deleting_users_fragment.html#code-allow_blank_password" class="hyperref">Listing <span class="ref">10.13</span></a>.</p>
<div class="codelisting" id="code-allow_blank_password" data-tralics-id="uid1212" data-number="10.13"><div class="heading"><span class="number">Listing 10.13:</span> 

<span class="description">Allowing empty passwords on update.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">attr_accessor</span> <span class="ss">:remember_token</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">maximum</span><span class="p">:</span> <span class="mi">255</span> <span class="p">},</span>
                    <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with</span><span class="p">:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness</span><span class="p">:</span> <span class="p">{</span> <span class="ss">case_sensitive</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
  <span class="n">has_secure_password</span>
<span class="hll">  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="p">{</span> <span class="ss">minimum</span><span class="p">:</span> <span class="mi">6</span> <span class="p">},</span> <span class="ss">allow_nil</span><span class="p">:</span> <span class="kp">true</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>In case you’re worried that <a href="updating_and_deleting_users_fragment.html#code-allow_blank_password" class="hyperref">Listing <span class="ref">10.13</span></a> might allow new users to sign up with empty passwords, recall from <a href="modeling_users_fragment.html#sec-minimum_password_standards" class="hyperref">Section <span class="ref">6.3.3</span></a> that <code>has_secure_password</code> includes a separate presence validation that specifically catches <code>nil</code> passwords.<span class="intersentencespace"></span> (Because <code>nil</code> passwords now bypass the main presence validation but are still caught by <code>has_secure_password</code>, this also fixes the duplicate error message mentioned in <a href="sign_up_fragment.html#sec-signup_error_messages" class="hyperref">Section <span class="ref">7.3.3</span></a>.)</p>
<p>With the code in this section, the user edit page should be working (<a href="updating_and_deleting_users_fragment.html#fig-edit_form_working" class="hyperref">Figure <span class="ref">10.5</span></a>), as you can double-check by re-running the test suite, which should now be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid1213" data-tralics-id="uid1213" data-number="10.14"><div class="heading"><span class="number">Listing 10.14:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div><div class="center figure" id="fig-edit_form_working" data-tralics-id="uid1214" data-number="10.5">
<div class="graphics image"><img src="images/figures/edit_form_working_new.png" alt="images/figures/edit_form_working_new"></div><div class="caption"><span class="header">Figure 10.5: </span><span class="description">The result of a successful edit.
</span></div></div>
<div id="sec-exercises_enabling_edits" data-tralics-id="uid1215" class="subsubsection" data-number="10.1.4.1"><h4><a href="#sec-exercises_enabling_edits" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Double-check that you can now make edits by making a few changes on the development version of the application. <span class="exercise" id="ex-b12fb2"></span>
</li>
<li>What happens when you change the email address to one without an associated Gravatar? <span class="exercise" id="ex-05aa0f"></span>
</li></ol>
</div></div></div><div id="sec-authorization" data-tralics-id="cid56" class="section" data-number="10.2"><h2><a href="updating_and_deleting_users_fragment.html#sec-authorization" class="heading hyperref"><span class="number">10.2 </span>Authorization</a></h2>
<p>In the context of web applications, <em>authentication</em> allows us to identify users of our site, while <em>authorization</em> lets us control what they can do.<span class="intersentencespace"></span> One nice effect of building the authentication machinery in <a href="basic_login_fragment.html#cha-basic_login" class="hyperref">Chapter <span class="ref">8</span></a> is that we are now in a position to implement authorization as well.</p>
<p>Although the edit and update actions from <a href="updating_and_deleting_users_fragment.html#sec-updating_users" class="hyperref">Section <span class="ref">10.1</span></a> are functionally complete, they suffer from a ridiculous security flaw: they allow anyone (even non-logged-in users) to access either action, and any logged-in user can update the information for any other user.<span class="intersentencespace"></span> In this section, we’ll implement a security model that requires users to be logged in and prevents them from updating any information other than their own.</p>
<p>In <a href="updating_and_deleting_users_fragment.html#sec-requiring_logged_in_users" class="hyperref">Section <span class="ref">10.2.1</span></a>, we’ll handle the case of
non-logged-in users who try to access a protected page to which they might normally have access.<span class="intersentencespace"></span> Because this could easily happen in the normal course of using the application, such users will be forwarded to the login page with a helpful message, as mocked up in <a href="updating_and_deleting_users_fragment.html#fig-login_page_protected_mockup" class="hyperref">Figure <span class="ref">10.6</span></a>.<span class="intersentencespace"></span> On the other hand, users who try to access a page for which they would never be authorized (such as a logged-in user trying to access a different user’s edit page) will be redirected to the root URL (<a href="updating_and_deleting_users_fragment.html#sec-requiring_the_right_user" class="hyperref">Section <span class="ref">10.2.2</span></a>).</p>
<div class="center figure" id="fig-login_page_protected_mockup" data-tralics-id="uid1218" data-number="10.6">
<div class="graphics image box"><img src="images/figures/login_page_protected_mockup.png" alt="images/figures/login_page_protected_mockup"></div><div class="caption"><span class="header">Figure 10.6: </span><span class="description">A mockup of the result of visiting a protected page
</span></div></div>
<div id="sec-requiring_logged_in_users" data-tralics-id="uid1219" class="subsection" data-number="10.2.1"><h3><a href="updating_and_deleting_users_fragment.html#sec-requiring_logged_in_users" class="heading hyperref"><span class="number">10.2.1 </span>Requiring logged-in users</a></h3>
<p>To implement the forwarding behavior shown in <a href="updating_and_deleting_users_fragment.html#fig-login_page_protected_mockup" class="hyperref">Figure <span class="ref">10.6</span></a>, we’ll use a <em>before filter</em> in the Users controller.<span class="intersentencespace"></span> Before filters use the <code>before_action</code> command to arrange for a particular method to be called before the given actions.<sup id="cha-10_footnote-ref-4" class="footnote"><a href="#cha-10_footnote-4">4</a></sup><span class="intersentencespace"></span> To require users to be logged in, we define a <code>logged_in_user</code> method and invoke it using <code>before_action :logged_in_user</code>, as shown in <a href="updating_and_deleting_users_fragment.html#code-authorize_before_filter" class="hyperref">Listing <span class="ref">10.15</span></a>.</p>
<div class="codelisting" id="code-authorize_before_filter" data-tralics-id="uid1221" data-number="10.15"><div class="heading"><span class="number">Listing 10.15:</span> 

<span class="description">Adding a <code>logged_in_user</code> before filter.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="hll">  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="c1"># Before filters</span>

    <span class="c1"># Confirms a logged-in user.</span>
    <span class="k">def</span> <span class="nf">logged_in_user</span>
<span class="hll">      <span class="k">unless</span> <span class="n">logged_in?</span>
</span><span class="hll">        <span class="n">flash</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Please log in."</span>
</span><span class="hll">        <span class="n">redirect_to</span> <span class="n">login_url</span>
</span><span class="hll">      <span class="k">end</span>
</span>    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>By default, before filters apply to <em>every</em> action in a controller, so here we restrict the filter to act only on the <code>:edit</code> and <code>:update</code> actions by passing the appropriate <code>only:</code> options hash.</p>
<p>We can see the result of the before filter in <a href="updating_and_deleting_users_fragment.html#code-authorize_before_filter" class="hyperref">Listing <span class="ref">10.15</span></a> by logging out and attempting to access the user edit page /users/1/edit, as seen in <a href="updating_and_deleting_users_fragment.html#fig-protected_log_in" class="hyperref">Figure <span class="ref">10.7</span></a>.</p>
<div class="center figure" id="fig-protected_log_in" data-tralics-id="uid1222" data-number="10.7">
<div class="graphics image"><img src="images/figures/protected_log_in_3rd_edition.png" alt="images/figures/protected_log_in_3rd_edition"></div><div class="caption"><span class="header">Figure 10.7: </span><span class="description">The login form after trying to access a protected page.
</span></div></div>
<p>As indicated in the caption of <a href="updating_and_deleting_users_fragment.html#code-authorize_before_filter" class="hyperref">Listing <span class="ref">10.15</span></a>, our test suite is currently <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid1223" data-tralics-id="uid1223" data-number="10.16"><div class="heading"><span class="number">Listing 10.16:</span> <span class="description"><span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div><p>The reason is that the edit and update actions now require a logged-in user, but no user is logged in inside the corresponding tests.</p>
<p>We’ll fix our test suite by logging the user in before hitting the edit or update actions.<span class="intersentencespace"></span> This is easy using the <code>log_in_as</code> helper developed in <a href="advanced_login_fragment.html#sec-remember_tests" class="hyperref">Section <span class="ref">9.3</span></a> (<a href="advanced_login_fragment.html#code-test_helper_log_in" class="hyperref">Listing <span class="ref">9.24</span></a>), as shown in <a href="updating_and_deleting_users_fragment.html#code-edit_tests_logged_in" class="hyperref">Listing <span class="ref">10.17</span></a>.</p>
<div class="codelisting" id="code-edit_tests_logged_in" data-tralics-id="uid1224" data-number="10.17"><div class="heading"><span class="number">Listing 10.17:</span> 

<span class="description">Logging in a test user.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_edit_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersEditTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"unsuccessful edit"</span> <span class="k">do</span>
<span class="hll">    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</span>    <span class="n">get</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"successful edit"</span> <span class="k">do</span>
<span class="hll">    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</span>    <span class="n">get</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>(We could eliminate some duplication by putting the test login in the <code>setup</code> method of <a href="updating_and_deleting_users_fragment.html#code-edit_tests_logged_in" class="hyperref">Listing <span class="ref">10.17</span></a>, but in <a href="updating_and_deleting_users_fragment.html#sec-friendly_forwarding" class="hyperref">Section <span class="ref">10.2.3</span></a> we’ll change one of the tests to visit the edit page <em>before</em> logging in, which isn’t possible if the login step happens during the test setup.)</p>
<p>At this point, our test suite should be green:</p>
<div class="codelisting" id="uid1225" data-tralics-id="uid1225" data-number="10.18"><div class="heading"><span class="number">Listing 10.18:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div><p>Even though our test suite is now passing, we’re not finished with the before filter, because the suite is still <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span> even if we remove our security model, as you can verify by commenting it out (<a href="updating_and_deleting_users_fragment.html#code-commented_out_before_filter" class="hyperref">Listing <span class="ref">10.19</span></a>).<span class="intersentencespace"></span> This is a <a href="http://catb.org/jargon/html/B/Bad-Thing.html" target="_blank" rel="noopener">Bad Thing</a>—of all the regressions we’d like our test suite to catch, a massive security hole is probably #1, so the code in <a href="updating_and_deleting_users_fragment.html#code-commented_out_before_filter" class="hyperref">Listing <span class="ref">10.19</span></a> should definitely be <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>.<span class="intersentencespace"></span> Let’s write tests to arrange that.</p>
<div class="codelisting" id="code-commented_out_before_filter" data-tralics-id="uid1226" data-number="10.19"><div class="heading"><span class="number">Listing 10.19:</span> 

<span class="description">Commenting out the before filter to test our security model.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># before_action :logged_in_user, only: [:edit, :update]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Because the before filter operates on a per-action basis, we’ll put the corresponding tests in the Users controller test.<span class="intersentencespace"></span> The plan is to hit the <code>edit</code> and <code>update</code> actions with the right kinds of requests and verify that the flash is set and that the user is redirected to the login path.<span class="intersentencespace"></span> From <a href="sign_up_fragment.html#table-RESTful_users" class="hyperref">Table <span class="ref">7.1</span></a>, we see that the proper requests are <code class="tt">GET</code> and <code class="tt">PATCH</code>, respectively, which means using the <code>get</code> and <code>patch</code> methods inside the tests.<span class="intersentencespace"></span> The results appear in <a href="updating_and_deleting_users_fragment.html#code-edit_update_redirect_tests" class="hyperref">Listing <span class="ref">10.20</span></a>.</p>
<div class="codelisting" id="code-edit_update_redirect_tests" data-tralics-id="uid1227" data-number="10.20"><div class="heading"><span class="number">Listing 10.20:</span> 

<span class="description">Testing that <code>edit</code> and <code>update</code> are protected.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/controllers/users_controller_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"should redirect edit when not logged in"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="n">flash</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should redirect update when not logged in"</span> <span class="k">do</span>
    <span class="n">patch</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">params</span><span class="p">:</span> <span class="p">{</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                              <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="p">}</span> <span class="p">}</span>
    <span class="n">assert_not</span> <span class="n">flash</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that the second test shown in <a href="updating_and_deleting_users_fragment.html#code-edit_update_redirect_tests" class="hyperref">Listing <span class="ref">10.20</span></a> involves using the <code>patch</code> method to send a <code class="tt">PATCH</code> request to <code>user_path(@user)</code>.<span class="intersentencespace"></span> According to <a href="sign_up_fragment.html#table-RESTful_users" class="hyperref">Table <span class="ref">7.1</span></a>, such a request gets routed to the <code>update</code> action in the Users controller, as required.</p>
<p>The test suite should now be <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>, as required.<span class="intersentencespace"></span> To get it to <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>, just uncomment the before filter (<a href="updating_and_deleting_users_fragment.html#code-uncommented_before_filter" class="hyperref">Listing <span class="ref">10.21</span></a>).</p>
<div class="codelisting" id="code-uncommented_before_filter" data-tralics-id="uid1228" data-number="10.21"><div class="heading"><span class="number">Listing 10.21:</span> 

<span class="description">Uncommenting the before filter.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="hll">  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>With that, our test suite should be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid1229" data-tralics-id="uid1229" data-number="10.22"><div class="heading"><span class="number">Listing 10.22:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div><p>Any accidental exposure of the edit methods to unauthorized users will now be caught immediately by our test suite.</p>
<div id="sec-exercises_requiring_logged_in_users" data-tralics-id="uid1230" class="subsubsection" data-number="10.2.1.1"><h4><a href="#sec-exercises_requiring_logged_in_users" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>As noted above, by default before filters apply to every action in a controller, which in our cases is an error (requiring, e.g., that users log in to hit the signup page, which is absurd).<span class="intersentencespace"></span> By commenting out the <code>only:</code> hash in <a href="updating_and_deleting_users_fragment.html#code-authorize_before_filter" class="hyperref">Listing <span class="ref">10.15</span></a>, confirm that the test suite catches this error. <span class="exercise" id="ex-5d0fb5"></span>
</li></ol>
</div></div>
<div id="sec-requiring_the_right_user" data-tralics-id="uid1232" class="subsection" data-number="10.2.2"><h3><a href="updating_and_deleting_users_fragment.html#sec-requiring_the_right_user" class="heading hyperref"><span class="number">10.2.2 </span>Requiring the right user</a></h3>
<p>Of course, requiring users to log in isn’t quite enough; users should only be allowed to edit their <em>own</em> information.<span class="intersentencespace"></span> As we saw in <a href="updating_and_deleting_users_fragment.html#sec-requiring_logged_in_users" class="hyperref">Section <span class="ref">10.2.1</span></a>, it’s easy to have a test suite that misses an essential security flaw, so we’ll proceed using test-driven development to be sure our code implements the security model correctly.<span class="intersentencespace"></span> To do this, we’ll add tests to the Users controller test to complement the ones shown in <a href="updating_and_deleting_users_fragment.html#code-edit_update_redirect_tests" class="hyperref">Listing <span class="ref">10.20</span></a>.</p>
<p>In order to make sure users can’t edit other users’ information, we need to be able to log in as a second user.<span class="intersentencespace"></span> This means adding a second user to our users fixture file, as shown in <a href="updating_and_deleting_users_fragment.html#code-fixture_second_user" class="hyperref">Listing <span class="ref">10.23</span></a>.</p>
<div class="codelisting" id="code-fixture_second_user" data-tralics-id="uid1233" data-number="10.23"><div class="heading"><span class="number">Listing 10.23:</span> 

<span class="description">Adding a second user to the fixture file.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">test/fixtures/users.yml</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="l-Scalar-Plain">michael</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Michael Example</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael@example.com</span>
  <span class="l-Scalar-Plain">password_digest</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= User.digest('password') %&gt;</span>

<span class="hll"><span class="l-Scalar-Plain">archer</span><span class="p-Indicator">:</span>
</span><span class="hll">  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Sterling Archer</span>
</span><span class="hll">  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">duchess@example.gov</span>
</span><span class="hll">  <span class="l-Scalar-Plain">password_digest</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= User.digest('password') %&gt;</span>
</span></pre></div></div></div><p>By using the <code>log_in_as</code> method defined in <a href="advanced_login_fragment.html#code-test_helper_log_in" class="hyperref">Listing <span class="ref">9.24</span></a>, we can test the <code>edit</code> and <code>update</code> actions as in <a href="updating_and_deleting_users_fragment.html#code-edit_update_wrong_user_tests" class="hyperref">Listing <span class="ref">10.24</span></a>.<span class="intersentencespace"></span> Note that we expect to redirect users to the root path instead of the login path because a user trying to edit a different user would already be logged in.</p>
<div class="codelisting" id="code-edit_update_wrong_user_tests" data-tralics-id="uid1234" data-number="10.24"><div class="heading"><span class="number">Listing 10.24:</span> 

<span class="description">Tests for trying to edit as the wrong user.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/controllers/users_controller_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span>       <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
<span class="hll">    <span class="vi">@other_user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">)</span>
</span>  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"should redirect edit when logged in as wrong user"</span> <span class="k">do</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@other_user</span><span class="p">)</span>
    <span class="n">get</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">assert</span> <span class="n">flash</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should redirect update when logged in as wrong user"</span> <span class="k">do</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@other_user</span><span class="p">)</span>
    <span class="n">patch</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">params</span><span class="p">:</span> <span class="p">{</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                              <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="p">}</span> <span class="p">}</span>
    <span class="n">assert</span> <span class="n">flash</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>To redirect users trying to edit another user’s profile, we’ll add a second method called <code>correct_user</code>, together with a before filter to call it (<a href="updating_and_deleting_users_fragment.html#code-correct_user_before_filter" class="hyperref">Listing <span class="ref">10.25</span></a>).<span class="intersentencespace"></span> Note that the <code>correct_user</code> before filter defines the <code>@user</code> variable, so <a href="updating_and_deleting_users_fragment.html#code-correct_user_before_filter" class="hyperref">Listing <span class="ref">10.25</span></a> also shows that we can eliminate the <code>@user</code> assignments in the <code>edit</code> and <code>update</code> actions.</p>
<div class="codelisting" id="code-correct_user_before_filter" data-tralics-id="uid1235" data-number="10.25"><div class="heading"><span class="number">Listing 10.25:</span> 

<span class="description">A before filter to protect the edit/update pages.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
<span class="hll">  <span class="n">before_action</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Profile updated"</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'edit'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="c1"># Before filters</span>

    <span class="c1"># Confirms a logged-in user.</span>
    <span class="k">def</span> <span class="nf">logged_in_user</span>
      <span class="k">unless</span> <span class="n">logged_in?</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Please log in."</span>
        <span class="n">redirect_to</span> <span class="n">login_url</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="c1"># Confirms the correct user.</span>
    <span class="k">def</span> <span class="nf">correct_user</span>
<span class="hll">      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class="hll">      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_url</span><span class="p">)</span> <span class="k">unless</span> <span class="vi">@user</span> <span class="o">==</span> <span class="n">current_user</span>
</span>    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>At this point, our test suite should be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid1236" data-tralics-id="uid1236" data-number="10.26"><div class="heading"><span class="number">Listing 10.26:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div><p>As a final refactoring, we’ll adopt a common convention and define a <code>current_user?</code> boolean method for use in the <code>correct_user</code> before filter, which we define in the Sessions helper (<a href="updating_and_deleting_users_fragment.html#code-current_user_p" class="hyperref">Listing <span class="ref">10.27</span></a>).<span class="intersentencespace"></span> We’ll use this method to replace code like</p>
<div class="code"><div class="highlight"><pre><span class="k">unless</span> <span class="vi">@user</span> <span class="o">==</span> <span class="n">current_user</span>
</pre></div></div>
<p>with the (slightly) more expressive</p>
<div class="code"><div class="highlight"><pre><span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</pre></div></div>
<div class="codelisting" id="code-current_user_p" data-tralics-id="uid1237" data-number="10.27"><div class="heading"><span class="number">Listing 10.27:</span> 

<span class="description">The <code>current_user?</code> method.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="c1"># Logs in the given user.</span>
  <span class="k">def</span> <span class="nf">log_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
  <span class="k">end</span>

  <span class="c1"># Remembers a user in a persistent session.</span>
  <span class="k">def</span> <span class="nf">remember</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">user</span><span class="o">.</span><span class="n">remember</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
  <span class="k">end</span>

  <span class="c1"># Returns true if the given user is the current user.</span>
  <span class="k">def</span> <span class="nf">current_user?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="hll">    <span class="n">user</span> <span class="o">==</span> <span class="n">current_user</span>
</span>  <span class="k">end</span>

  <span class="c1"># Returns the user corresponding to the remember token cookie.</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Replacing the direct comparison with the boolean method gives the code shown in <a href="updating_and_deleting_users_fragment.html#code-correct_user_before_filter_boolean" class="hyperref">Listing <span class="ref">10.28</span></a>.</p>
<div class="codelisting" id="code-correct_user_before_filter_boolean" data-tralics-id="uid1238" data-number="10.28"><div class="heading"><span class="number">Listing 10.28:</span> 

<span class="description">The final <code>correct_user</code> before filter.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">before_action</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Profile updated"</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'edit'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="c1"># Before filters</span>

    <span class="c1"># Confirms a logged-in user.</span>
    <span class="k">def</span> <span class="nf">logged_in_user</span>
      <span class="k">unless</span> <span class="n">logged_in?</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Please log in."</span>
        <span class="n">redirect_to</span> <span class="n">login_url</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="c1"># Confirms the correct user.</span>
    <span class="k">def</span> <span class="nf">correct_user</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="hll">      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_url</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</span>    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div>
<div id="sec-exercises_requiring_the_right_user" data-tralics-id="uid1239" class="subsubsection" data-number="10.2.2.1"><h4><a href="#sec-exercises_requiring_the_right_user" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Why is it important to protect both the <code>edit</code> and <code>update</code> actions? <span class="exercise" id="ex-c0afd2"></span>
</li>
<li>Which action could you more easily test in a browser? <span class="exercise" id="ex-5f2a07"></span>
</li></ol>
</div></div>
<div id="sec-friendly_forwarding" data-tralics-id="uid1242" class="subsection" data-number="10.2.3"><h3><a href="updating_and_deleting_users_fragment.html#sec-friendly_forwarding" class="heading hyperref"><span class="number">10.2.3 </span>Friendly forwarding</a></h3>
<p>Our site authorization is complete as written, but there is one minor blemish: when users try to access a protected page, they are currently redirected to their profile pages regardless of where they were trying to go.<span class="intersentencespace"></span> In other words, if a non-logged-in user tries to visit the edit page, after logging in the user will be redirected to /users/1 instead of /users/1/edit.<span class="intersentencespace"></span> It would be much friendlier to redirect them to their intended destination instead.</p>
<p>The application code will turn out to be relatively complicated, but we can write a ridiculously simple test for friendly forwarding just by reversing the order of logging in and visiting the edit page in <a href="updating_and_deleting_users_fragment.html#code-edit_tests_logged_in" class="hyperref">Listing <span class="ref">10.17</span></a>.<span class="intersentencespace"></span> As seen in <a href="updating_and_deleting_users_fragment.html#code-friendly_forwarding_test" class="hyperref">Listing <span class="ref">10.29</span></a>, the resulting test tries to visit the edit page, then logs in, and then checks that the user is redirected to the <em>edit</em> page instead of the default profile page.<span class="intersentencespace"></span> (<a href="updating_and_deleting_users_fragment.html#code-friendly_forwarding_test" class="hyperref">Listing <span class="ref">10.29</span></a> also removes the test for rendering the edit template since that’s no longer the expected behavior.)</p>
<div class="codelisting" id="code-friendly_forwarding_test" data-tralics-id="uid1243" data-number="10.29"><div class="heading"><span class="number">Listing 10.29:</span> 

<span class="description">A test for friendly forwarding.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_edit_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersEditTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="hll">  <span class="nb">test</span> <span class="s2">"successful edit with friendly forwarding"</span> <span class="k">do</span>
</span><span class="hll">    <span class="n">get</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</span><span class="hll">    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</span><span class="hll">    <span class="n">assert_redirected_to</span> <span class="n">edit_user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</span>    <span class="nb">name</span>  <span class="o">=</span> <span class="s2">"Foo Bar"</span>
    <span class="n">email</span> <span class="o">=</span> <span class="s2">"foo@bar.com"</span>
    <span class="n">patch</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">params</span><span class="p">:</span> <span class="p">{</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span>  <span class="nb">name</span><span class="p">,</span>
                                              <span class="ss">email</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
                                              <span class="ss">password</span><span class="p">:</span>              <span class="s2">""</span><span class="p">,</span>
                                              <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">""</span> <span class="p">}</span> <span class="p">}</span>
    <span class="n">assert_not</span> <span class="n">flash</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">assert_redirected_to</span> <span class="vi">@user</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">reload</span>
    <span class="n">assert_equal</span> <span class="nb">name</span><span class="p">,</span>  <span class="vi">@user</span><span class="o">.</span><span class="n">name</span>
    <span class="n">assert_equal</span> <span class="n">email</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Now that we have a failing test, we’re ready to implement friendly forwarding.<sup id="cha-10_footnote-ref-5" class="footnote"><a href="#cha-10_footnote-5">5</a></sup><span class="intersentencespace"></span> In order to forward users to their intended destination, we need to store the location of the requested page somewhere, and then redirect to that location instead of to the default.<span class="intersentencespace"></span> We accomplish this with a pair of methods, <code>store_location</code> and <code>redirect_back_or</code>, both defined in the Sessions helper (<a href="updating_and_deleting_users_fragment.html#code-friendly_forwarding_code" class="hyperref">Listing <span class="ref">10.30</span></a>).</p>
<div class="codelisting" id="code-friendly_forwarding_code" data-tralics-id="uid1245" data-number="10.30"><div class="heading"><span class="number">Listing 10.30:</span> 

<span class="description">Code to implement friendly forwarding.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/helpers/sessions_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Redirects to stored location (or to the default).</span>
  <span class="k">def</span> <span class="nf">redirect_back_or</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
    <span class="n">redirect_to</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:forwarding_url</span><span class="o">]</span> <span class="o">||</span> <span class="n">default</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:forwarding_url</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Stores the URL trying to be accessed.</span>
  <span class="k">def</span> <span class="nf">store_location</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:forwarding_url</span><span class="o">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">original_url</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">get?</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Here the storage mechanism for the forwarding URL is the same <code>session</code> facility we used in <a href="basic_login_fragment.html#sec-a_working_log_in_method" class="hyperref">Section <span class="ref">8.2.1</span></a> to log the user in.<span class="intersentencespace"></span> <a href="updating_and_deleting_users_fragment.html#code-friendly_forwarding_code" class="hyperref">Listing <span class="ref">10.30</span></a> also uses the <code>request</code> object (via <code>request.original_url</code>) to get the URL of the requested page.</p>
<p>The <code>store_location</code> method in <a href="updating_and_deleting_users_fragment.html#code-friendly_forwarding_code" class="hyperref">Listing <span class="ref">10.30</span></a> puts the requested URL in the <code>session</code> variable under the key <code>:forwarding_url</code>, but only for a <code>GET</code> request.<span class="intersentencespace"></span> This prevents storing the forwarding URL if a user, say, submits a form when not logged in (which is an edge case but could happen if, e.g., a user deleted the session cookies by hand before submitting the form).<span class="intersentencespace"></span> In such a case, the resulting redirect would issue a <code>GET</code> request to a URL expecting <code>POST</code>, <code>PATCH</code>, or <code>DELETE</code>, thereby causing an error.<span class="intersentencespace"></span> Including <code>if request.get?</code> prevents this from happening.<sup id="cha-10_footnote-ref-6" class="footnote"><a href="#cha-10_footnote-6">6</a></sup></p>
<p>To make use of <code>store_location</code>, we need to add it to the <code>logged_in_user</code> before filter, as shown in <a href="updating_and_deleting_users_fragment.html#code-add_store_location" class="hyperref">Listing <span class="ref">10.31</span></a>.</p>
<div class="codelisting" id="code-add_store_location" data-tralics-id="uid1247" data-number="10.31"><div class="heading"><span class="number">Listing 10.31:</span> 

<span class="description">Adding <code>store_location</code> to the logged-in user before filter.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">before_action</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="c1"># Before filters</span>

    <span class="c1"># Confirms a logged-in user.</span>
    <span class="k">def</span> <span class="nf">logged_in_user</span>
      <span class="k">unless</span> <span class="n">logged_in?</span>
<span class="hll">        <span class="n">store_location</span>
</span>        <span class="n">flash</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Please log in."</span>
        <span class="n">redirect_to</span> <span class="n">login_url</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="c1"># Confirms the correct user.</span>
    <span class="k">def</span> <span class="nf">correct_user</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_url</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>To implement the forwarding itself, we use the <code>redirect_back_or</code> method to redirect to the requested URL if it exists, or some default URL otherwise, which we add to the Sessions controller <code>create</code> action to redirect after successful login (<a href="updating_and_deleting_users_fragment.html#code-friendly_session_create" class="hyperref">Listing <span class="ref">10.32</span></a>).<span class="intersentencespace"></span> The <code>redirect_back_or</code> method uses the or operator <code>||</code> through</p>
<div class="code"><div class="highlight"><pre><span class="n">session</span><span class="o">[</span><span class="ss">:forwarding_url</span><span class="o">]</span> <span class="o">||</span> <span class="n">default</span>
</pre></div></div>
<p>This evaluates to <code>session[:forwarding_url]</code> unless it’s <code>nil</code>, in which case it evaluates to the given default URL.<span class="intersentencespace"></span> Note that <a href="updating_and_deleting_users_fragment.html#code-friendly_forwarding_code" class="hyperref">Listing <span class="ref">10.30</span></a> is careful to remove the forwarding URL (via <code>session.delete(:forwarding_url)</code>); otherwise, subsequent login attempts would forward to the protected page until the user closed their browser.<span class="intersentencespace"></span> (Testing for this is left as an exercise (<a href="updating_and_deleting_users_fragment.html#sec-exercises_friendly_forwarding" class="hyperref">Section <span class="ref">10.2.3.1</span></a>).)<span class="intersentencespace"></span> Also note that the session deletion occurs even though the line with the redirect appears first; redirects don’t happen until an explicit <code>return</code> or the end of the method, so any code appearing after the redirect is still executed.</p>
<div class="codelisting" id="code-friendly_session_create" data-tralics-id="uid1248" data-number="10.32"><div class="heading"><span class="number">Listing 10.32:</span> 

<span class="description">The Sessions <code>create</code> action with friendly forwarding.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/sessions_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="n">log_in</span> <span class="n">user</span>
      <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="o">==</span> <span class="s1">'1'</span> <span class="p">?</span> <span class="n">remember</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">:</span> <span class="n">forget</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="hll">      <span class="n">redirect_back_or</span> <span class="n">user</span>
</span>    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:danger</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Invalid email/password combination'</span>
      <span class="n">render</span> <span class="s1">'new'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>With that, the friendly forwarding integration test in <a href="updating_and_deleting_users_fragment.html#code-friendly_forwarding_test" class="hyperref">Listing <span class="ref">10.29</span></a> should pass, and the basic user authentication and page protection implementation is complete.<span class="intersentencespace"></span> As usual, it’s a good idea to verify that the test suite is <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span> before proceeding:</p>
<div class="codelisting" id="uid1249" data-tralics-id="uid1249" data-number="10.33"><div class="heading"><span class="number">Listing 10.33:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div>
<div id="sec-exercises_friendly_forwarding" data-tralics-id="uid1250" class="subsubsection" data-number="10.2.3.1"><h4><a href="#sec-exercises_friendly_forwarding" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Write a test to make sure that friendly forwarding only forwards to the given URL the first time.<span class="intersentencespace"></span> On subsequent login attempts, the forwarding URL should revert to the default (i.e., the profile page).<span class="intersentencespace"></span> <em>Hint</em>: Add to the test in <a href="updating_and_deleting_users_fragment.html#code-friendly_forwarding_test" class="hyperref">Listing <span class="ref">10.29</span></a> by checking for the right value of <code>session[:forwarding_url]</code>. <span class="exercise" id="ex-6ae96b"></span>
</li>
<li>Put a <code>debugger</code> (<a href="sign_up_fragment.html#sec-debugger" class="hyperref">Section <span class="ref">7.1.3</span></a>) in the Sessions controller’s <code>new</code> action, then log out and try to visit /users/1/edit.<span class="intersentencespace"></span> Confirm in the debugger that the value of <code>session[:forwarding_url]</code> is correct.<span class="intersentencespace"></span> What is the value of <code>request.get?</code> for the <code>new</code> action?<span class="intersentencespace"></span> (Sometimes the terminal can freeze up or act strangely when you’re using the debugger; use your technical sophistication (<a href="beginning_fragment.html#aside-technical_sophistication" class="hyperref">Box <span class="ref">1.1</span></a>) to resolve any issues.) <span class="exercise" id="ex-3a6af3"></span>
</li></ol>
</div></div></div><div id="sec-showing_all_users" data-tralics-id="cid57" class="section" data-number="10.3"><h2><a href="updating_and_deleting_users_fragment.html#sec-showing_all_users" class="heading hyperref"><span class="number">10.3 </span>Showing all users</a></h2>
<p>In this section, we’ll add the <a href="http://www.dictionary.com/browse/penultimate" target="_blank" rel="noopener">penultimate</a> user action, the <code>index</code> action, which is designed to display <em>all</em> the users instead of just one.<span class="intersentencespace"></span> Along the way, we’ll learn how to seed the database with sample users and how to <em>paginate</em> the user output so that the index page can scale up to display a potentially large number of users.<span class="intersentencespace"></span> A mockup of the result—users, pagination links, and a “Users” navigation link—appears in <a href="updating_and_deleting_users_fragment.html#fig-user_index_mockup" class="hyperref">Figure <span class="ref">10.8</span></a>.<sup id="cha-10_footnote-ref-7" class="footnote"><a href="#cha-10_footnote-7">7</a></sup><span class="intersentencespace"></span> In <a href="updating_and_deleting_users_fragment.html#sec-deleting_users" class="hyperref">Section <span class="ref">10.4</span></a>, we’ll add an administrative interface to the users index so that users can also be destroyed.</p>
<div class="center figure" id="fig-user_index_mockup" data-tralics-id="uid1254" data-number="10.8">
<div class="graphics image box"><img src="images/figures/user_index_mockup_bootstrap.png" alt="images/figures/user_index_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 10.8: </span><span class="description">A mockup of the users index page.
</span></div></div>
<div id="sec-users_index" data-tralics-id="uid1255" class="subsection" data-number="10.3.1"><h3><a href="updating_and_deleting_users_fragment.html#sec-users_index" class="heading hyperref"><span class="number">10.3.1 </span>Users index</a></h3>
<p>To get started with the users index, we’ll first implement a security model.<span class="intersentencespace"></span> Although we’ll keep individual user <code>show</code> pages visible to all site visitors, the user <code>index</code> will be restricted to logged-in users so that there’s a limit to how much unregistered users can see by default.<sup id="cha-10_footnote-ref-8" class="footnote"><a href="#cha-10_footnote-8">8</a></sup></p>
<p>To protect the <code>index</code> page from unauthorized access, we’ll first add a short test to verify that the <code>index</code> action is redirected properly (<a href="updating_and_deleting_users_fragment.html#code-index_action_redirected_test" class="hyperref">Listing <span class="ref">10.34</span></a>).</p>
<div class="codelisting" id="code-index_action_redirected_test" data-tralics-id="uid1257" data-number="10.34"><div class="heading"><span class="number">Listing 10.34:</span> 

<span class="description">Testing the <code>index</code> action redirect.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/controllers/users_controller_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span>       <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="vi">@other_user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">)</span>
  <span class="k">end</span>

<span class="hll">  <span class="nb">test</span> <span class="s2">"should redirect index when not logged in"</span> <span class="k">do</span>
</span><span class="hll">    <span class="n">get</span> <span class="n">users_path</span>
</span><span class="hll">    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
</span><span class="hll">  <span class="k">end</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Then we just need to add an <code>index</code> action and include it in the list of actions protected by the <code>logged_in_user</code> before filter (<a href="updating_and_deleting_users_fragment.html#code-logged_in_user_index" class="hyperref">Listing <span class="ref">10.35</span></a>).</p>
<div class="codelisting" id="code-logged_in_user_index" data-tralics-id="uid1258" data-number="10.35"><div class="heading"><span class="number">Listing 10.35:</span> 

<span class="description">Requiring a logged-in user for the <code>index</code> action.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="hll">  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
</span>  <span class="n">before_action</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>

<span class="hll">  <span class="k">def</span> <span class="nf">index</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="hll">
</span>  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>To display the users themselves, we need to make a variable containing all the site’s users and then render each one by iterating through them in the index view.<span class="intersentencespace"></span> As you may recall from the corresponding action in the toy app (<a href="toy_app_fragment.html#code-demo_index_action" class="hyperref">Listing <span class="ref">2.8</span></a>), we can use <code>User.all</code> to pull all the users out of the database, assigning them to an <code>@users</code> instance variable for use in the view, as seen in <a href="updating_and_deleting_users_fragment.html#code-user_index" class="hyperref">Listing <span class="ref">10.36</span></a>.<span class="intersentencespace"></span> (If displaying all the users at once seems like a bad idea, you’re right, and we’ll remove this blemish in <a href="updating_and_deleting_users_fragment.html#sec-pagination" class="hyperref">Section <span class="ref">10.3.3</span></a>.)</p>
<div class="codelisting" id="code-user_index" data-tralics-id="uid1259" data-number="10.36"><div class="heading"><span class="number">Listing 10.36:</span> 

<span class="description">The user <code>index</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">index</span>
<span class="hll">    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span>
</span>  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>To make the actual index page, we’ll make a view (whose file you’ll have to create) that iterates through the users and wraps each one in an <code>li</code> tag.<span class="intersentencespace"></span> We do this with the <code>each</code> method, displaying each user’s Gravatar and name, while wrapping the whole thing in a <code>ul</code> tag (<a href="updating_and_deleting_users_fragment.html#code-user_index_view" class="hyperref">Listing <span class="ref">10.37</span></a>).</p>
<div class="codelisting" id="code-user_index_view" data-tralics-id="uid1260" data-number="10.37"><div class="heading"><span class="number">Listing 10.37:</span> 

<span class="description">The users index view.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/index.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'All users'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"users"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">50</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
</pre></div></div></div><p>The code in <a href="updating_and_deleting_users_fragment.html#code-user_index_view" class="hyperref">Listing <span class="ref">10.37</span></a> uses the result of <a href="updating_and_deleting_users_fragment.html#code-gravatar_option_redux" class="hyperref">Listing <span class="ref">10.38</span></a> from <a href="sign_up_fragment.html#sec-exercises_a_gravatar_image" class="hyperref">Section <span class="ref">7.1.4.1</span></a>, which allows us to pass an option to the Gravatar helper specifying a size other than the default.<span class="intersentencespace"></span> If you didn’t do that exercise, update your Users helper file with the contents of <a href="updating_and_deleting_users_fragment.html#code-gravatar_option_redux" class="hyperref">Listing <span class="ref">10.38</span></a> before proceeding.<span class="intersentencespace"></span> (You are also welcome to use the Ruby 2.0–style version from <a href="sign_up_fragment.html#code-gravatar_keyword" class="hyperref">Listing <span class="ref">7.13</span></a> instead.)</p>
<div class="codelisting" id="code-gravatar_option_redux" data-tralics-id="uid1261" data-number="10.38"><div class="heading"><span class="number">Listing 10.38:</span> 

<span class="description">Adding an options hash in the <code>gravatar_for</code> helper.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/helpers/users_helper.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">UsersHelper</span>

  <span class="c1"># Returns the Gravatar for the given user.</span>
  <span class="k">def</span> <span class="nf">gravatar_for</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">80</span> <span class="p">})</span>
    <span class="n">gravatar_id</span> <span class="o">=</span> <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="o">::</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">downcase</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:size</span><span class="o">]</span>
    <span class="n">gravatar_url</span> <span class="o">=</span> <span class="s2">"https://secure.gravatar.com/avatar/</span><span class="si">#{</span><span class="n">gravatar_id</span><span class="si">}</span><span class="s2">?s=</span><span class="si">#{</span><span class="n">size</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">image_tag</span><span class="p">(</span><span class="n">gravatar_url</span><span class="p">,</span> <span class="ss">alt</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"gravatar"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Let’s also add a little CSS (or, rather, SCSS) for style (<a href="updating_and_deleting_users_fragment.html#code-user_index_css" class="hyperref">Listing <span class="ref">10.39</span></a>).</p>
<div class="codelisting" id="code-user_index_css" data-tralics-id="uid1262" data-number="10.39"><div class="heading"><span class="number">Listing 10.39:</span> 

<span class="description">CSS for the users index.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/assets/stylesheets/custom.scss</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="o">/*</span> <span class="nt">Users</span> <span class="nt">index</span> <span class="o">*/</span>

<span class="nc">.users</span> <span class="p">{</span>
  <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
  <span class="na">margin</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nt">li</span> <span class="p">{</span>
    <span class="na">overflow</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
    <span class="na">border-bottom</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nv">$gray-lighter</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div><p>Finally, we’ll add the URL to the users link in the site’s navigation header using <code>users_path</code>, thereby using the last of the unused named routes in <a href="sign_up_fragment.html#table-RESTful_users" class="hyperref">Table <span class="ref">7.1</span></a>.<span class="intersentencespace"></span> The result appears in <a href="updating_and_deleting_users_fragment.html#code-users_link" class="hyperref">Listing <span class="ref">10.40</span></a>.</p>
<div class="codelisting" id="code-users_link" data-tralics-id="uid1263" data-number="10.40"><div class="heading"><span class="number">Listing 10.40:</span> 

<span class="description">Adding the URL to the users link.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/layouts/_header.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"navbar navbar-fixed-top navbar-inverse"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"sample app"</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">"logo"</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;nav&gt;</span>
      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav navbar-right"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Home"</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Help"</span><span class="p">,</span> <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">logged_in?</span> <span class="cp">%&gt;</span>
<span class="hll">          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Users"</span><span class="p">,</span> <span class="n">users_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
</span>          <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">class=</span><span class="s">"dropdown-toggle"</span> <span class="na">data-toggle=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
              Account <span class="nt">&lt;b</span> <span class="na">class=</span><span class="s">"caret"</span><span class="nt">&gt;&lt;/b&gt;</span>
            <span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"dropdown-menu"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Profile"</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Settings"</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"divider"</span><span class="nt">&gt;&lt;/li&gt;</span>
              <span class="nt">&lt;li&gt;</span>
                <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log out"</span><span class="p">,</span> <span class="n">logout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">"delete"</span> <span class="cp">%&gt;</span>
              <span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;/ul&gt;</span>
          <span class="nt">&lt;/li&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Log in"</span><span class="p">,</span> <span class="n">login_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;/nav&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div></div></div><p>With that, the users index is fully functional, with all tests <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid1264" data-tralics-id="uid1264" data-number="10.41"><div class="heading"><span class="number">Listing 10.41:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div><p>On the other hand, as seen in <a href="updating_and_deleting_users_fragment.html#fig-user_index_only_one" class="hyperref">Figure <span class="ref">10.9</span></a>, it is a bit… lonely.<span class="intersentencespace"></span> Let’s remedy this sad situation.</p>
<div class="center figure" id="fig-user_index_only_one" data-tralics-id="uid1265" data-number="10.9">
<div class="graphics image"><img src="images/figures/user_index_only_one_3rd_edition.png" alt="images/figures/user_index_only_one_3rd_edition"></div><div class="caption"><span class="header">Figure 10.9: </span><span class="description">The users index page with only one user.
</span></div></div>
<div id="sec-exercises_user_index" data-tralics-id="uid1266" class="subsubsection" data-number="10.3.1.1"><h4><a href="#sec-exercises_user_index" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>We’ve now filled in all the links in the site layout.<span class="intersentencespace"></span> Write an integration test for all the layout links, including the proper behavior for logged-in and non-logged-in users.<span class="intersentencespace"></span> <em>Hint</em>: Use the <code>log_in_as</code> helper and add to the steps shown in <a href="filling_in_the_layout_fragment.html#code-layout_links_test" class="hyperref">Listing <span class="ref">5.32</span></a> . <span class="exercise" id="ex-143f12"></span>
</li></ol>
</div></div>
<div id="sec-sample_users" data-tralics-id="uid1268" class="subsection" data-number="10.3.2"><h3><a href="updating_and_deleting_users_fragment.html#sec-sample_users" class="heading hyperref"><span class="number">10.3.2 </span>Sample users</a></h3>
<p>In this section, we’ll give our lonely sample user some company.<span class="intersentencespace"></span> Of course, to create enough users to make a decent users index, we <em>could</em> use our web browser to visit the signup page and make the new users one by one, but a far better solution is to use Ruby to make the users for us.</p>
<p>First, we’ll add the <em>Faker</em> gem to the <code>Gemfile</code>, which will allow us to make sample users with semi-realistic names and email addresses (<a href="updating_and_deleting_users_fragment.html#code-faker_gemfile" class="hyperref">Listing <span class="ref">10.42</span></a>).<sup id="cha-10_footnote-ref-9" class="footnote intersentence"><a href="#cha-10_footnote-9">9</a></sup><span class="intersentencespace"></span> (Ordinarily, you’d probably want to restrict the <code class="tt">faker</code> gem to a development environment, but in the case of the sample app we’ll be using it on our production site as well (<a href="updating_and_deleting_users_fragment.html#sec-updating_and_deleting_users_conclusion" class="hyperref">Section <span class="ref">10.5</span></a>).)</p>
<div class="codelisting" id="code-faker_gemfile" data-tralics-id="uid1270" data-number="10.42"><div class="heading"><span class="number">Listing 10.42:</span> 

<span class="description">Adding the Faker gem to the <code>Gemfile</code>.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span>          <span class="s1">'5.0.1'</span>
<span class="n">gem</span> <span class="s1">'bcrypt'</span><span class="p">,</span>         <span class="s1">'3.1.11'</span>
<span class="hll"><span class="n">gem</span> <span class="s1">'faker'</span><span class="p">,</span>          <span class="s1">'1.6.6'</span>
</span><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div></div></div><p>Then install as usual:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div></div>
<p>Next, we’ll add a Ruby program to seed the database with sample users, for which Rails uses the standard file <code>db/seeds.rb</code>.<span class="intersentencespace"></span> The result appears in <a href="updating_and_deleting_users_fragment.html#code-db_seed" class="hyperref">Listing <span class="ref">10.43</span></a>.<span class="intersentencespace"></span> (The code in <a href="updating_and_deleting_users_fragment.html#code-db_seed" class="hyperref">Listing <span class="ref">10.43</span></a> is a bit advanced, so don’t worry too much about the details.)</p>
<div class="codelisting" id="code-db_seed" data-tralics-id="uid1271" data-number="10.43"><div class="heading"><span class="number">Listing 10.43:</span> 

<span class="description">A program for seeding the database with sample users.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">db/seeds.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span>  <span class="s2">"Example User"</span><span class="p">,</span>
             <span class="ss">email</span><span class="p">:</span> <span class="s2">"example@railstutorial.org"</span><span class="p">,</span>
             <span class="ss">password</span><span class="p">:</span>              <span class="s2">"foobar"</span><span class="p">,</span>
             <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">)</span>

<span class="mi">99</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
  <span class="nb">name</span>  <span class="o">=</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Name</span><span class="o">.</span><span class="n">name</span>
  <span class="n">email</span> <span class="o">=</span> <span class="s2">"example-</span><span class="si">#{</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">@railstutorial.org"</span>
  <span class="n">password</span> <span class="o">=</span> <span class="s2">"password"</span>
  <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span>  <span class="nb">name</span><span class="p">,</span>
               <span class="ss">email</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
               <span class="ss">password</span><span class="p">:</span>              <span class="n">password</span><span class="p">,</span>
               <span class="ss">password_confirmation</span><span class="p">:</span> <span class="n">password</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div><p>The code in <a href="updating_and_deleting_users_fragment.html#code-db_seed" class="hyperref">Listing <span class="ref">10.43</span></a> creates an example user with name and email address replicating our previous one, and then makes 99 more.<span class="intersentencespace"></span> The <code>create!</code> method is just like the <code>create</code> method, except it raises an exception (<a href="modeling_users_fragment.html#sec-finding_user_objects" class="hyperref">Section <span class="ref">6.1.4</span></a>) for an invalid user rather than returning <code>false</code>.<span class="intersentencespace"></span> This behavior makes debugging easier by avoiding silent errors.</p>
<p>With the code as in <a href="updating_and_deleting_users_fragment.html#code-db_seed" class="hyperref">Listing <span class="ref">10.43</span></a>, we can reset the database and then invoke the Rake task using <code>db:seed</code>:<sup id="cha-10_footnote-ref-10" class="footnote"><a href="#cha-10_footnote-10">10</a></sup></p>
<div class="code"><div class="highlight"><pre>$ rails db:migrate:reset
$ rails db:seed
</pre></div></div>
<p>Seeding the database can be slow, and on some systems could take up to a few minutes.<span class="intersentencespace"></span> Also, some readers have reported that they are unable to run the reset command if the Rails server is running, so you may have to stop the server first before proceeding (<a href="beginning_fragment.html#aside-technical_sophistication" class="hyperref">Box <span class="ref">1.1</span></a>).</p>
<p>After running the <code>db:seed</code> Rake task, our application should have 100 sample users.<span class="intersentencespace"></span> As seen in <a href="updating_and_deleting_users_fragment.html#fig-user_index_all" class="hyperref">Figure <span class="ref">10.10</span></a>, I’ve taken the liberty of associating the first few sample addresses with Gravatars so that they’re not all the default Gravatar image.</p>
<div class="center figure" id="fig-user_index_all" data-tralics-id="uid1273" data-number="10.10">
<div class="graphics image"><img src="images/figures/user_index_all_3rd_edition.png" alt="images/figures/user_index_all_3rd_edition"></div><div class="caption"><span class="header">Figure 10.10: </span><span class="description">The users index page with 100 sample users.
</span></div></div>
<div id="sec-exercises_sample_users" data-tralics-id="uid1274" class="subsubsection" data-number="10.3.2.1"><h4><a href="#sec-exercises_sample_users" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Verify that trying to visit the edit page of another user results in a redirect as required by <a href="updating_and_deleting_users_fragment.html#sec-requiring_the_right_user" class="hyperref">Section <span class="ref">10.2.2</span></a>. <span class="exercise" id="ex-41e0bf"></span>
</li></ol>
</div></div>
<div id="sec-pagination" data-tralics-id="uid1276" class="subsection" data-number="10.3.3"><h3><a href="updating_and_deleting_users_fragment.html#sec-pagination" class="heading hyperref"><span class="number">10.3.3 </span>Pagination</a></h3>
<p>Our original user doesn’t suffer from loneliness any more, but now we have the opposite problem: our user has <em>too many</em> companions, and they all appear on the same page.<span class="intersentencespace"></span> Right now there are a hundred, which is already a reasonably large number, and on a real site it could be thousands.<span class="intersentencespace"></span> The solution is to <em>paginate</em> the users, so that (for example) only 30 show up on a page at any one time.</p>
<p>There are several pagination methods available in Rails; we’ll use one of the simplest and most robust, called <a href="http://wiki.github.com/mislav/will_paginate/" target="_blank" rel="noopener">will_paginate</a>.<span class="intersentencespace"></span> To use it, we need to include both the <code class="tt">will_paginate</code> gem and <code class="tt">bootstrap-will_paginate</code>, which configures will_paginate to use Bootstrap’s pagination styles.<span class="intersentencespace"></span> The updated <code>Gemfile</code> appears in <a href="updating_and_deleting_users_fragment.html#code-will_paginate_gem" class="hyperref">Listing <span class="ref">10.44</span></a>.<sup id="cha-10_footnote-ref-11" class="footnote"><a href="#cha-10_footnote-11">11</a></sup></p>
<div class="codelisting" id="code-will_paginate_gem" data-tralics-id="uid1278" data-number="10.44"><div class="heading"><span class="number">Listing 10.44:</span> 

<span class="description">Including <code class="tt">will_paginate</code> in the <code>Gemfile</code>.</span>
</div>

<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span>                   <span class="s1">'5.0.1'</span>
<span class="n">gem</span> <span class="s1">'bcrypt'</span><span class="p">,</span>                  <span class="s1">'3.1.11'</span>
<span class="n">gem</span> <span class="s1">'faker'</span><span class="p">,</span>                   <span class="s1">'1.6.6'</span>
<span class="hll"><span class="n">gem</span> <span class="s1">'will_paginate'</span><span class="p">,</span>           <span class="s1">'3.1.0'</span>
</span><span class="hll"><span class="n">gem</span> <span class="s1">'bootstrap-will_paginate'</span><span class="p">,</span> <span class="s1">'0.0.10'</span>
</span><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div></div></div><p>Then run <code>bundle install</code>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div></div>
<p>You should also restart the webserver to ensure that the new gems are loaded properly.</p>
<p>To get pagination working, we need to add some code to the index view telling Rails to paginate the users, and we need to replace <code>User.all</code> in the <code>index</code> action with an object that knows about pagination.<span class="intersentencespace"></span> We’ll start by adding the special <code>will_paginate</code> method in the view (<a href="updating_and_deleting_users_fragment.html#code-will_paginate_index_view" class="hyperref">Listing <span class="ref">10.45</span></a>); we’ll see in a moment why the code appears both above and below the user list.</p>
<div class="codelisting" id="code-will_paginate_index_view" data-tralics-id="uid1279" data-number="10.45"><div class="heading"><span class="number">Listing 10.45:</span> 

<span class="description">The users index with pagination.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/index.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'All users'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="hll"><span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</span>
<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"users"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">50</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="hll"><span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</span></pre></div></div></div><p>The <code>will_paginate</code> method is a little magical; inside a <code>users</code> view, it automatically looks for an <code>@users</code> object, and then displays pagination links to access other pages.<span class="intersentencespace"></span> The view in <a href="updating_and_deleting_users_fragment.html#code-will_paginate_index_view" class="hyperref">Listing <span class="ref">10.45</span></a> doesn’t work yet, though, because currently <code>@users</code> contains the results of <code>User.all</code> (<a href="updating_and_deleting_users_fragment.html#code-user_index" class="hyperref">Listing <span class="ref">10.36</span></a>), whereas <code>will_paginate</code> requires that we paginate the results explicitly using the <code>paginate</code> method:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
<span class="go">  User Load (1.5ms)  SELECT "users".* FROM "users" LIMIT 30 OFFSET 0</span>
<span class="go">   (1.7ms)  SELECT COUNT(*) FROM "users"</span>
<span class="go">=&gt; #&lt;ActiveRecord::Relation [#&lt;User id: 1,...</span>
</pre></div></div>
<p>Note that <code>paginate</code> takes a hash argument with key <code>:page</code> and value equal to the page requested.<span class="intersentencespace"></span> <code>User.paginate</code> pulls the users out of the database one chunk at a time (30 by default), based on the <code>:page</code> parameter.<span class="intersentencespace"></span> So, for example, page 1 is users 1–30, page 2 is users 31–60, etc.<span class="intersentencespace"></span> If <code>page</code> is <code>nil</code>, <code>paginate</code> simply returns the first page.</p>
<p>Using the <code>paginate</code> method, we can paginate the users in the sample application by using <code>paginate</code> in place of <code>all</code> in the <code>index</code> action (<a href="updating_and_deleting_users_fragment.html#code-will_paginate_index_action" class="hyperref">Listing <span class="ref">10.46</span></a>).<span class="intersentencespace"></span> Here the <code>page</code> parameter comes from <code>params[:page]</code>, which is generated automatically by <code>will_paginate</code>.</p>
<div class="codelisting" id="code-will_paginate_index_action" data-tralics-id="uid1280" data-number="10.46"><div class="heading"><span class="number">Listing 10.46:</span> 

<span class="description">Paginating the users in the <code>index</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">index</span>
<span class="hll">    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
</span>  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>The users index page should now be working, appearing as in <a href="updating_and_deleting_users_fragment.html#fig-user_index_pagination" class="hyperref">Figure <span class="ref">10.11</span></a>.<span class="intersentencespace"></span> (On some systems, you may have to restart the Rails server at this point.)<span class="intersentencespace"></span> Because we included <code>will_paginate</code> both above and below the user list, the pagination links appear in both places.</p>
<div class="center figure" id="fig-user_index_pagination" data-tralics-id="uid1281" data-number="10.11">
<div class="graphics image"><img src="images/figures/user_index_pagination_3rd_edition.png" alt="images/figures/user_index_pagination_3rd_edition"></div><div class="caption"><span class="header">Figure 10.11: </span><span class="description">The users index page with pagination.
</span></div></div>
<p>If you now click on either the 2 link or Next link, you’ll get the second page of results, as shown in <a href="updating_and_deleting_users_fragment.html#fig-user_index_page_two_rails_3" class="hyperref">Figure <span class="ref">10.12</span></a>.</p>
<div class="center figure" id="fig-user_index_page_two_rails_3" data-tralics-id="uid1282" data-number="10.12">
<div class="graphics image"><img src="images/figures/user_index_page_two_3rd_edition.png" alt="images/figures/user_index_page_two_3rd_edition"></div><div class="caption"><span class="header">Figure 10.12: </span><span class="description">Page 2 of the users index.
</span></div></div>
<div id="sec-exercises_pagination" data-tralics-id="uid1283" class="subsubsection" data-number="10.3.3.1"><h4><a href="#sec-exercises_pagination" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Confirm at the console that setting the page to <code>nil</code> pulls out the first page of users. <span class="exercise" id="ex-35d060"></span>
</li>
<li>What is the Ruby class of the pagination object?<span class="intersentencespace"></span> How does it compare to the class of <code>User.all</code>? <span class="exercise" id="ex-05e085"></span>
</li></ol>
</div></div>
<div id="sec-users_index_test" data-tralics-id="uid1286" class="subsection" data-number="10.3.4"><h3><a href="updating_and_deleting_users_fragment.html#sec-users_index_test" class="heading hyperref"><span class="number">10.3.4 </span>Users index test</a></h3>
<p>Now that our users index page is working, we’ll write a lightweight test for it, including a minimal test for the pagination from <a href="updating_and_deleting_users_fragment.html#sec-pagination" class="hyperref">Section <span class="ref">10.3.3</span></a>.<span class="intersentencespace"></span> The idea is to log in, visit the index path, verify the first page of users is present, and then confirm that pagination is present on the page.<span class="intersentencespace"></span> For these last two steps to work, we need to have enough users in the test database to invoke pagination, i.e., more than 30.</p>
<p>We created a second user in the fixtures in <a href="updating_and_deleting_users_fragment.html#code-fixture_second_user" class="hyperref">Listing <span class="ref">10.23</span></a>, but 30 or so more users is a lot to create by hand.<span class="intersentencespace"></span> Luckily, as we’ve seen with the user fixture’s <code>password_digest</code> attribute, fixture files support embedded Ruby, which means we can create 30 additional users as shown in <a href="updating_and_deleting_users_fragment.html#code-users_fixtures_extra_users" class="hyperref">Listing <span class="ref">10.47</span></a>.<span class="intersentencespace"></span> (<a href="updating_and_deleting_users_fragment.html#code-users_fixtures_extra_users" class="hyperref">Listing <span class="ref">10.47</span></a> also creates a couple of other named users for future reference.)</p>
<div class="codelisting" id="code-users_fixtures_extra_users" data-tralics-id="uid1287" data-number="10.47"><div class="heading"><span class="number">Listing 10.47:</span> 

<span class="description">Adding 30 extra users to the fixture.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">test/fixtures/users.yml</span></span>
</div>

<div class="code"><div class="highlight"><pre>michael:
  name: Michael Example
  email: michael@example.com
  password_digest: &lt;%= User.digest('password') %&gt;

archer:
  name: Sterling Archer
  email: duchess@example.gov
  password_digest: &lt;%= User.digest('password') %&gt;

lana:
  name: Lana Kane
  email: hands@example.gov
  password_digest: &lt;%= User.digest('password') %&gt;

malory:
  name: Malory Archer
  email: boss@example.gov
  password_digest: &lt;%= User.digest('password') %&gt;

&lt;% 30.times do |n| %&gt;
user_&lt;%= n %&gt;:
  name:  &lt;%= "User #{n}" %&gt;
  email: &lt;%= "user-#{n}@example.com" %&gt;
  password_digest: &lt;%= User.digest('password') %&gt;
&lt;% end %&gt;
</pre></div></div></div><p>With the fixtures defined in <a href="updating_and_deleting_users_fragment.html#code-users_fixtures_extra_users" class="hyperref">Listing <span class="ref">10.47</span></a>, we’re ready to write a test of the users index.<span class="intersentencespace"></span> First we generate the relevant test:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate integration_test users_index
<span class="go">      invoke  test_unit</span>
<span class="go">      create    test/integration/users_index_test.rb</span>
</pre></div></div>
<p>The test itself involves checking for a <code>div</code> with the required <code>pagination</code> class and verifying that the first page of users is present.<span class="intersentencespace"></span> The result appears in <a href="updating_and_deleting_users_fragment.html#code-user_index_test" class="hyperref">Listing <span class="ref">10.48</span></a>.</p>
<div class="codelisting" id="code-user_index_test" data-tralics-id="uid1288" data-number="10.48"><div class="heading"><span class="number">Listing 10.48:</span> 

<span class="description">A test of the users index, including pagination.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_index_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersIndexTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"index including pagination"</span> <span class="k">do</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">get</span> <span class="n">users_path</span>
    <span class="n">assert_template</span> <span class="s1">'users/index'</span>
    <span class="n">assert_select</span> <span class="s1">'div.pagination'</span>
    <span class="no">User</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
      <span class="n">assert_select</span> <span class="s1">'a[href=?]'</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">),</span> <span class="ss">text</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The result should be a <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span> test suite:</p>
<div class="codelisting" id="uid1289" data-tralics-id="uid1289" data-number="10.49"><div class="heading"><span class="number">Listing 10.49:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div>
<div id="sec-exercises_user_index_test" data-tralics-id="uid1290" class="subsubsection" data-number="10.3.4.1"><h4><a href="#sec-exercises_user_index_test" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>By commenting out the pagination links in <a href="updating_and_deleting_users_fragment.html#code-will_paginate_index_view" class="hyperref">Listing <span class="ref">10.45</span></a>, confirm that the test in <a href="updating_and_deleting_users_fragment.html#code-user_index_test" class="hyperref">Listing <span class="ref">10.48</span></a> goes <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>. <span class="exercise" id="ex-874ecc"></span>
</li>
<li>Confirm that commenting out only <em>one</em> of the calls to will_paginate leaves the tests <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>.<span class="intersentencespace"></span> How would you test for the presence of both sets of will_paginate links?<span class="intersentencespace"></span> <em>Hint</em>: Use a count from <a href="filling_in_the_layout_fragment.html#table-assert_select" class="hyperref">Table <span class="ref">5.2</span></a>. <span class="exercise" id="ex-8edf5d"></span>
</li></ol>
</div></div>
<div id="sec-partial_refactoring" data-tralics-id="uid1293" class="subsection" data-number="10.3.5"><h3><a href="updating_and_deleting_users_fragment.html#sec-partial_refactoring" class="heading hyperref"><span class="number">10.3.5 </span>Partial refactoring</a></h3>
<p>The paginated users index is now complete, but there’s one improvement I can’t resist including: Rails has some incredibly slick tools for making compact views, and in this section we’ll refactor the index page to use them.<span class="intersentencespace"></span> Because our code is well-tested, we can refactor with confidence, assured that we are unlikely to break our site’s functionality.</p>
<p>The first step in our refactoring is to replace the user <code>li</code> from <a href="updating_and_deleting_users_fragment.html#code-will_paginate_index_view" class="hyperref">Listing <span class="ref">10.45</span></a> with a <code>render</code> call (<a href="updating_and_deleting_users_fragment.html#code-index_view_first_refactoring" class="hyperref">Listing <span class="ref">10.50</span></a>).</p>
<div class="codelisting" id="code-index_view_first_refactoring" data-tralics-id="uid1294" data-number="10.50"><div class="heading"><span class="number">Listing 10.50:</span> 

<span class="description">The first refactoring attempt in the index view.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/index.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'All users'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"users"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
<span class="hll">    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="n">user</span> <span class="cp">%&gt;</span>
</span>  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>Here we call <code>render</code> not on a string with the name of a partial, but rather on a <code>user</code> variable of class <code>User</code>;<sup id="cha-10_footnote-ref-12" class="footnote"><a href="#cha-10_footnote-12">12</a></sup> in this context, Rails automatically looks for a partial called <code>_user.html.erb</code>, which we must create (<a href="updating_and_deleting_users_fragment.html#code-user_partial" class="hyperref">Listing <span class="ref">10.51</span></a>).</p>
<div class="codelisting" id="code-user_partial" data-tralics-id="uid1296" data-number="10.51"><div class="heading"><span class="number">Listing 10.51:</span> 

<span class="description">A partial to render a single user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/_user.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">50</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div></div></div><p>This is a definite improvement, but we can do even better: we can call <code>render</code> <em>directly</em> on the <code>@users</code> variable (<a href="updating_and_deleting_users_fragment.html#code-index_final_refactoring" class="hyperref">Listing <span class="ref">10.52</span></a>).</p>
<div class="codelisting" id="code-index_final_refactoring" data-tralics-id="uid1297" data-number="10.52"><div class="heading"><span class="number">Listing 10.52:</span> 

<span class="description">The fully refactored users index.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/views/users/index.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">'All users'</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"users"</span><span class="nt">&gt;</span>
<span class="hll">  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
</span><span class="nt">&lt;/ul&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>Here Rails infers that <code>@users</code> is a list of <code>User</code> objects; moreover, when called with a collection of users, Rails automatically iterates through them and renders each one with the <code>_user.html.erb</code> partial (inferring the name of the partial from the name of the class).<span class="intersentencespace"></span> The result is the impressively compact code in <a href="updating_and_deleting_users_fragment.html#code-index_final_refactoring" class="hyperref">Listing <span class="ref">10.52</span></a>.</p>
<p>As with any refactoring, you should verify that the test suite is still <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span> after changing the application code:</p>
<div class="codelisting" id="uid1298" data-tralics-id="uid1298" data-number="10.53"><div class="heading"><span class="number">Listing 10.53:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div>
<div id="sec-exercises_partial_refactoring" data-tralics-id="uid1299" class="subsubsection" data-number="10.3.5.1"><h4><a href="#sec-exercises_partial_refactoring" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Comment out the <code>render</code> line in <a href="updating_and_deleting_users_fragment.html#code-index_final_refactoring" class="hyperref">Listing <span class="ref">10.52</span></a> and confirm that the resulting tests are <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>. <span class="exercise" id="ex-d0d59d"></span>
</li></ol>
</div></div></div><div id="sec-deleting_users" data-tralics-id="cid58" class="section" data-number="10.4"><h2><a href="updating_and_deleting_users_fragment.html#sec-deleting_users" class="heading hyperref"><span class="number">10.4 </span>Deleting users</a></h2>
<p>Now that the users index is complete, there’s only one canonical REST action left: <code>destroy</code>.<span class="intersentencespace"></span> In this section, we’ll add links to delete users, as mocked up in <a href="updating_and_deleting_users_fragment.html#fig-user_index_delete_links_mockup" class="hyperref">Figure <span class="ref">10.13</span></a>, and define the <code>destroy</code> action necessary to accomplish the deletion.<span class="intersentencespace"></span> But first, we’ll create the class of administrative users, or <em>admins</em>, authorized to do so.</p>
<div class="center figure" id="fig-user_index_delete_links_mockup" data-tralics-id="uid1301" data-number="10.13">
<div class="graphics image box"><img src="images/figures/user_index_delete_links_mockup_bootstrap.png" alt="images/figures/user_index_delete_links_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 10.13: </span><span class="description">A mockup of the users index with delete links.
</span></div></div>
<div id="sec-administrative_users" data-tralics-id="uid1302" class="subsection" data-number="10.4.1"><h3><a href="updating_and_deleting_users_fragment.html#sec-administrative_users" class="heading hyperref"><span class="number">10.4.1 </span>Administrative users</a></h3>
<p>We will identify privileged administrative users with a boolean <code>admin</code> attribute in the User model, which will lead automatically to an <code>admin?</code> boolean method to test for admin status.<span class="intersentencespace"></span> The resulting data model appears in <a href="updating_and_deleting_users_fragment.html#fig-user_model_admin" class="hyperref">Figure <span class="ref">10.14</span></a>.</p>
<div class="center figure" id="fig-user_model_admin" data-tralics-id="uid1303" data-number="10.14"><span class="graphics"><img src="images/figures/user_model_admin_3rd_edition.png" alt="user_model_admin_3rd_edition"></span>
<div class="caption"><span class="header">Figure 10.14: </span><span class="description">The User model with an added <code>admin</code> boolean attribute.
</span></div></div>
<p>As usual, we add the <code>admin</code> attribute with a migration, indicating the <code>boolean</code> type on the command line:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_admin_to_users admin:boolean
</pre></div></div>
<p>The migration adds the <code>admin</code> column to the <code>users</code> table, as shown in <a href="updating_and_deleting_users_fragment.html#code-admin_migration" class="hyperref">Listing <span class="ref">10.54</span></a>.<span class="intersentencespace"></span> Note that we’ve added the argument <code>default: false</code> to <code>add_column</code> in <a href="updating_and_deleting_users_fragment.html#code-admin_migration" class="hyperref">Listing <span class="ref">10.54</span></a>, which means that users will <em>not</em> be administrators by default.<span class="intersentencespace"></span> (Without the <code>default: false</code> argument, <code>admin</code> will be <code>nil</code> by default, which is still <code>false</code>, so this step is not strictly necessary.<span class="intersentencespace"></span> It is more explicit, though, and communicates our intentions more clearly both to Rails and to readers of our code.)</p>
<div class="codelisting" id="code-admin_migration" data-tralics-id="uid1304" data-number="10.54"><div class="heading"><span class="number">Listing 10.54:</span> 

<span class="description">The migration to add a boolean <code>admin</code> attribute to users.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">db/migrate/[timestamp]_add_admin_to_users.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddAdminToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="o">[</span><span class="mi">5</span><span class="o">.</span><span class="mi">0</span><span class="o">]</span>
  <span class="k">def</span> <span class="nf">change</span>
<span class="hll">    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:admin</span><span class="p">,</span> <span class="ss">:boolean</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="kp">false</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Next, we migrate as usual:</p>
<div class="code"><div class="highlight"><pre>$ rails db:migrate
</pre></div></div>
<p>As expected, Rails figures out the boolean nature of the <code>admin</code> attribute and automatically adds the question-mark method <code>admin?</code>:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">admin?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">toggle!</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">admin?</span>
<span class="go">=&gt; true</span>
</pre></div></div>
<p>Here we’ve used the <code>toggle!</code> method to flip the <code>admin</code> attribute from <code>false</code> to <code>true</code>.</p>
<p>As a final step, let’s update our seed data to make the first user an admin by default (<a href="updating_and_deleting_users_fragment.html#code-populator_with_admin" class="hyperref">Listing <span class="ref">10.55</span></a>).</p>
<div class="codelisting" id="code-populator_with_admin" data-tralics-id="uid1305" data-number="10.55"><div class="heading"><span class="number">Listing 10.55:</span> 

<span class="description">The seed data code with an admin user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">db/seeds.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span>  <span class="s2">"Example User"</span><span class="p">,</span>
             <span class="ss">email</span><span class="p">:</span> <span class="s2">"example@railstutorial.org"</span><span class="p">,</span>
             <span class="ss">password</span><span class="p">:</span>              <span class="s2">"foobar"</span><span class="p">,</span>
             <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span>
<span class="hll">             <span class="ss">admin</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
</span>
<span class="mi">99</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
  <span class="nb">name</span>  <span class="o">=</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Name</span><span class="o">.</span><span class="n">name</span>
  <span class="n">email</span> <span class="o">=</span> <span class="s2">"example-</span><span class="si">#{</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">@railstutorial.org"</span>
  <span class="n">password</span> <span class="o">=</span> <span class="s2">"password"</span>
  <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span>  <span class="nb">name</span><span class="p">,</span>
               <span class="ss">email</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
               <span class="ss">password</span><span class="p">:</span>              <span class="n">password</span><span class="p">,</span>
               <span class="ss">password_confirmation</span><span class="p">:</span> <span class="n">password</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div><p>Then reset the database:</p>
<div class="code"><div class="highlight"><pre>$ rails db:migrate:reset
$ rails db:seed
</pre></div></div>
<div id="sec-revisiting_strong_parameters" data-tralics-id="uid1306" class="subsubsection" data-number="10.4.1.1"><h4><a href="#sec-revisiting_strong_parameters" class="heading">Revisiting strong parameters</a></h4>
<p>You might have noticed that <a href="updating_and_deleting_users_fragment.html#code-populator_with_admin" class="hyperref">Listing <span class="ref">10.55</span></a> makes the user an admin by including <code>admin: true</code> in the initialization hash.<span class="intersentencespace"></span> This underscores the danger of exposing our objects to the wild Web: if we simply passed an initialization hash in from an arbitrary web request, a malicious user could send a <code class="tt">PATCH</code> request as follows:<sup id="cha-10_footnote-ref-13" class="footnote"><a href="#cha-10_footnote-13">13</a></sup></p>
<div class="code"><div class="highlight"><pre>patch /users/17?admin=1
</pre></div></div>
<p>This request would make user 17 an admin, which would be a potentially serious security breach.</p>
<p>Because of this danger, it is essential that we only update attributes that are safe to edit through the web.<span class="intersentencespace"></span> As noted in <a href="sign_up_fragment.html#sec-strong_parameters" class="hyperref">Section <span class="ref">7.3.2</span></a>, this is accomplished using <em>strong parameters</em> by calling <code>require</code> and <code>permit</code> on the <code>params</code> hash:</p>
<div class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>
</pre></div></div>
<p>Note in particular that <code>admin</code> is <em>not</em> in the list of permitted attributes.<span class="intersentencespace"></span> This is what prevents arbitrary users from granting themselves administrative access to our application.<span class="intersentencespace"></span> Because of its importance, it’s a good idea to write a test for any attribute that isn’t editable, and writing such a test for the <code>admin</code> attribute is left as an exercise (<a href="updating_and_deleting_users_fragment.html#sec-exercises_administrative_users" class="hyperref">Section <span class="ref">10.4.1.2</span></a>).</p>
</div>
<div id="sec-exercises_administrative_users" data-tralics-id="uid1308" class="subsubsection" data-number="10.4.1.2"><h4><a href="#sec-exercises_administrative_users" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>By issuing a <code class="tt">PATCH</code> request directly to the user path as shown in <a href="updating_and_deleting_users_fragment.html#code-forbidden_admin_test" class="hyperref">Listing <span class="ref">10.56</span></a>, verify that the <code>admin</code> attribute isn’t editable through the web.<span class="intersentencespace"></span> To be sure your test is covering the right thing, your first step should be to <em>add</em> <code>admin</code> to the list of permitted parameters in <code>user_params</code> so that the initial test is <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>. <span class="exercise" id="ex-11d303"></span>
</li></ol>
<div class="codelisting" id="code-forbidden_admin_test" data-tralics-id="uid1310" data-number="10.56"><div class="heading"><span class="number">Listing 10.56:</span> 

<span class="description">Testing that the <code>admin</code> attribute is forbidden.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">test/controllers/users_controller_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span>       <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="vi">@other_user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"should redirect update when not logged in"</span> <span class="k">do</span>
    <span class="n">patch</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">params</span><span class="p">:</span> <span class="p">{</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                              <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="p">}</span> <span class="p">}</span>
    <span class="n">assert_not</span> <span class="n">flash</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
  <span class="k">end</span>
<span class="hll">
</span><span class="hll">  <span class="nb">test</span> <span class="s2">"should not allow the admin attribute to be edited via the web"</span> <span class="k">do</span>
</span><span class="hll">    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@other_user</span><span class="p">)</span>
</span><span class="hll">    <span class="n">assert_not</span> <span class="vi">@other_user</span><span class="o">.</span><span class="n">admin?</span>
</span><span class="hll">    <span class="n">patch</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@other_user</span><span class="p">),</span> <span class="ss">params</span><span class="p">:</span> <span class="p">{</span>
</span><span class="hll">                                    <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="ss">password</span><span class="p">:</span>              <span class="no">FILL_IN</span><span class="p">,</span>
</span><span class="hll">                                            <span class="ss">password_confirmation</span><span class="p">:</span> <span class="no">FILL_IN</span><span class="p">,</span>
</span><span class="hll">                                            <span class="ss">admin</span><span class="p">:</span> <span class="no">FILL_IN</span> <span class="p">}</span> <span class="p">}</span>
</span><span class="hll">    <span class="n">assert_not</span> <span class="vi">@other_user</span><span class="o">.</span><span class="n">FILL_IN</span><span class="o">.</span><span class="n">admin?</span>
</span><span class="hll">  <span class="k">end</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div></div></div>
<div id="sec-the_destroy_action" data-tralics-id="uid1311" class="subsection" data-number="10.4.2"><h3><a href="updating_and_deleting_users_fragment.html#sec-the_destroy_action" class="heading hyperref"><span class="number">10.4.2 </span>The <code class="tt">destroy</code> action</a></h3>
<p>The final step needed to complete the Users resource is to add delete links and a <code>destroy</code> action.<span class="intersentencespace"></span> We’ll start by adding a delete link for each user on the users index page, restricting access to administrative users.<span class="intersentencespace"></span> The resulting <code>"delete"</code> links will be displayed only if the current user is an admin (<a href="updating_and_deleting_users_fragment.html#code-delete_links" class="hyperref">Listing <span class="ref">10.57</span></a>).</p>
<div class="codelisting" id="code-delete_links" data-tralics-id="uid1312" data-number="10.57"><div class="heading"><span class="number">Listing 10.57:</span> 

<span class="description">User delete links (viewable only by admins).<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/_user.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">50</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
<span class="hll">  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">admin?</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">current_user?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
</span><span class="hll">    | <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"delete"</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span><span class="p">,</span>
</span><span class="hll">                                  <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">confirm</span><span class="p">:</span> <span class="s2">"You sure?"</span> <span class="p">}</span> <span class="cp">%&gt;</span>
</span><span class="hll">  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</span><span class="nt">&lt;/li&gt;</span>
</pre></div></div></div><p>Note the <code>method: :delete</code> argument, which arranges for the link to issue the necessary <code class="tt">DELETE</code> request.<span class="intersentencespace"></span> We’ve also wrapped each link inside an <code>if</code> statement so that only admins can see them.<span class="intersentencespace"></span> The result for our admin user appears in <a href="updating_and_deleting_users_fragment.html#fig-index_delete_links_rails_3" class="hyperref">Figure <span class="ref">10.15</span></a>.</p>
<p>Web browsers can’t send <code class="tt">DELETE</code> requests natively, so Rails fakes them with JavaScript.<span class="intersentencespace"></span> This means that the delete links won’t work if the user has JavaScript disabled.<span class="intersentencespace"></span> If you must support non-JavaScript-enabled browsers you can fake a <code class="tt">DELETE</code> request using a form and a <code class="tt">POST</code> request, which works even without JavaScript.<sup id="cha-10_footnote-ref-14" class="footnote"><a href="#cha-10_footnote-14">14</a></sup></p>
<div class="center figure" id="fig-index_delete_links_rails_3" data-tralics-id="uid1314" data-number="10.15">
<div class="graphics image"><img src="images/figures/index_delete_links_3rd_edition.png" alt="images/figures/index_delete_links_3rd_edition"></div><div class="caption"><span class="header">Figure 10.15: </span><span class="description">The users index with delete links.
</span></div></div>
<p>To get the delete links to work, we need to add a <code>destroy</code> action (<a href="sign_up_fragment.html#table-RESTful_users" class="hyperref">Table <span class="ref">7.1</span></a>), which finds the corresponding user and destroys it with the Active Record <code>destroy</code> method, finally redirecting to the users index, as seen in <a href="updating_and_deleting_users_fragment.html#code-destroy_action" class="hyperref">Listing <span class="ref">10.58</span></a>.<span class="intersentencespace"></span> Because users have to be logged in to delete users, <a href="updating_and_deleting_users_fragment.html#code-destroy_action" class="hyperref">Listing <span class="ref">10.58</span></a> also adds <code>:destroy</code> to the <code>logged_in_user</code> before filter.</p>
<div class="codelisting" id="code-destroy_action" data-tralics-id="uid1315" data-number="10.58"><div class="heading"><span class="number">Listing 10.58:</span> 

<span class="description">Adding a working <code>destroy</code> action.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="hll">  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
</span>  <span class="n">before_action</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
<span class="hll">    <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
</span><span class="hll">    <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"User deleted"</span>
</span><span class="hll">    <span class="n">redirect_to</span> <span class="n">users_url</span>
</span>  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that the <code>destroy</code> action uses method chaining to combine the <code>find</code> and <code>destroy</code> into one line:</p>
<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
</pre></div></div>
<p>As constructed, only admins can destroy users through the web since only they can see the delete links, but there’s still a terrible security hole: any sufficiently sophisticated attacker could simply issue a <code class="tt">DELETE</code> request directly from the command line to delete any user on the site.<span class="intersentencespace"></span> To secure the site properly, we also need access control on the <code>destroy</code> action, so that <em>only</em> admins can delete users.</p>
<p>As in <a href="updating_and_deleting_users_fragment.html#sec-requiring_logged_in_users" class="hyperref">Section <span class="ref">10.2.1</span></a> and <a href="updating_and_deleting_users_fragment.html#sec-requiring_the_right_user" class="hyperref">Section <span class="ref">10.2.2</span></a>, we’ll enforce access control using a before filter, this time to restrict access to the <code>destroy</code> action to admins.<span class="intersentencespace"></span> The resulting <code>admin_user</code> before filter appears in <a href="updating_and_deleting_users_fragment.html#code-admin_destroy_before_filter" class="hyperref">Listing <span class="ref">10.59</span></a>.</p>
<div class="codelisting" id="code-admin_destroy_before_filter" data-tralics-id="uid1316" data-number="10.59"><div class="heading"><span class="number">Listing 10.59:</span> 

<span class="description">A before filter restricting the <code>destroy</code> action to admins.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">before_action</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
<span class="hll">  <span class="n">before_action</span> <span class="ss">:admin_user</span><span class="p">,</span>     <span class="ss">only</span><span class="p">:</span> <span class="ss">:destroy</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="c1"># Confirms an admin user.</span>
    <span class="k">def</span> <span class="nf">admin_user</span>
<span class="hll">      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_url</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user</span><span class="o">.</span><span class="n">admin?</span>
</span>    <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div>
<div id="sec-exercises_the_destroy_action" data-tralics-id="uid1317" class="subsubsection" data-number="10.4.2.1"><h4><a href="#sec-exercises_the_destroy_action" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>As the admin user, destroy a few sample users through the web interface.<span class="intersentencespace"></span> What are the corresponding entries in the server log? <span class="exercise" id="ex-6dd2ae"></span>
</li></ol>
</div></div>
<div id="sec-user_destroy_tests" data-tralics-id="uid1319" class="subsection" data-number="10.4.3"><h3><a href="updating_and_deleting_users_fragment.html#sec-user_destroy_tests" class="heading hyperref"><span class="number">10.4.3 </span>User destroy tests</a></h3>
<p>With something as dangerous as destroying users, it’s important to have good tests for the expected behavior.<span class="intersentencespace"></span> We start by arranging for one of our fixture users to be an admin, as shown in <a href="updating_and_deleting_users_fragment.html#code-fixture_user_admin" class="hyperref">Listing <span class="ref">10.60</span></a>.</p>
<div class="codelisting" id="code-fixture_user_admin" data-tralics-id="uid1320" data-number="10.60"><div class="heading"><span class="number">Listing 10.60:</span> 

<span class="description">Making one of the fixture users an admin.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">test/fixtures/users.yml</span></span>
</div>

<div class="code"><div class="highlight"><pre>michael:
  name: Michael Example
  email: michael@example.com
  password_digest: &lt;%= User.digest('password') %&gt;
<span class="hll">  admin: true
</span>
archer:
  name: Sterling Archer
  email: duchess@example.gov
  password_digest: &lt;%= User.digest('password') %&gt;

lana:
  name: Lana Kane
  email: hands@example.gov
  password_digest: &lt;%= User.digest('password') %&gt;

malory:
  name: Malory Archer
  email: boss@example.gov
  password_digest: &lt;%= User.digest('password') %&gt;

&lt;% 30.times do |n| %&gt;
user_&lt;%= n %&gt;:
  name:  &lt;%= "User #{n}" %&gt;
  email: &lt;%= "user-#{n}@example.com" %&gt;
  password_digest: &lt;%= User.digest('password') %&gt;
&lt;% end %&gt;
</pre></div></div></div><p>Following the practice from <a href="updating_and_deleting_users_fragment.html#sec-requiring_logged_in_users" class="hyperref">Section <span class="ref">10.2.1</span></a>, we’ll put action-level tests of access control in the Users controller test file.<span class="intersentencespace"></span> As with the logout test in <a href="basic_login_fragment.html#code-user_logout_test" class="hyperref">Listing <span class="ref">8.31</span></a>, we’ll use <code>delete</code> to issue a <code class="tt">DELETE</code> request directly to the <code>destroy</code> action.<span class="intersentencespace"></span> We need to check two cases: first, users who aren’t logged in should be redirected to the login page; second, users who are logged in but who aren’t admins should be redirected to the Home page.<span class="intersentencespace"></span> The result appears in <a href="updating_and_deleting_users_fragment.html#code-action_tests_admin" class="hyperref">Listing <span class="ref">10.61</span></a>.</p>
<div class="codelisting" id="code-action_tests_admin" data-tralics-id="uid1321" data-number="10.61"><div class="heading"><span class="number">Listing 10.61:</span> 

<span class="description">Action-level tests for admin access control.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/controllers/users_controller_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span>       <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="vi">@other_user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"should redirect destroy when not logged in"</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span> <span class="s1">'User.count'</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should redirect destroy when logged in as a non-admin"</span> <span class="k">do</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@other_user</span><span class="p">)</span>
    <span class="n">assert_no_difference</span> <span class="s1">'User.count'</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">assert_redirected_to</span> <span class="n">root_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that <a href="updating_and_deleting_users_fragment.html#code-action_tests_admin" class="hyperref">Listing <span class="ref">10.61</span></a> also makes sure that the user count doesn’t change using the <code>assert_no_difference</code> method (seen before in <a href="sign_up_fragment.html#code-a_test_for_invalid_submission" class="hyperref">Listing <span class="ref">7.23</span></a>).</p>
<p>The tests in <a href="updating_and_deleting_users_fragment.html#code-action_tests_admin" class="hyperref">Listing <span class="ref">10.61</span></a> verify the behavior in the case of an unauthorized (non-admin) user, but we also want to check that an admin can use a delete link to successfully destroy a user.<span class="intersentencespace"></span> Since the delete links appear on the users index, we’ll add these tests to the users index test from <a href="updating_and_deleting_users_fragment.html#code-user_index_test" class="hyperref">Listing <span class="ref">10.48</span></a>.<span class="intersentencespace"></span> The only really tricky part is verifying that a user gets deleted when an admin clicks on a delete link, which we’ll accomplish as follows:</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_difference</span> <span class="s1">'User.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span>
  <span class="n">delete</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@other_user</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p>This uses the <code>assert_difference</code> method first seen in <a href="sign_up_fragment.html#code-a_test_for_valid_submission" class="hyperref">Listing <span class="ref">7.33</span></a> when creating a user, this time verifying that a user is <em>destroyed</em> by checking that <code>User.count</code> changes by <span class="inline_math">\( -1 \)</span> when issuing a <code>delete</code> request to the corresponding user path.</p>
<p>Putting everything together gives the pagination and delete test in <a href="updating_and_deleting_users_fragment.html#code-delete_link_integration_test" class="hyperref">Listing <span class="ref">10.62</span></a>, which includes tests for both admins and non-admins.</p>
<div class="codelisting" id="code-delete_link_integration_test" data-tralics-id="uid1322" data-number="10.62"><div class="heading"><span class="number">Listing 10.62:</span> 

<span class="description">An integration test for delete links and destroying users.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/users_index_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersIndexTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@admin</span>     <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="vi">@non_admin</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"index as admin including pagination and delete links"</span> <span class="k">do</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@admin</span><span class="p">)</span>
    <span class="n">get</span> <span class="n">users_path</span>
    <span class="n">assert_template</span> <span class="s1">'users/index'</span>
    <span class="n">assert_select</span> <span class="s1">'div.pagination'</span>
    <span class="n">first_page_of_users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">first_page_of_users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
      <span class="n">assert_select</span> <span class="s1">'a[href=?]'</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">),</span> <span class="ss">text</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span>
      <span class="k">unless</span> <span class="n">user</span> <span class="o">==</span> <span class="vi">@admin</span>
        <span class="n">assert_select</span> <span class="s1">'a[href=?]'</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">),</span> <span class="ss">text</span><span class="p">:</span> <span class="s1">'delete'</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">assert_difference</span> <span class="s1">'User.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@non_admin</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"index as non-admin"</span> <span class="k">do</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@non_admin</span><span class="p">)</span>
    <span class="n">get</span> <span class="n">users_path</span>
    <span class="n">assert_select</span> <span class="s1">'a'</span><span class="p">,</span> <span class="ss">text</span><span class="p">:</span> <span class="s1">'delete'</span><span class="p">,</span> <span class="ss">count</span><span class="p">:</span> <span class="mi">0</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Note that <a href="updating_and_deleting_users_fragment.html#code-delete_link_integration_test" class="hyperref">Listing <span class="ref">10.62</span></a> checks for the right delete links, including skipping the test if the user happens to be the admin (which lacks a delete link due to <a href="updating_and_deleting_users_fragment.html#code-delete_links" class="hyperref">Listing <span class="ref">10.57</span></a>).</p>
<p>At this point, our deletion code is well-tested, and the test suite should be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid1323" data-tralics-id="uid1323" data-number="10.63"><div class="heading"><span class="number">Listing 10.63:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div>
<div id="sec-exercises_user_destroy_tests" data-tralics-id="uid1324" class="subsubsection" data-number="10.4.3.1"><h4><a href="#sec-exercises_user_destroy_tests" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>By commenting out the admin user before filter in <a href="updating_and_deleting_users_fragment.html#code-admin_destroy_before_filter" class="hyperref">Listing <span class="ref">10.59</span></a>, confirm that the tests go <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>. <span class="exercise" id="ex-1069ae"></span>
</li></ol>
</div></div></div><div id="sec-updating_and_deleting_users_conclusion" data-tralics-id="cid59" class="section" data-number="10.5"><h2><a href="updating_and_deleting_users_fragment.html#sec-updating_and_deleting_users_conclusion" class="heading hyperref"><span class="number">10.5 </span>Conclusion</a></h2>
<p>We’ve come a long way since introducing the Users controller way back in <a href="filling_in_the_layout_fragment.html#sec-user_signup" class="hyperref">Section <span class="ref">5.4</span></a>.<span class="intersentencespace"></span> Those users couldn’t even sign up; now users can sign up, log in, log out, view their profiles, edit their settings, and see an index of all users—and some can even destroy other users.</p>
<p>As it presently stands, the sample application forms a solid foundation for any website requiring users with authentication and authorization.<span class="intersentencespace"></span> In <a href="account_activation_fragment.html#cha-account_activation" class="hyperref">Chapter <span class="ref">11</span></a> and <a href="password_reset_fragment.html#cha-password_reset" class="hyperref">Chapter <span class="ref">12</span></a>, we’ll add two additional refinements: an account activation link for newly registered users (verifying a valid email address in the process) and password resets to help users who forget their passwords.</p>
<p>Before moving on, be sure to merge all the changes into the master branch:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add -A
<span class="gp">$</span> git commit -m <span class="s2">"Finish user edit, update, index, and destroy actions"</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge updating-users
<span class="gp">$</span> git push
</pre></div></div>
<p>You can also deploy the application and even populate the production database with sample users (using the <code>pg:reset</code> task to reset the production database):</p>
<div class="code"><div class="highlight"><pre>$ rails test
$ git push heroku
$ heroku pg:reset DATABASE
$ heroku run rails db:migrate
$ heroku run rails db:seed
$ heroku restart
</pre></div></div>
<p>Of course, on a real site you probably wouldn’t want to seed it with sample data, but I include it here for purposes of illustration (<a href="updating_and_deleting_users_fragment.html#fig-heroku_sample_users" class="hyperref">Figure <span class="ref">10.16</span></a>).<span class="intersentencespace"></span> Incidentally, the order of the sample users in <a href="updating_and_deleting_users_fragment.html#fig-heroku_sample_users" class="hyperref">Figure <span class="ref">10.16</span></a> may vary, and on my system doesn’t match the local version from <a href="updating_and_deleting_users_fragment.html#fig-user_index_pagination" class="hyperref">Figure <span class="ref">10.11</span></a>; this is because we haven’t specified a default ordering for users when retrieved from the database, so the current order is database-dependent.<span class="intersentencespace"></span> This doesn’t matter much for users, but it will for microposts, and we’ll address this issue further in <a href="user_microposts_fragment.html#sec-ordering_and_dependency" class="hyperref">Section <span class="ref">13.1.4</span></a>.</p>
<div class="center figure" id="fig-heroku_sample_users" data-tralics-id="uid1326" data-number="10.16">
<div class="graphics image"><img src="images/figures/heroku_sample_users.png" alt="images/figures/heroku_sample_users"></div><div class="caption"><span class="header">Figure 10.16: </span><span class="description">The sample users in production.
</span></div></div>
<div id="sec-updating_what_we_learned_in_this_chapter" data-tralics-id="uid1327" class="subsection" data-number="10.5.1"><h3><a href="updating_and_deleting_users_fragment.html#sec-updating_what_we_learned_in_this_chapter" class="heading hyperref"><span class="number">10.5.1 </span>What we learned in this chapter</a></h3>
<ul>
<li>Users can be updated using an edit form, which sends a <code class="tt">PATCH</code> request to the <code>update</code> action.
</li>
<li>Safe updating through the web is enforced using strong parameters.
</li>
<li>Before filters give a standard way to run methods before particular controller actions.
</li>
<li>We implement an authorization using before filters.
</li>
<li>Authorization tests use both low-level commands to submit particular HTTP requests directly to controller actions and high-level integration tests.
</li>
<li>Friendly forwarding redirects users where they wanted to go after logging in.
</li>
<li>The users index page shows all users, one page at a time.
</li>
<li>Rails uses the standard file <code>db/seeds.rb</code> to seed the database with sample data using <code>rails db:seed</code>.
</li>
<li>Running <code>render @users</code> automatically calls the <code>_user.html.erb</code> partial on each user in the collection.
</li>
<li>A boolean attribute called <code>admin</code> on the User model automatically creates an <code>admin?</code> boolean method on user objects.
</li>
<li>Admins can delete users through the web by clicking on delete links that issue <code class="tt">DELETE</code> requests to the Users controller <code>destroy</code> action.
</li>
<li>We can create a large number of test users using embedded Ruby inside fixtures.
</li></ul>
</div></div><div id="cha-10_footnotes">
  <ol class="footnotes">
    <li id="cha-10_footnote-1">Image retrieved from http://www.flickr.com/photos/sashawolff/4598355045/ on 2014-08-25.<span class="intersentencespace"></span> Copyright © 2010 by Sasha Wolff and used unaltered under the terms of the <a href="https://creativecommons.org/licenses/by/2.0/" target="_blank" rel="noopener">Creative Commons Attribution 2.0 Generic</a> license. <a class="arrow" href="#cha-10_footnote-ref-1">↑</a></li>
    <li id="cha-10_footnote-2">Don’t worry about how this works; the details are of interest to developers of the Rails framework itself, and by design are not important for Rails application developers. <a class="arrow" href="#cha-10_footnote-ref-2">↑</a></li>
    <li id="cha-10_footnote-3">Thanks to Jose Carlos Montero Gómez for a suggestion that further reduced duplication in the <code>new</code> and <code>edit</code> partials. <a class="arrow" href="#cha-10_footnote-ref-3">↑</a></li>
    <li id="cha-10_footnote-4">The command for before filters used to be called <code>before_filter</code>, but the Rails core team decided to rename it to emphasize that the filter takes place before particular controller actions. <a class="arrow" href="#cha-10_footnote-ref-4">↑</a></li>
    <li id="cha-10_footnote-5">The code in this section is adapted from the <a href="http://github.com/thoughtbot/clearance" target="_blank" rel="noopener">Clearance</a> gem by <a href="http://thoughtbot.com/" target="_blank" rel="noopener">thoughtbot</a>. <a class="arrow" href="#cha-10_footnote-ref-5">↑</a></li>
    <li id="cha-10_footnote-6">Thanks to reader Yoel Adler for pointing out this subtle issue, and for discovering the solution. <a class="arrow" href="#cha-10_footnote-ref-6">↑</a></li>
    <li id="cha-10_footnote-7">Image retriefed from http://www.flickr.com/photos/glasgows/338937124/ on 2014-08-25.<span class="intersentencespace"></span> Copyright © 2008 by M&amp;R Glasgow and used unaltered under the terms of the <a href="https://creativecommons.org/licenses/by/2.0/" target="_blank" rel="noopener">Creative Commons Attribution 2.0 Generic</a> license. <a class="arrow" href="#cha-10_footnote-ref-7">↑</a></li>
    <li id="cha-10_footnote-8">This is the same authorization model used by Twitter. <a class="arrow" href="#cha-10_footnote-ref-8">↑</a></li>
    <li id="cha-10_footnote-9">As always, you should use the version numbers listed at <a href="http://gemfiles-4th-ed.railstutorial.org/" target="_blank" rel="noopener">gemfiles-4th-ed.railstutorial.org</a> instead of the ones listed here. <a class="arrow" href="#cha-10_footnote-ref-9">↑</a></li>
    <li id="cha-10_footnote-10">In principle, these two tasks can be combined in <code>rails db:reset</code>, but as of this writing this command doesn’t work with the latest version of Rails. <a class="arrow" href="#cha-10_footnote-ref-10">↑</a></li>
    <li id="cha-10_footnote-11">As always, you should use the version numbers listed at <a href="http://gemfiles-4th-ed.railstutorial.org/" target="_blank" rel="noopener">gemfiles-4th-ed.railstutorial.org</a> instead of the ones listed here. <a class="arrow" href="#cha-10_footnote-ref-11">↑</a></li>
    <li id="cha-10_footnote-12">The name <code>user</code> is immaterial—we could have written <code>@users.each do |foobar|</code> and then used <code>render foobar</code>.<span class="intersentencespace"></span> The key is the <em>class</em> of the object—in this case, <code>User</code>. <a class="arrow" href="#cha-10_footnote-ref-12">↑</a></li>
    <li id="cha-10_footnote-13">Command-line tools such as <code class="tt">curl</code> can issue <code class="tt">PATCH</code> requests of this form. <a class="arrow" href="#cha-10_footnote-ref-13">↑</a></li>
    <li id="cha-10_footnote-14">See the RailsCast on “<a href="http://railscasts.com/episodes/77-destroy-without-javascript" target="_blank" rel="noopener">Destroy Without JavaScript</a>” for details. <a class="arrow" href="#cha-10_footnote-ref-14">↑</a></li>
  </ol>
</div>rb      XX=e)XL  a,:https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial_4th_edition/html/updating_and_deleting_users_fragment.html?X-Amz-Expires=604800&X-Amz-Date=20170202T100457Z&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20170202/us-west-2/s3/aws4_request&X-Amz-SignedHeaders=host&X-Amz-Signature=313c9a957bd70ef5d5bd6bfc2264698da8016b861af81892a918c3025798e178 security-info FnhllAKWRHGAlo+ESXykKAAAAAAAAAAAwAAAAAAAAEaphjoj9ApAYLLhYqsrhSapAAQAAgAAAAAAAAAAAAAAACw4N6+LhUposNgK7YiYWzI/H82DxalM0aJQdnbKfH40ZgoyJpFcT/u7IImFpjLfBfjtg2TO2UxuhrpIr1PDk+YAAAAAAAAGGzCCBhcwggT/oAMCAQICEAkMEh1kGcxPzNQuULyfEo0wDQYJKoZIhvcNAQELBQAwZDELMAkGA1UEBhMCVVMxFTATBgNVBAoTDERpZ2lDZXJ0IEluYzEZMBcGA1UECxMQd3d3LmRpZ2ljZXJ0LmNvbTEjMCEGA1UEAxMaRGlnaUNlcnQgQmFsdGltb3JlIENBLTIgRzIwHhcNMTYwNzE4MDAwMDAwWhcNMTcxMDI2MTIwMDAwWjB1MQswCQYDVQQGEwJVUzETMBEGA1UECBMKV2FzaGluZ3RvbjEQMA4GA1UEBxMHU2VhdHRsZTEYMBYGA1UEChMPQW1hem9uLmNvbSBJbmMuMSUwIwYDVQQDDBwqLnMzLXVzLXdlc3QtMi5hbWF6b25hd3MuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtPtaIwJ9+anWiEq/qLdHgQkQ51FdpjU3C/o1HSP3DGHcijP8q6gpOQ2GIT4xaAOOEstz5v5WY8kOfEE0UXsyB8LxmNyu4nPz4gEE1jCKXaFaMQUexl2nz1hNBCzabnDV10EB2+XPOWPw1troTgtKWuBxZ4EaC7dQXkgpqSqzcio33y9sZHlcEa2ok0DMgxTaEY0ryVdODJMlTIVoFwzkiedRV3dl7yRK8EqWMfWnVJzJ2JVMRqakWjQeLE+8oeo4F0m6BEch9qpIA8JV20oFv0cQLM6QQNFzX2EN/2v5uBtrB5g/g39+5Yu+kgkfhedTSkFunjEGol8G7jssC3jijwIDAQABo4ICsjCCAq4wHwYDVR0jBBgwFoAUwBKyKHRoRmfpcCV0GgBFWwZ9XEQwHQYDVR0OBBYEFF1JaGNuDmFfuVhgXPTd3tg4yz2iMIHhBgNVHREEgdkwgdaCGnMzLXVzLXdlc3QtMi5hbWF6b25hd3MuY29tghwqLnMzLXVzLXdlc3QtMi5hbWF6b25hd3MuY29tghpzMy51cy13ZXN0LTIuYW1hem9uYXdzLmNvbYIcKi5zMy51cy13ZXN0LTIuYW1hem9uYXdzLmNvbYIkczMuZHVhbHN0YWNrLnVzLXdlc3QtMi5hbWF6b25hd3MuY29tgiYqLnMzLmR1YWxzdGFjay51cy13ZXN0LTIuYW1hem9uYXdzLmNvbYISKi5zMy5hbWF6b25hd3MuY29tMA4GA1UdDwEB/wQEAwIFoDAdBgNVHSUEFjAUBggrBgEFBQcDAQYIKwYBBQUHAwIwgYEGA1UdHwR6MHgwOqA4oDaGNGh0dHA6Ly9jcmwzLmRpZ2ljZXJ0LmNvbS9EaWdpQ2VydEJhbHRpbW9yZUNBLTJHMi5jcmwwOqA4oDaGNGh0dHA6Ly9jcmw0LmRpZ2ljZXJ0LmNvbS9EaWdpQ2VydEJhbHRpbW9yZUNBLTJHMi5jcmwwTAYDVR0gBEUwQzA3BglghkgBhv1sAQEwKjAoBggrBgEFBQcCARYcaHR0cHM6Ly93d3cuZGlnaWNlcnQuY29tL0NQUzAIBgZngQwBAgIweQYIKwYBBQUHAQEEbTBrMCQGCCsGAQUFBzABhhhodHRwOi8vb2NzcC5kaWdpY2VydC5jb20wQwYIKwYBBQUHMAKGN2h0dHA6Ly9jYWNlcnRzLmRpZ2ljZXJ0LmNvbS9EaWdpQ2VydEJhbHRpbW9yZUNBLTJHMi5jcnQwDAYDVR0TAQH/BAIwADANBgkqhkiG9w0BAQsFAAOCAQEAYH38ntfWdhwWcuD895IsKMmdlnbReTnnEKe6n6tldoxpWEJkjMA0hURZnZrbr5FL3ar6bWF9wnFKMYPxMfjhNzpB8/lbp63yZSDmVpDIsOIRWjkdcMsnpBHDHQWPV9T7fIgxT4WqAK92O3kQs1+bmsuXISBelIMev1G02BYa7EDD8JZyoltleTcs8rzvRRgE37GfxAtu07fxQqyDSvj7ojpSoIUmTVDVJMTGCkSemYpdR3DqTzmsej6eV7TbLdvFTjFnRJ4Zdehb17CoVvkOTB1v/oXaabIIi3UEsDu3UpxdB7mU4G1qgy8XDMitAtpBL6+EIw0QKw5+JoSuzbybEgAAAIAAAACAAAAAJVRMU19FQ0RIRV9SU0FfV0lUSF9BRVNfMTI4X0dDTV9TSEEyNTYAAAABAAA= request-method GET request-Origin https://www.railstutorial.org response-head HTTP/1.1 200 OK
x-amz-id-2: jkYt6jZtOqk40J7zUUWLM4yJnFoMleECLOuLQOLPIgMQrihM/YHDJWCsbuxEgpLzNV90f8Aepkg=
x-amz-request-id: D21579389F7EC8F1
Date: Thu, 02 Feb 2017 11:07:17 GMT
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: GET
Access-Control-Max-Age: 3000
Vary: Origin, Access-Control-Request-Headers, Access-Control-Request-Method
Last-Modified: Thu, 22 Dec 2016 05:29:25 GMT
Etag: "bdac4275328bd76f08f9dafe0280d08b"
Accept-Ranges: bytes
Content-Type: text/html
Content-Length: 247557
Server: AmazonS3
 uncompressed-len 0  