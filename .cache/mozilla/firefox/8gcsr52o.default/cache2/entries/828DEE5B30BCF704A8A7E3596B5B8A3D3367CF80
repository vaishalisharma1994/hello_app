<div id="cha-following_users" data-tralics-id="cid79" class="chapter" data-number="14" data-chapter="following_users"><h1><a href="following_users_fragment.html#cha-following_users" class="heading hyperref"><span class="number">Chapter 14 </span>Following users</a></h1>
<p>In this chapter, we will complete the Rails Tutorial sample application by adding a social layer that allows users to follow (and unfollow) other users, resulting in each user’s Home page displaying a status feed of the followed users’ microposts.<span class="intersentencespace"></span> We’ll start by learning how to model relationships between users in <a href="following_users_fragment.html#sec-the_relationship_model" class="hyperref">Section <span class="ref">14.1</span></a>, and we’ll build the corresponding web interface in <a href="following_users_fragment.html#sec-a_web_interface_for_following_and_followers" class="hyperref">Section <span class="ref">14.2</span></a> (including an introduction to Ajax).<span class="intersentencespace"></span> We’ll end by developing a fully functional status feed in <a href="following_users_fragment.html#sec-the_status_feed" class="hyperref">Section <span class="ref">14.3</span></a>.</p>
<p>This final chapter contains some of the most challenging material in the tutorial, including some Ruby/SQL trickery to make the status feed.<span class="intersentencespace"></span> Through these examples, you will see how Rails can handle even rather intricate data models, which should serve you well as you go on to develop your own applications with their own specific requirements.<span class="intersentencespace"></span> To help with the transition from tutorial to independent development, <a href="following_users_fragment.html#sec-following_conclusion" class="hyperref">Section <span class="ref">14.4</span></a> offers some pointers to more advanced resources.</p>
<p>Because the material in this chapter is particularly challenging, before writing any code we’ll pause for a moment and take a tour of the interface.<span class="intersentencespace"></span> As in previous chapters, at this early stage we’ll represent pages using mockups.<sup id="cha-14_footnote-ref-1" class="footnote"><a href="#cha-14_footnote-1">1</a></sup><span class="intersentencespace"></span> The full page flow runs as follows: a user (John Calvin) starts at his profile page (<a href="following_users_fragment.html#fig-page_flow_profile_mockup" class="hyperref">Figure <span class="ref">14.1</span></a>) and navigates to the Users page (<a href="following_users_fragment.html#fig-page_flow_user_index_mockup" class="hyperref">Figure <span class="ref">14.2</span></a>) to select a user to follow.<span class="intersentencespace"></span> Calvin navigates to the profile of a second user, Thomas Hobbes (<a href="following_users_fragment.html#fig-page_flow_other_profile_follow_button" class="hyperref">Figure <span class="ref">14.3</span></a>), clicking on the “Follow” button to follow that user.<span class="intersentencespace"></span> This changes the “Follow” button to “Unfollow” and increments Hobbes’s “followers” count by one (<a href="following_users_fragment.html#fig-page_flow_other_profile_unfollow_button_mockup" class="hyperref">Figure <span class="ref">14.4</span></a>).<span class="intersentencespace"></span> Navigating to his home page, Calvin now sees an incremented “following” count and finds Hobbes’s microposts in his status feed (<a href="following_users_fragment.html#fig-page_flow_home_page_feed_mockup" class="hyperref">Figure <span class="ref">14.5</span></a>).<span class="intersentencespace"></span> The rest of this chapter is dedicated to making this page flow actually work.</p>
<div class="center figure" id="fig-page_flow_profile_mockup" data-tralics-id="uid1766" data-number="14.1">
<div class="graphics image box"><img src="images/figures/page_flow_profile_mockup_3rd_edition.png" alt="images/figures/page_flow_profile_mockup_3rd_edition"></div><div class="caption"><span class="header">Figure 14.1: </span><span class="description">A current user’s profile.
</span></div></div>
<div class="center figure" id="fig-page_flow_user_index_mockup" data-tralics-id="uid1767" data-number="14.2">
<div class="graphics image box"><img src="images/figures/page_flow_user_index_mockup_bootstrap.png" alt="images/figures/page_flow_user_index_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 14.2: </span><span class="description">Finding a user to follow.
</span></div></div>
<div class="center figure" id="fig-page_flow_other_profile_follow_button" data-tralics-id="uid1768" data-number="14.3">
<div class="graphics image box"><img src="images/figures/page_flow_other_profile_follow_button_mockup_3rd_edition.png" alt="images/figures/page_flow_other_profile_follow_button_mockup_3rd_edition"></div><div class="caption"><span class="header">Figure 14.3: </span><span class="description">The profile of a user to follow, with a follow button.
</span></div></div>
<div class="center figure" id="fig-page_flow_other_profile_unfollow_button_mockup" data-tralics-id="uid1769" data-number="14.4">
<div class="graphics image box"><img src="images/figures/page_flow_other_profile_unfollow_button_mockup_3rd_edition.png" alt="images/figures/page_flow_other_profile_unfollow_button_mockup_3rd_edition"></div><div class="caption"><span class="header">Figure 14.4: </span><span class="description">A profile with an unfollow button and incremented followers count.
</span></div></div>
<div class="center figure" id="fig-page_flow_home_page_feed_mockup" data-tralics-id="uid1770" data-number="14.5">
<div class="graphics image box"><img src="images/figures/page_flow_home_page_feed_mockup_3rd_edition.png" alt="images/figures/page_flow_home_page_feed_mockup_3rd_edition"></div><div class="caption"><span class="header">Figure 14.5: </span><span class="description">The Home page with status feed and incremented following count.
</span></div></div>
</div><div id="sec-the_relationship_model" data-tralics-id="cid80" class="section" data-number="14.1"><h2><a href="following_users_fragment.html#sec-the_relationship_model" class="heading hyperref"><span class="number">14.1 </span>The Relationship model</a></h2>
<p>Our first step in implementing following users is to construct a data model, which is not as straightforward as it seems.<span class="intersentencespace"></span> Naïvely, it seems that a <code>has_many</code> relationship would do: a user <code>has_many</code> followed users and <code>has_many</code> followers.<span class="intersentencespace"></span> As we will see, there is a problem with this approach, and we’ll learn how to fix it using <code>has_many :through</code>.</p>
<p>As usual, Git users should create a new topic branch:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b following-users
</pre></div></div>
<div id="sec-a_problem_with_the_data_model" data-tralics-id="uid1771" class="subsection" data-number="14.1.1"><h3><a href="following_users_fragment.html#sec-a_problem_with_the_data_model" class="heading hyperref"><span class="number">14.1.1 </span>A problem with the data model (and a solution)</a></h3>
<p>As a first step toward constructing a data model for following users, let’s examine a typical case.<span class="intersentencespace"></span> For instance, consider a user who follows a second user: we could say that, e.g., Calvin is following Hobbes, and Hobbes is followed by Calvin, so that Calvin is the <em>follower</em> and Hobbes is <em>followed</em>.<span class="intersentencespace"></span> Using Rails’ default pluralization convention, the set of all users following a given user is that user’s <em>followers</em>, and <code>hobbes.followers</code> is an array of those users.<span class="intersentencespace"></span> Unfortunately, the reverse doesn’t work: by default, the set of all followed users would be called the <em>followeds</em>, which is ungrammatical and clumsy.<span class="intersentencespace"></span> We’ll adopt Twitter’s convention and call them <em>following</em> (as in “50 following, 75 followers”), with a corresponding <code>calvin.following</code> array.</p>
<p>This discussion suggests modeling the followed users as in <a href="following_users_fragment.html#fig-naive_user_has_many_following" class="hyperref">Figure <span class="ref">14.6</span></a>, with a <code>following</code> table and a <code>has_many</code> association.<span class="intersentencespace"></span> Since <code>user.following</code> should be a collection of users, each row of the <code>following</code> table would need to be a user, as identified by the <code>followed_id</code>, together with the <code>follower_id</code> to establish the association.<sup id="cha-14_footnote-ref-2" class="footnote"><a href="#cha-14_footnote-2">2</a></sup><span class="intersentencespace"></span> In addition, since each row is a user, we would need to include the user’s other attributes, including the name, email, password, etc.</p>
<div class="center figure" id="fig-naive_user_has_many_following" data-tralics-id="uid1773" data-number="14.6">
<div class="graphics image"><img src="images/figures/naive_user_has_many_following.png" alt="images/figures/naive_user_has_many_following"></div><div class="caption"><span class="header">Figure 14.6: </span><span class="description">A naïve implementation of user following.
</span></div></div>
<p>The problem with the data model in <a href="following_users_fragment.html#fig-naive_user_has_many_following" class="hyperref">Figure <span class="ref">14.6</span></a> is that it is terribly redundant: each row contains not only each followed user’s id, but all their other information as well—all of which is <em>already</em> in the <code>users</code> table.<span class="intersentencespace"></span> Even worse, to model user <em>followers</em> we would need a separate, similarly redundant <code>followers</code> table.<span class="intersentencespace"></span> Finally, this data model is a maintainability nightmare: each time a user changed (say) their name, we would need to update not just the user’s record in the <code>users</code> table but also <em>every row containing that user</em>
in both the <code>following</code> and <code>followers</code> tables.</p>
<p>The problem here is that we are missing an underlying abstraction.<span class="intersentencespace"></span> One way to find the proper model is to consider how we might implement the act of <em>following</em> in a web application.<span class="intersentencespace"></span> Recall from <a href="sign_up_fragment.html#sec-a_users_resource" class="hyperref">Section <span class="ref">7.1.2</span></a> that the REST architecture involves <em>resources</em> that are created and destroyed.<span class="intersentencespace"></span> This leads us to ask two questions: When a user follows another user, what is being created?<span class="intersentencespace"></span> When a user <em>un</em>follows another user, what is being destroyed?<span class="intersentencespace"></span> Upon reflection, we see that in these cases the application should either create or destroy a <em>relationship</em> between two users.<span class="intersentencespace"></span> A user then has many relationships, and has many <code>following</code> (or <code>followers</code>) <em>through</em> these relationships.</p>
<p>There’s an additional detail we need to address regarding our application’s data model: unlike symmetric Facebook-style friendships, which are always reciprocal (at least at the data-model level), Twitter-style following relationships are potentially <em>asymmetric</em>—Calvin can follow Hobbes without Hobbes following Calvin.<span class="intersentencespace"></span> To distinguish between these two cases, we’ll adopt the terminology of <em>active</em> and <em>passive</em> relationships: if Calvin is following Hobbes but not vice versa, Calvin has an active relationship with Hobbes and Hobbes has a passive relationship with Calvin.<sup id="cha-14_footnote-ref-3" class="footnote"><a href="#cha-14_footnote-3">3</a></sup></p>
<p>We’ll focus now on using active relationships to generate a list of followed users, and consider the passive case in <a href="following_users_fragment.html#sec-followers" class="hyperref">Section <span class="ref">14.1.5</span></a>.<span class="intersentencespace"></span> <a href="following_users_fragment.html#fig-naive_user_has_many_following" class="hyperref">Figure <span class="ref">14.6</span></a> suggests how to implement it: since each followed user is uniquely identified by <code>followed_id</code>, we could convert <code>following</code> to an <code>active_relationships</code> table, omit the user details, and use <code>followed_id</code> to retrieve the followed user from the <code>users</code> table.<span class="intersentencespace"></span> A diagram of the data model appears in <a href="following_users_fragment.html#fig-user_has_many_following" class="hyperref">Figure <span class="ref">14.7</span></a>.</p>
<div class="center figure" id="fig-user_has_many_following" data-tralics-id="uid1775" data-number="14.7">
<div class="graphics image"><img src="images/figures/user_has_many_following_3rd_edition.png" alt="images/figures/user_has_many_following_3rd_edition"></div><div class="caption"><span class="header">Figure 14.7: </span><span class="description">A model of followed users through active relationships.
</span></div></div>
<p>Because we’ll end up using the same database table for both active and passive relationships, we’ll use the generic term <em>relationship</em> for the table name, with a corresponding Relationship model.<span class="intersentencespace"></span> The result is the Relationship data model shown in <a href="following_users_fragment.html#fig-relationship_model" class="hyperref">Figure <span class="ref">14.8</span></a>.<span class="intersentencespace"></span> We’ll see starting in <a href="following_users_fragment.html#sec-following" class="hyperref">Section <span class="ref">14.1.4</span></a> how to use the Relationship model to simulate both Active Relationship and Passive Relationship models.</p>
<div class="center figure" id="fig-relationship_model" data-tralics-id="uid1776" data-number="14.8">
<div class="graphics image"><img src="images/figures/relationship_model.png" alt="images/figures/relationship_model"></div><div class="caption"><span class="header">Figure 14.8: </span><span class="description">The Relationship data model.
</span></div></div>
<p>To get started with the implementation, we first generate a migration corresponding to <a href="following_users_fragment.html#fig-relationship_model" class="hyperref">Figure <span class="ref">14.8</span></a>:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate model Relationship follower_id:integer followed_id:integer
</pre></div></div>
<p>Because we will be finding relationships by <code>follower_id</code> and by <code>followed_id</code>, we should add an index on each column for efficiency, as shown in <a href="following_users_fragment.html#code-relationships_migration" class="hyperref">Listing <span class="ref">14.1</span></a>.</p>
<div class="codelisting" id="code-relationships_migration" data-tralics-id="uid1777" data-number="14.1"><div class="heading"><span class="number">Listing 14.1:</span> 

<span class="description">Adding indices for the <code>relationships</code> table.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">db/migrate/[timestamp]_create_relationships.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateRelationships</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="o">[</span><span class="mi">5</span><span class="o">.</span><span class="mi">0</span><span class="o">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:relationships</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:follower_id</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:followed_id</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>
<span class="hll">    <span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:follower_id</span>
</span><span class="hll">    <span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:followed_id</span>
</span><span class="hll">    <span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="o">[</span><span class="ss">:follower_id</span><span class="p">,</span> <span class="ss">:followed_id</span><span class="o">]</span><span class="p">,</span> <span class="ss">unique</span><span class="p">:</span> <span class="kp">true</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p><a href="following_users_fragment.html#code-relationships_migration" class="hyperref">Listing <span class="ref">14.1</span></a> also includes a multiple-key index that enforces uniqueness on (<code>follower_id</code>, <code>followed_id</code>) pairs, so that a user can’t follow another user more than once.<span class="intersentencespace"></span> (Compare to the email uniqueness index from <a href="modeling_users_fragment.html#code-email_uniqueness_index" class="hyperref">Listing <span class="ref">6.29</span></a> and the multiple-key index in <a href="user_microposts_fragment.html#code-micropost_migration" class="hyperref">Listing <span class="ref">13.3</span></a>.)<span class="intersentencespace"></span> As we’ll see starting in <a href="following_users_fragment.html#sec-following" class="hyperref">Section <span class="ref">14.1.4</span></a>, our user interface won’t allow this to happen, but adding a unique index arranges to raise an error if a user tries to create duplicate relationships anyway (for example, by using a command-line tool such as <code>curl</code>).</p>
<p>To create the <code>relationships</code> table, we migrate the database as usual:</p>
<div class="code"><div class="highlight"><pre>$ rails db:migrate
</pre></div></div>
<div id="sec-exercises_a_problem_with_the_data_model" data-tralics-id="uid1778" class="subsubsection" data-number="14.1.1.1"><h4><a href="#sec-exercises_a_problem_with_the_data_model" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>For the user with id equal to <code>1</code> from <a href="following_users_fragment.html#fig-user_has_many_following" class="hyperref">Figure <span class="ref">14.7</span></a>, what would the value of <code>user.following.map(&amp;:id)</code> be?<span class="intersentencespace"></span> (Recall the <code>map(&amp;:method_name)</code> pattern from <a href="rails_flavored_ruby_fragment.html#sec-blocks" class="hyperref">Section <span class="ref">4.3.2</span></a>; <code>user.following.map(&amp;:id)</code> just returns the array of ids.) <span class="exercise" id="ex-a7cab2"></span>
</li>
<li>By referring again to <a href="following_users_fragment.html#fig-user_has_many_following" class="hyperref">Figure <span class="ref">14.7</span></a>, determine the ids of <code>user.following</code> for the user with id equal to <code>2</code>.<span class="intersentencespace"></span> What would the value of <code>user.following.map(&amp;:id)</code> be for this user? <span class="exercise" id="ex-47cec8"></span>
</li></ol>
</div></div>
<div id="sec-relationship_user_associations" data-tralics-id="uid1781" class="subsection" data-number="14.1.2"><h3><a href="following_users_fragment.html#sec-relationship_user_associations" class="heading hyperref"><span class="number">14.1.2 </span>User/relationship associations</a></h3>
<p>Before implementing user following and followers, we first need to establish the association between users and relationships.<span class="intersentencespace"></span> A user <code>has_many</code> relationships, and—since relationships involve <em>two</em> users—a relationship <code>belongs_to</code> both a follower and a followed user.</p>
<p>As with microposts in <a href="user_microposts_fragment.html#sec-user_micropost_associations" class="hyperref">Section <span class="ref">13.1.3</span></a>, we will create new relationships using the user association, with code such as</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">active_relationships</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">followed_id</span><span class="p">:</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div></div>
<p>At this point, you might expect application code as in <a href="user_microposts_fragment.html#sec-user_micropost_associations" class="hyperref">Section <span class="ref">13.1.3</span></a>, and it’s similar, but there are two key differences.</p>
<p>First, in the case of the user/micropost association we could write</p>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
<p>This works because by convention Rails looks for a Micropost model corresponding to the <code>:microposts</code> symbol.<sup id="cha-14_footnote-ref-4" class="footnote"><a href="#cha-14_footnote-4">4</a></sup><span class="intersentencespace"></span> In the present case, though, we want to write</p>
<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:active_relationships</span>
</pre></div></div>
<p>even though the underlying model is called Relationship.<span class="intersentencespace"></span> We will thus have to tell Rails the model class name to look for.</p>
<p>Second, before we wrote</p>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div>
<p>in the Micropost model.<span class="intersentencespace"></span> This works because the <code>microposts</code> table has a <code>user_id</code> attribute to identify the user (<a href="user_microposts_fragment.html#sec-the_basic_model" class="hyperref">Section <span class="ref">13.1.1</span></a>).<span class="intersentencespace"></span> An id used in this manner to connect two database tables is known as a <em>foreign key</em>, and when the foreign key for a User model object is <code>user_id</code>, Rails infers the association automatically: by default, Rails expects a foreign key of the form <code>&lt;class&gt;_id</code>, where <code>&lt;class&gt;</code> is the lower-case version of the class name.<sup id="cha-14_footnote-ref-5" class="footnote"><a href="#cha-14_footnote-5">5</a></sup><span class="intersentencespace"></span> In the present case, although we are still dealing with users, the user following another user is now identified with the foreign key <code>follower_id</code>, so we have to tell that to Rails.</p>
<p>The result of the above discussion is the user/relationship association shown in <a href="following_users_fragment.html#code-user_relationships_association" class="hyperref">Listing <span class="ref">14.2</span></a> and <a href="following_users_fragment.html#code-relationship_belongs_to" class="hyperref">Listing <span class="ref">14.3</span></a>.</p>
<div class="codelisting" id="code-user_relationships_association" data-tralics-id="uid1784" data-number="14.2"><div class="heading"><span class="number">Listing 14.2:</span> 

<span class="description">Implementing the active relationships <code>has_many</code> association.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>
<span class="hll">  <span class="n">has_many</span> <span class="ss">:active_relationships</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span>  <span class="s2">"Relationship"</span><span class="p">,</span>
</span><span class="hll">                                  <span class="ss">foreign_key</span><span class="p">:</span> <span class="s2">"follower_id"</span><span class="p">,</span>
</span><span class="hll">                                  <span class="ss">dependent</span><span class="p">:</span>   <span class="ss">:destroy</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>(Since destroying a user should also destroy that user’s relationships, we’ve added <code>dependent: :destroy</code> to the association.)</p>
<div class="codelisting" id="code-relationship_belongs_to" data-tralics-id="uid1785" data-number="14.3"><div class="heading"><span class="number">Listing 14.3:</span> 

<span class="description">Adding the follower <code>belongs_to</code> association to the Relationship model.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/relationship.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Relationship</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="hll">  <span class="n">belongs_to</span> <span class="ss">:follower</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span> <span class="s2">"User"</span>
</span><span class="hll">  <span class="n">belongs_to</span> <span class="ss">:followed</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span> <span class="s2">"User"</span>
</span><span class="k">end</span>
</pre></div></div></div><p>The <code>followed</code> association isn’t actually needed until <a href="following_users_fragment.html#sec-following" class="hyperref">Section <span class="ref">14.1.4</span></a>, but the parallel follower/followed structure is clearer if we implement them both at the same time.</p>
<p>The relationships in <a href="following_users_fragment.html#code-user_relationships_association" class="hyperref">Listing <span class="ref">14.2</span></a> and <a href="following_users_fragment.html#code-relationship_belongs_to" class="hyperref">Listing <span class="ref">14.3</span></a> give rise to methods analogous to the ones we saw in <a href="user_microposts_fragment.html#table-association_methods" class="hyperref">Table <span class="ref">13.1</span></a>, as shown in <a href="following_users_fragment.html#table-association_methods_relationships" class="hyperref">Table <span class="ref">14.1</span></a>.</p>
<div class="table" id="table-association_methods_relationships" data-tralics-id="uid1786" data-number="14.1"><table class="tabular">
<tbody><tr class="bottom_border"><td class="align_left"><strong>Method</strong></td>
<td class="align_left"><strong>Purpose</strong></td>
</tr><tr><td class="align_left"><code>active_relationship.follower</code></td>
<td class="align_left">Returns the follower</td>
</tr><tr><td class="align_left"><code>active_relationship.followed</code></td>
<td class="align_left">Returns the followed user</td>
</tr><tr><td class="align_left"><code>user.active_relationships.create(followed_id: other_user.id)</code></td>
<td class="align_left">Creates an active relationship associated with <code>user</code></td>
</tr><tr><td class="align_left"><code>user.active_relationships.create!(followed_id: other_user.id)</code></td>
<td class="align_left">Creates an active relationship associated with <code>user</code> (exception on failure)</td>
</tr><tr><td class="align_left"><code>user.active_relationships.build(followed_id: other_user.id)</code></td>
<td class="align_left">Returns a new Relationship object associated with <code>user</code></td>
</tr></tbody></table><div class="caption"><span class="header">Table 14.1: </span><span class="description">A summary of user/active relationship association methods.
</span></div></div>
<div id="sec-exercises_relationship_user_associations" data-tralics-id="uid1787" class="subsubsection" data-number="14.1.2.1"><h4><a href="#sec-exercises_relationship_user_associations" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Using the <code>create</code> method from <a href="following_users_fragment.html#table-association_methods_relationships" class="hyperref">Table <span class="ref">14.1</span></a> in the console, create an active relationship for the first user in the database where the followed id is the second user. <span class="exercise" id="ex-158b52"></span>
</li>
<li>Confirm that the values for <code>active_relationship.followed</code> and <code>active_relationship.follower</code> are correct. <span class="exercise" id="ex-bc5326"></span>
</li></ol>
</div></div>
<div id="sec-relationship_validations" data-tralics-id="uid1790" class="subsection" data-number="14.1.3"><h3><a href="following_users_fragment.html#sec-relationship_validations" class="heading hyperref"><span class="number">14.1.3 </span>Relationship validations</a></h3>
<p>Before moving on, we’ll add a couple of Relationship model validations for completeness.<span class="intersentencespace"></span> The tests (<a href="following_users_fragment.html#code-relationship_validation_tests" class="hyperref">Listing <span class="ref">14.4</span></a>) and application code (<a href="following_users_fragment.html#code-relationship_validations" class="hyperref">Listing <span class="ref">14.5</span></a>) are straightforward.<span class="intersentencespace"></span> As with the generated user fixture from <a href="modeling_users_fragment.html#code-default_fixtures" class="hyperref">Listing <span class="ref">6.30</span></a>, the generated relationship fixture also violates the uniqueness constraint imposed by the corresponding migration (<a href="following_users_fragment.html#code-relationships_migration" class="hyperref">Listing <span class="ref">14.1</span></a>).<span class="intersentencespace"></span> The solution—removing the fixture contents as in <a href="modeling_users_fragment.html#code-empty_fixtures" class="hyperref">Listing <span class="ref">6.31</span></a>—is also the same, as seen in <a href="following_users_fragment.html#code-empty_relationship_fixture" class="hyperref">Listing <span class="ref">14.6</span></a>.</p>
<div class="codelisting" id="code-relationship_validation_tests" data-tralics-id="uid1791" data-number="14.4"><div class="heading"><span class="number">Listing 14.4:</span> 

<span class="description">Testing the Relationship model validations.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">test/models/relationship_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">RelationshipTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@relationship</span> <span class="o">=</span> <span class="no">Relationship</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">follower_id</span><span class="p">:</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                     <span class="ss">followed_id</span><span class="p">:</span> <span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should be valid"</span> <span class="k">do</span>
    <span class="n">assert</span> <span class="vi">@relationship</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should require a follower_id"</span> <span class="k">do</span>
    <span class="vi">@relationship</span><span class="o">.</span><span class="n">follower_id</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">assert_not</span> <span class="vi">@relationship</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should require a followed_id"</span> <span class="k">do</span>
    <span class="vi">@relationship</span><span class="o">.</span><span class="n">followed_id</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">assert_not</span> <span class="vi">@relationship</span><span class="o">.</span><span class="n">valid?</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="code-relationship_validations" data-tralics-id="uid1792" data-number="14.5"><div class="heading"><span class="number">Listing 14.5:</span> 

<span class="description">Adding the Relationship model validations.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/relationship.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Relationship</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:follower</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span> <span class="s2">"User"</span>
  <span class="n">belongs_to</span> <span class="ss">:followed</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span> <span class="s2">"User"</span>
<span class="hll">  <span class="n">validates</span> <span class="ss">:follower_id</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
</span><span class="hll">  <span class="n">validates</span> <span class="ss">:followed_id</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
</span><span class="k">end</span>
</pre></div></div></div><div class="codelisting" id="code-empty_relationship_fixture" data-tralics-id="uid1793" data-number="14.6"><div class="heading"><span class="number">Listing 14.6:</span> 

<span class="description">Removing the contents of the relationship fixture.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/fixtures/relationships.yml</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="c1"># empty</span>
</pre></div></div></div><p>At this point, the tests should be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid1794" data-tralics-id="uid1794" data-number="14.7"><div class="heading"><span class="number">Listing 14.7:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div>
<div id="sec-exercises_relationship_validations" data-tralics-id="uid1795" class="subsubsection" data-number="14.1.3.1"><h4><a href="#sec-exercises_relationship_validations" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Verify by commenting out the validations in <a href="following_users_fragment.html#code-relationship_validations" class="hyperref">Listing <span class="ref">14.5</span></a> that the tests still pass.<span class="intersentencespace"></span> (This is a change as of Rails 5, and in previous versions of Rails the validations are required.<span class="intersentencespace"></span> We’ll plan to leave them in for completeness, but it’s worth bearing in mind that you may see these validations omitted in other people’s code.) <span class="exercise" id="ex-0003a9"></span>
</li></ol>
</div></div>
<div id="sec-following" data-tralics-id="uid1797" class="subsection" data-number="14.1.4"><h3><a href="following_users_fragment.html#sec-following" class="heading hyperref"><span class="number">14.1.4 </span>Followed users</a></h3>
<p>We come now to the heart of the Relationship associations: <code>following</code> and <code>followers</code>.<span class="intersentencespace"></span> Here we will use <code>has_many :through</code> for the first time: a user has many following <em>through</em> relationships, as illustrated in <a href="following_users_fragment.html#fig-user_has_many_following" class="hyperref">Figure <span class="ref">14.7</span></a>.<span class="intersentencespace"></span> By default, in a <code>has_many :through</code> association Rails looks for a foreign key corresponding to the singular version of the association.<span class="intersentencespace"></span> In other words, with code like</p>
<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:followeds</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:active_relationships</span>
</pre></div></div>
<p>Rails would see “followeds” and use the singular “followed”, assembling a collection using the <code>followed_id</code> in the <code>relationships</code> table.<span class="intersentencespace"></span> But, as noted in <a href="following_users_fragment.html#sec-a_problem_with_the_data_model" class="hyperref">Section <span class="ref">14.1.1</span></a>, <code>user.followeds</code> is rather awkward, so we’ll write <code>user.following</code> instead.<span class="intersentencespace"></span> Naturally, Rails allows us to override the default, in this case using the <code>source</code> parameter (as shown in <a href="following_users_fragment.html#code-has_many_following_through_active_relationships" class="hyperref">Listing <span class="ref">14.8</span></a>), which explicitly tells Rails that the source of the <code>following</code> array is the set of <code>followed</code> ids.</p>
<div class="codelisting" id="code-has_many_following_through_active_relationships" data-tralics-id="uid1798" data-number="14.8"><div class="heading"><span class="number">Listing 14.8:</span> 

<span class="description">Adding the User model <code>following</code> association.<span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:active_relationships</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span>  <span class="s2">"Relationship"</span><span class="p">,</span>
                                  <span class="ss">foreign_key</span><span class="p">:</span> <span class="s2">"follower_id"</span><span class="p">,</span>
                                  <span class="ss">dependent</span><span class="p">:</span>   <span class="ss">:destroy</span>
<span class="hll">  <span class="n">has_many</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:active_relationships</span><span class="p">,</span> <span class="ss">source</span><span class="p">:</span> <span class="ss">:followed</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>The association defined in <a href="following_users_fragment.html#code-has_many_following_through_active_relationships" class="hyperref">Listing <span class="ref">14.8</span></a> leads to a powerful combination of Active Record and array-like behavior.<span class="intersentencespace"></span> For example, we can check if the followed users collection includes another user with the <code>include?</code> method (<a href="rails_flavored_ruby_fragment.html#sec-arrays_and_ranges" class="hyperref">Section <span class="ref">4.3.1</span></a>), or find objects through the association:</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
<span class="n">user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
</pre></div></div>
<p>We can also add and delete elements just as with arrays:</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">following</span> <span class="o">&lt;&lt;</span> <span class="n">other_user</span>
<span class="n">user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
</pre></div></div>
<p>(Recall from <a href="rails_flavored_ruby_fragment.html#sec-arrays_and_ranges" class="hyperref">Section <span class="ref">4.3.1</span></a> that the shovel operator <code>&lt;&lt;</code> appends to the end of an array.)</p>
<p>Although in many contexts we can effectively treat <code>following</code> as an array, Rails is smart about how it handles things under the hood.<span class="intersentencespace"></span> For example, code like</p>
<div class="code"><div class="highlight"><pre><span class="n">following</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
</pre></div></div>
<p>looks like it might have to pull all the followed users out of the database to apply the <code>include?</code> method, but in fact for efficiency Rails arranges for the comparison to happen directly in the database.<span class="intersentencespace"></span> (Compare to the code in <a href="user_microposts_fragment.html#sec-rendering_microposts" class="hyperref">Section <span class="ref">13.2.1</span></a>, where we saw that</p>
<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span>
</pre></div></div>
<p>performs the count directly in the database.)</p>
<p>To manipulate following relationships, we’ll introduce <code>follow</code> and <code>unfollow</code> utility methods so that we can write, e.g., <code>user.follow(other_user)</code>.<span class="intersentencespace"></span> We’ll also add an associated <code>following?</code> boolean method to test if one user is following another.<sup id="cha-14_footnote-ref-6" class="footnote"><a href="#cha-14_footnote-6">6</a></sup></p>
<p>This is exactly the kind of situation where I like to write some tests first.<span class="intersentencespace"></span> The reason is that we are quite far from writing a working web interface for following users, but it’s hard to proceed without some sort of <em>client</em> for the code we’re developing.<span class="intersentencespace"></span> In this case, it’s easy to write a short test for the User model, in which we use <code>following?</code> to make sure the user isn’t following the other user, use <code>follow</code> to follow another user, use <code>following?</code> to verify that the operation succeeded, and finally <code>unfollow</code> and verify that it worked.<span class="intersentencespace"></span> The result appears in <a href="following_users_fragment.html#code-utility_method_tests" class="hyperref">Listing <span class="ref">14.9</span></a>.</p>
<div class="codelisting" id="code-utility_method_tests" data-tralics-id="uid1800" data-number="14.9"><div class="heading"><span class="number">Listing 14.9:</span> 

<span class="description">Tests for some “following” utility methods.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"should follow and unfollow a user"</span> <span class="k">do</span>
    <span class="n">michael</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="n">archer</span>  <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="n">michael</span><span class="o">.</span><span class="n">following?</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
    <span class="n">michael</span><span class="o">.</span><span class="n">follow</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
    <span class="n">assert</span> <span class="n">michael</span><span class="o">.</span><span class="n">following?</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
    <span class="n">michael</span><span class="o">.</span><span class="n">unfollow</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="n">michael</span><span class="o">.</span><span class="n">following?</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>By treating the <code>following</code> association as an array, we can write the <code>follow</code>, <code>unfollow</code>, and <code>following?</code> methods as shown in <a href="following_users_fragment.html#code-follow_unfollow_following" class="hyperref">Listing <span class="ref">14.10</span></a>.<span class="intersentencespace"></span> (Note that we have omitted the user <code>self</code> variable whenever possible.)</p>
<div class="codelisting" id="code-follow_unfollow_following" data-tralics-id="uid1801" data-number="14.10"><div class="heading"><span class="number">Listing 14.10:</span> 

<span class="description">Utility methods for following.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">feed</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="c1"># Follows a user.</span>
  <span class="k">def</span> <span class="nf">follow</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
<span class="hll">    <span class="n">following</span> <span class="o">&lt;&lt;</span> <span class="n">other_user</span>
</span>  <span class="k">end</span>

  <span class="c1"># Unfollows a user.</span>
  <span class="k">def</span> <span class="nf">unfollow</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
<span class="hll">    <span class="n">following</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="c1"># Returns true if the current user is following the other user.</span>
  <span class="k">def</span> <span class="nf">following?</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
<span class="hll">    <span class="n">following</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>With the code in <a href="following_users_fragment.html#code-follow_unfollow_following" class="hyperref">Listing <span class="ref">14.10</span></a>, the tests should be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid1802" data-tralics-id="uid1802" data-number="14.11"><div class="heading"><span class="number">Listing 14.11:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div>
<div id="sec-exercises_following" data-tralics-id="uid1803" class="subsubsection" data-number="14.1.4.1"><h4><a href="#sec-exercises_following" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>At the console, replicate the steps shown in <a href="following_users_fragment.html#code-utility_method_tests" class="hyperref">Listing <span class="ref">14.9</span></a>. <span class="exercise" id="ex-c750b5"></span>
</li>
<li>What is the SQL for each of the commands in the previous exercise? <span class="exercise" id="ex-0876ac"></span>
</li></ol>
</div></div>
<div id="sec-followers" data-tralics-id="uid1806" class="subsection" data-number="14.1.5"><h3><a href="following_users_fragment.html#sec-followers" class="heading hyperref"><span class="number">14.1.5 </span>Followers</a></h3>
<p>The final piece of the relationships puzzle is to add a <code>user.followers</code> method to go with <code>user.following</code>.<span class="intersentencespace"></span> You may have noticed from <a href="following_users_fragment.html#fig-user_has_many_following" class="hyperref">Figure <span class="ref">14.7</span></a> that all the information needed to extract an array of followers is already present in the <code>relationships</code> table (which we are treating as the <code>active_relationships</code> table via the code in <a href="following_users_fragment.html#code-user_relationships_association" class="hyperref">Listing <span class="ref">14.2</span></a>).<span class="intersentencespace"></span> Indeed, the technique is exactly the same as for followed users, with the roles of <code>follower_id</code> and <code>followed_id</code> reversed, and with <code>passive_relationships</code> in place of <code>active_relationships</code>.<span class="intersentencespace"></span> The data model then appears as in <a href="following_users_fragment.html#fig-user_has_many_followers" class="hyperref">Figure <span class="ref">14.9</span></a>.</p>
<div class="center figure" id="fig-user_has_many_followers" data-tralics-id="uid1807" data-number="14.9">
<div class="graphics image"><img src="images/figures/user_has_many_followers_3rd_edition.png" alt="images/figures/user_has_many_followers_3rd_edition"></div><div class="caption"><span class="header">Figure 14.9: </span><span class="description">A model for user followers through passive relationships.
</span></div></div>
<p>The implementation of the data model in <a href="following_users_fragment.html#fig-user_has_many_followers" class="hyperref">Figure <span class="ref">14.9</span></a> parallels <a href="following_users_fragment.html#code-has_many_following_through_active_relationships" class="hyperref">Listing <span class="ref">14.8</span></a> exactly, as seen in <a href="following_users_fragment.html#code-has_many_following_through_passive_relationships" class="hyperref">Listing <span class="ref">14.12</span></a>.</p>
<div class="codelisting" id="code-has_many_following_through_passive_relationships" data-tralics-id="uid1808" data-number="14.12"><div class="heading"><span class="number">Listing 14.12:</span> 

<span class="description">Implementing <code>user.followers</code> using passive relationships.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:active_relationships</span><span class="p">,</span>  <span class="ss">class_name</span><span class="p">:</span>  <span class="s2">"Relationship"</span><span class="p">,</span>
                                   <span class="ss">foreign_key</span><span class="p">:</span> <span class="s2">"follower_id"</span><span class="p">,</span>
                                   <span class="ss">dependent</span><span class="p">:</span>   <span class="ss">:destroy</span>
<span class="hll">  <span class="n">has_many</span> <span class="ss">:passive_relationships</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span>  <span class="s2">"Relationship"</span><span class="p">,</span>
</span><span class="hll">                                   <span class="ss">foreign_key</span><span class="p">:</span> <span class="s2">"followed_id"</span><span class="p">,</span>
</span><span class="hll">                                   <span class="ss">dependent</span><span class="p">:</span>   <span class="ss">:destroy</span>
</span>  <span class="n">has_many</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:active_relationships</span><span class="p">,</span>  <span class="ss">source</span><span class="p">:</span> <span class="ss">:followed</span>
<span class="hll">  <span class="n">has_many</span> <span class="ss">:followers</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:passive_relationships</span><span class="p">,</span> <span class="ss">source</span><span class="p">:</span> <span class="ss">:follower</span>
</span>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>It’s worth noting that we could actually omit the <code>:source</code> key for <code>followers</code> in <a href="following_users_fragment.html#code-has_many_following_through_passive_relationships" class="hyperref">Listing <span class="ref">14.12</span></a>, using simply</p>
<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:followers</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:passive_relationships</span>
</pre></div></div>
<p>This is because, in the case of a <code>:followers</code> attribute, Rails will singularize “followers” and automatically look for the foreign key <code>follower_id</code> in this case.<span class="intersentencespace"></span> <a href="following_users_fragment.html#code-has_many_following_through_passive_relationships" class="hyperref">Listing <span class="ref">14.12</span></a> keeps the <code>:source</code> key to emphasize the parallel structure with the <code>has_many :following</code> association.</p>
<p>We can conveniently test the data model above using the <code>followers.include?</code> method, as shown in <a href="following_users_fragment.html#code-followers_test" class="hyperref">Listing <span class="ref">14.13</span></a>.<span class="intersentencespace"></span> (<a href="following_users_fragment.html#code-followers_test" class="hyperref">Listing <span class="ref">14.13</span></a> might have used a <code>followed_by?</code> method to complement the <code>following?</code> method, but it turns out we won’t need it in our application.)</p>
<div class="codelisting" id="code-followers_test" data-tralics-id="uid1809" data-number="14.13"><div class="heading"><span class="number">Listing 14.13:</span> 

<span class="description">A test for <code>followers</code>.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"should follow and unfollow a user"</span> <span class="k">do</span>
    <span class="n">michael</span>  <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="n">archer</span>   <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="n">michael</span><span class="o">.</span><span class="n">following?</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
    <span class="n">michael</span><span class="o">.</span><span class="n">follow</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
    <span class="n">assert</span> <span class="n">michael</span><span class="o">.</span><span class="n">following?</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
<span class="hll">    <span class="n">assert</span> <span class="n">archer</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">michael</span><span class="p">)</span>
</span>    <span class="n">michael</span><span class="o">.</span><span class="n">unfollow</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="n">michael</span><span class="o">.</span><span class="n">following?</span><span class="p">(</span><span class="n">archer</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p><a href="following_users_fragment.html#code-followers_test" class="hyperref">Listing <span class="ref">14.13</span></a> adds only one line to the test from <a href="following_users_fragment.html#code-utility_method_tests" class="hyperref">Listing <span class="ref">14.9</span></a>, but so many things have to go right to get it to pass that it’s a very sensitive test of the code in <a href="following_users_fragment.html#code-has_many_following_through_passive_relationships" class="hyperref">Listing <span class="ref">14.12</span></a>.</p>
<p>At this point, the full test suite should be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div>
<div id="sec-exercises_followers" data-tralics-id="uid1810" class="subsubsection" data-number="14.1.5.1"><h4><a href="#sec-exercises_followers" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>At the console, create several followers for the first user in the database (which you should call <code>user</code>).<span class="intersentencespace"></span> What is the value of <code>user.followers.map(&amp;:id)</code>? <span class="exercise" id="ex-a97f17"></span>
</li>
<li>Confirm that <code>user.followers.count</code> matches the number of followers you created in the previous exercise. <span class="exercise" id="ex-61e463"></span>
</li>
<li>What is the SQL used by <code>user.followers.count</code>?<span class="intersentencespace"></span> How is this different from <code>user.followers.to_a.count</code>?<span class="intersentencespace"></span> <em>Hint</em>: Suppose that the user had a million followers. <span class="exercise" id="ex-c79c64"></span>
</li></ol>
</div></div></div><div id="sec-a_web_interface_for_following_and_followers" data-tralics-id="cid81" class="section" data-number="14.2"><h2><a href="following_users_fragment.html#sec-a_web_interface_for_following_and_followers" class="heading hyperref"><span class="number">14.2 </span>A web interface for following users</a></h2>
<p><a href="following_users_fragment.html#sec-the_relationship_model" class="hyperref">Section <span class="ref">14.1</span></a> placed some rather heavy demands on our data modeling skills, and it’s fine if it takes a while to soak in.<span class="intersentencespace"></span> In fact, one of the best ways to understand the associations is to use them in the web interface.</p>
<p>In the introduction to this chapter, we saw a preview of the page flow for user following.<span class="intersentencespace"></span> In this section, we will implement the basic interface and following/unfollowing functionality shown in those mockups.<span class="intersentencespace"></span> We will also make separate pages to show the user following and followers arrays.<span class="intersentencespace"></span> In <a href="following_users_fragment.html#sec-the_status_feed" class="hyperref">Section <span class="ref">14.3</span></a>, we’ll complete our sample application by adding the user’s status feed.</p>
<div id="sec-sample_following_data" data-tralics-id="uid1814" class="subsection" data-number="14.2.1"><h3><a href="following_users_fragment.html#sec-sample_following_data" class="heading hyperref"><span class="number">14.2.1 </span>Sample following data</a></h3>
<p>As in previous chapters, we will find it convenient to use <code>rails db:seed</code> to fill the database with sample relationships.<span class="intersentencespace"></span> This will allow us to design the look and feel of the web pages first, deferring the back-end functionality until later in this section.</p>
<p>Code to seed the following relationships appears in <a href="following_users_fragment.html#code-sample_relationships" class="hyperref">Listing <span class="ref">14.14</span></a>.<span class="intersentencespace"></span> Here we somewhat arbitrarily arrange for the first user to follow users 3 through 51, and then have users 4 through 41 follow that user back.<span class="intersentencespace"></span> The resulting relationships will be sufficient for developing the application interface.</p>
<div class="codelisting" id="code-sample_relationships" data-tralics-id="uid1815" data-number="14.14"><div class="heading"><span class="number">Listing 14.14:</span> 

<span class="description">Adding following/follower relationships to the sample data.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">db/seeds.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="c1"># Users</span>
<span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span>  <span class="s2">"Example User"</span><span class="p">,</span>
             <span class="ss">email</span><span class="p">:</span> <span class="s2">"example@railstutorial.org"</span><span class="p">,</span>
             <span class="ss">password</span><span class="p">:</span>              <span class="s2">"foobar"</span><span class="p">,</span>
             <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s2">"foobar"</span><span class="p">,</span>
             <span class="ss">admin</span><span class="p">:</span>     <span class="kp">true</span><span class="p">,</span>
             <span class="ss">activated</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
             <span class="ss">activated_at</span><span class="p">:</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>

<span class="mi">99</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
  <span class="nb">name</span>  <span class="o">=</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Name</span><span class="o">.</span><span class="n">name</span>
  <span class="n">email</span> <span class="o">=</span> <span class="s2">"example-</span><span class="si">#{</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">@railstutorial.org"</span>
  <span class="n">password</span> <span class="o">=</span> <span class="s2">"password"</span>
  <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span>  <span class="nb">name</span><span class="p">,</span>
               <span class="ss">email</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
               <span class="ss">password</span><span class="p">:</span>              <span class="n">password</span><span class="p">,</span>
               <span class="ss">password_confirmation</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
               <span class="ss">activated</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
               <span class="ss">activated_at</span><span class="p">:</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1"># Microposts</span>
<span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="ss">:created_at</span><span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="mi">50</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
  <span class="n">content</span> <span class="o">=</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Lorem</span><span class="o">.</span><span class="n">sentence</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
  <span class="n">users</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">content</span><span class="p">:</span> <span class="n">content</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="hll"><span class="c1"># Following relationships</span>
</span><span class="hll"><span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span>
</span><span class="hll"><span class="n">user</span>  <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">first</span>
</span><span class="hll"><span class="n">following</span> <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">2</span><span class="o">.</span><span class="n">.</span><span class="mi">50</span><span class="o">]</span>
</span><span class="hll"><span class="n">followers</span> <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">3</span><span class="o">.</span><span class="n">.</span><span class="mi">40</span><span class="o">]</span>
</span><span class="hll"><span class="n">following</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">followed</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">follow</span><span class="p">(</span><span class="n">followed</span><span class="p">)</span> <span class="p">}</span>
</span><span class="hll"><span class="n">followers</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">follower</span><span class="o">|</span> <span class="n">follower</span><span class="o">.</span><span class="n">follow</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
</span></pre></div></div></div><p>To execute the code in <a href="following_users_fragment.html#code-sample_relationships" class="hyperref">Listing <span class="ref">14.14</span></a>, we reset and reseed the database as usual:</p>
<div class="code"><div class="highlight"><pre>$ rails db:migrate:reset
$ rails db:seed
</pre></div></div>
<div id="sec-exercises_sample_following_data" data-tralics-id="uid1816" class="subsubsection" data-number="14.2.1.1"><h4><a href="#sec-exercises_sample_following_data" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Using the console, confirm that <code>User.first.followers.count</code> matches the value expected from <a href="following_users_fragment.html#code-sample_relationships" class="hyperref">Listing <span class="ref">14.14</span></a>. <span class="exercise" id="ex-a7b803"></span>
</li>
<li>Confirm that <code>User.first.following.count</code> is correct as well. <span class="exercise" id="ex-b4bbb0"></span>
</li></ol>
</div></div>
<div id="sec-stats_and_a_follow_form" data-tralics-id="uid1819" class="subsection" data-number="14.2.2"><h3><a href="following_users_fragment.html#sec-stats_and_a_follow_form" class="heading hyperref"><span class="number">14.2.2 </span>Stats and a follow form</a></h3>
<p>Now that our sample users have both followed users and followers, we need to update the profile page and Home page to reflect this.<span class="intersentencespace"></span> We’ll start by making a partial to display the following and follower statistics on the profile and home pages.<span class="intersentencespace"></span> We’ll next add a follow/unfollow form, and then make dedicated pages for showing “following” (followed users) and “followers”.</p>
<p>As noted in <a href="following_users_fragment.html#sec-a_problem_with_the_data_model" class="hyperref">Section <span class="ref">14.1.1</span></a>, we’ll adopt Twitter’s convention of using “following” as a label for followed users, as in “50 following”.<span class="intersentencespace"></span> This usage is reflected in the mockup sequence starting in <a href="following_users_fragment.html#fig-page_flow_profile_mockup" class="hyperref">Figure <span class="ref">14.1</span></a> and shown in close-up in <a href="following_users_fragment.html#fig-stats_partial_mockup" class="hyperref">Figure <span class="ref">14.10</span></a>.</p>
<div class="center figure" id="fig-stats_partial_mockup" data-tralics-id="uid1820" data-number="14.10"><span class="graphics"><img src="images/figures/stats_partial_mockup.png" alt="stats_partial_mockup"></span>
<div class="caption"><span class="header">Figure 14.10: </span><span class="description">A mockup of the stats partial.
</span></div></div>
<p>The stats in <a href="following_users_fragment.html#fig-stats_partial_mockup" class="hyperref">Figure <span class="ref">14.10</span></a> consist of the number of users the current user is following and the number of followers, each of which should be a link to its respective dedicated display page.<span class="intersentencespace"></span> In <a href="filling_in_the_layout_fragment.html#cha-filling_in_the_layout" class="hyperref">Chapter <span class="ref">5</span></a>, we stubbed out such links with the dummy text <code>’#’</code>, but that was before we had much experience with routes.<span class="intersentencespace"></span> This time, although we’ll defer the actual pages to <a href="following_users_fragment.html#sec-following_and_followers_pages" class="hyperref">Section <span class="ref">14.2.3</span></a>, we’ll make the routes now, as seen in <a href="following_users_fragment.html#code-following_followers_actions_routes" class="hyperref">Listing <span class="ref">14.15</span></a>.<span class="intersentencespace"></span> This code uses the <code>:member</code> method inside a <code>resources</code> <em>block</em>, which we haven’t seen before, but see if you can guess what it does.</p>
<div class="codelisting" id="code-following_followers_actions_routes" data-tralics-id="uid1821" data-number="14.15"><div class="heading"><span class="number">Listing 14.15:</span> 

<span class="description">Adding <code>following</code> and <code>followers</code> actions to the Users controller.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">root</span>   <span class="s1">'static_pages#home'</span>
  <span class="n">get</span>    <span class="s1">'/help'</span><span class="p">,</span>    <span class="ss">to</span><span class="p">:</span> <span class="s1">'static_pages#help'</span>
  <span class="n">get</span>    <span class="s1">'/about'</span><span class="p">,</span>   <span class="ss">to</span><span class="p">:</span> <span class="s1">'static_pages#about'</span>
  <span class="n">get</span>    <span class="s1">'/contact'</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">'static_pages#contact'</span>
  <span class="n">get</span>    <span class="s1">'/signup'</span><span class="p">,</span>  <span class="ss">to</span><span class="p">:</span> <span class="s1">'users#new'</span>
  <span class="n">get</span>    <span class="s1">'/login'</span><span class="p">,</span>   <span class="ss">to</span><span class="p">:</span> <span class="s1">'sessions#new'</span>
  <span class="n">post</span>   <span class="s1">'/login'</span><span class="p">,</span>   <span class="ss">to</span><span class="p">:</span> <span class="s1">'sessions#create'</span>
  <span class="n">delete</span> <span class="s1">'/logout'</span><span class="p">,</span>  <span class="ss">to</span><span class="p">:</span> <span class="s1">'sessions#destroy'</span>
<span class="hll">  <span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
</span><span class="hll">    <span class="n">member</span> <span class="k">do</span>
</span><span class="hll">      <span class="n">get</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">:followers</span>
</span><span class="hll">    <span class="k">end</span>
</span><span class="hll">  <span class="k">end</span>
</span>  <span class="n">resources</span> <span class="ss">:account_activations</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:password_resets</span><span class="p">,</span>     <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:microposts</span><span class="p">,</span>          <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
<span class="k">end</span>
</pre></div></div></div><p>You might suspect that the URLs for following and followers will look like /users/1/following and /users/1/followers, and that is exactly what the code in <a href="following_users_fragment.html#code-following_followers_actions_routes" class="hyperref">Listing <span class="ref">14.15</span></a> arranges.<span class="intersentencespace"></span> Since both pages will be <em>showing</em> data, the proper HTTP verb is a <code class="tt">GET</code> request, so we use the <code>get</code> method to arrange for the URLs to respond appropriately.<span class="intersentencespace"></span> Meanwhile, the <code>member</code> method arranges for the routes to respond to URLs containing the user id.<span class="intersentencespace"></span> The other possibility, <code>collection</code>, works without the id, so that</p>
<div class="code"><div class="highlight"><pre><span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
  <span class="n">collection</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:tigers</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>
<p>would respond to the URL /users/tigers (presumably to display all the tigers in our application).<sup id="cha-14_footnote-ref-7" class="footnote"><a href="#cha-14_footnote-7">7</a></sup></p>
<p>A table of the routes generated by <a href="following_users_fragment.html#code-following_followers_actions_routes" class="hyperref">Listing <span class="ref">14.15</span></a> appears in <a href="following_users_fragment.html#table-following_routes" class="hyperref">Table <span class="ref">14.2</span></a>.<span class="intersentencespace"></span> Note the named routes for the followed user and followers pages, which we’ll put to use shortly.</p>
<div class="table" id="table-following_routes" data-tralics-id="uid1823" data-number="14.2"><table class="tabular">
<tbody><tr class="bottom_border"><td class="align_left"><strong>HTTP request</strong></td>
<td class="align_left"><strong>URL</strong></td>
<td class="align_left"><strong>Action</strong></td>
<td class="align_left"><strong>Named route</strong></td>
</tr><tr><td class="align_left"><code class="tt">GET</code></td>
<td class="align_left">/users/1/following</td>
<td class="align_left"><code>following</code></td>
<td class="align_left"><code>following_user_path(1)</code></td>
</tr><tr><td class="align_left"><code class="tt">GET</code></td>
<td class="align_left">/users/1/followers</td>
<td class="align_left"><code>followers</code></td>
<td class="align_left"><code>followers_user_path(1)</code></td>
</tr></tbody></table><div class="caption"><span class="header">Table 14.2: </span><span class="description">RESTful routes provided by the custom rules in resource in <a href="following_users_fragment.html#code-following_followers_actions_routes" class="hyperref">Listing <span class="ref">14.15</span></a>.
</span></div></div>
<p>With the routes defined, we are now in a position to define the stats partial, which involves a couple of links inside a div, as shown in <a href="following_users_fragment.html#code-stats_partial" class="hyperref">Listing <span class="ref">14.16</span></a>.</p>
<div class="codelisting" id="code-stats_partial" data-tralics-id="uid1824" data-number="14.16"><div class="heading"><span class="number">Listing 14.16:</span> 

<span class="description">A partial for displaying follower stats.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/shared/_stats.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="vi">@user</span> <span class="o">||=</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"stats"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">following_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;strong</span> <span class="na">id=</span><span class="s">"following"</span> <span class="na">class=</span><span class="s">"stat"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/strong&gt;</span>
    following
  <span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;strong</span> <span class="na">id=</span><span class="s">"followers"</span> <span class="na">class=</span><span class="s">"stat"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/strong&gt;</span>
    followers
  <span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div><p>Since we will be including the stats on both the user show pages and the home page, the first line of <a href="following_users_fragment.html#code-stats_partial" class="hyperref">Listing <span class="ref">14.16</span></a> picks the right one using</p>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="vi">@user</span> <span class="o">||=</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
</pre></div></div>
<p>As discussed in <a href="basic_login_fragment.html#aside-or_equals" class="hyperref">Box <span class="ref">8.1</span></a>, this does nothing when <code>@user</code> is not <code>nil</code> (as on a profile page), but when it is (as on the Home page) it sets <code>@user</code> to the current user.<span class="intersentencespace"></span> Note also that the following/follower counts are calculated through the associations using</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">count</span>
</pre></div></div>
<p>and</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">count</span>
</pre></div></div>
<p>Compare these to the microposts count from <a href="user_microposts_fragment.html#code-user_show_microposts" class="hyperref">Listing <span class="ref">13.24</span></a>, where we wrote</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span>
</pre></div></div>
<p>to count the microposts.<span class="intersentencespace"></span> As in that case, Rails calculates the count directly in the database for efficiency.</p>
<p>One final detail worth noting is the presence of CSS ids on some elements, as in</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;strong</span> <span class="na">id=</span><span class="s">"following"</span> <span class="na">class=</span><span class="s">"stat"</span><span class="nt">&gt;</span>
...
<span class="nt">&lt;/strong&gt;</span>
</pre></div></div>
<p>This is for the benefit of the Ajax implementation in <a href="following_users_fragment.html#sec-a_working_follow_button_with_ajax" class="hyperref">Section <span class="ref">14.2.5</span></a>, which accesses elements on the page using their unique ids.</p>
<p>With the partial in hand, including the stats on the Home page is easy, as shown in <a href="following_users_fragment.html#code-home_page_stats" class="hyperref">Listing <span class="ref">14.17</span></a>.</p>
<div class="codelisting" id="code-home_page_stats" data-tralics-id="uid1825" data-number="14.17"><div class="heading"><span class="number">Listing 14.17:</span> 

<span class="description">Adding follower stats to the Home page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/static_pages/home.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">logged_in?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">"col-md-4"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"user_info"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/user_info'</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
<span class="hll">      <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"stats"</span><span class="nt">&gt;</span>
</span><span class="hll">        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/stats'</span> <span class="cp">%&gt;</span>
</span><span class="hll">      <span class="nt">&lt;/section&gt;</span>
</span>      <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"micropost_form"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/micropost_form'</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;/aside&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-8"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h3&gt;</span>Micropost Feed<span class="nt">&lt;/h3&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/feed'</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>To style the stats, we’ll add some SCSS, as shown in <a href="following_users_fragment.html#code-stats_css" class="hyperref">Listing <span class="ref">14.18</span></a> (which contains all the stylesheet code needed in this chapter).<span class="intersentencespace"></span> The resulting Home page appears in <a href="following_users_fragment.html#fig-home_page_follow_stats" class="hyperref">Figure <span class="ref">14.11</span></a>.</p>
<div class="codelisting" id="code-stats_css" data-tralics-id="uid1826" data-number="14.18"><div class="heading"><span class="number">Listing 14.18:</span> 

<span class="description">SCSS for the Home page sidebar.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/assets/stylesheets/custom.scss</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="o">/*</span> <span class="nt">sidebar</span> <span class="o">*/</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.gravatar</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.gravatar_edit</span> <span class="p">{</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">15</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>

<span class="hll"><span class="nc">.stats</span> <span class="p">{</span>
</span>  <span class="na">overflow</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="na">padding</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nt">a</span> <span class="p">{</span>
    <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">0</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
    <span class="na">border-left</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nv">$gray-lighter</span><span class="p">;</span>
    <span class="na">color</span><span class="o">:</span> <span class="nb">gray</span><span class="p">;</span>
    <span class="k">&amp;</span><span class="nd">:first-child</span> <span class="p">{</span>
      <span class="na">padding-left</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="na">border</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">&amp;</span><span class="nd">:hover</span> <span class="p">{</span>
      <span class="na">text-decoration</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
      <span class="na">color</span><span class="o">:</span> <span class="nb">blue</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nt">strong</span> <span class="p">{</span>
    <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="hll"><span class="nc">.user_avatars</span> <span class="p">{</span>
</span>  <span class="na">overflow</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="nc">.gravatar</span> <span class="p">{</span>
    <span class="na">margin</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="mi">1</span><span class="kt">px</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nt">a</span> <span class="p">{</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="hll"><span class="nc">.users.follow</span> <span class="p">{</span>
</span>  <span class="na">padding</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* forms */</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
</pre></div></div></div><div class="center figure" id="fig-home_page_follow_stats" data-tralics-id="uid1827" data-number="14.11">
<div class="graphics image"><img src="images/figures/home_page_follow_stats_3rd_edition.png" alt="images/figures/home_page_follow_stats_3rd_edition"></div><div class="caption"><span class="header">Figure 14.11: </span><span class="description">The Home page with follow stats.
</span></div></div>
<p>We’ll render the stats partial on the profile page in a moment, but first let’s make a partial for the follow/unfollow button, as shown in <a href="following_users_fragment.html#code-follow_form_partial" class="hyperref">Listing <span class="ref">14.19</span></a>.</p>
<div class="codelisting" id="code-follow_form_partial" data-tralics-id="uid1828" data-number="14.19"><div class="heading"><span class="number">Listing 14.19:</span> 

<span class="description">A partial for a follow/unfollow form.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/_follow_form.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"follow_form"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">following?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'unfollow'</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'follow'</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>This does nothing but defer the real work to <code>follow</code> and <code>unfollow</code> partials, which need new routes for the Relationships resource, which follows the Microposts resource example (<a href="user_microposts_fragment.html#code-microposts_resource" class="hyperref">Listing <span class="ref">13.30</span></a>), as seen in <a href="following_users_fragment.html#code-relationships_resource" class="hyperref">Listing <span class="ref">14.20</span></a>.</p>
<div class="codelisting" id="code-relationships_resource" data-tralics-id="uid1829" data-number="14.20"><div class="heading"><span class="number">Listing 14.20:</span> 

<span class="description">Adding the routes for user relationships.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">config/routes.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">root</span>                <span class="s1">'static_pages#home'</span>
  <span class="n">get</span>    <span class="s1">'help'</span>    <span class="o">=&gt;</span> <span class="s1">'static_pages#help'</span>
  <span class="n">get</span>    <span class="s1">'about'</span>   <span class="o">=&gt;</span> <span class="s1">'static_pages#about'</span>
  <span class="n">get</span>    <span class="s1">'contact'</span> <span class="o">=&gt;</span> <span class="s1">'static_pages#contact'</span>
  <span class="n">get</span>    <span class="s1">'signup'</span>  <span class="o">=&gt;</span> <span class="s1">'users#new'</span>
  <span class="n">get</span>    <span class="s1">'login'</span>   <span class="o">=&gt;</span> <span class="s1">'sessions#new'</span>
  <span class="n">post</span>   <span class="s1">'login'</span>   <span class="o">=&gt;</span> <span class="s1">'sessions#create'</span>
  <span class="n">delete</span> <span class="s1">'logout'</span>  <span class="o">=&gt;</span> <span class="s1">'sessions#destroy'</span>
  <span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
    <span class="n">member</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">:followers</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">resources</span> <span class="ss">:account_activations</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:edit</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:password_resets</span><span class="p">,</span>     <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:microposts</span><span class="p">,</span>          <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
<span class="hll">  <span class="n">resources</span> <span class="ss">:relationships</span><span class="p">,</span>       <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
</span><span class="k">end</span>
</pre></div></div></div><p>The follow/unfollow partials themselves are shown in <a href="following_users_fragment.html#code-follow_form" class="hyperref">Listing <span class="ref">14.21</span></a> and <a href="following_users_fragment.html#code-unfollow_form" class="hyperref">Listing <span class="ref">14.22</span></a>.</p>
<div class="codelisting" id="code-follow_form" data-tralics-id="uid1830" data-number="14.21"><div class="heading"><span class="number">Listing 14.21:</span> 

<span class="description">A form for following a user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/_follow.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">active_relationships</span><span class="o">.</span><span class="n">build</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div&gt;</span><span class="cp">&lt;%=</span> <span class="n">hidden_field_tag</span> <span class="ss">:followed_id</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Follow"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div></div><div class="codelisting" id="code-unfollow_form" data-tralics-id="uid1831" data-number="14.22"><div class="heading"><span class="number">Listing 14.22:</span> 

<span class="description">A form for unfollowing a user.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/_unfollow.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">active_relationships</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">followed_id</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
             <span class="ss">html</span><span class="p">:</span> <span class="p">{</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span> <span class="p">})</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Unfollow"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>These two forms both use <code>form_for</code> to manipulate a Relationship model object; the main difference between the two is that <a href="following_users_fragment.html#code-follow_form" class="hyperref">Listing <span class="ref">14.21</span></a> builds a <em>new</em> relationship, whereas <a href="following_users_fragment.html#code-unfollow_form" class="hyperref">Listing <span class="ref">14.22</span></a> finds the existing relationship.<span class="intersentencespace"></span> Naturally, the former sends a <code class="tt">POST</code> request to the Relationships controller to <code>create</code> a relationship, while the latter sends a <code class="tt">DELETE</code> request to <code>destroy</code> a relationship.<span class="intersentencespace"></span> (We’ll write these actions in <a href="following_users_fragment.html#sec-a_working_follow_button_the_standard_way" class="hyperref">Section <span class="ref">14.2.4</span></a>.)<span class="intersentencespace"></span> Finally, you’ll note that the follow form doesn’t have any content other than the button, but it still needs to send the <code>followed_id</code> to the controller.<span class="intersentencespace"></span> We accomplish this with the <code>hidden_field_tag</code> method in <a href="following_users_fragment.html#code-follow_form" class="hyperref">Listing <span class="ref">14.21</span></a>, which produces HTML of the form</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"followed_id"</span> <span class="na">name=</span><span class="s">"followed_id"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"3"</span> <span class="nt">/&gt;</span>
</pre></div></div>
<p>As we saw in <a href="password_reset_fragment.html#sec-resetting_the_password" class="hyperref">Section <span class="ref">12.3</span></a> (<a href="password_reset_fragment.html#code-password_reset_form" class="hyperref">Listing <span class="ref">12.14</span></a>), the hidden <code>input</code> tag puts the relevant information on the page without displaying it in the browser.</p>
<p>We can now include the follow form and the following statistics on the user profile page simply by rendering the partials, as shown in <a href="following_users_fragment.html#code-user_follow_form_profile_stats" class="hyperref">Listing <span class="ref">14.23</span></a>.<span class="intersentencespace"></span> Profiles with follow and unfollow buttons, respectively, appear in <a href="following_users_fragment.html#fig-profile_follow_button" class="hyperref">Figure <span class="ref">14.12</span></a> and <a href="following_users_fragment.html#fig-profile_unfollow_button" class="hyperref">Figure <span class="ref">14.13</span></a>.</p>
<div class="codelisting" id="code-user_follow_form_profile_stats" data-tralics-id="uid1832" data-number="14.23"><div class="heading"><span class="number">Listing 14.23:</span> 

<span class="description">Adding the follow form and follower stats to the user profile page.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/show.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">"col-md-4"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="nt">&lt;h1&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
<span class="hll">    <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"stats"</span><span class="nt">&gt;</span>
</span><span class="hll">      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/stats'</span> <span class="cp">%&gt;</span>
</span><span class="hll">    <span class="nt">&lt;/section&gt;</span>
</span>  <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-8"</span><span class="nt">&gt;</span>
<span class="hll">    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'follow_form'</span> <span class="k">if</span> <span class="n">logged_in?</span> <span class="cp">%&gt;</span>
</span>    <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;h3&gt;</span>Microposts (<span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>)<span class="nt">&lt;/h3&gt;</span>
      <span class="nt">&lt;ol</span> <span class="na">class=</span><span class="s">"microposts"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/ol&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div><div class="center figure" id="fig-profile_follow_button" data-tralics-id="uid1833" data-number="14.12">
<div class="graphics image"><img src="images/figures/profile_follow_button_3rd_edition.png" alt="images/figures/profile_follow_button_3rd_edition"></div><div class="caption"><span class="header">Figure 14.12: </span><span class="description">A user profile with a follow button (/users/2).
</span></div></div>
<div class="center figure" id="fig-profile_unfollow_button" data-tralics-id="uid1834" data-number="14.13">
<div class="graphics image"><img src="images/figures/profile_unfollow_button_3rd_edition.png" alt="images/figures/profile_unfollow_button_3rd_edition"></div><div class="caption"><span class="header">Figure 14.13: </span><span class="description">A user profile with an unfollow button (/users/5).
</span></div></div>
<p>We’ll get these buttons working soon enough—in fact, we’ll do it two ways, the standard way (<a href="following_users_fragment.html#sec-a_working_follow_button_the_standard_way" class="hyperref">Section <span class="ref">14.2.4</span></a>) and using Ajax (<a href="following_users_fragment.html#sec-a_working_follow_button_with_ajax" class="hyperref">Section <span class="ref">14.2.5</span></a>)—but first we’ll finish the HTML interface by making the following and followers pages.</p>
<div id="sec-exercises_stats_and_a_follow_form" data-tralics-id="uid1835" class="subsubsection" data-number="14.2.2.1"><h4><a href="#sec-exercises_stats_and_a_follow_form" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Verify that /users/2 has a follow form and that /users/5 has an unfollow form.<span class="intersentencespace"></span> Is there a follow form on /users/1? <span class="exercise" id="ex-2a6762"></span>
</li>
<li>Confirm in the browser that the stats appear correctly on the Home page and on the profile page. <span class="exercise" id="ex-62859b"></span>
</li>
<li>Write tests for the stats on the Home page.<span class="intersentencespace"></span> <em>Hint</em>: Add to the test in <a href="user_microposts_fragment.html#code-user_profile_test" class="hyperref">Listing <span class="ref">13.28</span></a>.<span class="intersentencespace"></span> Why don’t we also have to test the stats on the profile page? <span class="exercise" id="ex-0bb8bf"></span>
</li></ol>
</div></div>
<div id="sec-following_and_followers_pages" data-tralics-id="uid1839" class="subsection" data-number="14.2.3"><h3><a href="following_users_fragment.html#sec-following_and_followers_pages" class="heading hyperref"><span class="number">14.2.3 </span>Following and followers pages</a></h3>
<p>Pages to display followed users and followers will resemble a hybrid of the user profile page and the user index page (<a href="updating_and_deleting_users_fragment.html#sec-users_index" class="hyperref">Section <span class="ref">10.3.1</span></a>), with a sidebar of user information (including the following stats) and a list of users.<span class="intersentencespace"></span> In addition, we’ll include a raster of smaller user profile image links in the sidebar.<span class="intersentencespace"></span> Mockups matching these requirements appear in <a href="following_users_fragment.html#fig-following_mockup" class="hyperref">Figure <span class="ref">14.14</span></a> (following) and <a href="following_users_fragment.html#fig-followers_mockup" class="hyperref">Figure <span class="ref">14.15</span></a> (followers).</p>
<div class="center figure" id="fig-following_mockup" data-tralics-id="uid1840" data-number="14.14">
<div class="graphics image box"><img src="images/figures/following_mockup_bootstrap.png" alt="images/figures/following_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 14.14: </span><span class="description">A mockup of the user following page.
</span></div></div>
<div class="center figure" id="fig-followers_mockup" data-tralics-id="uid1841" data-number="14.15">
<div class="graphics image box"><img src="images/figures/followers_mockup_bootstrap.png" alt="images/figures/followers_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 14.15: </span><span class="description">A mockup of the user followers page.
</span></div></div>
<p>Our first step is to get the following and followers links to work.<span class="intersentencespace"></span> We’ll follow Twitter’s lead and have both pages require user login.<span class="intersentencespace"></span> As with most previous examples of access control, we’ll write the tests first, as shown in <a href="following_users_fragment.html#code-following_followers_authorization_test" class="hyperref">Listing <span class="ref">14.24</span></a>.<span class="intersentencespace"></span> Note that <a href="following_users_fragment.html#code-following_followers_authorization_test" class="hyperref">Listing <span class="ref">14.24</span></a> uses the named routes from <a href="following_users_fragment.html#table-following_routes" class="hyperref">Table <span class="ref">14.2</span></a>.</p>
<div class="codelisting" id="code-following_followers_authorization_test" data-tralics-id="uid1842" data-number="14.24"><div class="heading"><span class="number">Listing 14.24:</span> 

<span class="description">Tests for the authorization of the following and followers pages.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/controllers/users_controller_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="vi">@other_user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"should redirect following when not logged in"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">following_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should redirect followers when not logged in"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The only tricky part of the implementation is realizing that we need to add two new actions to the Users controller.<span class="intersentencespace"></span> Based on the routes defined in <a href="following_users_fragment.html#code-following_followers_actions_routes" class="hyperref">Listing <span class="ref">14.15</span></a>, we need to call them <code>following</code> and <code>followers</code>.<span class="intersentencespace"></span> Each action needs to set a title, find the user, retrieve either <code>@user.following</code> or <code>@user.followers</code> (in paginated form), and then render the page.<span class="intersentencespace"></span> The result appears in <a href="following_users_fragment.html#code-following_followers_actions" class="hyperref">Listing <span class="ref">14.25</span></a>.</p>
<div class="codelisting" id="code-following_followers_actions" data-tralics-id="uid1843" data-number="14.25"><div class="heading"><span class="number">Listing 14.25:</span> 

<span class="description">The <code>following</code> and <code>followers</code> actions.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/users_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">,</span>
                                        <span class="ss">:following</span><span class="p">,</span> <span class="ss">:followers</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">following</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">"Following"</span>
    <span class="vi">@user</span>  <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="n">render</span> <span class="s1">'show_follow'</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">followers</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">"Followers"</span>
    <span class="vi">@user</span>  <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="n">render</span> <span class="s1">'show_follow'</span>
  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>As we’ve seen throughout this tutorial, the usual Rails convention is to implicitly render the template corresponding to an action, such as rendering <code>show.html.erb</code> at the end of the <code>show</code> action.<span class="intersentencespace"></span> In contrast, both actions in <a href="following_users_fragment.html#code-following_followers_actions" class="hyperref">Listing <span class="ref">14.25</span></a> make an <em>explicit</em> call to <code>render</code>, in this case rendering a view called <code>show_follow</code>, which we must create.<span class="intersentencespace"></span> The reason for the common view is that the ERb is nearly identical for the two cases, and <a href="following_users_fragment.html#code-show_follow_view" class="hyperref">Listing <span class="ref">14.26</span></a> covers them both.</p>
<div class="codelisting" id="code-show_follow_view" data-tralics-id="uid1844" data-number="14.26"><div class="heading"><span class="number">Listing 14.26:</span> 

<span class="description">The <code>show_follow</code> view used to render following and followers.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/views/users/show_follow.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@title</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">"col-md-4"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"user_info"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;h1&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
      <span class="nt">&lt;span&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"view my profile"</span><span class="p">,</span> <span class="vi">@user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
      <span class="nt">&lt;span&gt;&lt;b&gt;</span>Microposts:<span class="nt">&lt;/b&gt;</span> <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"stats"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/stats'</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@users</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"user_avatars"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">30</span><span class="p">),</span> <span class="n">user</span> <span class="cp">%&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
  <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h3&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@title</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h3&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@users</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"users follow"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/ul&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div></div></div><p>The actions in <a href="following_users_fragment.html#code-following_followers_actions" class="hyperref">Listing <span class="ref">14.25</span></a> render the view from <a href="following_users_fragment.html#code-show_follow_view" class="hyperref">Listing <span class="ref">14.26</span></a> in two contexts, “following” and “followers”, with the results shown in <a href="following_users_fragment.html#fig-user_following" class="hyperref">Figure <span class="ref">14.16</span></a> and <a href="following_users_fragment.html#fig-user_followers" class="hyperref">Figure <span class="ref">14.17</span></a>.<span class="intersentencespace"></span> Note that nothing in the above code uses the current user, so the same links work for other users, as shown in <a href="following_users_fragment.html#fig-different_user_followers" class="hyperref">Figure <span class="ref">14.18</span></a>.</p>
<div class="center figure" id="fig-user_following" data-tralics-id="uid1845" data-number="14.16">
<div class="graphics image"><img src="images/figures/user_following_3rd_edition.png" alt="images/figures/user_following_3rd_edition"></div><div class="caption"><span class="header">Figure 14.16: </span><span class="description">Showing the users the given user is following.
</span></div></div>
<div class="center figure" id="fig-user_followers" data-tralics-id="uid1846" data-number="14.17">
<div class="graphics image"><img src="images/figures/user_followers_3rd_edition.png" alt="images/figures/user_followers_3rd_edition"></div><div class="caption"><span class="header">Figure 14.17: </span><span class="description">Showing the given user’s followers.
</span></div></div>
<div class="center figure" id="fig-different_user_followers" data-tralics-id="uid1847" data-number="14.18">
<div class="graphics image"><img src="images/figures/diferent_user_followers_3rd_edition.png" alt="images/figures/diferent_user_followers_3rd_edition"></div><div class="caption"><span class="header">Figure 14.18: </span><span class="description">Showing a different user’s followers.
</span></div></div>
<p>At this point, the tests in <a href="following_users_fragment.html#code-following_followers_authorization_test" class="hyperref">Listing <span class="ref">14.24</span></a> should be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span> due to the before filter in <a href="following_users_fragment.html#code-following_followers_actions" class="hyperref">Listing <span class="ref">14.25</span></a>:</p>
<div class="codelisting" id="uid1848" data-tralics-id="uid1848" data-number="14.27"><div class="heading"><span class="number">Listing 14.27:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div><p>To test the <code>show_follow</code> rendering, we’ll write a couple of short integration tests that verify the presence of working following and followers pages.<span class="intersentencespace"></span> They are designed to be a sanity check, not to be comprehensive; indeed, as noted in <a href="filling_in_the_layout_fragment.html#sec-layout_link_tests" class="hyperref">Section <span class="ref">5.3.4</span></a>, comprehensive tests of things like HTML structure are likely to be brittle and thus counter-productive.<span class="intersentencespace"></span> Our plan in the case of following/followers pages is to check the number is correctly displayed and that links with the right URLs appear on the page.</p>
<p>To get started, we’ll generate an integration test as usual:</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate integration_test following
<span class="go">      invoke  test_unit</span>
<span class="go">      create    test/integration/following_test.rb</span>
</pre></div></div>
<p>Next, we need to assemble some test data, which we can do by adding some relationships fixtures to create following/follower relationships.<span class="intersentencespace"></span> Recall from <a href="user_microposts_fragment.html#sec-profile_micropost_tests" class="hyperref">Section <span class="ref">13.2.3</span></a> that we can use code like</p>
<div class="code"><div class="highlight"><pre><span class="l-Scalar-Plain">orange</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="s">"I</span><span class="nv"> </span><span class="s">just</span><span class="nv"> </span><span class="s">ate</span><span class="nv"> </span><span class="s">an</span><span class="nv"> </span><span class="s">orange!"</span>
  <span class="l-Scalar-Plain">created_at</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= 10.minutes.ago %&gt;</span>
  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael</span>
</pre></div></div>
<p>to associate a micropost with a given user.<span class="intersentencespace"></span> In particular, we can write</p>
<div class="code"><div class="highlight"><pre><span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael</span>
</pre></div></div>
<p>instead of</p>
<div class="code"><div class="highlight"><pre><span class="l-Scalar-Plain">user_id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</pre></div></div>
<p>Applying this idea to the relationships fixtures gives the associations in <a href="following_users_fragment.html#code-relationships_fixtures" class="hyperref">Listing <span class="ref">14.28</span></a>.</p>
<div class="codelisting" id="code-relationships_fixtures" data-tralics-id="uid1849" data-number="14.28"><div class="heading"><span class="number">Listing 14.28:</span> 

<span class="description">Relationships fixtures for use in following/follower tests.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">test/fixtures/relationships.yml</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="l-Scalar-Plain">one</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">follower</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael</span>
  <span class="l-Scalar-Plain">followed</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">lana</span>

<span class="l-Scalar-Plain">two</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">follower</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael</span>
  <span class="l-Scalar-Plain">followed</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">malory</span>

<span class="l-Scalar-Plain">three</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">follower</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">lana</span>
  <span class="l-Scalar-Plain">followed</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael</span>

<span class="l-Scalar-Plain">four</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">follower</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">archer</span>
  <span class="l-Scalar-Plain">followed</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">michael</span>
</pre></div></div></div><p>The fixtures in <a href="following_users_fragment.html#code-relationships_fixtures" class="hyperref">Listing <span class="ref">14.28</span></a> first arrange for Michael to follow Lana and Malory, and then arrange for Michael to be followed by Lana and Archer.<span class="intersentencespace"></span> To test for the right count, we can use the same <code>assert_match</code> method we used in <a href="user_microposts_fragment.html#code-user_profile_test" class="hyperref">Listing <span class="ref">13.28</span></a> to test for the display of the number of microposts on the user profile page.<span class="intersentencespace"></span> Adding in assertions for the right links yields the tests shown in <a href="following_users_fragment.html#code-following_tests" class="hyperref">Listing <span class="ref">14.29</span></a>.</p>
<div class="codelisting" id="code-following_tests" data-tralics-id="uid1850" data-number="14.29"><div class="heading"><span class="number">Listing 14.29:</span> 

<span class="description">Tests for following/follower pages.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/following_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">FollowingTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"following page"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">following_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">assert_match</span> <span class="vi">@user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
      <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"followers page"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">assert_match</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
      <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>In <a href="following_users_fragment.html#code-following_tests" class="hyperref">Listing <span class="ref">14.29</span></a>, note that we include the assertion</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_not</span> <span class="vi">@user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">empty?</span>
</pre></div></div>
<p>which is included to make sure that</p>
<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
  <span class="n">assert_select</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p>isn’t <a href="https://en.wikipedia.org/wiki/Vacuous_truth" target="_blank" rel="noopener">vacuously true</a> (and similarly for <code>followers</code>).<span class="intersentencespace"></span> In other words, if <code>@user.following.empty?</code> were true, not a single <code>assert_select</code> would execute in the loop, leading the tests to pass and thereby give us a false sense of security.</p>
<p>The test suite should now be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid1851" data-tralics-id="uid1851" data-number="14.30"><div class="heading"><span class="number">Listing 14.30:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div>
<div id="sec-exercises_" data-tralics-id="uid1852" class="subsubsection" data-number="14.2.3.1"><h4><a href="#sec-exercises_" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Verify in a browser that /users/1/followers and /users/1/following work.<span class="intersentencespace"></span> Do the image links in the sidebar work as well? <span class="exercise" id="ex-64cc1d"></span>
</li>
<li>Comment out the application code needed to turn the <code>assert_select</code> tests in <a href="following_users_fragment.html#code-following_tests" class="hyperref">Listing <span class="ref">14.29</span></a> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span> to confirm they’re testing the right thing. <span class="exercise" id="ex-68811a"></span>
</li></ol>
</div></div>
<div id="sec-a_working_follow_button_the_standard_way" data-tralics-id="uid1855" class="subsection" data-number="14.2.4"><h3><a href="following_users_fragment.html#sec-a_working_follow_button_the_standard_way" class="heading hyperref"><span class="number">14.2.4 </span>A working follow button the standard way</a></h3>
<p>Now that our views are in order, it’s time to get the follow/unfollow buttons working.<span class="intersentencespace"></span> Because following and unfollowing involve creating and destroying relationships, we need a Relationships controller, which we generate as usual</p>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller Relationships
</pre></div></div>
<p>As we’ll see in <a href="following_users_fragment.html#code-relationships_controller" class="hyperref">Listing <span class="ref">14.32</span></a>, enforcing access control on the Relationships controller actions won’t much matter, but we’ll still follow our previous practice of enforcing the security model as early as possible.<span class="intersentencespace"></span> In particular, we’ll check that attempts to access actions in the Relationships controller require a logged-in user (and thus get redirected to the login page), while also not changing the Relationship count, as shown in <a href="following_users_fragment.html#code-relationships_access_control" class="hyperref">Listing <span class="ref">14.31</span></a>.</p>
<div class="codelisting" id="code-relationships_access_control" data-tralics-id="uid1856" data-number="14.31"><div class="heading"><span class="number">Listing 14.31:</span> 

<span class="description">Basic access control tests for relationships.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/controllers/relationships_controller_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">RelationshipsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="nb">test</span> <span class="s2">"create should require logged-in user"</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span> <span class="s1">'Relationship.count'</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">relationships_path</span>
    <span class="k">end</span>
    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"destroy should require logged-in user"</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span> <span class="s1">'Relationship.count'</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">relationship_path</span><span class="p">(</span><span class="n">relationships</span><span class="p">(</span><span class="ss">:one</span><span class="p">))</span>
    <span class="k">end</span>
    <span class="n">assert_redirected_to</span> <span class="n">login_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>We can get the tests in <a href="following_users_fragment.html#code-relationships_access_control" class="hyperref">Listing <span class="ref">14.31</span></a> to pass by adding the <code>logged_in_user</code> before filter (<a href="following_users_fragment.html#code-relationships_controller" class="hyperref">Listing <span class="ref">14.32</span></a>).</p>
<div class="codelisting" id="code-relationships_controller" data-tralics-id="uid1857" data-number="14.32"><div class="heading"><span class="number">Listing 14.32:</span> 

<span class="description">Access control for relationships.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/controllers/relationships_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelationshipsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>To get the follow and unfollow buttons to work, all we need to do is find the user associated with the <code>followed_id</code> in the corresponding form (i.e., <a href="following_users_fragment.html#code-follow_form" class="hyperref">Listing <span class="ref">14.21</span></a> or <a href="following_users_fragment.html#code-unfollow_form" class="hyperref">Listing <span class="ref">14.22</span></a>), and then use the appropriate <code>follow</code> or <code>unfollow</code> method from <a href="following_users_fragment.html#code-follow_unfollow_following" class="hyperref">Listing <span class="ref">14.10</span></a>.<span class="intersentencespace"></span> The full implementation appears in <a href="following_users_fragment.html#code-relationships_controller_following" class="hyperref">Listing <span class="ref">14.33</span></a>.</p>
<div class="codelisting" id="code-relationships_controller_following" data-tralics-id="uid1858" data-number="14.33"><div class="heading"><span class="number">Listing 14.33:</span> 

<span class="description">The Relationships controller.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/relationships_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelationshipsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
<span class="hll">    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:followed_id</span><span class="o">]</span><span class="p">)</span>
</span><span class="hll">    <span class="n">current_user</span><span class="o">.</span><span class="n">follow</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class="hll">    <span class="n">redirect_to</span> <span class="n">user</span>
</span>  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
<span class="hll">    <span class="n">user</span> <span class="o">=</span> <span class="no">Relationship</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">followed</span>
</span><span class="hll">    <span class="n">current_user</span><span class="o">.</span><span class="n">unfollow</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class="hll">    <span class="n">redirect_to</span> <span class="n">user</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>We can see from <a href="following_users_fragment.html#code-relationships_controller_following" class="hyperref">Listing <span class="ref">14.33</span></a> why the security issue mentioned above is minor: if an unlogged-in user were to hit either action directly (e.g., using a command-line tool like <code>curl</code>), <code>current_user</code> would be <code>nil</code>, and in both cases the action’s second line would raise an exception, resulting in an error but no harm to the application or its data.<span class="intersentencespace"></span> It’s best not to rely on that, though, so we’ve taken the extra step and added an additional layer of security.</p>
<p>With that, the core follow/unfollow functionality is complete, and any user can follow or unfollow any other user, as you can verify by clicking the corresponding buttons in your browser.<span class="intersentencespace"></span> (We’ll write integration tests to verify this behavior in <a href="following_users_fragment.html#sec-following_tests" class="hyperref">Section <span class="ref">14.2.6</span></a>.)<span class="intersentencespace"></span> The result of following user #2 is shown in <a href="following_users_fragment.html#fig-unfollowed_user" class="hyperref">Figure <span class="ref">14.19</span></a> and <a href="following_users_fragment.html#fig-followed_user" class="hyperref">Figure <span class="ref">14.20</span></a>.</p>
<div class="center figure" id="fig-unfollowed_user" data-tralics-id="uid1859" data-number="14.19">
<div class="graphics image"><img src="images/figures/unfollowed_user.png" alt="images/figures/unfollowed_user"></div><div class="caption"><span class="header">Figure 14.19: </span><span class="description">An unfollowed user.
</span></div></div>
<div class="center figure" id="fig-followed_user" data-tralics-id="uid1860" data-number="14.20">
<div class="graphics image"><img src="images/figures/followed_user.png" alt="images/figures/followed_user"></div><div class="caption"><span class="header">Figure 14.20: </span><span class="description">The result of following an unfollowed user.
</span></div></div>
<div id="sec-exercises_a_working_follow_button_the_standard_way" data-tralics-id="uid1861" class="subsubsection" data-number="14.2.4.1"><h4><a href="#sec-exercises_a_working_follow_button_the_standard_way" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Follow and unfollow /users/2 through the web.<span class="intersentencespace"></span> Did it work? <span class="exercise" id="ex-b57314"></span>
</li>
<li>According to the server log, which templates are rendered in each case? <span class="exercise" id="ex-04f8d5"></span>
</li></ol>
</div></div>
<div id="sec-a_working_follow_button_with_ajax" data-tralics-id="uid1864" class="subsection" data-number="14.2.5"><h3><a href="following_users_fragment.html#sec-a_working_follow_button_with_ajax" class="heading hyperref"><span class="number">14.2.5 </span>A working follow button with Ajax</a></h3>
<p>Although our user following implementation is complete as it stands, we have one bit of polish left to add before starting work on the status feed.<span class="intersentencespace"></span> You may have noticed in <a href="following_users_fragment.html#sec-a_working_follow_button_the_standard_way" class="hyperref">Section <span class="ref">14.2.4</span></a> that both the <code>create</code> and <code>destroy</code> actions in the Relationships controller simply redirect <em>back</em> to the original profile.<span class="intersentencespace"></span> In other words, a user starts on another user’s profile page, follows the other user, and is immediately redirected back to the original page.<span class="intersentencespace"></span> It is reasonable to ask why the user needs to leave that page at all.</p>
<p>This is exactly the problem solved by <em>Ajax</em>, which allows web pages to send requests asynchronously to the server without leaving the page.<sup id="cha-14_footnote-ref-8" class="footnote"><a href="#cha-14_footnote-8">8</a></sup><span class="intersentencespace"></span> Because adding Ajax to web forms is a common practice, Rails makes Ajax easy to implement.<span class="intersentencespace"></span> Indeed, updating the follow/unfollow form partials is trivial: just change</p>
<div class="code"><div class="highlight"><pre><span class="n">form_for</span>
</pre></div></div>
<p>to</p>
<div class="code"><div class="highlight"><pre><span class="n">form_for</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">,</span> <span class="ss">remote</span><span class="p">:</span> <span class="kp">true</span>
</pre></div></div>
<p>and Rails <a href="http://catb.org/jargon/html/A/automagically.html" target="_blank" rel="noopener">automagically</a> uses Ajax.<span class="intersentencespace"></span> The updated partials appear in <a href="following_users_fragment.html#code-follow_form_ajax" class="hyperref">Listing <span class="ref">14.34</span></a> and <a href="following_users_fragment.html#code-unfollow_form_ajax" class="hyperref">Listing <span class="ref">14.35</span></a>.</p>
<div class="codelisting" id="code-follow_form_ajax" data-tralics-id="uid1866" data-number="14.34"><div class="heading"><span class="number">Listing 14.34:</span> 

<span class="description">A form for following a user using Ajax.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/_follow.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="hll"><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">active_relationships</span><span class="o">.</span><span class="n">build</span><span class="p">,</span> <span class="ss">remote</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
</span>  <span class="nt">&lt;div&gt;</span><span class="cp">&lt;%=</span> <span class="n">hidden_field_tag</span> <span class="ss">:followed_id</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Follow"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div></div><div class="codelisting" id="code-unfollow_form_ajax" data-tralics-id="uid1867" data-number="14.35"><div class="heading"><span class="number">Listing 14.35:</span> 

<span class="description">A form for unfollowing a user using Ajax.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/users/_unfollow.html.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">active_relationships</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">followed_id</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
             <span class="ss">html</span><span class="p">:</span> <span class="p">{</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span> <span class="p">},</span>
<span class="hll">             <span class="ss">remote</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
</span>  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Unfollow"</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s2">"btn"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div></div></div><p>The actual HTML generated by this ERb isn’t particularly relevant, but you might be curious, so here’s a peek at a schematic view (details may differ):</p>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/relationships/117"</span> <span class="na">class=</span><span class="s">"edit_relationship"</span> <span class="na">data-remote=</span><span class="s">"true"</span>
      <span class="na">id=</span><span class="s">"edit_relationship_117"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
  .
  .
  .
<span class="nt">&lt;/form&gt;</span>
</pre></div></div>
<p>This sets the variable <code>data-remote="true"</code> inside the form tag, which tells Rails to allow the form to be handled by JavaScript.<span class="intersentencespace"></span> By using a simple HTML property instead of inserting the full JavaScript code (as in previous versions of Rails), Rails follows the philosophy of <a href="http://railscasts.com/episodes/205-unobtrusive-javascript" target="_blank" rel="noopener"><em>unobtrusive JavaScript</em></a>.</p>
<p>Having updated the form, we now need to arrange for the Relationships controller to respond to Ajax requests.<span class="intersentencespace"></span> We can do this using the <code>respond_to</code> method, responding appropriately depending on the type of request.<span class="intersentencespace"></span> The general pattern looks like this:</p>
<div class="code"><div class="highlight"><pre><span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
  <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="n">user</span> <span class="p">}</span>
  <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
<span class="k">end</span>
</pre></div></div>
<p>The syntax is potentially confusing, and it’s important to understand that in the code above only <em>one</em> of the lines gets executed.<span class="intersentencespace"></span> (In this sense, <code>respond_to</code> is more like an if-then-else statement than a series of sequential lines.)<span class="intersentencespace"></span> Adapting the Relationships controller to respond to Ajax involves adding <code>respond_to</code> as above to the <code>create</code> and <code>destroy</code> actions from <a href="following_users_fragment.html#code-relationships_controller_following" class="hyperref">Listing <span class="ref">14.33</span></a>.<span class="intersentencespace"></span> The result appears as in <a href="following_users_fragment.html#code-relationships_controller_ajax" class="hyperref">Listing <span class="ref">14.36</span></a>.<span class="intersentencespace"></span> Note the change from the local variable <code>user</code> to the instance variable <code>@user</code>; in <a href="following_users_fragment.html#code-relationships_controller_following" class="hyperref">Listing <span class="ref">14.33</span></a> there was no need for an instance variable, but now such a variable is necessary for use in <a href="following_users_fragment.html#code-follow_form_ajax" class="hyperref">Listing <span class="ref">14.34</span></a> and <a href="following_users_fragment.html#code-unfollow_form_ajax" class="hyperref">Listing <span class="ref">14.35</span></a>.</p>
<div class="codelisting" id="code-relationships_controller_ajax" data-tralics-id="uid1868" data-number="14.36"><div class="heading"><span class="number">Listing 14.36:</span> 

<span class="description">Responding to Ajax requests in the Relationships controller.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/controllers/relationships_controller.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelationshipsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:logged_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:followed_id</span><span class="o">]</span><span class="p">)</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">follow</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
<span class="hll">    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class="hll">      <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@user</span> <span class="p">}</span>
</span><span class="hll">      <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
</span><span class="hll">    <span class="k">end</span>
</span>  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">Relationship</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">followed</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">unfollow</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
<span class="hll">    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class="hll">      <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@user</span> <span class="p">}</span>
</span><span class="hll">      <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
</span><span class="hll">    <span class="k">end</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>The actions in <a href="following_users_fragment.html#code-relationships_controller_ajax" class="hyperref">Listing <span class="ref">14.36</span></a> degrade gracefully, which means that they work fine in browsers that have JavaScript disabled (although a small amount of configuration is necessary, as shown in <a href="following_users_fragment.html#code-degrade_gracefully" class="hyperref">Listing <span class="ref">14.37</span></a>).</p>
<div class="codelisting" id="code-degrade_gracefully" data-tralics-id="uid1869" data-number="14.37"><div class="heading"><span class="number">Listing 14.37:</span> 

<span class="description">Configuration needed for graceful degradation of form submission.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">config/application.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">'../boot'</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="k">module</span> <span class="nn">SampleApp</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="c1"># Include the authenticity token in remote forms.</span>
<span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">action_view</span><span class="o">.</span><span class="n">embed_authenticity_token_in_remote_forms</span> <span class="o">=</span> <span class="kp">true</span>
</span>  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>On the other hand, we have yet to respond properly when JavaScript is enabled.<span class="intersentencespace"></span> In the case of an Ajax request, Rails automatically calls a <em>JavaScript embedded Ruby</em> (<code>.js.erb</code>) file with the same name as the action, i.e., <code>create.js.erb</code> or <code>destroy.js.erb</code>.<span class="intersentencespace"></span> As you might guess, such files allow us to mix JavaScript and embedded Ruby to perform actions on the current page.<span class="intersentencespace"></span> It is these files that we need to create and edit in order to update the user profile page upon being followed or unfollowed.</p>
<p>Inside a JS-ERb file, Rails automatically provides the <a href="http://jquery.com/" target="_blank" rel="noopener">jQuery</a> JavaScript helpers to manipulate the page using the <a href="http://www.w3.org/DOM/" target="_blank" rel="noopener">Document Object Model (DOM)</a>.<span class="intersentencespace"></span> The jQuery library (which we saw briefly in <a href="user_microposts_fragment.html#sec-image_validation" class="hyperref">Section <span class="ref">13.4.2</span></a>) provides a large number of methods for manipulating the DOM, but here we will need only two.<span class="intersentencespace"></span> First, we will need to know about the dollar-sign syntax to access a DOM element based on its unique CSS id.<span class="intersentencespace"></span> For example, to manipulate the <code>follow_form</code> element, we will use the syntax</p>
<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">"#follow_form"</span><span class="p">)</span>
</pre></div></div>
<p>(Recall from <a href="following_users_fragment.html#code-follow_form_partial" class="hyperref">Listing <span class="ref">14.19</span></a> that this is a <code>div</code> that wraps the form, not the form itself.)<span class="intersentencespace"></span> This syntax, inspired by CSS, uses the <code>#</code> symbol to indicate a CSS id.<span class="intersentencespace"></span> As you might guess, jQuery, like CSS, uses a dot <code>.</code> to manipulate CSS classes.</p>
<p>The second method we’ll need is <code>html</code>, which updates the HTML inside the relevant element with the contents of its argument.<span class="intersentencespace"></span> For example, to replace the entire follow form with the string <code>"foobar"</code>, we would write</p>
<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">"#follow_form"</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">"foobar"</span><span class="p">)</span>
</pre></div></div>
<p>Unlike plain JavaScript files, JS-ERb files also allow the use of embedded Ruby, which we apply in the <code>create.js.erb</code> file to update the follow form with the <code>unfollow</code> partial (which is what should show after a successful following) and update the follower count.<span class="intersentencespace"></span> The result is shown in <a href="following_users_fragment.html#code-create_js_erb" class="hyperref">Listing <span class="ref">14.38</span></a>.<span class="intersentencespace"></span> This uses the <code>escape_javascript</code> method, which is needed to escape out the result when inserting HTML in a JavaScript file.</p>
<div class="codelisting" id="code-create_js_erb" data-tralics-id="uid1870" data-number="14.38"><div class="heading"><span class="number">Listing 14.38:</span> 

<span class="description">The JavaScript embedded Ruby to create a following relationship.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/relationships/create.js.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">"#follow_form"</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">"&lt;%= escape_javascript(render('users/unfollow')) %&gt;"</span><span class="p">);</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">"#followers"</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">'&lt;%= @user.followers.count %&gt;'</span><span class="p">);</span>
</pre></div></div></div><p>Note the presence of line-ending semicolons, which are characteristic of languages with syntax descended from <a href="https://en.wikipedia.org/wiki/ALGOL" target="_blank" rel="noopener">ALGOL</a>.</p>
<p>The <code>destroy.js.erb</code> file is analogous (<a href="following_users_fragment.html#code-destroy_js_erb" class="hyperref">Listing <span class="ref">14.39</span></a>).</p>
<div class="codelisting" id="code-destroy_js_erb" data-tralics-id="uid1871" data-number="14.39"><div class="heading"><span class="number">Listing 14.39:</span> 

<span class="description">The Ruby JavaScript (RJS) to destroy a following relationship.<span class="intersentencespace"></span> <span class="break"></span> <span class="filepath">app/views/relationships/destroy.js.erb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">"#follow_form"</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">"&lt;%= escape_javascript(render('users/follow')) %&gt;"</span><span class="p">);</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">"#followers"</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">'&lt;%= @user.followers.count %&gt;'</span><span class="p">);</span>
</pre></div></div></div><p>With that, you should navigate to a user profile page and verify that you can follow and unfollow without a page refresh.</p>
<div id="sec-exercises_a_working_follow_button_with_ajax" data-tralics-id="uid1872" class="subsubsection" data-number="14.2.5.1"><h4><a href="#sec-exercises_a_working_follow_button_with_ajax" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Unfollow and refollow /users/2 through the web.<span class="intersentencespace"></span> Did it work? <span class="exercise" id="ex-8991b6"></span>
</li>
<li>According to the server log, which templates are rendered in each case? <span class="exercise" id="ex-d7e936"></span>
</li></ol>
</div></div>
<div id="sec-following_tests" data-tralics-id="uid1875" class="subsection" data-number="14.2.6"><h3><a href="following_users_fragment.html#sec-following_tests" class="heading hyperref"><span class="number">14.2.6 </span>Following tests</a></h3>
<p>Now that the follow buttons are working, we’ll write some simple tests to prevent regressions.<span class="intersentencespace"></span> To follow a user, we post to the relationships path and verify that the number of followed users increases by 1:</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_difference</span> <span class="s1">'@user.following.count'</span><span class="p">,</span> <span class="mi">1</span> <span class="k">do</span>
  <span class="n">post</span> <span class="n">relationships_path</span><span class="p">,</span> <span class="ss">params</span><span class="p">:</span> <span class="p">{</span> <span class="ss">followed_id</span><span class="p">:</span> <span class="vi">@other</span><span class="o">.</span><span class="n">id</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div></div>
<p>This tests the standard implementation, but testing the Ajax version is almost exactly the same; the only difference is the addition of the option <code>xhr: true</code>:</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_difference</span> <span class="s1">'@user.following.count'</span><span class="p">,</span> <span class="mi">1</span> <span class="k">do</span>
  <span class="n">post</span> <span class="n">relationships_path</span><span class="p">,</span> <span class="ss">params</span><span class="p">:</span> <span class="p">{</span> <span class="ss">followed_id</span><span class="p">:</span> <span class="vi">@other</span><span class="o">.</span><span class="n">id</span> <span class="p">},</span> <span class="ss">xhr</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div></div>
<p>Here <code>xhr</code> stands for XmlHttpRequest; setting the <code>xhr</code> option to <code>true</code> issues an Ajax request in the test, which causes the <code>respond_to</code> block in <a href="following_users_fragment.html#code-relationships_controller_ajax" class="hyperref">Listing <span class="ref">14.36</span></a> to execute the proper JavaScript method.</p>
<p>The same parallel structure applies to deleting users, with <code>delete</code> instead of <code>post</code>.<span class="intersentencespace"></span> Here we check that the followed user count goes down by 1 and include the relationship and followed user’s id:</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_difference</span> <span class="s1">'@user.following.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span>
  <span class="n">delete</span> <span class="n">relationship_path</span><span class="p">(</span><span class="n">relationship</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div>
<p>and</p>
<div class="code"><div class="highlight"><pre><span class="n">assert_difference</span> <span class="s1">'@user.following.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span>
  <span class="n">delete</span> <span class="n">relationship_path</span><span class="p">(</span><span class="n">relationship</span><span class="p">),</span> <span class="ss">xhr</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div></div>
<p>Putting the two cases together gives the tests in <a href="following_users_fragment.html#code-follow_button_tests" class="hyperref">Listing <span class="ref">14.40</span></a>.</p>
<div class="codelisting" id="code-follow_button_tests" data-tralics-id="uid1876" data-number="14.40"><div class="heading"><span class="number">Listing 14.40:</span> 

<span class="description">Tests for the follow and unfollow buttons.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/following_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">FollowingTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span>  <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
<span class="hll">    <span class="vi">@other</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">)</span>
</span>    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"should follow a user the standard way"</span> <span class="k">do</span>
    <span class="n">assert_difference</span> <span class="s1">'@user.following.count'</span><span class="p">,</span> <span class="mi">1</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">relationships_path</span><span class="p">,</span> <span class="ss">params</span><span class="p">:</span> <span class="p">{</span> <span class="ss">followed_id</span><span class="p">:</span> <span class="vi">@other</span><span class="o">.</span><span class="n">id</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should follow a user with Ajax"</span> <span class="k">do</span>
    <span class="n">assert_difference</span> <span class="s1">'@user.following.count'</span><span class="p">,</span> <span class="mi">1</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">relationships_path</span><span class="p">,</span> <span class="ss">xhr</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">params</span><span class="p">:</span> <span class="p">{</span> <span class="ss">followed_id</span><span class="p">:</span> <span class="vi">@other</span><span class="o">.</span><span class="n">id</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should unfollow a user the standard way"</span> <span class="k">do</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">follow</span><span class="p">(</span><span class="vi">@other</span><span class="p">)</span>
    <span class="n">relationship</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">active_relationships</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">followed_id</span><span class="p">:</span> <span class="vi">@other</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="n">assert_difference</span> <span class="s1">'@user.following.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">relationship_path</span><span class="p">(</span><span class="n">relationship</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should unfollow a user with Ajax"</span> <span class="k">do</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">follow</span><span class="p">(</span><span class="vi">@other</span><span class="p">)</span>
    <span class="n">relationship</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">active_relationships</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">followed_id</span><span class="p">:</span> <span class="vi">@other</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="n">assert_difference</span> <span class="s1">'@user.following.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">relationship_path</span><span class="p">(</span><span class="n">relationship</span><span class="p">),</span> <span class="ss">xhr</span><span class="p">:</span> <span class="kp">true</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>At this point, the tests should be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid1877" data-tralics-id="uid1877" data-number="14.41"><div class="heading"><span class="number">Listing 14.41:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div>
<div id="sec-exercises_following_tests" data-tralics-id="uid1878" class="subsubsection" data-number="14.2.6.1"><h4><a href="#sec-exercises_following_tests" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>By commenting and uncommenting each of the lines in the <code>respond_to</code> blocks (<a href="following_users_fragment.html#code-relationships_controller_ajax" class="hyperref">Listing <span class="ref">14.36</span></a>), verify that the tests are testing the right things.<span class="intersentencespace"></span> Which test fails in each case? <span class="exercise" id="ex-96d361"></span>
</li>
<li>What happens if you delete one of the occurrences of <code>xhr: true</code> in <a href="following_users_fragment.html#code-follow_button_tests" class="hyperref">Listing <span class="ref">14.40</span></a>?<span class="intersentencespace"></span> Explain why this is a problem, and why the procedure in the previous exercise would catch it. <span class="exercise" id="ex-90699b"></span>
</li></ol>
</div></div></div><div id="sec-the_status_feed" data-tralics-id="cid82" class="section" data-number="14.3"><h2><a href="following_users_fragment.html#sec-the_status_feed" class="heading hyperref"><span class="number">14.3 </span>The status feed</a></h2>
<p>We come now to the pinnacle of our sample application: the status feed of microposts.<span class="intersentencespace"></span> Appropriately, this section contains some of the most advanced material in the entire tutorial.<span class="intersentencespace"></span> The full status feed builds on the proto-feed from <a href="user_microposts_fragment.html#sec-a_proto_feed" class="hyperref">Section <span class="ref">13.3.3</span></a> by assembling an array of the microposts from the users being followed by the current user, along with the current user’s own microposts.<span class="intersentencespace"></span> Throughout this section, we’ll proceed through a series of feed implementations of increasing sophistication.<span class="intersentencespace"></span> To accomplish this, we will need some fairly advanced Rails, Ruby, and even SQL programming techniques.</p>
<p>Because of the heavy lifting ahead, it’s especially important to review where we’re going.<span class="intersentencespace"></span> A recap of the final status feed, shown in <a href="following_users_fragment.html#fig-page_flow_home_page_feed_mockup" class="hyperref">Figure <span class="ref">14.5</span></a>, appears again in <a href="following_users_fragment.html#fig-home_page_feed_mockup" class="hyperref">Figure <span class="ref">14.21</span></a>.</p>
<div class="center figure" id="fig-home_page_feed_mockup" data-tralics-id="uid1881" data-number="14.21">
<div class="graphics image box"><img src="images/figures/page_flow_home_page_feed_mockup_bootstrap.png" alt="images/figures/page_flow_home_page_feed_mockup_bootstrap"></div><div class="caption"><span class="header">Figure 14.21: </span><span class="description">A mockup of a user’s Home page with a status feed.
</span></div></div>
<div id="sec-motivation_and_strategy" data-tralics-id="uid1882" class="subsection" data-number="14.3.1"><h3><a href="following_users_fragment.html#sec-motivation_and_strategy" class="heading hyperref"><span class="number">14.3.1 </span>Motivation and strategy</a></h3>
<p>The basic idea behind the feed is simple.<span class="intersentencespace"></span> <a href="following_users_fragment.html#fig-user_feed" class="hyperref">Figure <span class="ref">14.22</span></a> shows a sample <code>microposts</code> database table and the resulting feed.<span class="intersentencespace"></span> The purpose of a feed is to pull out the microposts whose user ids correspond to the users being followed by the current user (and the current user itself), as indicated by the arrows in the diagram.</p>
<div class="center figure" id="fig-user_feed" data-tralics-id="uid1883" data-number="14.22">
<div class="graphics image"><img src="images/figures/user_feed.png" alt="images/figures/user_feed"></div><div class="caption"><span class="header">Figure 14.22: </span><span class="description">The feed for a user (id 1) following users with ids 2, 7, 8, and 10.
</span></div></div>
<p>Although we don’t yet know how to implement the feed, the tests are relatively straightforward, so (following the guidelines in <a href="static_pages_fragment.html#aside-when_to_test" class="hyperref">Box <span class="ref">3.3</span></a>) we’ll write them first.<span class="intersentencespace"></span> The key is to check all three requirements for the feed: microposts for both followed users and the user itself should be included in the feed, but a post from an <em>unfollowed</em> user should not be included.<span class="intersentencespace"></span> Based on the fixtures in <a href="updating_and_deleting_users_fragment.html#code-users_fixtures_extra_users" class="hyperref">Listing <span class="ref">10.47</span></a> and <a href="user_microposts_fragment.html#code-add_micropost_different_owner" class="hyperref">Listing <span class="ref">13.53</span></a>, this means that Michael should see Lana’s posts and his own posts, but not Archer’s posts.<span class="intersentencespace"></span> Converting these requirements to assertions and recalling that the <code>feed</code> is in the User model (<a href="user_microposts_fragment.html#code-proto_status_feed" class="hyperref">Listing <span class="ref">13.46</span></a>) gives the updated User model test shown in <a href="following_users_fragment.html#code-full_feed_test" class="hyperref">Listing <span class="ref">14.42</span></a>.</p>
<div class="codelisting" id="code-full_feed_test" data-tralics-id="uid1884" data-number="14.42"><div class="heading"><span class="number">Listing 14.42:</span> 

<span class="description">A test for the status feed.<span class="intersentencespace"></span> <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/models/user_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"feed should have the right posts"</span> <span class="k">do</span>
    <span class="n">michael</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="n">archer</span>  <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:archer</span><span class="p">)</span>
    <span class="n">lana</span>    <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:lana</span><span class="p">)</span>
    <span class="c1"># Posts from followed user</span>
    <span class="n">lana</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">post_following</span><span class="o">|</span>
      <span class="n">assert</span> <span class="n">michael</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">post_following</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="c1"># Posts from self</span>
    <span class="n">michael</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">post_self</span><span class="o">|</span>
      <span class="n">assert</span> <span class="n">michael</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">post_self</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="c1"># Posts from unfollowed user</span>
    <span class="n">archer</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">post_unfollowed</span><span class="o">|</span>
      <span class="n">assert_not</span> <span class="n">michael</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">post_unfollowed</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div><p>Of course, the current implementation is just a proto-feed, so the new test is initially <span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid1885" data-tralics-id="uid1885" data-number="14.43"><div class="heading"><span class="number">Listing 14.43:</span> <span class="description"><span style="color: red"><span class="sc"></span><span class="sc"><strong>red</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div>
<div id="sec-exercises_motivation_and_strategy" data-tralics-id="uid1886" class="subsubsection" data-number="14.3.1.1"><h4><a href="#sec-exercises_motivation_and_strategy" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Assuming the micropost’s ids are numbered sequentially, with larger numbers being more recent, what would <code>user.feed.map(&amp;:id)</code> return for the feed shown in <a href="following_users_fragment.html#fig-user_feed" class="hyperref">Figure <span class="ref">14.22</span></a>?<span class="intersentencespace"></span> <em>Hint</em>: Recall the default scope from <a href="user_microposts_fragment.html#sec-ordering_and_dependency" class="hyperref">Section <span class="ref">13.1.4</span></a>. <span class="exercise" id="ex-da79ac"></span>
</li></ol>
</div></div>
<div id="sec-a_first_feed_implementation" data-tralics-id="uid1888" class="subsection" data-number="14.3.2"><h3><a href="following_users_fragment.html#sec-a_first_feed_implementation" class="heading hyperref"><span class="number">14.3.2 </span>A first feed implementation</a></h3>
<p>With the status feed design requirements captured in the test from <a href="following_users_fragment.html#code-full_feed_test" class="hyperref">Listing <span class="ref">14.42</span></a>, we’re ready to start writing the feed.<span class="intersentencespace"></span> Since the final feed implementation is rather intricate, we’ll build up to it by introducing one piece at a time.<span class="intersentencespace"></span> The first step is to think of the kind of query we’ll need.<span class="intersentencespace"></span> We need to select all the microposts from the <code>microposts</code> table with ids corresponding to the users being followed by a given user (or the user itself).<span class="intersentencespace"></span> We might write this schematically as follows:</p>
<div class="code"><div class="highlight"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">microposts</span>
<span class="k">WHERE</span> <span class="n">user_id</span> <span class="k">IN</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">list</span> <span class="k">of</span> <span class="n">ids</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">OR</span> <span class="n">user_id</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">user</span> <span class="n">id</span><span class="o">&gt;</span>
</pre></div></div>
<p>In writing this code, we’ve guessed that SQL supports an <code>IN</code> keyword that allows us to test for set inclusion.<span class="intersentencespace"></span> (Happily, it does.)</p>
<p>Recall from the proto-feed in <a href="user_microposts_fragment.html#sec-a_proto_feed" class="hyperref">Section <span class="ref">13.3.3</span></a> that Active Record uses the <code>where</code> method to accomplish the kind of select shown above, as illustrated in <a href="user_microposts_fragment.html#code-proto_status_feed" class="hyperref">Listing <span class="ref">13.46</span></a>.<span class="intersentencespace"></span> There, our select was very simple; we just picked out all the microposts with user id corresponding to the current user:</p>
<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"user_id = ?"</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</pre></div></div>
<p>Here, we expect it to be more complicated, something like this:</p>
<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"user_id IN (?) OR user_id = ?"</span><span class="p">,</span> <span class="n">following_ids</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</pre></div></div>
<p>We see from these conditions that we’ll need an array of ids corresponding to the users being followed.<span class="intersentencespace"></span> One way to do this is to use Ruby’s <code>map</code> method, available on any “enumerable” object, i.e., any object (such as an Array or a Hash) that consists of a collection of elements.<sup id="cha-14_footnote-ref-9" class="footnote"><a href="#cha-14_footnote-9">9</a></sup><span class="intersentencespace"></span> We saw an example of this method in <a href="rails_flavored_ruby_fragment.html#sec-blocks" class="hyperref">Section <span class="ref">4.3.2</span></a>; as another example, we’ll use <code>map</code> to convert an array of integers to an array of strings:</p>
<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">].</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span><span class="o">.</span><span class="n">to_s</span> <span class="p">}</span>
<span class="go">=&gt; ["1", "2", "3", "4"]</span>
</pre></div></div>
<p>Situations like the one illustrated above, where the same method gets called on each element in the collection, are common enough that there’s a shorthand notation for it (seen briefly in <a href="rails_flavored_ruby_fragment.html#sec-blocks" class="hyperref">Section <span class="ref">4.3.2</span></a>) that uses an <em>ampersand</em> <code>&amp;</code> and a symbol corresponding to the method:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">].</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_s</span><span class="p">)</span>
<span class="go">=&gt; ["1", "2", "3", "4"]</span>
</pre></div></div>
<p>Using the <code>join</code> method (<a href="rails_flavored_ruby_fragment.html#sec-arrays_and_ranges" class="hyperref">Section <span class="ref">4.3.1</span></a>), we can create a string composed of the ids by joining them on comma-space :</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">].</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_s</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span>
<span class="go">=&gt; "1, 2, 3, 4"</span>
</pre></div></div>
<p>We can use the above method to construct the necessary array of followed user ids by calling <code>id</code> on each element in <code>user.following</code>.<span class="intersentencespace"></span> For example, for the first user in the database this array appears as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)</span>
<span class="go">=&gt; [3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22,</span>
<span class="go">23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41,</span>
<span class="go">42, 43, 44, 45, 46, 47, 48, 49, 50, 51]</span>
</pre></div></div>
<p>In fact, because this sort of construction is so useful, Active Record provides it by default:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">following_ids</span>
<span class="go">=&gt; [3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22,</span>
<span class="go">23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41,</span>
<span class="go">42, 43, 44, 45, 46, 47, 48, 49, 50, 51]</span>
</pre></div></div>
<p>Here the <code>following_ids</code> method is synthesized by Active Record based on the <code>has_many :following</code> association (<a href="following_users_fragment.html#code-has_many_following_through_active_relationships" class="hyperref">Listing <span class="ref">14.8</span></a>); the result is that we need only append <code>_ids</code> to the association name to get the ids corresponding to the <code>user.following</code> collection.<span class="intersentencespace"></span> A string of followed user ids then appears as follows:</p>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">following_ids</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span>
<span class="go">=&gt; "3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22,</span>
<span class="go">23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41,</span>
<span class="go">42, 43, 44, 45, 46, 47, 48, 49, 50, 51"</span>
</pre></div></div>
<p>When inserting into an SQL string, though, you don’t need to do this; the <code>?</code> interpolation takes care of it for you (and in fact eliminates some database-dependent incompatibilities).<span class="intersentencespace"></span> This means we can use <code>following_ids</code> by itself.<span class="intersentencespace"></span> As a result, the initial guess of</p>
<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"user_id IN (?) OR user_id = ?"</span><span class="p">,</span> <span class="n">following_ids</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</pre></div></div>
<p>actually works!<span class="intersentencespace"></span> The result appears in <a href="following_users_fragment.html#code-initial_working_feed" class="hyperref">Listing <span class="ref">14.44</span></a>.</p>
<div class="codelisting" id="code-initial_working_feed" data-tralics-id="uid1890" data-number="14.44"><div class="heading"><span class="number">Listing 14.44:</span> 

<span class="description">The initial working feed.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Returns true if a password reset has expired.</span>
  <span class="k">def</span> <span class="nf">password_reset_expired?</span>
    <span class="n">reset_sent_at</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">.</span><span class="n">hours</span><span class="o">.</span><span class="n">ago</span>
  <span class="k">end</span>

  <span class="c1"># Returns a user's status feed.</span>
  <span class="k">def</span> <span class="nf">feed</span>
<span class="hll">    <span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"user_id IN (?) OR user_id = ?"</span><span class="p">,</span> <span class="n">following_ids</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="c1"># Follows a user.</span>
  <span class="k">def</span> <span class="nf">follow</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">active_relationships</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">followed_id</span><span class="p">:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>The test suite should be <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span>:</p>
<div class="codelisting" id="uid1891" data-tralics-id="uid1891" data-number="14.45"><div class="heading"><span class="number">Listing 14.45:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div><p>In some applications, this initial implementation might be good enough for most practical purposes, but <a href="following_users_fragment.html#code-initial_working_feed" class="hyperref">Listing <span class="ref">14.44</span></a> isn’t the final implementation; see if you can make a guess about why not before moving on to the next section.<span class="intersentencespace"></span> (<em>Hint</em>: What if a user is following 5000 other users?)</p>
<div id="sec-exercises_a_first_feed_implementation" data-tralics-id="uid1892" class="subsubsection" data-number="14.3.2.1"><h4><a href="#sec-exercises_a_first_feed_implementation" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>In <a href="following_users_fragment.html#code-initial_working_feed" class="hyperref">Listing <span class="ref">14.44</span></a>, remove the part of the query that finds the user’s own posts.<span class="intersentencespace"></span> Which test in <a href="following_users_fragment.html#code-full_feed_test" class="hyperref">Listing <span class="ref">14.42</span></a> breaks? <span class="exercise" id="ex-aef112"></span>
</li>
<li>In <a href="following_users_fragment.html#code-initial_working_feed" class="hyperref">Listing <span class="ref">14.44</span></a>, remove the part of the query that finds the followed users’ posts.<span class="intersentencespace"></span> Which test in <a href="following_users_fragment.html#code-full_feed_test" class="hyperref">Listing <span class="ref">14.42</span></a> breaks? <span class="exercise" id="ex-5f14ae"></span>
</li>
<li>How could you change the query in <a href="following_users_fragment.html#code-initial_working_feed" class="hyperref">Listing <span class="ref">14.44</span></a> to have the feed erroneously return microposts of unfollowed users, thereby breaking the third test in <a href="following_users_fragment.html#code-full_feed_test" class="hyperref">Listing <span class="ref">14.42</span></a>?<span class="intersentencespace"></span> <em>Hint</em>: Returning all the microposts would do the trick. <span class="exercise" id="ex-102e2b"></span>
</li></ol>
</div></div>
<div id="sec-scopes_subselects_and_a_lambda" data-tralics-id="uid1896" class="subsection" data-number="14.3.3"><h3><a href="following_users_fragment.html#sec-scopes_subselects_and_a_lambda" class="heading hyperref"><span class="number">14.3.3 </span>Subselects</a></h3>
<p>As hinted at in the last section, the feed implementation in <a href="following_users_fragment.html#sec-a_first_feed_implementation" class="hyperref">Section <span class="ref">14.3.2</span></a> doesn’t scale well when the number of microposts in the feed is large, as would likely happen if a user were following, say, 5000 other users.<span class="intersentencespace"></span> In this section, we’ll reimplement the status feed in a way that scales better with the number of followed users.</p>
<p>The problem with the code in <a href="following_users_fragment.html#sec-a_first_feed_implementation" class="hyperref">Section <span class="ref">14.3.2</span></a> is that <code>following_ids</code> pulls <em>all</em> the followed users’ ids into memory, and creates an array the full length of the followed users array.<span class="intersentencespace"></span> Since the condition in <a href="following_users_fragment.html#code-initial_working_feed" class="hyperref">Listing <span class="ref">14.44</span></a> actually just checks inclusion in a set, there must be a more efficient way to do this, and indeed SQL is optimized for just such set operations.<span class="intersentencespace"></span> The solution involves pushing the finding of followed user ids into the database using a <em>subselect</em>.</p>
<p>We’ll start by refactoring the feed with the slightly modified code in <a href="following_users_fragment.html#code-feed_second_cut" class="hyperref">Listing <span class="ref">14.46</span></a>.</p>
<div class="codelisting" id="code-feed_second_cut" data-tralics-id="uid1897" data-number="14.46"><div class="heading"><span class="number">Listing 14.46:</span> 

<span class="description">Using key-value pairs in the feed’s <code>where</code> method.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Returns a user's status feed.</span>
  <span class="k">def</span> <span class="nf">feed</span>
<span class="hll">    <span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"user_id IN (:following_ids) OR user_id = :user_id"</span><span class="p">,</span>
</span><span class="hll">                    <span class="ss">following_ids</span><span class="p">:</span> <span class="n">following_ids</span><span class="p">,</span> <span class="ss">user_id</span><span class="p">:</span> <span class="nb">id</span><span class="p">)</span>
</span>  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>As preparation for the next step, we have replaced</p>
<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"user_id IN (?) OR user_id = ?"</span><span class="p">,</span> <span class="n">following_ids</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</pre></div></div>
<p>with the equivalent</p>
<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"user_id IN (:following_ids) OR user_id = :user_id"</span><span class="p">,</span>
                <span class="ss">following_ids</span><span class="p">:</span> <span class="n">following_ids</span><span class="p">,</span> <span class="ss">user_id</span><span class="p">:</span> <span class="nb">id</span><span class="p">)</span>
</pre></div></div>
<p>The question mark syntax is fine, but when we want the <em>same</em> variable inserted in more than one place, the second syntax is more convenient.</p>
<p>The above discussion implies that we will be adding a <em>second</em> occurrence of <code>user_id</code> in the SQL query.<span class="intersentencespace"></span> In particular, we can replace the Ruby code</p>
<div class="code"><div class="highlight"><pre><span class="n">following_ids</span>
</pre></div></div>
<p>with the SQL snippet</p>
<div class="code"><div class="highlight"><pre><span class="n">following_ids</span> <span class="o">=</span> <span class="s2">"SELECT followed_id FROM relationships</span>
<span class="s2">                 WHERE  follower_id = :user_id"</span>
</pre></div></div>
<p>This code contains an SQL subselect, and internally the entire select for user 1 would look something like this:</p>
<div class="code"><div class="highlight"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">microposts</span>
<span class="k">WHERE</span> <span class="n">user_id</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">followed_id</span> <span class="k">FROM</span> <span class="n">relationships</span>
                  <span class="k">WHERE</span>  <span class="n">follower_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">OR</span> <span class="n">user_id</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div></div>
<p>This subselect arranges for all the set logic to be pushed into the database, which is more efficient.</p>
<p>With this foundation, we are ready for a more efficient feed implementation, as seen in <a href="following_users_fragment.html#code-feed_final" class="hyperref">Listing <span class="ref">14.47</span></a>.<span class="intersentencespace"></span> Note that, because it is now raw SQL, the <code>following_ids</code> string is <em>interpolated</em>, not escaped.</p>
<div class="codelisting" id="code-feed_final" data-tralics-id="uid1898" data-number="14.47"><div class="heading"><span class="number">Listing 14.47:</span> 

<span class="description">The final implementation of the feed.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">app/models/user.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Returns a user's status feed.</span>
  <span class="k">def</span> <span class="nf">feed</span>
    <span class="n">following_ids</span> <span class="o">=</span> <span class="s2">"SELECT followed_id FROM relationships</span>
<span class="s2">                     WHERE  follower_id = :user_id"</span>
    <span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"user_id IN (</span><span class="si">#{</span><span class="n">following_ids</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">                     OR user_id = :user_id"</span><span class="p">,</span> <span class="ss">user_id</span><span class="p">:</span> <span class="nb">id</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div></div></div><p>This code has a formidable combination of Rails, Ruby, and SQL, but it does the job, and does it well:</p>
<div class="codelisting" id="uid1899" data-tralics-id="uid1899" data-number="14.48"><div class="heading"><span class="number">Listing 14.48:</span> <span class="description"><span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span></span>
</div>

<div class="code"><div class="highlight"><pre>$ rails test
</pre></div></div></div><p>Of course, even the subselect won’t scale forever.<span class="intersentencespace"></span> For bigger sites, you would probably need to generate the feed asynchronously using a background job, but such scaling subtleties are beyond the scope of this tutorial.</p>
<p>With the code in <a href="following_users_fragment.html#code-feed_final" class="hyperref">Listing <span class="ref">14.47</span></a>, our status feed is now complete.<span class="intersentencespace"></span> Recall from <a href="user_microposts_fragment.html#sec-a_proto_feed" class="hyperref">Section <span class="ref">13.3.3</span></a> that the Home page already includes the feed.<span class="intersentencespace"></span> In <a href="user_microposts_fragment.html#cha-user_microposts" class="hyperref">Chapter <span class="ref">13</span></a>, the result was only a proto-feed (<a href="user_microposts_fragment.html#fig-home_with_proto_feed" class="hyperref">Figure <span class="ref">13.14</span></a>), but with the implementation in <a href="following_users_fragment.html#code-feed_final" class="hyperref">Listing <span class="ref">14.47</span></a> as seen in <a href="following_users_fragment.html#fig-home_page_with_feed" class="hyperref">Figure <span class="ref">14.23</span></a> the Home page now shows the full feed.</p>
<div class="center figure" id="fig-home_page_with_feed" data-tralics-id="uid1900" data-number="14.23">
<div class="graphics image"><img src="images/figures/home_page_with_feed_3rd_edition.png" alt="images/figures/home_page_with_feed_3rd_edition"></div><div class="caption"><span class="header">Figure 14.23: </span><span class="description">The Home page with a working status feed.
</span></div></div>
<p>At this point, we’re ready to merge our changes into the master branch:</p>
<div class="code"><div class="highlight"><pre>$ rails test
$ git add -A
$ git commit -m "Add user following"
$ git checkout master
$ git merge following-users
</pre></div></div>
<p>We can then push the code to the remote repository and deploy the application to production:</p>
<div class="code"><div class="highlight"><pre>$ git push
$ git push heroku
$ heroku pg:reset DATABASE
$ heroku run rails db:migrate
$ heroku run rails db:seed
</pre></div></div>
<p>The result is a working status feed on the live Web (<a href="following_users_fragment.html#fig-live_status_feed" class="hyperref">Figure <span class="ref">14.24</span></a>).</p>
<div class="center figure" id="fig-live_status_feed" data-tralics-id="uid1901" data-number="14.24">
<div class="graphics image"><img src="images/figures/live_status_feed.png" alt="images/figures/live_status_feed"></div><div class="caption"><span class="header">Figure 14.24: </span><span class="description">A working status feed on the live Web.
</span></div></div>
<div id="sec-exercises_scopes_subselects_and_a_lambda" data-tralics-id="uid1902" class="subsubsection" data-number="14.3.3.1"><h4><a href="#sec-exercises_scopes_subselects_and_a_lambda" class="heading">Exercises</a></h4>
 <div class="society-note">
<p>Solutions to exercises are available for free at <a href="http://railstutorial.org/solutions" target="_blank" rel="noopener">railstutorial.org/solutions</a> with any Rails Tutorial purchase.<span class="intersentencespace"></span> To see other people’s answers and to record your own, join the <a href="http://learnenough.com/society" target="_blank" rel="noopener">Learn Enough Society</a> at <a href="http://learnenough.com/society" target="_blank" rel="noopener">learnenough.com/society</a>.<span class="intersentencespace"></span>  </p></div>
<ol>
<li>Write an integration test to verify that the first page of the feed appears on the Home page as required.<span class="intersentencespace"></span> A template appears in <a href="following_users_fragment.html#code-home_feed_test" class="hyperref">Listing <span class="ref">14.49</span></a>. <span class="exercise" id="ex-1d34e5"></span>
</li>
<li>Note that <a href="following_users_fragment.html#code-home_feed_test" class="hyperref">Listing <span class="ref">14.49</span></a> escapes the expected HTML using <code>CGI.escapeHTML</code> (which is closely related to the <code>CGI.escape</code> method we used in <a href="account_activation_fragment.html#sec-email_tests" class="hyperref">Section <span class="ref">11.2.3</span></a> to escape URLs).<span class="intersentencespace"></span> Why is escaping the HTML necessary in this case?<span class="intersentencespace"></span> <em>Hint</em>: Try removing the escaping and carefully inspect the page source for the micropost content that doesn’t match.<span class="intersentencespace"></span> Using the search feature of your terminal shell (Cmd-F on Ctrl-F on most systems) to find the word “sorry” may prove particularly helpful. <span class="exercise" id="ex-05d0df"></span>
</li></ol>
<div class="codelisting" id="code-home_feed_test" data-tralics-id="uid1905" data-number="14.49"><div class="heading"><span class="number">Listing 14.49:</span> 

<span class="description">Testing the feed HTML.<span class="intersentencespace"></span> <span style="color: ForestGreen"><span class="sc"></span><span class="sc"><strong>green</strong></span><span class="sc"></span></span><span class="break"></span> <span class="filepath">test/integration/following_test.rb</span></span>
</div>

<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">FollowingTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:michael</span><span class="p">)</span>
    <span class="n">log_in_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="nb">test</span> <span class="s2">"feed on Home page"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">root_path</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
      <span class="n">assert_match</span> <span class="no">CGI</span><span class="o">.</span><span class="n">escapeHTML</span><span class="p">(</span><span class="no">FILL_IN</span><span class="p">),</span> <span class="no">FILL_IN</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div></div></div></div><div id="sec-following_conclusion" data-tralics-id="cid83" class="section" data-number="14.4"><h2><a href="following_users_fragment.html#sec-following_conclusion" class="heading hyperref"><span class="number">14.4 </span>Conclusion</a></h2>
<p>With the addition of the status feed, we’ve finished the sample application for the <em>Ruby on Rails Tutorial</em>.<span class="intersentencespace"></span> This application includes examples of all the major features of Rails, including models, views, controllers, templates, partials, filters, validations, callbacks, <code>has_many</code>/<code>belongs_to</code> and <code>has_many :through</code> associations, security, testing, and deployment.</p>
<p>Despite this impressive list, there is still much to learn about web development.<span class="intersentencespace"></span> As a first step in this process, this section contains some suggestions for further learning.</p>
<div id="sec-guide_to_further_resources" data-tralics-id="uid1906" class="subsection" data-number="14.4.1"><h3><a href="following_users_fragment.html#sec-guide_to_further_resources" class="heading hyperref"><span class="number">14.4.1 </span>Guide to further resources</a></h3>
<p>There is a wealth of Rails resources in stores and on the web—indeed, the supply is so rich that it can be overwhelming.<span class="intersentencespace"></span> The good news is that, having gotten this far, you’re ready for almost anything else out there.<span class="intersentencespace"></span> Here are some suggestions for further learning:</p>
<ul>
<li><a href="http://learnenough.com/story" target="_blank" rel="noopener">The Learn Enough Society</a>: Premium subscription service that includes a special enhanced version of the <em>Ruby on Rails Tutorial</em> book and 15+ hours of streaming screencast lessons filled with the kind of tips, tricks, and live demos that you can’t get from reading a book.<span class="intersentencespace"></span> Also includes text and videos for the other <a href="http://learnenough.com/" target="_blank" rel="noopener">Learn Enough</a> tutorials.<span class="intersentencespace"></span> Scholarship discounts are available.
</li>
<li><a href="http://launchschool.com/railstutorial" target="_blank" rel="noopener">Launch School</a>: Lots of in-person developer bootcamps have sprung up in recent years, and I recommend looking for one in your area, but <a href="http://launchschool.com/railstutorial" target="_blank" rel="noopener">Launch School</a> is available online and so can be taken from anywhere.<span class="intersentencespace"></span> Launch School is an especially good choice if you want instructor feedback within the context of a structured curriculum.
</li>
<li>The <a href="http://turing.io/" target="_blank" rel="noopener">Turing School of Software &amp; Design</a>: a full-time, 27-week Ruby/Rails/JavaScript training program in Denver, Colorado.<span class="intersentencespace"></span> Most of their students start with limited programming experience but have the determination and drive needed to pick it up quickly.<span class="intersentencespace"></span> Turing guarantees its students will find a job after graduating or they’ll refund the cost of tuition.
</li>
<li><a href="http://bloc.io/" target="_blank" rel="noopener">Bloc</a>: An online bootcamp with a structured curriculum, personalized mentorship, and a focus on learning through concrete projects.<span class="intersentencespace"></span> Use the coupon code <span class="sc">BLOCLOVESHARTL</span> to get $500 off the enrollment fee.
</li>
<li><a href="http://www.thefirehoseproject.com/?tid=HARTL-RAILS-TUT-EB2&amp;pid=HARTL-RAILS-TUT-EB2" target="_blank" rel="noopener">Firehose Project</a>: A mentor-driven, online coding bootcamp focused on real-world programming skills like test-driven development, algorithms, and building an advanced web application as part of an agile team.<span class="intersentencespace"></span> Two-week free intro course.
</li>
<li><a href="http://www.thinkful.com/a/railstutorial" target="_blank" rel="noopener">Thinkful</a>: An online class that pairs you with a professional engineer as you work through a project-based curriculum.<span class="intersentencespace"></span> Subjects include Ruby on Rails, front-end development, web design, and data science.
</li>
<li><a href="https://pragmaticstudio.com/refs/railstutorial" target="_blank" rel="noopener">Pragmatic Studio</a>: Online Ruby and Rails courses from Mike and Nicole Clark.
</li>
<li><a href="https://tutorials.railsapps.org/hartl" target="_blank" rel="noopener">RailsApps</a>: Instructive sample Rails apps
</li>
<li><a href="https://www.codeschool.com/" target="_blank" rel="noopener">Code School</a>: A large variety of interactive programming courses
</li></ul>
</div>
<div id="sec-following_users_what_we_learned_in_this_chapter" data-tralics-id="uid1916" class="subsection" data-number="14.4.2"><h3><a href="following_users_fragment.html#sec-following_users_what_we_learned_in_this_chapter" class="heading hyperref"><span class="number">14.4.2 </span>What we learned in this chapter</a></h3>
<ul>
<li>Rails’ <code>has_many :through</code> allows the modeling of complicated data relationships.<span class="intersentencespace"></span>
</li>
<li>The <code>has_many</code> method takes several optional arguments, including the object class name and the foreign key.<span class="intersentencespace"></span>
</li>
<li>Using <code>has_many</code> and <code>has_many :through</code> with properly chosen class names and foreign keys, we can model both active (following) and passive (being followed) relationships.<span class="intersentencespace"></span>
</li>
<li>Rails routing supports nested routes.<span class="intersentencespace"></span>
</li>
<li>The <code>where</code> method is a flexible and powerful way to create database queries.<span class="intersentencespace"></span>
</li>
<li>Rails supports issuing lower-level SQL queries if needed.<span class="intersentencespace"></span>
</li>
<li>By putting together everything we’ve learned in this book, we’ve successfully implemented user following with a status feed of microposts from followed users.<span class="intersentencespace"></span>
</li></ul>
</div></div><div id="cha-14_footnotes">
  <ol class="footnotes">
    <li id="cha-14_footnote-1">Image of child retrieved from http://www.flickr.com/photos/john_lustig/2518452221/ on 2013-12-16.<span class="intersentencespace"></span> Copyright © 2008 by John Lustig and used unaltered under the terms of the <a href="https://creativecommons.org/licenses/by/2.0/" target="_blank" rel="noopener">Creative Commons Attribution 2.0 Generic</a> license.<span class="intersentencespace"></span> Image of tiger retrieved from https://www.flickr.com/photos/renemensen/9187111340 on 2014-08-15.<span class="intersentencespace"></span> Copyright © 2013 by Rene Mesen and used unaltered under the terms of the <a href="https://creativecommons.org/licenses/by/2.0/" target="_blank" rel="noopener">Creative Commons Attribution 2.0 Generic</a> license. <a class="arrow" href="#cha-14_footnote-ref-1">↑</a></li>
    <li id="cha-14_footnote-2">For simplicity, <a href="following_users_fragment.html#fig-naive_user_has_many_following" class="hyperref">Figure <span class="ref">14.6</span></a> omits the <code>following</code> table’s <code>id</code> column. <a class="arrow" href="#cha-14_footnote-ref-2">↑</a></li>
    <li id="cha-14_footnote-3">Thanks to reader Paul Fioravanti for suggesting this terminology. <a class="arrow" href="#cha-14_footnote-ref-3">↑</a></li>
    <li id="cha-14_footnote-4">Technically, Rails converts the argument of <code>has_many</code> to a class name using the <code>classify</code> method, which converts <code>"foo_bars"</code> to <code>"FooBar"</code>. <a class="arrow" href="#cha-14_footnote-ref-4">↑</a></li>
    <li id="cha-14_footnote-5">Technically, Rails uses the <code>underscore</code> method to convert the class name to an id.<span class="intersentencespace"></span> For example, <code>"FooBar".underscore</code> is <code>"foo_bar"</code>, so the foreign key for a <code>FooBar</code> object would be <code>foo_bar_id</code>. <a class="arrow" href="#cha-14_footnote-ref-5">↑</a></li>
    <li id="cha-14_footnote-6">Once you have a lot of experience modeling a particular domain, you can often guess such utility methods in advance, and even when you can’t you’ll often find yourself writing them to make the tests cleaner.<span class="intersentencespace"></span> In this case, though, it’s OK if you wouldn’t have guessed them.<span class="intersentencespace"></span> Software development is usually an iterative process—you write code until it starts getting ugly, and then you refactor it—but for brevity the tutorial presentation is streamlined a bit. <a class="arrow" href="#cha-14_footnote-ref-6">↑</a></li>
    <li id="cha-14_footnote-7">For more details on such routing options, see the <a href="http://guides.rubyonrails.org/routing.html" target="_blank" rel="noopener">Rails Guides article on “Rails Routing from the Outside In”</a>. <a class="arrow" href="#cha-14_footnote-ref-7">↑</a></li>
    <li id="cha-14_footnote-8">Because it is nominally an acronym for <em>asynchronous JavaScript and XML</em>, Ajax is sometimes misspelled “AJAX”, even though the <a href="http://www.adaptivepath.com/ideas/ajax-new-approach-web-applications/" target="_blank" rel="noopener">original Ajax article</a> spells it as “Ajax” throughout. <a class="arrow" href="#cha-14_footnote-ref-8">↑</a></li>
    <li id="cha-14_footnote-9">The main requirement is that enumerable objects must implement an <code>each</code> method to iterate through the collection. <a class="arrow" href="#cha-14_footnote-ref-9">↑</a></li>
  </ol>
</div>u      Xh=XhP=h*Xh  ~a,:https://softcover.s3-us-west-2.amazonaws.com/636/ruby_on_rails_tutorial_4th_edition/html/following_users_fragment.html?X-Amz-Expires=604800&X-Amz-Date=20170205T144313Z&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAJMNNDDBSYVXVHGAA/20170205/us-west-2/s3/aws4_request&X-Amz-SignedHeaders=host&X-Amz-Signature=97f444be703bb6e663d51eca3ccde45331ef9da50d9d6031bd5b355388b936cd security-info FnhllAKWRHGAlo+ESXykKAAAAAAAAAAAwAAAAAAAAEaphjoj9ApAYLLhYqsrhSapAAQAAgAAAAAAAAAAAAAAACw4N6+LhUposNgK7YiYWzI/H82DxalM0aJQdnbKfH40ZgoyJpFcT/u7IImFpjLfBfjtg2TO2UxuhrpIr1PDk+YAAAAAAAAGGzCCBhcwggT/oAMCAQICEAkMEh1kGcxPzNQuULyfEo0wDQYJKoZIhvcNAQELBQAwZDELMAkGA1UEBhMCVVMxFTATBgNVBAoTDERpZ2lDZXJ0IEluYzEZMBcGA1UECxMQd3d3LmRpZ2ljZXJ0LmNvbTEjMCEGA1UEAxMaRGlnaUNlcnQgQmFsdGltb3JlIENBLTIgRzIwHhcNMTYwNzE4MDAwMDAwWhcNMTcxMDI2MTIwMDAwWjB1MQswCQYDVQQGEwJVUzETMBEGA1UECBMKV2FzaGluZ3RvbjEQMA4GA1UEBxMHU2VhdHRsZTEYMBYGA1UEChMPQW1hem9uLmNvbSBJbmMuMSUwIwYDVQQDDBwqLnMzLXVzLXdlc3QtMi5hbWF6b25hd3MuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtPtaIwJ9+anWiEq/qLdHgQkQ51FdpjU3C/o1HSP3DGHcijP8q6gpOQ2GIT4xaAOOEstz5v5WY8kOfEE0UXsyB8LxmNyu4nPz4gEE1jCKXaFaMQUexl2nz1hNBCzabnDV10EB2+XPOWPw1troTgtKWuBxZ4EaC7dQXkgpqSqzcio33y9sZHlcEa2ok0DMgxTaEY0ryVdODJMlTIVoFwzkiedRV3dl7yRK8EqWMfWnVJzJ2JVMRqakWjQeLE+8oeo4F0m6BEch9qpIA8JV20oFv0cQLM6QQNFzX2EN/2v5uBtrB5g/g39+5Yu+kgkfhedTSkFunjEGol8G7jssC3jijwIDAQABo4ICsjCCAq4wHwYDVR0jBBgwFoAUwBKyKHRoRmfpcCV0GgBFWwZ9XEQwHQYDVR0OBBYEFF1JaGNuDmFfuVhgXPTd3tg4yz2iMIHhBgNVHREEgdkwgdaCGnMzLXVzLXdlc3QtMi5hbWF6b25hd3MuY29tghwqLnMzLXVzLXdlc3QtMi5hbWF6b25hd3MuY29tghpzMy51cy13ZXN0LTIuYW1hem9uYXdzLmNvbYIcKi5zMy51cy13ZXN0LTIuYW1hem9uYXdzLmNvbYIkczMuZHVhbHN0YWNrLnVzLXdlc3QtMi5hbWF6b25hd3MuY29tgiYqLnMzLmR1YWxzdGFjay51cy13ZXN0LTIuYW1hem9uYXdzLmNvbYISKi5zMy5hbWF6b25hd3MuY29tMA4GA1UdDwEB/wQEAwIFoDAdBgNVHSUEFjAUBggrBgEFBQcDAQYIKwYBBQUHAwIwgYEGA1UdHwR6MHgwOqA4oDaGNGh0dHA6Ly9jcmwzLmRpZ2ljZXJ0LmNvbS9EaWdpQ2VydEJhbHRpbW9yZUNBLTJHMi5jcmwwOqA4oDaGNGh0dHA6Ly9jcmw0LmRpZ2ljZXJ0LmNvbS9EaWdpQ2VydEJhbHRpbW9yZUNBLTJHMi5jcmwwTAYDVR0gBEUwQzA3BglghkgBhv1sAQEwKjAoBggrBgEFBQcCARYcaHR0cHM6Ly93d3cuZGlnaWNlcnQuY29tL0NQUzAIBgZngQwBAgIweQYIKwYBBQUHAQEEbTBrMCQGCCsGAQUFBzABhhhodHRwOi8vb2NzcC5kaWdpY2VydC5jb20wQwYIKwYBBQUHMAKGN2h0dHA6Ly9jYWNlcnRzLmRpZ2ljZXJ0LmNvbS9EaWdpQ2VydEJhbHRpbW9yZUNBLTJHMi5jcnQwDAYDVR0TAQH/BAIwADANBgkqhkiG9w0BAQsFAAOCAQEAYH38ntfWdhwWcuD895IsKMmdlnbReTnnEKe6n6tldoxpWEJkjMA0hURZnZrbr5FL3ar6bWF9wnFKMYPxMfjhNzpB8/lbp63yZSDmVpDIsOIRWjkdcMsnpBHDHQWPV9T7fIgxT4WqAK92O3kQs1+bmsuXISBelIMev1G02BYa7EDD8JZyoltleTcs8rzvRRgE37GfxAtu07fxQqyDSvj7ojpSoIUmTVDVJMTGCkSemYpdR3DqTzmsej6eV7TbLdvFTjFnRJ4Zdehb17CoVvkOTB1v/oXaabIIi3UEsDu3UpxdB7mU4G1qgy8XDMitAtpBL6+EIw0QKw5+JoSuzbybEgAAAIAAAACAAAAAJVRMU19FQ0RIRV9SU0FfV0lUSF9BRVNfMTI4X0dDTV9TSEEyNTYAAAABAAA= request-method GET request-Origin https://www.railstutorial.org response-head HTTP/1.1 200 OK
x-amz-id-2: Oc/u74Qs10QnVROU0fxKCCyRKiDYTQMopCloDSUr5hvj/w50SDRTFAg3dCy6znFy7TCqhtUyS5M=
x-amz-request-id: D405A49EB9AF1724
Date: Sun, 05 Feb 2017 18:00:33 GMT
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: GET
Access-Control-Max-Age: 3000
Vary: Origin, Access-Control-Request-Headers, Access-Control-Request-Method
Last-Modified: Thu, 22 Dec 2016 05:28:12 GMT
Etag: "ce303b2acf5b1e184ee9a2fd21af607d"
Accept-Ranges: bytes
Content-Type: text/html
Content-Length: 242359
Server: AmazonS3
 uncompressed-len 0  